Notebook[{
Cell[BoxData[
 RowBox[{"(*", "\n", 
  RowBox[{
   RowBox[{"CoreDynamicAlgorithms", ".", 
    RowBox[{"nb", ":", " ", 
     RowBox[{
     "An", " ", "implementation", " ", "of", " ", "the", " ", "RNEA", " ", 
      "algorithm", "\n", "and", " ", "its", " ", 
      RowBox[{"derivative", ".", "\n", "Copyright"}], " ", 
      RowBox[{"(", "C", ")"}], " ", "2017", " ", "Nelson", " ", "Rosa", " ", 
      RowBox[{"Jr", ".", "\n", "\n", "This"}], " ", "program", " ", "is", " ",
       "free", " ", "software"}], ":", " ", 
     RowBox[{"you", " ", "can", " ", "redistribute", " ", "it", " ", 
      RowBox[{"and", "/", "or"}], " ", "modify", "\n", "it", " ", "under", 
      " ", "the", " ", "terms", " ", "of", " ", "the", " ", "GNU", " ", 
      "General", " ", "Public", " ", "License", " ", "as", " ", "published", 
      " ", "by", "\n", 
      RowBox[{"the", " ", "Free", " ", "Software", " ", "Foundation"}]}]}]}], 
   ",", " ", 
   RowBox[{
   "either", " ", "version", " ", "3", " ", "of", " ", "the", " ", 
    "License"}], ",", " ", 
   RowBox[{"or", "\n", 
    RowBox[{"(", 
     RowBox[{"at", " ", "your", " ", "option"}], ")"}], " ", "any", " ", 
    "later", " ", 
    RowBox[{"version", ".", " ", "This"}], " ", "program", " ", "is", " ", 
    "distributed", " ", "in", " ", "the", " ", "\n", "hope", " ", "that", " ",
     "it", " ", "will", " ", "be", " ", "useful"}], ",", " ", 
   RowBox[{
    RowBox[{"but", " ", "WITHOUT", " ", "ANY", " ", "WARRANTY"}], ";", " ", 
    RowBox[{
    "without", " ", "even", " ", "the", " ", "\n", "implied", " ", "warranty",
      " ", "of", " ", "MERCHANTABILITY", " ", "or", " ", "FITNESS", " ", 
     "FOR", " ", "A", " ", "PARTICULAR", " ", 
     RowBox[{"PURPOSE", ".", "\n", "See"}], " ", "the", " ", "GNU", " ", 
     "General", " ", "Public", " ", "License", " ", "for", " ", "more", " ", 
     RowBox[{"details", ".", " ", "You"}], " ", "should", " ", "have", " ", 
     "\n", "received", " ", "a", " ", "copy", " ", "of", " ", "the", " ", 
     "GNU", " ", "General", " ", "Public", " ", "License", " ", "along", " ", 
     "with", " ", "this", " ", 
     RowBox[{"program", ".", "\n", "If"}], " ", "not"}]}], ",", " ", 
   RowBox[{
    RowBox[{"see", " ", "<", 
     RowBox[{"http", ":"}]}], "//", 
    RowBox[{
     RowBox[{
      RowBox[{
       RowBox[{"www", ".", "gnu", ".", "org"}], "/", "licenses"}], "/"}], ">",
      "."}]}]}], "\n", "*)"}]], "Code",
 InitializationCell->True,
 CellLabel->"In[13]:=",ExpressionUUID->"59f5aa58-c7ae-458c-ae67-8abe32970981"],

Cell[CellGroupData[{

Cell["Begin Package", \
"Section",ExpressionUUID->"04ab2fc5-9b64-4da9-9a70-e61022bce381"],

Cell[BoxData[{
 RowBox[{"BeginPackage", "[", 
  RowBox[{"\"\<RigidBodyDynamics`\>\"", ",", " ", 
   RowBox[{"{", 
    RowBox[{"\"\<GlobalVariables`\>\"", ",", " ", "\"\<Derivatives`\>\""}], 
    "}"}]}], "]"}], "\[IndentingNewLine]", 
 RowBox[{"Begin", "[", "\"\<`Private`\>\"", "]"}]}], "Input",
 InitializationCell->
  True,ExpressionUUID->"d87f4dd9-db65-4e30-b098-18ed02ae01d7"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"Options", "[", "RBDSaveDynamics", "]"}], " ", "=", " ", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"\"\<D\>\"", " ", "\[Rule]", " ", "Automatic"}], ",", " ", 
      RowBox[{"\"\<F\>\"", " ", "\[Rule]", " ", "Automatic"}]}], "}"}]}], 
   ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"RBDSaveDynamics", "[", 
    RowBox[{"rbd_", ",", " ", "n_", ",", " ", 
     RowBox[{"OptionsPattern", "[", "]"}]}], "]"}], " ", ":=", " ", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"dir", ",", " ", "fil"}], "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"fil", " ", "=", " ", 
       RowBox[{"OptionValue", "[", "\"\<F\>\"", "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"fil", " ", "===", " ", "Automatic"}], ",", " ", 
        RowBox[{
         RowBox[{"fil", " ", "=", " ", "\"\<CompiledFunctions\>\""}], ";"}]}],
        "]"}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"dir", " ", "=", " ", 
       RowBox[{"OptionValue", "[", "\"\<D\>\"", "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"dir", " ", "=", " ", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"dir", " ", "===", " ", "Automatic"}], ",", " ", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"NotebookDirectory", "[", "]"}], ",", " ", "fil"}], "}"}], 
         ",", " ", 
         RowBox[{"{", 
          RowBox[{"dir", ",", " ", "fil"}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"dir", " ", "=", " ", 
       RowBox[{"FileNameJoin", "@", 
        RowBox[{"Flatten", "@", "dir"}]}]}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"!", 
         RowBox[{"DirectoryQ", "[", "dir", "]"}]}], ",", " ", 
        RowBox[{
         RowBox[{"CreateDirectory", "[", "dir", "]"}], ";"}]}], "]"}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"Export", "[", 
       RowBox[{
        RowBox[{"FileNameJoin", "[", 
         RowBox[{"{", 
          RowBox[{"dir", ",", " ", 
           RowBox[{"\"\<rbd-\>\"", " ", "<>", " ", 
            RowBox[{"ToString", "[", "n", "]"}], " ", "<>", " ", 
            "\"\<.mx\>\""}]}], "}"}], "]"}], ",", " ", "rbd"}], "]"}]}]}], 
    "\[IndentingNewLine]", "]"}]}], ";"}]}], "Input",
 InitializationCell->
  True,ExpressionUUID->"7f674f35-5bdb-4c7a-a973-7a869a2c8730"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"Options", "[", "RBDDeleteDynamics", "]"}], " ", "=", " ", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"\"\<D\>\"", " ", "\[Rule]", " ", "Automatic"}], ",", " ", 
      RowBox[{"\"\<F\>\"", " ", "\[Rule]", " ", "Automatic"}]}], "}"}]}], 
   ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"RBDDeleteDynamics", "[", 
    RowBox[{"n_", ",", " ", 
     RowBox[{"OptionsPattern", "[", "]"}]}], "]"}], " ", ":=", " ", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"dir", ",", " ", "fil"}], "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"fil", " ", "=", " ", 
       RowBox[{"OptionValue", "[", "\"\<F\>\"", "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"fil", " ", "===", " ", "Automatic"}], ",", " ", 
        RowBox[{
         RowBox[{"fil", " ", "=", " ", "\"\<CompiledFunctions\>\""}], ";"}]}],
        "]"}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"dir", " ", "=", " ", 
       RowBox[{"OptionValue", "[", "\"\<D\>\"", "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"dir", " ", "=", " ", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"dir", " ", "===", " ", "Automatic"}], ",", " ", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"NotebookDirectory", "[", "]"}], ",", " ", "fil"}], "}"}], 
         ",", " ", 
         RowBox[{"{", 
          RowBox[{"dir", ",", " ", "fil"}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"dir", " ", "=", " ", 
       RowBox[{"FileNameJoin", "@", 
        RowBox[{"Flatten", "@", "dir"}]}]}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"DirectoryQ", "[", "dir", "]"}], ",", " ", 
        RowBox[{"DeleteDirectory", "[", 
         RowBox[{"dir", ",", " ", 
          RowBox[{"DeleteContents", "\[Rule]", "True"}]}], "]"}]}], "]"}]}]}],
     "\[IndentingNewLine]", "]"}]}], ";"}]}], "Input",
 InitializationCell->
  True,ExpressionUUID->"52a4f2b9-0283-4b12-bb15-e5325d990a35"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"Options", "[", "RBDLoadDynamics", "]"}], " ", "=", " ", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"\"\<D\>\"", " ", "\[Rule]", " ", "Automatic"}], ",", " ", 
      RowBox[{"\"\<F\>\"", " ", "\[Rule]", " ", "Automatic"}]}], "}"}]}], 
   ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"RBDLoadDynamics", "::", "dir"}], " ", "=", " ", 
    "\"\<`` does not exist.\>\""}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"RBDLoadDynamics", "[", 
    RowBox[{"n_", ",", " ", 
     RowBox[{"OptionsPattern", "[", "]"}]}], "]"}], " ", ":=", " ", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "rbd", ",", " ", "lib", ",", " ", "dir", ",", " ", "fil", ",", " ", 
       "d"}], "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"fil", " ", "=", " ", 
       RowBox[{"OptionValue", "[", "\"\<F\>\"", "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"fil", " ", "===", " ", "Automatic"}], ",", " ", 
        RowBox[{
         RowBox[{"fil", " ", "=", " ", "\"\<CompiledFunctions\>\""}], ";"}]}],
        "]"}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"dir", " ", "=", " ", 
       RowBox[{"OptionValue", "[", "\"\<D\>\"", "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"dir", " ", "=", " ", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"dir", " ", "===", " ", "Automatic"}], ",", " ", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"NotebookDirectory", "[", "]"}], ",", " ", "fil"}], "}"}], 
         ",", " ", 
         RowBox[{"{", 
          RowBox[{"dir", ",", " ", "fil"}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"dir", " ", "=", " ", 
       RowBox[{"FileNameJoin", "@", 
        RowBox[{"Flatten", "@", "dir"}]}]}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"!", 
         RowBox[{"DirectoryQ", "[", "dir", "]"}]}], ",", " ", 
        "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"Message", "[", 
          RowBox[{
           RowBox[{"RBDLoadDynamics", "::", "dir"}], ",", " ", "dir"}], "]"}],
          ";", " ", "\[IndentingNewLine]", 
         RowBox[{"Return", "[", "$Failed", "]"}], ";"}]}], 
       "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"Import", "[", 
       RowBox[{"FileNameJoin", "[", 
        RowBox[{"{", 
         RowBox[{"dir", ",", " ", 
          RowBox[{"\"\<rbd-\>\"", " ", "<>", " ", 
           RowBox[{"ToString", "[", "n", "]"}], " ", "<>", " ", 
           "\"\<.mx\>\""}]}], "}"}], "]"}], "]"}]}]}], "\[IndentingNewLine]", 
    "]"}]}], ";"}]}], "Input",
 InitializationCell->
  True,ExpressionUUID->"49cfc31d-69f0-4f2b-9ad5-76cfe8f18c5c"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Expanded inputs for Compile", \
"Section",ExpressionUUID->"8278f024-1335-4385-9af0-6f7198297bb9"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"SetAttributes", "[", 
   RowBox[{"CompileArgs", ",", " ", "HoldFirst"}], "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"CompileArgs", "[", 
    RowBox[{"v_", ",", " ", "n_", ",", " ", 
     RowBox[{"list_:", "True"}]}], "]"}], " ", ":=", " ", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", "a", "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"a", " ", "=", " ", 
       RowBox[{"Thread", "/@", 
        RowBox[{"Thread", "[", 
         RowBox[{"\[FormalP]", "@", "v"}], "]"}]}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"a", "\[LeftDoubleBracket]", 
        RowBox[{"All", ",", " ", 
         RowBox[{"2", ";;", "3"}]}], "\[RightDoubleBracket]"}], " ", "=", " ", 
       RowBox[{
        RowBox[{"a", "\[LeftDoubleBracket]", 
         RowBox[{"All", ",", " ", 
          RowBox[{"2", ";;", "3"}]}], "\[RightDoubleBracket]"}], " ", "/.", 
        " ", 
        RowBox[{
         RowBox[{"\[FormalP]", "[", "a_", "]"}], " ", "\[RuleDelayed]", " ", 
         "a"}]}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{"list", ",", " ", 
        RowBox[{
         RowBox[{
          RowBox[{"a", "\[LeftDoubleBracket]", 
           RowBox[{"All", ",", " ", "3"}], "\[RightDoubleBracket]"}], " ", 
          "=", " ", 
          RowBox[{
           RowBox[{
            RowBox[{"If", "[", 
             RowBox[{
              RowBox[{"IntegerQ", "[", "#", "]"}], ",", " ", "1", ",", " ", 
              RowBox[{"Length", "@", "#"}]}], "]"}], "&"}], " ", "/@", " ", 
           RowBox[{"a", "\[LeftDoubleBracket]", 
            RowBox[{"All", ",", " ", "3"}], "\[RightDoubleBracket]"}]}]}], 
         ";"}]}], "]"}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"Table", "[", "\[IndentingNewLine]", 
       RowBox[{"(*", " ", 
        RowBox[{"wrap", " ", "args", " ", "in", " ", "Hold"}], " ", "*)"}], 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{
          RowBox[{"CreateSymbol", "[", 
           RowBox[{
            RowBox[{"Evaluate", "@", 
             RowBox[{
             "i", "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}]}], 
            ",", " ", "j", ",", " ", "Hold"}], "]"}], ",", " ", 
          RowBox[{"i", "\[LeftDoubleBracket]", "2", "\[RightDoubleBracket]"}],
           ",", " ", 
          RowBox[{
           RowBox[{
           "i", "\[LeftDoubleBracket]", "3", "\[RightDoubleBracket]"}], "+", 
           "j"}]}], "}"}], ",", " ", "\[IndentingNewLine]", 
        RowBox[{"{", 
         RowBox[{"i", ",", " ", "a"}], "}"}], ",", " ", 
        RowBox[{"{", 
         RowBox[{"j", ",", " ", "0", ",", " ", "n"}], "}"}]}], 
       "\[IndentingNewLine]", "]"}]}]}], "\[IndentingNewLine]", "]"}]}], 
  ";"}]}], "Input",
 InitializationCell->True,
 CellLabel->
  "In[22]:=",ExpressionUUID->"a8e7d36b-be75-452d-852f-ddcaacdf720b"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Compile Expressions of Pure Functions", \
"Section",ExpressionUUID->"3d54113b-9519-4a08-b31d-5f7e1a407f10"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"SetAttributes", "[", 
    RowBox[{"RBDCompileExpression", ",", " ", "HoldRest"}], "]"}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"RBDCompileExpression", "[", 
     RowBox[{"F_Association", ",", " ", 
      RowBox[{"n_:", "0"}], ",", " ", 
      RowBox[{"o", ":", 
       RowBox[{"OptionsPattern", "[", "Compile", "]"}]}]}], "]"}], " ", ":=", 
    " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"f", ",", " ", "v", ",", " ", "c"}], "}"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
       "add", " ", "relevant", " ", "variable", " ", "to", " ", "depth"}], 
       " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"v", " ", "=", " ", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"v_Symbol", ",", " ", "i_Integer"}], "}"}], " ", 
         "\[RuleDelayed]", " ", 
         RowBox[{"depth", "[", 
          RowBox[{"v", ",", " ", "i", ",", " ", "n"}], "]"}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"f", " ", "=", " ", 
        RowBox[{
         RowBox[{"Hold", "[", "\"\<O\>\"", "]"}], "/.", " ", "F"}]}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"f", " ", "=!=", " ", 
           RowBox[{"Hold", "[", "\"\<O\>\"", "]"}]}], " ", "&&", " ", 
          RowBox[{"f", " ", "=!=", " ", 
           RowBox[{"Hold", "[", 
            RowBox[{"{", "}"}], "]"}]}]}], ",", " ", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"ReleaseHold", "[", 
           RowBox[{
            RowBox[{"f", "\[LeftDoubleBracket]", 
             RowBox[{"All", ",", " ", "All", ",", " ", 
              RowBox[{"{", 
               RowBox[{"1", ",", " ", "3"}], "}"}]}], 
             "\[RightDoubleBracket]"}], " ", "/.", " ", "v"}], "]"}], ";"}]}],
         "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"(*", " ", 
        RowBox[{"compile", " ", "functions"}], " ", "*)"}], 
       "\[IndentingNewLine]", 
       RowBox[{"f", " ", "=", 
        RowBox[{
         RowBox[{"Hold", "[", "\"\<I\>\"", "]"}], " ", "/.", " ", "F"}]}], 
       ";", "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"f", " ", "=!=", " ", 
           RowBox[{"Hold", "[", "\"\<I\>\"", "]"}]}], " ", "&&", " ", 
          RowBox[{"f", " ", "=!=", " ", 
           RowBox[{"Hold", "@", 
            RowBox[{"{", "}"}]}]}]}], ",", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"f", " ", "=", 
           RowBox[{"Thread", "[", "f", "]"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"c", " ", "=", " ", "RBDCompileExpression"}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"v", " ", "=", " ", 
           RowBox[{
            RowBox[{"Hold", "[", 
             RowBox[{"{", 
              RowBox[{"x_", ",", " ", "y_"}], "}"}], "]"}], " ", 
            "\[RuleDelayed]", " ", 
            RowBox[{"c", "[", 
             RowBox[{
              RowBox[{"ToString", "@", 
               RowBox[{"Unevaluated", "@", "x"}]}], ",", " ", "x", ",", " ", 
              "y", ",", " ", "n", ",", " ", "o"}], "]"}]}]}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"Association", "[", 
           RowBox[{"f", " ", "/.", " ", "v"}], "]"}]}], ",", 
         "\[IndentingNewLine]", 
         RowBox[{"<|", "|>"}]}], "\[IndentingNewLine]", "]"}]}]}], 
     "\[IndentingNewLine]", "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"SetAttributes", "[", 
   RowBox[{"timer", ",", " ", "HoldFirst"}], "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"timlst", " ", "=", " ", 
   RowBox[{"{", "}"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"timer", "[", 
     RowBox[{"x_", ",", " ", "f_", ",", " ", "n_"}], "]"}], " ", ":=", " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"s", ",", " ", "t", ",", "r"}], "}"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{"PrependTo", "[", 
         RowBox[{"timlst", ",", " ", 
          RowBox[{
           RowBox[{"StringTemplate", "[", "\"\<`` in `` \>\"", "]"}], "[", 
           RowBox[{"n", ",", " ", "f"}], "]"}]}], "]"}], ";"}], "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"PrependTo", "[", 
        RowBox[{"timlst", ",", " ", 
         RowBox[{
          RowBox[{"ToString", "@", 
           RowBox[{"Unevaluated", "@", "n"}]}], " ", "<>", " ", 
          "\"\< in \>\"", " ", "<>", " ", 
          RowBox[{"ToString", "@", 
           RowBox[{"Unevaluated", "@", "f"}]}]}]}], "]"}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{
         RowBox[{"Print", "[", 
          RowBox[{"Row", "@", "timlst"}], "]"}], ";"}], "*)"}], 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"t", ",", " ", "r"}], "}"}], " ", "=", " ", 
        RowBox[{"AbsoluteTiming", "[", "x", "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"s", " ", "=", " ", 
        RowBox[{"First", "@", "timlst"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"timlst", " ", "=", " ", 
        RowBox[{"Rest", "@", "timlst"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"Print", "[", 
        RowBox[{"\"\<\\t\>\"", ",", " ", "s", ",", " ", 
         RowBox[{"\"\<took \>\"", " ", "<>", " ", 
          RowBox[{"ToString", "@", "t"}], " ", "<>", " ", 
          "\"\< seconds.\>\""}]}], "]"}], ";", "\[IndentingNewLine]", "r"}]}],
      "\[IndentingNewLine]", "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"RBDCompileExpression", "[", 
    RowBox[{"name_String", ",", " ", "expr_", ",", " ", "a_", ",", " ", 
     RowBox[{"n_:", "0"}], ",", " ", 
     RowBox[{"o", ":", 
      RowBox[{"OptionsPattern", "[", "Compile", "]"}]}]}], "]"}], " ", ":=", 
   " ", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"s", ",", " ", "v", ",", " ", "f"}], "}"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{"diff", " ", "name"}], " ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"s", " ", "=", " ", 
       RowBox[{
        RowBox[{
         RowBox[{"CreateSymbolString", "[", 
          RowBox[{"name", ",", " ", "#"}], "]"}], "&"}], " ", "/@", " ", 
        RowBox[{"Range", "[", 
         RowBox[{"0", ",", " ", "n"}], "]"}]}]}], ";", "\[IndentingNewLine]", 
      
      RowBox[{"(*", " ", 
       RowBox[{"get", " ", "Compile", " ", "arguments"}], " ", "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"v", " ", "=", " ", 
       RowBox[{"CompileArgs", "[", 
        RowBox[{"a", ",", " ", "n"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
       "replace", " ", "\"\<b\>\"", " ", "with", " ", "args", " ", "in", " ", 
        "a"}], " ", "*)"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"ReleaseHold", "[", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{
         RowBox[{"Hold", "@", 
          RowBox[{"Block", "[", 
           RowBox[{"\"\<b\>\"", ",", " ", "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{"SetAttributes", "[", 
              RowBox[{"\"\<b\>\"", ",", " ", "NHoldAll"}], "]"}], ";", 
             "\[IndentingNewLine]", 
             RowBox[{"(*", " ", 
              RowBox[{"differentiate", " ", "pure", " ", "function"}], " ", 
              "*)"}], "\[IndentingNewLine]", 
             RowBox[{"v", " ", "=", " ", 
              RowBox[{"Select", "[", 
               RowBox[{
                RowBox[{"a", "\[LeftDoubleBracket]", 
                 RowBox[{"All", ",", " ", 
                  RowBox[{"{", 
                   RowBox[{"1", ",", "3"}], "}"}]}], 
                 "\[RightDoubleBracket]"}], ",", " ", 
                RowBox[{
                 RowBox[{
                  RowBox[{"Times", "@@", 
                   RowBox[{
                   "#", "\[LeftDoubleBracket]", "2", 
                    "\[RightDoubleBracket]"}]}], " ", ">", " ", "0"}], 
                 "&"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
             RowBox[{"f", " ", "=", " ", 
              RowBox[{"If", "[", 
               RowBox[{
                RowBox[{
                 RowBox[{"TensorQ", "[", "expr", "]"}], " ", "||", " ", 
                 RowBox[{"NumericQ", "[", "expr", "]"}]}], ",", " ", 
                RowBox[{"(", 
                 RowBox[{"expr", "&"}], ")"}], ",", " ", 
                RowBox[{"(", 
                 RowBox[{
                  RowBox[{"expr", "[", "##", "]"}], "&"}], ")"}]}], "]"}]}], 
             ";", "\[IndentingNewLine]", 
             RowBox[{"f", " ", "=", " ", 
              RowBox[{"N", "@", 
               RowBox[{"First", "@", 
                RowBox[{"Df", "[", 
                 RowBox[{
                  RowBox[{"{", 
                   RowBox[{
                    RowBox[{"{", "f", "}"}], ",", " ", "v"}], "}"}], ",", 
                  " ", "\"\<ch\>\"", ",", " ", 
                  RowBox[{"D", " ", "\[Rule]", " ", "n"}]}], "]"}]}]}]}], ";",
              "\[IndentingNewLine]", 
             RowBox[{"f", "=", " ", 
              RowBox[{"DfToCompiledFunction", "[", 
               RowBox[{"f", ",", " ", 
                RowBox[{"a", "\[LeftDoubleBracket]", 
                 RowBox[{"All", ",", " ", 
                  RowBox[{"{", 
                   RowBox[{"1", ",", "3"}], "}"}]}], 
                 "\[RightDoubleBracket]"}], ",", " ", 
                RowBox[{"a", "\[LeftDoubleBracket]", 
                 RowBox[{"All", ",", " ", "2"}], "\[RightDoubleBracket]"}], 
                ",", " ", "o"}], "]"}]}], ";"}]}], "\[IndentingNewLine]", 
           "]"}]}], " ", "/.", " ", 
         RowBox[{"\"\<b\>\"", " ", "\[Rule]", " ", 
          RowBox[{"Flatten", "[", 
           RowBox[{"v", "\[LeftDoubleBracket]", 
            RowBox[{"All", ",", " ", "All", ",", " ", "1"}], 
            "\[RightDoubleBracket]"}], "]"}]}]}], " ", "/.", " ", 
        RowBox[{
         RowBox[{"Hold", "[", "x_Symbol", "]"}], " ", "\[RuleDelayed]", " ", 
         "x"}]}], "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
      RowBox[{"AssociationThread", "[", 
       RowBox[{"s", " ", "\[Rule]", " ", "f"}], "]"}]}]}], 
    "\[IndentingNewLine]", "]"}]}], ";"}]}], "Input",
 InitializationCell->True,
 CellLabel->
  "In[24]:=",ExpressionUUID->"31edee34-209f-48d8-8c6f-7d5a7f090bfa"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Compile Function Modules", \
"Section",ExpressionUUID->"0c24cb1d-bb29-454f-9ea3-074267fe3a8f"],

Cell["\<\
for no constraints create C as follows:
\t\[OpenCurlyDoubleQuote]C\[CloseCurlyDoubleQuote] -> \
{\[OpenCurlyDoubleQuote]left\[CloseCurlyDoubleQuote] -> None, \
\[OpenCurlyDoubleQuote]right\[CloseCurlyDoubleQuote] -> None}\
\>", "Text",ExpressionUUID->"fd4f07c2-f162-4758-a4b3-c51afea31a80"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"Options", "[", "RBDCompileFunction", "]"}], " ", "=", " ", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"\"\<S\>\"", " ", "\[Rule]", " ", "spatfun"}], ",", " ", 
      RowBox[{"\"\<C\>\"", " ", "\[Rule]", " ", "confun"}], ",", " ", 
      RowBox[{"\"\<D\>\"", " ", "\[Rule]", " ", "datrules"}], ",", " ", 
      RowBox[{"\"\<a\>\"", " ", "\[Rule]", " ", 
       RowBox[{"{", 
        RowBox[{"1", ",", "2"}], "}"}]}], ",", " ", 
      RowBox[{"\"\<e\>\"", " ", "\[Rule]", " ", 
       RowBox[{"{", "}"}]}], ",", " ", 
      RowBox[{"\"\<f\>\"", " ", "\[Rule]", " ", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"CompilationOptions", "\[Rule]", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"\"\<InlineCompiledFunctions\>\"", "\[Rule]", "True"}], 
            ",", " ", 
            RowBox[{"\"\<ExpressionOptimization\>\"", "\[Rule]", "True"}]}], 
           "}"}]}], ",", " ", 
         RowBox[{"CompilationTarget", " ", "\[Rule]", " ", "\"\<C\>\""}]}], 
        "}"}]}]}], "}"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"RBDCompileFunction", "[", 
    RowBox[{"F_List", ",", " ", "n_", ",", " ", 
     RowBox[{"opts", ":", 
      RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], " ", ":=", " ", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "f", ",", " ", "a", ",", " ", "d", ",", " ", "A", ",", " ", "S", ",", 
       " ", "C", ",", " ", "D", ",", " ", "slot", ",", " ", "part"}], "}"}], 
     ",", "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
       RowBox[{
        RowBox[{"don", "'"}], "t", " ", "use", " ", "variable", " ", "slot"}],
        ",", " ", 
       RowBox[{"must", " ", "be", " ", "kept", " ", "a", " ", "symbol"}]}], 
      " ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"S", " ", "=", " ", 
       RowBox[{"OptionValue", "[", "\"\<S\>\"", "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"C", " ", "=", " ", 
       RowBox[{"OptionValue", "[", "\"\<C\>\"", "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"D", " ", "=", " ", 
       RowBox[{"OptionValue", "[", "\"\<D\>\"", "]"}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
        RowBox[{
         RowBox[{
          RowBox[{"extract", " ", "fcns", " ", "in", " ", "S"}], " ", "&"}], 
         " ", "C", " ", "and", " ", "create", " ", "replacement", " ", 
         RowBox[{"rule", ":", " ", "f"}]}], " ", "\[RuleDelayed]", " ", 
        RowBox[{"f", "[", "x", "]"}]}], " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{"A", " ", "=", " ", 
       RowBox[{"Join", "@@", 
        RowBox[{"(", 
         RowBox[{
          RowBox[{
           RowBox[{"CreateInlinedFunctionHeaders", "[", 
            RowBox[{"#", ",", " ", "n"}], "]"}], "&"}], " ", "/@", " ", 
          RowBox[{"{", 
           RowBox[{"S", ",", " ", "C"}], "}"}]}], ")"}]}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
       "compile", " ", "functions", " ", "in", " ", "S", " ", "once", " ", 
        "and", " ", "create", " ", "rep", " ", 
        RowBox[{"rules", ":"}]}], " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{"S", " ", "=", " ", 
       RowBox[{"RulesForInlinedFunctions", "[", 
        RowBox[{"S", ",", " ", "n", ",", " ", 
         RowBox[{"OptionValue", "[", "\"\<e\>\"", "]"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"A", ",", " ", "S"}], "}"}], " ", "=", " ", 
       RowBox[{"Dispatch", " ", "/@", " ", 
        RowBox[{"{", 
         RowBox[{"A", ",", " ", "S"}], "}"}]}]}], ";", "\[IndentingNewLine]", 
      
      RowBox[{"Association", "@", 
       RowBox[{"Table", "[", "\[IndentingNewLine]", 
        RowBox[{"(*", " ", 
         RowBox[{"compile", " ", "constraints"}], " ", "*)"}], 
        "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{
          RowBox[{"f", "=", " ", 
           RowBox[{"Table", "[", "\[IndentingNewLine]", 
            RowBox[{"(*", " ", 
             RowBox[{
             "tie", " ", "arguments", " ", "of", " ", "f", " ", "to", " ", 
              "variables", " ", "in", " ", "\"\<v\>\"", " ", "and", " ", 
              "\"\<d\>\""}], " ", "*)"}], "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{
              RowBox[{"d", " ", "=", " ", 
               RowBox[{
                RowBox[{"JoinInputArguments", "[", 
                 RowBox[{"Fi", ",", " ", "n"}], "]"}], "\[LeftDoubleBracket]", 
                RowBox[{"All", ",", " ", "1"}], "\[RightDoubleBracket]"}]}], 
              ";", "\[IndentingNewLine]", 
              RowBox[{"f", " ", "=", " ", 
               RowBox[{
                RowBox[{
                 RowBox[{"Hold", "[", "\"\<f\>\"", "]"}], "@@", "d"}], "  ", "/.",
                 " ", "A"}]}], " ", ";", "\[IndentingNewLine]", 
              "\[IndentingNewLine]", 
              RowBox[{"(*", " ", 
               RowBox[{
                RowBox[{"replace", " ", "independent", " ", "args", " ", 
                 RowBox[{"w", "/", " ", 
                  RowBox[{"Slot", "[", "...", "]"}]}]}], ";", " ", 
                RowBox[{
                "slot", " ", "should", " ", "be", " ", "a", " ", "symbol", 
                 " ", "here"}]}], " ", "*)"}], "\[IndentingNewLine]", 
              RowBox[{"a", " ", "=", " ", 
               RowBox[{
                RowBox[{"Partition", "[", 
                 RowBox[{"d", ",", " ", 
                  RowBox[{"n", "+", "1"}]}], "]"}], "\[LeftDoubleBracket]", 
                RowBox[{"OptionValue", "[", "\"\<a\>\"", "]"}], 
                "\[RightDoubleBracket]"}]}], ";", "\[IndentingNewLine]", 
              RowBox[{"f", " ", "=", " ", 
               RowBox[{"InsertDevecedArguments", "[", 
                RowBox[{"f", ",", " ", "a"}], "]"}]}], ";", 
              "\[IndentingNewLine]", "\[IndentingNewLine]", 
              RowBox[{"(*", " ", 
               RowBox[{
               "add", " ", "family", " ", "of", " ", "S", " ", "fcns"}], " ", 
               "*)"}], "\[IndentingNewLine]", 
              RowBox[{"f", " ", "=", " ", 
               RowBox[{"f", " ", "/.", " ", "S"}]}], ";", 
              "\[IndentingNewLine]", "\[IndentingNewLine]", 
              RowBox[{"(*", " ", 
               RowBox[{
               "add", " ", "in", " ", "family", " ", "of", " ", "C", " ", 
                "fcns"}], " ", "*)"}], "\[IndentingNewLine]", 
              RowBox[{"RBDConstraintFunctions", "[", 
               RowBox[{"Fi", "[", 
                RowBox[{"\"\<C\>\"", ",", " ", "c"}], "]"}], "]"}], ";", 
              "\[IndentingNewLine]", 
              RowBox[{"d", " ", "=", " ", 
               RowBox[{"RulesForInlinedFunctions", "[", 
                RowBox[{"C", ",", " ", "n", ",", " ", 
                 RowBox[{"OptionValue", "[", "\"\<e\>\"", "]"}]}], "]"}]}], 
              ";", "\[IndentingNewLine]", 
              RowBox[{"f", " ", "=", " ", 
               RowBox[{
                RowBox[{"f", " ", "/.", " ", "d"}], " ", "/.", " ", 
                RowBox[{"Block", "[", 
                 RowBox[{
                  RowBox[{"{", 
                   RowBox[{"RuleDelayed", " ", "=", " ", "Rule"}], "}"}], ",",
                   " ", "D"}], "]"}]}]}], ";", "\[IndentingNewLine]", 
              "\[IndentingNewLine]", 
              RowBox[{"c", " ", "\[Rule]", " ", "f"}]}], ",", 
             "\[IndentingNewLine]", 
             RowBox[{"{", 
              RowBox[{"c", ",", " ", 
               RowBox[{"Keys", "@", 
                RowBox[{"Fi", "[", "\"\<C\>\"", "]"}]}]}], "}"}]}], 
            "\[IndentingNewLine]", "]"}]}], ";", "\[IndentingNewLine]", 
          "\[IndentingNewLine]", 
          RowBox[{"(*", " ", 
           RowBox[{"compile", " ", "function", " ", "in", " ", "F"}], " ", 
           "*)"}], "\[IndentingNewLine]", 
          RowBox[{"f", " ", "=", " ", 
           RowBox[{"f", " ", "/.", " ", 
            RowBox[{"\"\<f\>\"", " ", "\[Rule]", " ", 
             RowBox[{"CompileFunction", "[", 
              RowBox[{"Fi", ",", " ", "n", ",", " ", 
               RowBox[{"OptionValue", "[", "\"\<f\>\"", "]"}]}], "]"}]}]}]}], 
          ";", "\[IndentingNewLine]", 
          RowBox[{"f", " ", "=", " ", 
           RowBox[{"f", " ", "/.", " ", 
            RowBox[{
             RowBox[{"Hold", "[", "x_", "]"}], " ", "\[RuleDelayed]", " ", 
             "x"}]}]}], ";", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"Fi", "[", "\"\<name\>\"", "]"}], " ", "\[Rule]", " ", 
           RowBox[{"Association", "[", "f", "]"}]}]}], ",", 
         "\[IndentingNewLine]", 
         RowBox[{"{", 
          RowBox[{"Fi", ",", " ", "F"}], "}"}]}], "\[IndentingNewLine]", 
        "]"}]}]}]}], "\[IndentingNewLine]", "]"}]}], ";"}]}], "Input",
 InitializationCell->True,
 CellLabel->"In[30]:=",ExpressionUUID->"447fbcf5-bc18-4fb4-8d21-cc65c7f71170"],

Cell[CellGroupData[{

Cell["Helper functions", \
"Subsection",ExpressionUUID->"faec4d56-5fb4-4ac1-81fa-57c2dce0ca06"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"JoinInputArguments", "[", 
    RowBox[{"F_Association", ",", " ", "n_"}], "]"}], " ", ":=", " ", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", "d", "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
      "merge", " ", "\"\<v\>\"", " ", "and", " ", "\"\<d\>\"", " ", "without",
        " ", "evaluating", " ", "values", " ", "into", " ", "one", " ", 
       "argument", " ", "list"}], " ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"d", " ", "=", " ", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"Hold", "[", 
          RowBox[{"CompileArgs", "[", 
           RowBox[{"\"\<v\>\"", ",", " ", "n", ",", " ", "False"}], "]"}], 
          "]"}], ",", " ", 
         RowBox[{"Hold", "[", 
          RowBox[{"CompileArgs", "[", 
           RowBox[{"\"\<d\>\"", ",", " ", "0", ",", " ", "False"}], "]"}], 
          "]"}]}], "}"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"d", " ", "=", " ", 
       RowBox[{"d", " ", "/.", " ", "F"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
        RowBox[{"extract", " ", "symbolic", " ", "arg", " ", "only"}], ",", 
        " ", 
        RowBox[{"drop", " ", "type", " ", "and", " ", "depth"}]}], " ", 
       "*)"}], "\[IndentingNewLine]", 
      RowBox[{"Partition", "[", 
       RowBox[{
        RowBox[{"Flatten", "[", 
         RowBox[{"ReleaseHold", "[", "d", "]"}], "]"}], ",", " ", "3"}], 
       "]"}]}]}], "\[IndentingNewLine]", "]"}]}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"InsertDevecedArguments", "[", 
     RowBox[{"f_", ",", " ", "args_"}], "]"}], " ", ":=", " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"a", ",", " ", "p", ",", " ", "s"}], "}"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
        RowBox[{"replace", " ", "independent", " ", "args", " ", 
         RowBox[{"w", "/", " ", 
          RowBox[{
           RowBox[{"Slot", "[", "i", "]"}], "\[LeftDoubleBracket]", "j", 
           "\[RightDoubleBracket]"}]}]}], ",", " ", 
        RowBox[{"where", " ", "j", " ", "depends", " ", "on", " ", 
         RowBox[{"devec", "[", "..", "]"}]}]}], " ", "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"a", " ", "=", " ", 
        RowBox[{"MapIndexed", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"(", 
            RowBox[{"#1", " ", "\[Rule]", " ", 
             RowBox[{"p", "[", 
              RowBox[{
               RowBox[{"s", "[", 
                RowBox[{
                "#2", "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}], 
                "]"}], ",", " ", 
               RowBox[{
               "#2", "\[LeftDoubleBracket]", "2", "\[RightDoubleBracket]"}]}],
               "]"}]}], ")"}], "&"}], ",", " ", "args", ",", " ", 
          RowBox[{"{", "2", "}"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"a", " ", "=", " ", 
        RowBox[{
         RowBox[{"Flatten", "@", "a"}], " ", "/.", " ", 
         RowBox[{"{", 
          RowBox[{"Hold", " ", "\[Rule]", " ", "HoldPattern"}], "}"}]}]}], 
       ";", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{
         RowBox[{
          RowBox[{"With", "[", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"e", " ", "=", " ", "f"}], "}"}], ",", " ", 
            RowBox[{"e", "&"}]}], "]"}], " ", "/.", " ", "a"}], " ", "/.", 
         " ", 
         RowBox[{"s", " ", "\[Rule]", " ", "Slot"}]}], " ", "/.", " ", 
        RowBox[{"p", " ", "\[Rule]", " ", "Part"}]}]}]}], 
     "\[IndentingNewLine]", "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"RulesForInlinedFunctions", "[", 
     RowBox[{"S_", ",", " ", "n_", ",", " ", 
      RowBox[{"o", ":", 
       RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], " ", ":=", " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", "f", "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
       "create", " ", "replacement", " ", "rules", " ", "for", " ", 
        "arguments", " ", "of", " ", "f"}], " ", "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"f", " ", "=", " ", 
        RowBox[{
         RowBox[{
          RowBox[{"ToExpression", "[", 
           RowBox[{"#1", ",", " ", "InputForm", ",", " ", "HoldPattern"}], 
           "]"}], " ", "\[RuleDelayed]", " ", "#2"}], "&"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"(*", " ", 
        RowBox[{
        "compile", " ", "functions", " ", "in", " ", "A", " ", "and", " ", 
         "create", " ", "rep", " ", 
         RowBox[{"rules", ":"}]}], " ", "*)"}], "\[IndentingNewLine]", 
       RowBox[{"(*", " ", 
        RowBox[{
         RowBox[{"HoldPattern", "[", "f", "]"}], " ", "\[RuleDelayed]", " ", 
         "CompiledFunction"}], " ", "*)"}], "\[IndentingNewLine]", 
       RowBox[{"KeyValueMap", "[", 
        RowBox[{"f", ",", " ", 
         RowBox[{"RBDCompileExpression", "[", 
          RowBox[{"S", ",", " ", "n", ",", " ", "o"}], "]"}]}], "]"}]}]}], 
     "\[IndentingNewLine]", "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"CreateInlinedFunctionHeaders", "[", 
     RowBox[{"S_Association", ",", " ", "n_"}], "]"}], " ", ":=", " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"A", ",", " ", "a", ",", " ", "f"}], "}"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
        RowBox[{
        "extract", " ", "fcns", " ", "in", " ", "A", " ", "and", " ", 
         "create", " ", "replacement", " ", 
         RowBox[{"rule", ":", " ", "f"}]}], " ", "\[RuleDelayed]", " ", 
        RowBox[{"f", "[", "x", "]"}]}], " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"A", " ", "=", " ", 
        RowBox[{
         RowBox[{"Hold", "[", "\"\<I\>\"", "]"}], " ", "/.", " ", "S"}]}], 
       ";", "\[IndentingNewLine]", 
       RowBox[{"With", "[", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"e", " ", "=", " ", "A"}], "}"}], ",", 
         "\[IndentingNewLine]", 
         RowBox[{"BlockExpression", "[", 
          RowBox[{
           RowBox[{"{", "}"}], ",", "\[IndentingNewLine]", 
           RowBox[{"(*", " ", 
            RowBox[{
             RowBox[{"create", " ", "0"}], "-", 
             RowBox[{"th", " ", "order", " ", "function", " ", "call"}]}], 
            " ", "*)"}], "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"a", " ", "=", " ", 
             RowBox[{
              RowBox[{
               RowBox[{"{", 
                RowBox[{
                 RowBox[{
                 "#", "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}], 
                 ",", " ", 
                 RowBox[{
                  RowBox[{
                  "#", "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}],
                   "@@", 
                  RowBox[{"(", 
                   RowBox[{"#", "\[LeftDoubleBracket]", 
                    RowBox[{"2", ",", " ", "All", ",", " ", "1"}], 
                    "\[RightDoubleBracket]"}], ")"}]}]}], "}"}], "&"}], " ", "/@",
               " ", 
              RowBox[{"Join", "@", 
               RowBox[{"ReleaseHold", "[", "e", "]"}]}]}]}], ";", 
            "\[IndentingNewLine]", 
            RowBox[{"(*", " ", 
             RowBox[{
              RowBox[{"expand", " ", "up", " ", "to", " ", "n"}], "-", 
              RowBox[{"th", " ", "order", " ", "function", " ", "call"}]}], 
             " ", "*)"}], "\[IndentingNewLine]", 
            RowBox[{"f", " ", "=", " ", 
             RowBox[{
              RowBox[{"Table", "[", 
               RowBox[{
                RowBox[{"CreateSymbol", "[", 
                 RowBox[{
                  RowBox[{"\[FormalP]", "[", "#", "]"}], ",", " ", "i", ",", 
                  " ", "Hold"}], "]"}], ",", " ", 
                RowBox[{"{", 
                 RowBox[{"i", ",", " ", "0", ",", " ", "n"}], "}"}]}], "]"}], 
              "&"}]}], ";", "\[IndentingNewLine]", 
            RowBox[{"a", " ", "=", " ", 
             RowBox[{"Map", "[", 
              RowBox[{"f", ",", " ", "a", ",", " ", 
               RowBox[{"{", "2", "}"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
            RowBox[{"(*", " ", 
             RowBox[{
              RowBox[{"create", " ", 
               RowBox[{"HoldPattern", "[", "f", "]"}]}], " ", 
              "\[RuleDelayed]", " ", 
              RowBox[{"f", "[", 
               RowBox[{"x", ",", " ", "..."}], "]"}]}], " ", "*)"}], 
            "\[IndentingNewLine]", 
            RowBox[{"a", " ", "=", " ", 
             RowBox[{"MapThread", "[", 
              RowBox[{
               RowBox[{
                RowBox[{
                 RowBox[{"HoldPattern", "[", "#1", "]"}], " ", 
                 "\[RuleDelayed]", " ", "#2"}], "&"}], ",", " ", 
               RowBox[{"a", "\[Transpose]"}], ",", " ", "2"}], "]"}]}], ";", 
            "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{"Flatten", "@", "a"}], " ", "/.", " ", 
             RowBox[{
              RowBox[{"Hold", "[", "x_", "]"}], " ", "\[RuleDelayed]", " ", 
              "x"}]}]}], ",", " ", "\[IndentingNewLine]", 
           RowBox[{"{", 
            RowBox[{
            "CreateSymbol", ",", " ", "a", ",", " ", "Hold", ",", " ", 
             "Join"}], "}"}]}], "\[IndentingNewLine]", "]"}]}], 
        "\[IndentingNewLine]", "]"}]}]}], "\[IndentingNewLine]", "]"}]}], 
   ";"}], "\[IndentingNewLine]"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"CompileFunction", "[", 
    RowBox[{"F_Association", ",", " ", "n_", ",", " ", 
     RowBox[{"opts", ":", 
      RowBox[{"OptionsPattern", "[", "Compile", "]"}]}]}], "]"}], " ", ":=", 
   " ", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "f", ",", " ", "i", ",", " ", "d", ",", " ", "C", ",", " ", "I"}], 
      "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
       RowBox[{
        RowBox[{"compile", " ", "inline", " ", "expressions"}], ";", " ", 
        RowBox[{"override", " ", "inline", " ", "with", " ", 
         RowBox[{"F", "'"}], "s"}]}], ",", " ", 
       RowBox[{"if", " ", "key", " ", "collision"}]}], " ", "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"I", " ", "=", " ", 
       RowBox[{"RBDCompileExpression", "[", 
        RowBox[{
         RowBox[{"F", "\[LeftDoubleBracket]", 
          RowBox[{"{", 
           RowBox[{"\"\<I\>\"", ",", " ", "\"\<O\>\""}], "}"}], 
          "\[RightDoubleBracket]"}], ",", " ", "n"}], "]"}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"f", " ", "=", " ", 
       RowBox[{
        RowBox[{"ToExpression", "[", 
         RowBox[{
         "\"\<HoldPattern[\>\"", " ", "<>", " ", "#", " ", "<>", " ", 
          "\"\<]\>\""}], "]"}], "&"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"I", " ", "=", " ", 
       RowBox[{"KeyMap", "[", 
        RowBox[{"f", ",", " ", "I"}], "]"}]}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
       "add", " ", "\"\<v\>\"", " ", "and", " ", "\"\<d\>\"", " ", "to", " ", 
        
        RowBox[{"depth", "[", "...", "]"}]}], " ", "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"f", " ", "=", " ", 
       RowBox[{
        RowBox[{"Hold", "[", "\"\<v\>\"", "]"}], "/.", " ", "F"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"f", " ", "=!=", " ", 
          RowBox[{"Hold", "[", "\"\<v\>\"", "]"}]}], " ", "&&", " ", 
         RowBox[{"f", " ", "=!=", " ", 
          RowBox[{"Hold", "[", 
           RowBox[{"{", "}"}], "]"}]}]}], ",", " ", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"ReleaseHold", "[", 
          RowBox[{
           RowBox[{"f", "\[LeftDoubleBracket]", 
            RowBox[{"All", ",", " ", "All", ",", " ", 
             RowBox[{"{", 
              RowBox[{"1", ",", " ", "3"}], "}"}]}], 
            "\[RightDoubleBracket]"}], " ", "/.", " ", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"v_Symbol", ",", " ", "i_Integer"}], "}"}], " ", 
            "\[RuleDelayed]", " ", 
            RowBox[{"depth", "[", 
             RowBox[{"v", ",", " ", "i", ",", " ", "n"}], "]"}]}]}], "]"}], 
         ";"}]}], "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"f", " ", "=", " ", 
       RowBox[{
        RowBox[{"Hold", "[", "\"\<d\>\"", "]"}], "/.", " ", "F"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"f", " ", "=!=", " ", 
          RowBox[{"Hold", "[", "\"\<d\>\"", "]"}]}], " ", "&&", " ", 
         RowBox[{"f", " ", "=!=", " ", 
          RowBox[{"Hold", "[", 
           RowBox[{"{", "}"}], "]"}]}]}], ",", " ", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"ReleaseHold", "[", 
          RowBox[{
           RowBox[{"f", "\[LeftDoubleBracket]", 
            RowBox[{"All", ",", " ", "All", ",", " ", 
             RowBox[{"{", 
              RowBox[{"1", ",", " ", "3"}], "}"}]}], 
            "\[RightDoubleBracket]"}], " ", "/.", " ", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"v_Symbol", ",", " ", "i_Integer"}], "}"}], " ", 
            "\[RuleDelayed]", " ", 
            RowBox[{"depth", "[", 
             RowBox[{"v", ",", " ", "i", ",", " ", "0"}], "]"}]}]}], "]"}], 
         ";"}]}], "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{"create", " ", "function", " ", "to", " ", "compile"}], " ", 
       "*)"}], "\[IndentingNewLine]", 
      RowBox[{"f", " ", "=", " ", 
       RowBox[{"ReleaseHold", "[", 
        RowBox[{
         RowBox[{"Hold", "@", 
          RowBox[{"MergeFunctions", "[", 
           RowBox[{"\"\<f\>\"", ",", " ", 
            RowBox[{"C", "[", "]"}], ",", " ", "\"\<lcls\>\"", ",", " ", 
            "n"}], "]"}]}], " ", "/.", " ", "F"}], "]"}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
       "take", " ", "out", " ", "index", " ", "variables", " ", "that", " ", 
        RowBox[{"aren", "'"}], "t", " ", "directly", " ", "given", " ", "a", 
        " ", "value"}], " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{"i", " ", "=", " ", 
       RowBox[{"Cases", "[", 
        RowBox[{"f", ",", " ", 
         RowBox[{
          RowBox[{"HoldPattern", "[", 
           RowBox[{
            RowBox[{"(", 
             RowBox[{"Do", "|", "Table"}], ")"}], "[", 
            RowBox[{"_", ",", " ", "x__"}], "]"}], "]"}], " ", 
          "\[RuleDelayed]", " ", 
          RowBox[{"Hold", "[", "x", "]"}]}], ",", " ", "Infinity"}], "]"}]}], 
      ";", "\[IndentingNewLine]", 
      RowBox[{"d", " ", "=", " ", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"i_", ",", " ", "x_", ",", " ", "___"}], "}"}], " ", 
        "\[RuleDelayed]", " ", 
        RowBox[{"Hold", "@", 
         RowBox[{"SetDelayed", "[", 
          RowBox[{
           RowBox[{"depth", "[", "i", "]"}], ",", " ", 
           RowBox[{
            RowBox[{"depth", "[", "x", "]"}], "-", 
            RowBox[{"If", "[", 
             RowBox[{
              RowBox[{
               RowBox[{"Total", "[", 
                RowBox[{"depth", "[", "x", "]"}], "]"}], " ", "\[Equal]", " ",
                "0"}], ",", " ", "0", ",", " ", 
              RowBox[{"{", 
               RowBox[{
                RowBox[{"-", "1"}], ",", " ", "0"}], "}"}]}], "]"}]}]}], 
          "]"}]}]}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"ReleaseHold", "@", 
       RowBox[{"Cases", "[", 
        RowBox[{"i", ",", " ", "d", ",", " ", "Infinity"}], "]"}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
        RowBox[{"do", " ", "some", " ", "post"}], "-", 
        RowBox[{
        "procesing", " ", "clean", " ", "up", " ", "on", " ", 
         "differentiated", " ", "function"}]}], " ", "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"f", " ", "=", " ", 
       RowBox[{"FixLinearSolve", "@", 
        RowBox[{"FixDotProducts", "@", 
         RowBox[{"FixFunctions", "[", "f", "]"}]}]}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
       "merge", " ", "\"\<v\>\"", " ", "and", " ", "\"\<d\>\"", " ", 
        "without", " ", "evaluating", " ", "values", " ", "into", " ", "one", 
        " ", "argument", " ", "list"}], " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{"d", " ", "=", " ", 
       RowBox[{
        RowBox[{"\"\<v\>\"", " ", "\[RuleDelayed]", " ", 
         RowBox[{"Evaluate", "@", 
          RowBox[{"JoinInputArguments", "[", 
           RowBox[{"F", ",", " ", "n"}], "]"}]}]}], " ", "/.", " ", 
        RowBox[{
         RowBox[{"Hold", "[", "x_", "]"}], " ", "\[RuleDelayed]", " ", 
         "x"}]}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{"create", " ", "Compile"}], " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{"f", " ", "=", " ", 
       RowBox[{
        RowBox[{
         RowBox[{
          RowBox[{"Hold", "[", 
           RowBox[{"Compile", "[", 
            RowBox[{"\"\<v\>\"", ",", " ", 
             RowBox[{"C", "[", "]"}], ",", " ", "opts"}], "]"}], "]"}], " ", "/.",
           " ", "d"}], " ", "/.", " ", 
         RowBox[{"C", " ", "\[Rule]", " ", 
          RowBox[{"CreateSymbol", "[", 
           RowBox[{"C", ",", " ", "n"}], "]"}]}]}], " ", "/.", " ", "f"}]}], 
      ";", "\[IndentingNewLine]", 
      RowBox[{"f", " ", "=", " ", 
       RowBox[{"f", " ", "/.", " ", 
        RowBox[{"Normal", "@", "I"}]}]}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{"compile", " ", "function"}], " ", "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"ReleaseHold", "[", "f", "]"}]}]}], "\[IndentingNewLine]", 
    "]"}]}], ";"}]}], "Input",
 InitializationCell->True,
 CellLabel->
  "In[32]:=",ExpressionUUID->"97b526a4-8397-44ee-bca3-74207cdf82ad"]
}, Open  ]]
}, Open  ]],

Cell[CellGroupData[{

Cell["End Package", \
"Section",ExpressionUUID->"1d964aff-3d18-4ba8-81cc-221ea29e2078"],

Cell[BoxData[{
 RowBox[{"End", "[", "]"}], "\[IndentingNewLine]", 
 RowBox[{"EndPackage", "[", "]"}]}], "Input",
 InitializationCell->True,
 CellLabel->
  "In[37]:=",ExpressionUUID->"a100829e-e148-4b7b-ad64-278794228295"]
}, Open  ]]
},
AutoGeneratedPackage->Automatic,
Evaluator->"Local",
WindowSize->{1247, 1385},
WindowMargins->{{67, Automatic}, {0, Automatic}},
PrivateNotebookOptions->{"FileOutlineCache"->False},
CellContext->"Global`",
TrackCellChangeTimes->False,
FrontEndVersion->"11.3 for Linux x86 (64-bit) (March 6, 2018)",
StyleDefinitions->"Default.nb"
]

