Notebook[{
Cell[BoxData[
 RowBox[{"(*", "\n", 
  RowBox[{
   RowBox[{"RigidBodySystem", ".", 
    RowBox[{"nb", ":", " ", 
     RowBox[{"High", "-", 
      RowBox[{
      "level", " ", "functions", " ", "used", " ", "to", " ", "define", " ", 
       "a", " ", "rigid", " ", 
       RowBox[{"body", ".", "\n", "Copyright"}], " ", 
       RowBox[{"(", "C", ")"}], " ", "2014", " ", "Nelson", " ", "Rosa", " ", 
       
       RowBox[{"Jr", ".", "\n", "\n", "This"}], " ", "program", " ", "is", 
       " ", "free", " ", "software"}]}], ":", " ", 
     RowBox[{"you", " ", "can", " ", "redistribute", " ", "it", " ", 
      RowBox[{"and", "/", "or"}], " ", "modify", "\n", "it", " ", "under", 
      " ", "the", " ", "terms", " ", "of", " ", "the", " ", "GNU", " ", 
      "General", " ", "Public", " ", "License", " ", "as", " ", "published", 
      " ", "by", "\n", 
      RowBox[{"the", " ", "Free", " ", "Software", " ", "Foundation"}]}]}]}], 
   ",", " ", 
   RowBox[{
   "either", " ", "version", " ", "3", " ", "of", " ", "the", " ", 
    "License"}], ",", " ", 
   RowBox[{"or", "\n", 
    RowBox[{"(", 
     RowBox[{"at", " ", "your", " ", "option"}], ")"}], " ", "any", " ", 
    "later", " ", 
    RowBox[{"version", ".", " ", "This"}], " ", "program", " ", "is", " ", 
    "distributed", " ", "in", " ", "the", " ", "\n", "hope", " ", "that", " ",
     "it", " ", "will", " ", "be", " ", "useful"}], ",", " ", 
   RowBox[{
    RowBox[{"but", " ", "WITHOUT", " ", "ANY", " ", "WARRANTY"}], ";", " ", 
    RowBox[{
    "without", " ", "even", " ", "the", " ", "\n", "implied", " ", "warranty",
      " ", "of", " ", "MERCHANTABILITY", " ", "or", " ", "FITNESS", " ", 
     "FOR", " ", "A", " ", "PARTICULAR", " ", 
     RowBox[{"PURPOSE", ".", "\n", "See"}], " ", "the", " ", "GNU", " ", 
     "General", " ", "Public", " ", "License", " ", "for", " ", "more", " ", 
     RowBox[{"details", ".", " ", "You"}], " ", "should", " ", "have", " ", 
     "\n", "received", " ", "a", " ", "copy", " ", "of", " ", "the", " ", 
     "GNU", " ", "General", " ", "Public", " ", "License", " ", "along", " ", 
     "with", " ", "this", " ", 
     RowBox[{"program", ".", "\n", "If"}], " ", "not"}]}], ",", " ", 
   RowBox[{
    RowBox[{"see", " ", "<", 
     RowBox[{"http", ":"}]}], "//", 
    RowBox[{
     RowBox[{
      RowBox[{
       RowBox[{"www", ".", "gnu", ".", "org"}], "/", "licenses"}], "/"}], ">",
      "."}]}]}], "\n", "*)"}]], "Code",
 InitializationCell->
  True,ExpressionUUID->"65f9c771-df43-425b-a1fe-b2a9a25ea22e"],

Cell[CellGroupData[{

Cell["TODO", "Section",ExpressionUUID->"15249854-6eab-479c-8879-6080f9c5e9a2"],

Cell["\<\
place all variables in expand constraint into \[DoubleStruckX] vars...maybe \
can\[CloseCurlyQuote]t reverse operation\
\>", "Text",ExpressionUUID->"5ff51d30-114a-407a-835d-58d90a7c28af"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Notes", \
"Section",ExpressionUUID->"e00fced7-32d1-4f3e-822f-0bb741fe8e90"],

Cell[BoxData[
 RowBox[{"(*", " ", 
  RowBox[{
   RowBox[{"cons", ":", " ", "q"}], ",", " ", "v", ",", " ", "a", ",", " ", 
   RowBox[{"b", ";", " ", 
    RowBox[{"types", ":", " ", "p"}]}], ",", " ", "v", ",", " ", "u"}], " ", 
  "*)"}]], "Input",ExpressionUUID->"0a2ee722-6a49-43a0-913c-6e9fe7ced324"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", " ", 
   RowBox[{"constraints", " ", "are", " ", "of", " ", "the", " ", "form", " ", 
    RowBox[{
     RowBox[{"r", "[", 
      RowBox[{"o", ",", " ", "o"}], "]"}], ".", 
     RowBox[{"R", "[", 
      RowBox[{"o", ",", " ", "c"}], "]"}], ".", 
     RowBox[{"X", "[", 
      RowBox[{"c", ",", " ", "b"}], "]"}], ".", 
     RowBox[{"X", "[", 
      RowBox[{"b", ",", " ", "j"}], "]"}], ".", 
     RowBox[{"s", "[", 
      RowBox[{"j", ",", " ", "j"}], "]"}]}]}], " ", "*)"}], 
  "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{
   "where", " ", "o", " ", "is", " ", "the", " ", "frame", " ", "the", " ", 
    "constraint", " ", "is", " ", "taken", " ", "from"}], " ", "*)"}], 
  "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{
    RowBox[{"c", " ", "is", " ", "a", " ", 
     RowBox[{"frame", "/", "point"}], " ", "on", " ", "b"}], ",", " ", 
    RowBox[{
    "where", " ", "the", " ", "constraint", " ", "is", " ", "being", " ", 
     "applied"}]}], " ", "*)"}], "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{
    RowBox[{
    "j", " ", "are", " ", "joints", " ", "that", " ", "are", " ", "part", " ",
      "of", " ", "the", " ", "constraint"}], ",", " ", 
    RowBox[{"the", " ", "ancestors", " ", "of", " ", 
     RowBox[{"b", "."}]}]}], " ", "*)"}], "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{
    RowBox[{
    "we", " ", "break", " ", "it", " ", "down", " ", "further", " ", "with", 
     " ", 
     RowBox[{"R", "[", 
      RowBox[{"o", ",", " ", "c"}], "]"}]}], " ", "=", " ", 
    RowBox[{
     RowBox[{
      RowBox[{"R", "[", 
       RowBox[{"o", ",", " ", "b"}], "]"}], ".", 
      RowBox[{"R", "[", 
       RowBox[{"b", ",", " ", "c"}], "]"}]}], " ", "and"}]}], " ", "*)"}], 
  "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{
    RowBox[{
     RowBox[{"X", "[", 
      RowBox[{"b", ",", " ", "j"}], "]"}], " ", "=", " ", 
     RowBox[{
      RowBox[{"X", "[", 
       RowBox[{"b", ",", " ", "0"}], "]"}], ".", 
      RowBox[{"X", "[", 
       RowBox[{"0", ",", " ", "j"}], "]"}]}]}], ",", " ", 
    RowBox[{
     RowBox[{"where", " ", "0"}], " ", "=", " ", "Root"}], ",", " ", 
    RowBox[{
     RowBox[{"i", ".", "e", ".", " ", "the"}], " ", "inertial", " ", 
     "world"}]}], " ", "*)"}], "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{
    RowBox[{"frame", ".", "  ", "This"}], " ", "simplifies", " ", 
    "constraints", " ", "down", " ", "to"}], " ", "*)"}], 
  "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{
    RowBox[{
     RowBox[{"r", "[", 
      RowBox[{"o", ",", " ", "o"}], "]"}], ".", 
     RowBox[{"R", "[", 
      RowBox[{"o", ",", " ", "b"}], "]"}], ".", 
     RowBox[{"T", "[", 
      RowBox[{"c", ",", " ", "b"}], "]"}], ".", 
     RowBox[{"X", "[", 
      RowBox[{"b", ",", " ", "j"}], "]"}], ".", 
     RowBox[{"s", "[", 
      RowBox[{"j", ",", " ", "j"}], "]"}]}], ",", " ", 
    RowBox[{"where", " ", 
     RowBox[{"T", "[", 
      RowBox[{"c", ",", " ", "b"}], "]"}], " ", "is", " ", "a"}]}], " ", 
   "*)"}], "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{
   "translation", " ", "to", " ", "the", " ", "point", " ", "c", " ", "in", 
    " ", 
    RowBox[{"b", "'"}], "s", " ", "frame", " ", "from", " ", 
    RowBox[{"b", "'"}], "s", " ", 
    RowBox[{"origin", "."}]}], " ", "*)"}], "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{
   "this", " ", "also", " ", "has", " ", "the", " ", "benefit", " ", "that", 
    " ", "computing", " ", 
    RowBox[{"d", "/", "dt"}], " ", "X", " ", "is", " ", "simpler", " ", 
    "as"}], " ", "*)"}], "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{
    RowBox[{
     RowBox[{
      RowBox[{"d", "/", "dt"}], " ", 
      RowBox[{"X", "[", 
       RowBox[{"o", ",", " ", "0"}], "]"}]}], " ", "=", " ", 
     RowBox[{
      RowBox[{
       RowBox[{"(", 
        RowBox[{
         RowBox[{"v", "[", 
          RowBox[{"o", ",", " ", "0"}], "]"}], " ", "-", " ", 
         RowBox[{"v", "[", 
          RowBox[{"o", ",", " ", "o"}], "]"}]}], ")"}], " ", "x", " ", 
       RowBox[{"X", "[", 
        RowBox[{"o", ",", " ", "0"}], "]"}]}], " ", "=", " ", 
      RowBox[{
       RowBox[{"-", 
        RowBox[{"v", "[", 
         RowBox[{"o", ",", " ", "o"}], "]"}]}], " ", "x", " ", 
       RowBox[{"X", "[", 
        RowBox[{"o", ",", " ", "0"}], "]"}]}]}]}], ","}], " ", "*)"}], 
  "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{
    RowBox[{"where", " ", 
     RowBox[{"v", "[", 
      RowBox[{"o", ",", " ", "o"}], "]"}], " ", "is", " ", "the", " ", 
     "spatial", " ", "velocity", " ", "of", " ", "o", " ", "in", " ", 
     RowBox[{"o", "'"}], "s", " ", "frame"}], ";"}], " ", "*)"}], " ", 
  RowBox[{"(*", " ", 
   RowBox[{
   "we", " ", "can", " ", "get", " ", "v", " ", "from", " ", "a", " ", 
    "prior", " ", "call", " ", "to", " ", "the", " ", "RNEA", " ", 
    RowBox[{"function", "."}]}], " ", 
   "*)"}]}]], "Input",ExpressionUUID->"e51befbb-5c2d-43e2-b7b3-749182c89b7b"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Begin Package", \
"Section",ExpressionUUID->"7516a8a1-d217-4d6c-82b3-acb35d3ebe89"],

Cell[BoxData[{
 RowBox[{"BeginPackage", "[", 
  RowBox[{
  "\"\<RigidBodyDynamics`\>\"", ",", " ", "\"\<GlobalVariables`\>\""}], 
  "]"}], "\[IndentingNewLine]", 
 RowBox[{"Begin", "[", "\"\<`Private`\>\"", "]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"con", " ", "=", " ", 
   RowBox[{"{", "}"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"\[Epsilon]", " ", "=", " ", "1"}], ";"}]}], "Input",
 InitializationCell->
  True,ExpressionUUID->"cb256213-bcb2-42c0-8d1d-2892cc110a24"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Settling Time in Constraint Stabilization Feedback Law", \
"Section",ExpressionUUID->"fd6c1ce6-3826-4153-a408-a56cbec4fe15"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"RBDSetEpsilon", "[", 
    RowBox[{"e_:", "1"}], "]"}], " ", ":=", " ", 
   RowBox[{"(", 
    RowBox[{"\[Epsilon]", " ", "=", " ", "e"}], ")"}]}], ";"}]], "Input",
 InitializationCell->
  True,ExpressionUUID->"fec6873b-213d-4c16-ab48-67178ee0ed99"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Get List of Constraints Added", \
"Section",ExpressionUUID->"18199f87-8139-4d53-83a3-9d0dfc8fa73d"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"RBDListConstraints", "[", 
    RowBox[{"form_:", 
     RowBox[{"{", "___", "}"}]}], "]"}], " ", ":=", " ", 
   RowBox[{"Cases", "[", 
    RowBox[{"con", ",", " ", "form"}], "]"}]}], ";"}]], "Input",
 InitializationCell->
  True,ExpressionUUID->"628765c1-0832-4806-b028-99598cfa0c84"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Remove Constraints", \
"Section",ExpressionUUID->"bf121257-7a2f-44ef-a345-ac879a9cee30"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"RBDRemoveConstraint", "[", 
    RowBox[{"form_:", 
     RowBox[{"{", "___", "}"}]}], "]"}], " ", ":=", " ", 
   RowBox[{"(", 
    RowBox[{"con", " ", "=", " ", 
     RowBox[{"DeleteCases", "[", 
      RowBox[{"con", ",", " ", "form"}], "]"}]}], ")"}]}], ";"}]], "Input",
 InitializationCell->
  True,ExpressionUUID->"a5288890-7b4b-42b5-ba73-8b61bdb141ee"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Add List of Constraints", \
"Section",ExpressionUUID->"ad2ece75-3425-47d1-94ab-d74eb25ec293"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"RBDAddConstraints", "[", "c_", "]"}], " ", ":=", " ", 
   RowBox[{"con", " ", "=", " ", "c"}]}], ";"}]], "Input",
 InitializationCell->
  True,ExpressionUUID->"d7677ec8-1c86-47f3-98fc-cfd33f781e7a"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Add Physical Constraints", \
"Section",ExpressionUUID->"20630fbd-3de5-498e-a036-e5ee492ef2d1"],

Cell[BoxData[
 RowBox[{
  RowBox[{"Options", "[", "RBDConQ", "]"}], " ", "=", " ", 
  RowBox[{"{", 
   RowBox[{
    RowBox[{"\"\<n\>\"", " ", "\[Rule]", " ", "Automatic"}], ",", " ", 
    RowBox[{"\"\<\[Phi]\>\"", " ", "\[Rule]", " ", "True"}], ",", " ", 
    RowBox[{"Expand", " ", "\[Rule]", " ", "True"}], ",", " ", 
    RowBox[{"\"\<Kp\>\"", " ", "\[Rule]", " ", "1"}], ",", " ", 
    RowBox[{"\"\<Kv\>\"", " ", "\[Rule]", " ", "1"}]}], "}"}]}]], "Input",
 InitializationCell->
  True,ExpressionUUID->"efdaeb4b-2724-488c-b3ef-2f94d60035f1"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"addcon", "[", 
    RowBox[{"c_", ",", " ", "n_", ",", " ", "e_", ",", " ", "t_", ",", " ", 
     RowBox[{"OptionsPattern", "[", "RBDConQ", "]"}]}], "]"}], ":=", " ", 
   RowBox[{"AppendTo", "[", 
    RowBox[{"con", ",", " ", 
     RowBox[{"{", 
      RowBox[{"c", ",", " ", "n", ",", " ", "e", ",", " ", "t", ",", " ", 
       RowBox[{"OptionValue", "[", "\"\<\[Phi]\>\"", "]"}], ",", " ", 
       RowBox[{"OptionValue", "[", "\"\<Kp\>\"", "]"}], ",", " ", 
       RowBox[{"OptionValue", "[", "\"\<Kv\>\"", "]"}], ",", " ", 
       RowBox[{"OptionValue", "[", "Expand", "]"}], ",", " ", 
       RowBox[{"OptionValue", "[", "\"\<n\>\"", "]"}]}], "}"}]}], "]"}]}], 
  ";"}]], "Input",
 InitializationCell->
  True,ExpressionUUID->"468c07ce-4e6e-46b7-a7e8-77e7bd41f016"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"SetAttributes", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"RBDConQ", ",", " ", "RBDConV", ",", " ", "RBDConA"}], "}"}], 
     ",", " ", "Listable"}], "]"}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"RBDConQ", "[", 
     RowBox[{"name_", ",", " ", "expr_", ",", " ", 
      RowBox[{"opts", ":", 
       RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], " ", ":=", " ", 
    RowBox[{"addcon", "[", 
     RowBox[{
     "\"\<q\>\"", ",", " ", "name", ",", " ", "expr", ",", " ", "\"\<p\>\"", 
      ",", " ", "opts"}], "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"RBDConV", "[", 
     RowBox[{"name_", ",", " ", "expr_", ",", " ", 
      RowBox[{"opts", ":", 
       RowBox[{"OptionsPattern", "[", "RBDConQ", "]"}]}]}], "]"}], " ", ":=", 
    " ", 
    RowBox[{"addcon", "[", 
     RowBox[{
     "\"\<v\>\"", ",", " ", "name", ",", " ", "expr", ",", " ", "\"\<p\>\"", 
      ",", " ", 
      RowBox[{"\"\<Kp\>\"", " ", "\[Rule]", " ", "0"}], ",", " ", "opts"}], 
     "]"}]}], ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"RBDConA", "[", 
    RowBox[{"name_", ",", " ", "expr_", ",", " ", 
     RowBox[{"opts", ":", 
      RowBox[{"OptionsPattern", "[", "RBDConQ", "]"}]}]}], "]"}], " ", ":=", 
   " ", 
   RowBox[{"addcon", "[", 
    RowBox[{
    "\"\<a\>\"", ",", " ", "name", ",", " ", "expr", ",", " ", "\"\<p\>\"", 
     ",", " ", 
     RowBox[{"\"\<Kp\>\"", " ", "\[Rule]", " ", "0"}], ",", " ", 
     RowBox[{"\"\<Kv\>\"", " ", "\[Rule]", " ", "0"}], ",", " ", "opts"}], 
    "]"}]}], ";"}]}], "Input",
 InitializationCell->
  True,ExpressionUUID->"8dc79c9a-5863-496f-b703-a41dbfb43609"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Add Virtual Constraints", \
"Section",ExpressionUUID->"8d08de62-5bc5-4bca-a42a-4133ad164b73"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"SetAttributes", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"RBDVirtQ", ",", " ", "RBDVirtV", ",", " ", "RBDVirtA"}], "}"}],
      ",", " ", "Listable"}], "]"}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"RBDVirtQ", "[", 
     RowBox[{"name_", ",", " ", "expr_", ",", " ", 
      RowBox[{"opts", ":", 
       RowBox[{"OptionsPattern", "[", "RBDConQ", "]"}]}]}], "]"}], " ", ":=", 
    " ", 
    RowBox[{"addcon", "[", 
     RowBox[{
     "\"\<q\>\"", ",", " ", "name", ",", " ", "expr", ",", " ", "\"\<v\>\"", 
      ",", " ", "opts"}], "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"RBDVirtV", "[", 
     RowBox[{"name_", ",", " ", "expr_", ",", " ", 
      RowBox[{"opts", ":", 
       RowBox[{"OptionsPattern", "[", "RBDConQ", "]"}]}]}], "]"}], " ", ":=", 
    " ", 
    RowBox[{"addcon", "[", 
     RowBox[{
     "\"\<v\>\"", ",", " ", "name", ",", " ", "expr", ",", " ", "\"\<v\>\"", 
      ",", " ", 
      RowBox[{"\"\<Kp\>\"", " ", "\[Rule]", " ", "0"}], ",", " ", "opts"}], 
     "]"}]}], ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"RBDVirtA", "[", 
    RowBox[{"name_", ",", " ", "expr_", ",", " ", 
     RowBox[{"opts", ":", 
      RowBox[{"OptionsPattern", "[", "RBDConQ", "]"}]}]}], "]"}], " ", ":=", 
   " ", 
   RowBox[{"addcon", "[", 
    RowBox[{
    "\"\<a\>\"", ",", " ", "name", ",", " ", "expr", ",", " ", "\"\<v\>\"", 
     ",", " ", 
     RowBox[{"\"\<Kp\>\"", " ", "\[Rule]", " ", "0"}], ",", " ", 
     RowBox[{"\"\<Kv\>\"", " ", "\[Rule]", " ", "0"}], ",", " ", "opts"}], 
    "]"}]}], ";"}]}], "Input",
 InitializationCell->
  True,ExpressionUUID->"99289ee5-bd6f-4565-939f-83c36a6a59b8"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Add Transmission Matrix", \
"Section",ExpressionUUID->"b6977626-b220-442d-81b9-72297bdff902"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", " ", 
   RowBox[{
    RowBox[{"P", " ", "=", " ", 
     RowBox[{
      RowBox[{"qdot", "\[Transpose]"}], ".", "B", ".", "u"}]}], ",", " ", 
    RowBox[{
     RowBox[{
     "using", " ", "Con", " ", "we", " ", "can", " ", "determine", " ", "B", 
      " ", "from", " ", "expr"}], " ", "=", " ", 
     RowBox[{
      RowBox[{"B", "\[Transpose]"}], ".", "qdot"}]}]}], " ", "*)"}], 
  "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"SetAttributes", "[", 
     RowBox[{"RBDTranV", ",", " ", "Listable"}], "]"}], ";"}], 
   "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"RBDTranV", "::", "expr"}], " ", "=", " ", 
     "\"\<Expression should either be T.\[DoubleStruckV] or \
\[DoubleStruckB]'[...], where T is a matrix.  Resulting expression will \
result in zero force transmission.\>\""}], ";"}], "\[IndentingNewLine]", 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"RBDTranV", "[", 
      RowBox[{"name_", ",", " ", "expr_", ",", " ", 
       RowBox[{"opts", ":", 
        RowBox[{"OptionsPattern", "[", "RBDConQ", "]"}]}]}], "]"}], " ", ":=",
      " ", 
     RowBox[{"Module", "[", 
      RowBox[{
       RowBox[{"{", "}"}], ",", "\[IndentingNewLine]", 
       RowBox[{"(*", " ", 
        RowBox[{"should", " ", "provide", " ", 
         RowBox[{
          RowBox[{"\[DoubleStruckB]", "'"}], "[", "...", "]"}], " ", "and", 
         " ", 
         RowBox[{"\[DoubleStruckV]", "[", "...", "]"}], " ", "expressions", 
         " ", "here", " ", "only"}], " ", "*)"}], "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{"FreeQ", "[", 
           RowBox[{"expr", ",", " ", 
            RowBox[{"\[DoubleStruckV]", "|", 
             RowBox[{
              RowBox[{"Derivative", "[", "1", "]"}], "[", "\[DoubleStruckB]", 
              "]"}]}]}], "]"}], ",", " ", 
          RowBox[{"Message", "[", 
           RowBox[{"RBDTranV", "::", "expr"}], "]"}]}], "]"}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"addcon", "[", 
         RowBox[{
         "\"\<v\>\"", ",", " ", "name", ",", " ", "expr", ",", " ", 
          "\"\<u\>\"", ",", " ", 
          RowBox[{"\"\<\[Phi]\>\"", " ", "\[Rule]", " ", "False"}], ",", " ", 
          
          RowBox[{"\"\<Kp\>\"", " ", "\[Rule]", " ", "0"}], ",", " ", 
          RowBox[{"\"\<Kv\>\"", " ", "\[Rule]", " ", "0"}], ",", " ", 
          "opts"}], "]"}]}]}], "\[IndentingNewLine]", "]"}]}], 
    ";"}]}]}]], "Input",
 InitializationCell->
  True,ExpressionUUID->"fb76affe-ee80-4220-a136-2a7555174e5d"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Expand Constraints", \
"Section",ExpressionUUID->"21d42b96-236c-48fa-bc02-7e5ed1804c9c"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"Options", "[", "RBDExpandExpression", "]"}], " ", "=", " ", 
    RowBox[{"Join", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        RowBox[{"Assumptions", " ", "\[Rule]", " ", 
         RowBox[{"Element", "[", 
          RowBox[{
           RowBox[{"(", 
            RowBox[{
            "_\[DoubleStruckQ]", "|", "_\[DoubleStruckV]", "|", 
             "_\[DoubleStruckX]", "|", "_\[DoubleStruckC]", "|", 
             "_\[DoubleStruckB]"}], ")"}], ",", " ", "Reals"}], "]"}]}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{"Trig", " ", "\[Rule]", " ", "False"}], ",", " ", 
        RowBox[{"TransformationFunctions", "\[Rule]", 
         RowBox[{"{", 
          RowBox[{"Automatic", ",", " ", "TrigReduce"}], "}"}]}]}], "}"}], 
      ",", " ", 
      RowBox[{"Options", "[", "Simplify", "]"}]}], "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"RBDExpandExpression", "[", 
    RowBox[{"expr_", ",", " ", 
     RowBox[{"opts", ":", 
      RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], " ", ":=", " ", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"e", ",", " ", "r"}], "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"e", " ", "=", " ", 
       RowBox[{"expr", " ", "/.", " ", 
        RowBox[{"b_\[DoubleStruckB]", " ", "\[RuleDelayed]", " ", 
         RowBox[{"RBDSpatialPosition", "[", "b", "]"}]}]}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"e", " ", "=", " ", 
       RowBox[{"Block", "[", 
        RowBox[{
         RowBox[{"{", "Derivative", "}"}], ",", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{
           RowBox[{
            RowBox[{
             RowBox[{"Derivative", "[", "1", "]"}], "[", "\[DoubleStruckQ]", 
             "]"}], "[", "x__", "]"}], " ", ":=", " ", 
           RowBox[{"\[DoubleStruckV]", "[", "x", "]"}]}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{
            RowBox[{
             RowBox[{"Derivative", "[", "2", "]"}], "[", "\[DoubleStruckQ]", 
             "]"}], "[", "x__", "]"}], " ", ":=", " ", 
           RowBox[{"\[DoubleStruckA]", "[", "x", "]"}]}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{
            RowBox[{
             RowBox[{"Derivative", "[", "1", "]"}], "[", "\[DoubleStruckV]", 
             "]"}], "[", "x__", "]"}], " ", ":=", " ", 
           RowBox[{"\[DoubleStruckA]", "[", "x", "]"}]}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"(*", " ", 
           RowBox[{"memoize", " ", "expanded", " ", 
            RowBox[{"\[DoubleStruckB]", "'"}], "s"}], " ", "*)"}], 
          "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{
            RowBox[{
             RowBox[{"Derivative", "[", "1", "]"}], "[", "\[DoubleStruckB]", 
             "]"}], "[", "x__", "]"}], " ", ":=", " ", 
           RowBox[{
            RowBox[{
             RowBox[{
              RowBox[{"Derivative", "[", "1", "]"}], "[", "\[DoubleStruckB]", 
              "]"}], "[", "x", "]"}], " ", "=", " ", 
            RowBox[{"Con", "[", 
             RowBox[{
              RowBox[{"RBDSpatialPosition", "@", 
               RowBox[{"\[DoubleStruckB]", "[", "x", "]"}]}], ",", " ", 
              "\[DoubleStruckQ]", ",", " ", "\[DoubleStruckV]"}], "]"}]}]}], 
          ";", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{
            RowBox[{
             RowBox[{"Derivative", "[", "2", "]"}], "[", "\[DoubleStruckB]", 
             "]"}], "[", "x__", "]"}], " ", ":=", " ", 
           RowBox[{
            RowBox[{
             RowBox[{
              RowBox[{"Derivative", "[", "2", "]"}], "[", "\[DoubleStruckB]", 
              "]"}], "[", "x", "]"}], " ", "=", " ", 
            RowBox[{"Module", "[", 
             RowBox[{
              RowBox[{"{", 
               RowBox[{"b", " ", "=", " ", 
                RowBox[{
                 RowBox[{"\[DoubleStruckB]", "'"}], "[", "x", "]"}]}], "}"}], 
              ",", " ", 
              RowBox[{
               RowBox[{"Con", "[", 
                RowBox[{
                "b", ",", " ", "\[DoubleStruckV]", ",", " ", 
                 "\[DoubleStruckA]"}], "]"}], "+", 
               RowBox[{"Con", "[", 
                RowBox[{
                "b", ",", " ", "\[DoubleStruckQ]", ",", " ", 
                 "\[DoubleStruckV]"}], "]"}]}]}], "]"}]}]}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{
            RowBox[{
             RowBox[{"Derivative", "[", 
              RowBox[{"n_", "?", "Positive"}], "]"}], "[", "\[DoubleStruckC]",
              "]"}], "[", "x__", "]"}], " ", ":=", " ", "0"}], ";", 
          "\[IndentingNewLine]", "\[IndentingNewLine]", "e"}]}], 
        "\[IndentingNewLine]", "]"}]}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"r", " ", "=", " ", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"1.", " ", "\[Rule]", " ", "1"}], ",", " ", 
         RowBox[{
          RowBox[{"-", "1."}], " ", "\[Rule]", " ", 
          RowBox[{"-", "1"}]}], ",", " ", 
         RowBox[{"0.", " ", "\[Rule]", "  ", "0"}]}], "}"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"e", " ", "=", " ", 
       RowBox[{"e", " ", "/.", " ", "r"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"Chop", "[", 
        RowBox[{"TrigReduce", "@", 
         RowBox[{"Simplify", "[", 
          RowBox[{"e", ",", " ", "opts"}], "]"}]}], "]"}], " ", "/.", " ", 
       "r"}]}]}], "\[IndentingNewLine]", "]"}]}], ";"}]}], "Input",
 InitializationCell->
  True,ExpressionUUID->"d25bd395-589a-4cb5-9b3d-401221544cbc"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Constraint Functions", \
"Section",ExpressionUUID->"e49d07f6-189b-4019-8f47-266922a4ae61"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"rfun", "[", 
     RowBox[{
      RowBox[{"x_:", 
       RowBox[{"{", "}"}]}], ",", " ", 
      RowBox[{"\[Lambda]_:", 
       RowBox[{"{", "}"}]}]}], "]"}], " ", ":=", " ", 
    RowBox[{"EvaluateConstraintFunction", "[", 
     RowBox[{"\"\<r\>\"", ",", " ", "x", ",", " ", "\[Lambda]"}], "]"}]}], 
   ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"rdotfun", "[", 
     RowBox[{
      RowBox[{"x_:", 
       RowBox[{"{", "}"}]}], ",", " ", 
      RowBox[{"\[Lambda]_:", 
       RowBox[{"{", "}"}]}]}], "]"}], " ", ":=", " ", 
    RowBox[{"EvaluateConstraintFunction", "[", 
     RowBox[{"\"\<rdot\>\"", ",", " ", "x", ",", " ", "\[Lambda]"}], "]"}]}], 
   ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"Tcbfun", "[", 
     RowBox[{
      RowBox[{"x_:", 
       RowBox[{"{", "}"}]}], ",", " ", 
      RowBox[{"\[Lambda]_:", 
       RowBox[{"{", "}"}]}]}], "]"}], " ", ":=", " ", 
    RowBox[{"EvaluateConstraintFunction", "[", 
     RowBox[{"\"\<Tcb\>\"", ",", " ", "x", ",", " ", "\[Lambda]"}], "]"}]}], 
   ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"Jfun", "[", 
     RowBox[{
      RowBox[{"x_:", 
       RowBox[{"{", "}"}]}], ",", " ", 
      RowBox[{"\[Lambda]_:", 
       RowBox[{"{", "}"}]}]}], "]"}], " ", ":=", " ", 
    RowBox[{"EvaluateConstraintFunction", "[", 
     RowBox[{"\"\<J\>\"", ",", " ", "x", ",", " ", "\[Lambda]"}], "]"}]}], 
   ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"\[Phi]fun", "[", 
     RowBox[{
      RowBox[{"x_:", 
       RowBox[{"{", "}"}]}], ",", " ", 
      RowBox[{"\[Lambda]_:", 
       RowBox[{"{", "}"}]}]}], "]"}], " ", ":=", " ", 
    RowBox[{"EvaluateConstraintFunction", "[", 
     RowBox[{"\"\<\[Phi]\>\"", ",", " ", "x", ",", " ", "\[Lambda]"}], 
     "]"}]}], ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"\[Eta]fun", "[", 
     RowBox[{
      RowBox[{"x_:", 
       RowBox[{"{", "}"}]}], ",", " ", 
      RowBox[{"\[Lambda]_:", 
       RowBox[{"{", "}"}]}]}], "]"}], " ", ":=", " ", 
    RowBox[{"EvaluateConstraintFunction", "[", 
     RowBox[{"\"\<\[Eta]\>\"", ",", " ", "x", ",", " ", "\[Lambda]"}], 
     "]"}]}], ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"Kfun", "[", 
     RowBox[{
      RowBox[{"x_:", 
       RowBox[{"{", "}"}]}], ",", " ", 
      RowBox[{"\[Lambda]_:", 
       RowBox[{"{", "}"}]}]}], "]"}], " ", ":=", " ", 
    RowBox[{"EvaluateConstraintFunction", "[", 
     RowBox[{"\"\<K\>\"", ",", " ", "x", ",", " ", "\[Lambda]"}], "]"}]}], 
   ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"EvaluateConstraintFunction", "[", 
    RowBox[{"t_", ",", " ", 
     RowBox[{"x_:", 
      RowBox[{"{", "}"}]}], ",", " ", 
     RowBox[{"\[Lambda]_:", 
      RowBox[{"{", "}"}]}]}], "]"}], " ", ":=", " ", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"a", ",", " ", "b"}], "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"a", " ", "=", " ", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"x", " ", "===", " ", 
          RowBox[{"{", "}"}]}], ",", " ", 
         RowBox[{"Array", "[", 
          RowBox[{"\[DoubleStruckX]", ",", " ", "nx"}], "]"}], ",", " ", 
         "x"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"b", " ", "=", " ", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"\[Lambda]", " ", "===", " ", 
          RowBox[{"{", "}"}]}], ",", " ", 
         RowBox[{"Array", "[", 
          RowBox[{"\[DoubleStruckC]", ",", " ", "nc"}], "]"}], ",", " ", 
         "\[Lambda]"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"rb", "[", 
        RowBox[{"C", ",", " ", "t"}], "]"}], "[", 
       RowBox[{"a", ",", " ", "b"}], "]"}]}]}], "\[IndentingNewLine]", 
    "]"}]}], ";"}]}], "Input",
 InitializationCell->
  True,ExpressionUUID->"c287c901-62f7-4046-b56c-a5a930b28fd2"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"RBDConstraintFunctions", "::", "a"}], " ", "=", " ", 
    "\"\<`1` is not an nca of `2`.  Replacing `1` with `3`.  Update \
constraint if this is not desired behavior.\>\""}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"RBDConstraintFunctions", "[", "]"}], " ", ":=", " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"j", ",", " ", "t", ",", " ", "b"}], "}"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"j", " ", "=", " ", 
        RowBox[{"<|", 
         RowBox[{
          RowBox[{"\"\<J\>\"", " ", "\[Rule]", " ", 
           RowBox[{"(", 
            RowBox[{
             RowBox[{"{", "}"}], "&"}], ")"}]}], ",", " ", 
          RowBox[{"\"\<\[Phi]\>\"", " ", "\[Rule]", " ", 
           RowBox[{"(", 
            RowBox[{
             RowBox[{"{", "}"}], "&"}], ")"}]}], ",", " ", 
          RowBox[{"\"\<\[Eta]\>\"", " ", "\[Rule]", " ", 
           RowBox[{"(", 
            RowBox[{
             RowBox[{"{", "}"}], "&"}], ")"}]}], ",", " ", 
          RowBox[{"\"\<K\>\"", " ", "\[Rule]", " ", 
           RowBox[{"(", 
            RowBox[{
             RowBox[{"{", "}"}], "&"}], ")"}]}], ",", " ", 
          RowBox[{"\"\<n\>\"", " ", "\[Rule]", " ", 
           RowBox[{"<|", "|>"}]}]}], "|>"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"t", " ", "=", " ", 
        RowBox[{"<|", 
         RowBox[{
          RowBox[{"\"\<p\>\"", " ", "\[Rule]", " ", 
           RowBox[{"{", "}"}]}], ",", " ", 
          RowBox[{"\"\<v\>\"", " ", "\[Rule]", " ", 
           RowBox[{"{", "}"}]}], ",", " ", 
          RowBox[{"\"\<u\>\"", " ", "\[Rule]", " ", 
           RowBox[{"{", "}"}]}]}], "|>"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"b", " ", "=", " ", 
        RowBox[{"ConBFunctions", "[", "False", "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"SetConstraintData", "[", 
        RowBox[{"j", ",", " ", "t", ",", " ", "b"}], "]"}]}]}], 
     "\[IndentingNewLine]", "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"RBDConstraintFunctions", "[", "None", "]"}], " ", ":=", " ", 
    RowBox[{"RBDConstraintFunctions", "[", "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"RBDConstraintFunctions", "[", "All", "]"}], " ", ":=", " ", 
    RowBox[{"RBDConstraintFunctions", "@", 
     RowBox[{"DeleteDuplicates", "[", 
      RowBox[{"con", "\[LeftDoubleBracket]", 
       RowBox[{"All", ",", " ", "2"}], "\[RightDoubleBracket]"}], "]"}]}]}], 
   ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"RBDConstraintFunctions", "[", "name_", "]"}], " ", ":=", " ", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "c", ",", " ", "J", ",", " ", "\[Phi]", ",", " ", "\[Eta]", ",", " ", 
       "K", ",", " ", "brX", ",", " ", "n", ",", " ", "t"}], "}"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
       RowBox[{"adds", " ", "desired", " ", "constraints", " ", "to", " ", 
        RowBox[{"rb", "[", "C", "]"}]}], ";", " ", 
       RowBox[{
       "returns", " ", "an", " ", "intermediate", " ", "representation"}]}], 
      " ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
       RowBox[{"of", " ", "final", " ", "constraints"}], ";", " ", 
       RowBox[{
       "rest", " ", "of", " ", "code", " ", "places", " ", "in", " ", "final",
         " ", "representation"}]}], " ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"c", " ", "=", " ", 
       RowBox[{"PreprocessConstraints", "[", "name", "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"c", " ", "===", " ", 
          RowBox[{"{", "}"}]}], " ", "||", " ", 
         RowBox[{"KeyFreeQ", "[", 
          RowBox[{"rb", ",", " ", "C"}], "]"}]}], ",", " ", 
        RowBox[{"Return", "[", 
         RowBox[{"RBDConstraintFunctions", "[", "]"}], "]"}]}], "]"}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
       "extract", " ", "data", " ", "from", " ", "intermediate", " ", 
        "representation", " ", "in", " ", 
        RowBox[{"rb", "[", "C", "]"}]}], " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"J", ",", " ", "\[Phi]"}], "}"}], " ", "=", " ", 
       RowBox[{"ConvertToXLFunction", " ", "/@", " ", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"rb", "[", 
           RowBox[{"C", ",", " ", "\"\<J\>\""}], "]"}], ",", " ", 
          RowBox[{"rb", "[", 
           RowBox[{"C", ",", " ", "\"\<\[Phi]\>\""}], "]"}]}], "}"}]}]}], ";",
       "\[IndentingNewLine]", 
      RowBox[{"brX", " ", "=", " ", 
       RowBox[{"ConBFunctions", "[", "]"}]}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{"partition", " ", "row", " ", "type"}], " ", "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"t", " ", "=", " ", 
       RowBox[{"rb", "[", 
        RowBox[{"C", ",", " ", "\"\<t\>\""}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"t", " ", "=", " ", 
       RowBox[{"GroupBy", "[", 
        RowBox[{
         RowBox[{"Range", "@", 
          RowBox[{"Length", "@", "t"}]}], ",", " ", 
         RowBox[{
          RowBox[{"t", "\[LeftDoubleBracket]", "#", "\[RightDoubleBracket]"}],
           "&"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"t", " ", "=", " ", 
       RowBox[{"Join", "[", 
        RowBox[{
         RowBox[{"<|", 
          RowBox[{
           RowBox[{"\"\<p\>\"", " ", "\[Rule]", " ", 
            RowBox[{"{", "}"}]}], ",", " ", 
           RowBox[{"\"\<v\>\"", " ", "\[Rule]", " ", 
            RowBox[{"{", "}"}]}], ",", " ", 
           RowBox[{"\"\<u\>\"", " ", "\[Rule]", " ", 
            RowBox[{"{", "}"}]}]}], "|>"}], ",", " ", "t"}], "]"}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
       "define", " ", "feedback", " ", "error", " ", "for", " ", "constraint",
         " ", "stabilization"}], " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{"\[Eta]", " ", "=", " ", 
       RowBox[{"ConvertToXLFunction", "@", 
        RowBox[{"Transpose", "@", 
         RowBox[{"rb", "[", 
          RowBox[{"C", ",", " ", "\"\<\[Eta]\>\""}], "]"}]}]}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"K", " ", "=", " ", 
       RowBox[{
        RowBox[{
         RowBox[{
          RowBox[{"{", 
           RowBox[{
            RowBox[{"1", "/", 
             RowBox[{"\[Epsilon]", "^", "2"}]}], ",", " ", 
            RowBox[{"1", "/", "\[Epsilon]"}]}], "}"}], "#"}], "&"}], " ", "/@",
         " ", 
        RowBox[{"rb", "[", 
         RowBox[{"C", ",", " ", "\"\<K\>\""}], "]"}]}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"K", " ", "=", " ", 
       RowBox[{"DiagonalMatrix", " ", "/@", " ", 
        RowBox[{"Transpose", "[", "K", "]"}]}]}], ";", "\[IndentingNewLine]", 
      
      RowBox[{"K", " ", "=", " ", 
       RowBox[{"ConvertToXLFunction", "@", "K"}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"n", " ", "=", " ", 
       RowBox[{"<|", 
        RowBox[{
         RowBox[{"\"\<J\>\"", " ", "\[Rule]", " ", "J"}], ",", " ", 
         RowBox[{"\"\<\[Phi]\>\"", " ", "\[Rule]", " ", "\[Phi]"}], ",", " ", 
         
         RowBox[{"\"\<\[Eta]\>\"", " ", "\[Rule]", " ", "\[Eta]"}], ",", " ", 
         
         RowBox[{"\"\<K\>\"", " ", "\[Rule]", " ", "K"}], ",", " ", 
         RowBox[{"\"\<n\>\"", " ", "\[Rule]", " ", 
          RowBox[{"rb", "[", 
           RowBox[{"C", ",", " ", "\"\<n\>\""}], "]"}]}]}], "|>"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"SetConstraintData", "[", 
       RowBox[{"n", ",", " ", "t", ",", " ", "brX"}], "]"}]}]}], 
    "\[IndentingNewLine]", "]"}]}], ";"}]}], "Input",
 InitializationCell->
  True,ExpressionUUID->"99048470-c283-4721-bc25-207b40c529db"],

Cell[CellGroupData[{

Cell["Helper Functions", \
"Subsection",ExpressionUUID->"03970afd-0e6f-4aa6-8a61-740e7c849c7c"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"SetConstraintData", "::", "u"}], " ", "=", " ", 
    "\"\<There are `1` actuators and `2` virtual constraints.  There may not \
be enough actuators to solve for these constraints.\>\""}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"SetConstraintData", "[", 
   RowBox[{"J_", ",", " ", "T_", ",", " ", "B_"}], "]"}], " ", ":=", " ", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", "n", "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{
      RowBox[{"{", 
       RowBox[{"nf", ",", " ", "nv", ",", " ", "nu"}], "}"}], " ", "=", " ", 
      RowBox[{"Length", " ", "/@", " ", 
       RowBox[{"Values", "@", 
        RowBox[{"T", "\[LeftDoubleBracket]", 
         RowBox[{"{", 
          RowBox[{"\"\<p\>\"", ",", " ", "\"\<v\>\"", ",", " ", "\"\<u\>\""}],
           "}"}], "\[RightDoubleBracket]"}]}]}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"nu", " ", "<", " ", "nv"}], ",", " ", 
       RowBox[{"Message", "[", 
        RowBox[{
         RowBox[{"SetConstraintData", "::", "u"}], ",", " ", "nu", ",", " ", 
         "nv"}], "]"}]}], "]"}], ";", "\[IndentingNewLine]", 
     RowBox[{"zpos", " ", "=", " ", 
      RowBox[{"Table", "[", 
       RowBox[{"z1", ",", " ", 
        RowBox[{"Length", "@", 
         RowBox[{"B", "[", "\"\<bo\>\"", "]"}]}]}], 
       RowBox[{"(*", 
        RowBox[{"nf", " ", "+", " ", "nv", " ", "+", " ", "nu"}], "*)"}], 
       "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"ZAb", " ", "=", " ", 
      RowBox[{"Table", "[", 
       RowBox[{"z1", ",", " ", 
        RowBox[{"nq", " ", "+", " ", "nf", " ", "+", " ", "nv"}], ",", " ", 
        RowBox[{
        "nq", " ", "+", " ", "nf", " ", "+", " ", "nu", " ", "+", " ", 
         "1"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"rb", "[", "C", "]"}], " ", "=", " ", 
      RowBox[{"Join", "[", 
       RowBox[{"J", ",", " ", "T", ",", " ", "B"}], "]"}]}]}]}], 
   "\[IndentingNewLine]", "]"}]}]}], "Input",
 InitializationCell->
  True,ExpressionUUID->"0a2aa8cb-796d-427a-b9e3-2463e6398b7f"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"PreprocessConstraints", "::", "name"}], " ", "=", " ", 
   "\"\<No valid constraints found under ``.\>\""}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"PreprocessConstraints", "[", "names_", "]"}], " ", ":=", " ", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"c", ",", " ", "t", ",", " ", "f"}], "}"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
       RowBox[{
        RowBox[{"remove", " ", "C"}], ";", " ", 
        RowBox[{
        "it", " ", "has", " ", "Function", " ", "as", " ", "head", " ", "not",
          " ", "List"}]}], ",", " ", 
       RowBox[{"which", " ", "AddCon", " ", "needs"}]}], " ", "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"KeyDropFrom", "[", 
       RowBox[{"rb", ",", " ", "C"}], "]"}], ";", "\[IndentingNewLine]", 
      RowBox[{"t", " ", "=", " ", 
       RowBox[{"{", 
        RowBox[{
        "\"\<q\>\"", ",", " ", "\"\<v\>\"", ",", " ", "\"\<a\>\"", ",", " ", 
         "\"\<b\>\""}], "}"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"f", " ", "=", " ", 
       RowBox[{"{", 
        RowBox[{
        "ConQ", ",", " ", "ConV", ",", " ", "ConA", ",", " ", "ConB"}], 
        "}"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"c", " ", "=", " ", 
       RowBox[{"Cases", "[", 
        RowBox[{"con", ",", " ", 
         RowBox[{"{", 
          RowBox[{"_", ",", " ", 
           RowBox[{"Alternatives", "@@", "names"}], ",", " ", "__"}], "}"}]}],
         "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"c", "=", " ", 
       RowBox[{"Select", "[", 
        RowBox[{"c", ",", " ", 
         RowBox[{
          RowBox[{"StringMatchQ", "[", 
           RowBox[{
            RowBox[{"First", "@", "#"}], ",", " ", "t"}], "]"}], "&"}]}], 
        "]"}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"c", " ", "===", " ", 
         RowBox[{"{", "}"}]}], ",", " ", 
        RowBox[{
         RowBox[{"Message", "[", 
          RowBox[{
           RowBox[{"PreprocessConstraints", "::", "name"}], ",", " ", 
           "names"}], "]"}], ";", " ", 
         RowBox[{"Return", "[", 
          RowBox[{"{", "}"}], "]"}]}]}], "]"}], ";", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{"expand", " ", 
        RowBox[{"constraints", "?"}]}], "*)"}], "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"c", "\[LeftDoubleBracket]", 
        RowBox[{"All", ",", " ", "1"}], "\[RightDoubleBracket]"}], " ", "=", 
       " ", 
       RowBox[{"MapThread", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"If", "[", 
           RowBox[{"#1", ",", " ", "#2", ",", " ", "\"\<b\>\""}], " ", "]"}], 
          "&"}], ",", " ", 
         RowBox[{
          RowBox[{"c", "\[LeftDoubleBracket]", 
           RowBox[{"All", ",", " ", 
            RowBox[{"{", 
             RowBox[{"8", ",", " ", "1"}], "}"}]}], "\[RightDoubleBracket]"}],
           "\[Transpose]"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{"replace", " ", "with", " ", "con", " ", "type"}], " ", "*)"}],
       "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"c", "\[LeftDoubleBracket]", 
        RowBox[{"All", ",", " ", "1"}], "\[RightDoubleBracket]"}], " ", "=", 
       " ", 
       RowBox[{
        RowBox[{"c", "\[LeftDoubleBracket]", 
         RowBox[{"All", ",", " ", "1"}], "\[RightDoubleBracket]"}], " ", "/.",
         " ", 
        RowBox[{"Thread", "[", 
         RowBox[{"t", " ", "\[Rule]", " ", "f"}], "]"}]}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{"drop", " ", "expand", " ", "column"}], " ", "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"c", " ", "=", " ", 
       RowBox[{"Drop", "[", 
        RowBox[{"c", ",", " ", "None", ",", " ", 
         RowBox[{"{", "8", "}"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
        RowBox[{
        "adds", " ", "constraints", " ", "to", " ", "rb", " ", "and", " ", 
         "returns", " ", "the", " ", "results", " ", "from", " ", "ConQ"}], 
        ",", " ", 
        RowBox[{"etc", "."}]}], " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{
        RowBox[{
         RowBox[{"#", "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}], 
         "@@", 
         RowBox[{"#", "\[LeftDoubleBracket]", 
          RowBox[{"2", ";;"}], "\[RightDoubleBracket]"}]}], "&"}], " ", "/@", 
       " ", "c"}], ";", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{"return", " ", "intermediate", " ", "format"}], " ", "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"rb", "[", "C", "]"}]}]}], "\[IndentingNewLine]", "]"}]}], 
  ";"}]}], "Input",
 InitializationCell->
  True,ExpressionUUID->"3e04e3ce-d0e4-4c4b-a549-6e8951b99ac6"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"Con", "[", 
     RowBox[{"expr_", ",", " ", "c_", ",", " ", "dc_", ",", " ", 
      RowBox[{"z_:", "z1"}]}], "]"}], " ", ":=", " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"e", ",", " ", "a", ",", " ", "b"}], "}"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"e", " ", "=", " ", 
        RowBox[{"RBDExpandExpression", "[", "expr", "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"(*", " ", 
        RowBox[{
         RowBox[{
         "try", " ", "to", " ", "figure", " ", "out", " ", "vars", " ", "to", 
          " ", "take", " ", "derivates", " ", 
          RowBox[{"w", "/"}]}], ",", " ", 
         RowBox[{"if", " ", "not", " ", "specified"}]}], " ", "*)"}], 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"a", " ", "=", " ", 
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{"VectorQ", "[", "c", "]"}], ",", " ", "c", ",", " ", 
          RowBox[{"SortBy", "[", 
           RowBox[{
            RowBox[{"DeleteDuplicates", "[", 
             RowBox[{"Cases", "[", 
              RowBox[{"e", ",", " ", "_c", ",", " ", 
               RowBox[{"{", 
                RowBox[{"-", "2"}], "}"}]}], "]"}], "]"}], ",", " ", 
            "RBDGetIndex"}], "]"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"b", " ", "=", " ", 
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{"TensorQ", "[", "dc", "]"}], ",", "dc", ",", " ", 
          RowBox[{"a", " ", "/.", " ", 
           RowBox[{"Thread", "[", 
            RowBox[{"c", " ", "\[Rule]", " ", "dc"}], "]"}]}]}], "]"}]}], ";",
        "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"a", " ", "===", " ", 
          RowBox[{"{", "}"}]}], ",", " ", "z", ",", " ", 
         RowBox[{
          RowBox[{"D", "[", 
           RowBox[{"e", ",", " ", 
            RowBox[{"{", "a", "}"}]}], "]"}], ".", "b"}]}], "]"}]}]}], 
     "\[IndentingNewLine]", "]"}]}], ";"}], "\n", "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{"convert", " ", "from", " ", "string", " ", "to", " ", "number"}], 
   " ", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"StandardizeCon", "[", "expr_", "]"}], " ", ":=", " ", 
    RowBox[{"expr", " ", "/.", " ", 
     RowBox[{
      RowBox[{
       RowBox[{"f_", "[", 
        RowBox[{"x_", ",", " ", "y_String"}], "]"}], " ", "/;", " ", 
       RowBox[{"MemberQ", "[", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
          "\[DoubleStruckQ]", ",", " ", "\[DoubleStruckV]", ",", " ", 
           "\[DoubleStruckA]"}], "}"}], ",", " ", "f"}], "]"}]}], " ", 
      "\[RuleDelayed]", " ", 
      RowBox[{"RBDGetDOF", "[", 
       RowBox[{"f", "[", 
        RowBox[{"x", ",", " ", "y"}], "]"}], "]"}]}]}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"ValidCon", "::", "expr"}], " ", "=", " ", 
    "\"\<Ignoring constraint `2` in `1`.  The expression can only be a \
function of `3`.  Modify source expression.\>\""}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"ValidCon", "[", 
    RowBox[{"name_", ",", " ", "expr_", ",", " ", 
     RowBox[{"excl_:", 
      RowBox[{"{", "}"}]}], ",", " ", 
     RowBox[{"Jexcl_:", 
      RowBox[{"{", "}"}]}], ",", " ", 
     RowBox[{"h_:", 
      RowBox[{"{", 
       RowBox[{
       "\[DoubleStruckQ]", ",", " ", "\[DoubleStruckV]", ",", " ", 
        "\[DoubleStruckA]"}], "}"}]}]}], "]"}], " ", ":=", " ", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"v", ",", " ", "J", ",", " ", "a"}], "}"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"J", " ", "=", " ", "Jexcl"}], ";", "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"J", " ", "=!=", " ", 
         RowBox[{"{", "}"}]}], ",", "\[IndentingNewLine]", 
        RowBox[{"(*", " ", 
         RowBox[{
         "is", " ", "constraint", " ", "linear", " ", "in", " ", "variables", 
          " ", "in", " ", 
          RowBox[{"Jexcl", "?", " ", "compute"}], " ", "Jacobian"}], " ", 
         "*)"}], "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"v", " ", "=", " ", 
          RowBox[{"Alternatives", "@@", 
           RowBox[{"(", 
            RowBox[{"Blank", " ", "/@", " ", "J"}], ")"}]}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"a", " ", "=", " ", 
          RowBox[{"Flatten", "@", 
           RowBox[{"DeleteDuplicates", "[", 
            RowBox[{"Cases", "[", 
             RowBox[{"expr", ",", " ", "v", ",", " ", 
              RowBox[{"{", 
               RowBox[{"-", "2"}], "}"}]}], "]"}], "]"}]}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"J", " ", "=", " ", 
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{"a", " ", "===", " ", 
             RowBox[{"{", "}"}]}], ",", " ", "z1", ",", " ", 
            RowBox[{"D", "[", 
             RowBox[{"expr", ",", " ", 
              RowBox[{"{", "a", "}"}]}], "]"}]}], "]"}]}], ";"}]}], 
       "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
      RowBox[{"a", " ", "=", " ", 
       RowBox[{"Alternatives", "@@", 
        RowBox[{"(", 
         RowBox[{"Blank", " ", "/@", " ", "excl"}], ")"}]}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{"is", " ", "constraint", " ", 
        RowBox[{"valid", "?"}]}], " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{"v", " ", "=", " ", 
       RowBox[{
        RowBox[{"FreeQ", "[", 
         RowBox[{"J", ",", " ", "v"}], "]"}], " ", "&&", " ", 
        RowBox[{"FreeQ", "[", 
         RowBox[{"expr", ",", " ", "a"}], "]"}]}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
        RowBox[{"if", " ", "invalid"}], ",", " ", 
        RowBox[{"print", " ", "error", " ", "message"}]}], " ", "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"!", "v"}], ",", " ", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"J", " ", "=", " ", 
          RowBox[{
           RowBox[{"Switch", "[", 
            RowBox[{
             RowBox[{"Length", "@", "#"}], ",", " ", "0", ",", " ", 
             "\"\<\>\"", ",", " ", "1", ",", " ", 
             RowBox[{
             "#", "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}], ",",
              " ", "2", ",", " ", 
             RowBox[{
              RowBox[{
              "#", "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}], 
              " ", "<>", " ", "\"\< and \>\"", " ", "<>", " ", 
              RowBox[{
              "#", "\[LeftDoubleBracket]", "2", "\[RightDoubleBracket]"}]}], 
             ",", " ", "3", ",", " ", 
             RowBox[{
              RowBox[{
              "#", "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}], 
              " ", "<>", " ", "\"\<, \>\"", " ", "<>", " ", 
              RowBox[{
              "#", "\[LeftDoubleBracket]", "2", "\[RightDoubleBracket]"}], 
              " ", "<>", " ", "\"\<, and \>\"", " ", "<>", " ", 
              RowBox[{
              "#", "\[LeftDoubleBracket]", "3", "\[RightDoubleBracket]"}]}]}],
             "]"}], "&"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"a", " ", "=", " ", 
          RowBox[{"J", "[", 
           RowBox[{"ToString", " ", "/@", " ", 
            RowBox[{"Complement", "[", 
             RowBox[{"h", ",", " ", "excl"}], "]"}]}], "]"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"J", " ", "=", " ", 
          RowBox[{"J", "[", 
           RowBox[{"ToString", " ", "/@", " ", "Jexcl"}], "]"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"StringLength", "@", "J"}], " ", ">", " ", "0"}], ",", 
           " ", 
           RowBox[{
            RowBox[{"a", " ", "=", " ", 
             RowBox[{
             "a", " ", "<>", " ", "\"\<; and must be linear in \>\"", " ", "<>",
               " ", "J"}]}], ";"}]}], "]"}], ";", "\[IndentingNewLine]", 
         RowBox[{"J", " ", "=", " ", 
          RowBox[{"ToString", "[", 
           RowBox[{"expr", ",", " ", "InputForm"}], "]"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"StringLength", "@", "J"}], " ", ">", " ", "200"}], ",", 
           " ", 
           RowBox[{"J", " ", "=", " ", 
            RowBox[{
             RowBox[{"StringTake", "[", 
              RowBox[{"J", ",", " ", "200"}], "]"}], " ", "<>", " ", 
             "\"\<...\>\""}]}]}], "]"}], ";", "\[IndentingNewLine]", 
         RowBox[{"Message", "[", 
          RowBox[{
           RowBox[{"ValidCon", "::", "expr"}], ",", " ", "name", ",", " ", 
           "J", ",", " ", "a"}], "]"}]}]}], "\[IndentingNewLine]", "]"}], ";",
       "\[IndentingNewLine]", "v"}]}], "\[IndentingNewLine]", "]"}]}], 
  ";"}]}], "Input",
 InitializationCell->
  True,ExpressionUUID->"bc8c41a0-f4de-4ff1-b977-ced7e49b5986"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"SetAttributes", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"ConQ", ",", " ", "ConV", ",", " ", "ConA", ",", " ", "ConB"}], 
      "}"}], ",", " ", "Listable"}], "]"}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"ConQ", "[", 
     RowBox[{
     "name_", ",", " ", "expr_", ",", " ", "t_", ",", " ", "\[Phi]_", ",", 
      " ", "Kp_", ",", " ", "Kv_", ",", " ", "n_"}], "]"}], " ", ":=", " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", "e", "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"e", " ", "=", " ", 
        RowBox[{"RBDExpandExpression", "[", "expr", "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"ValidCon", "[", 
          RowBox[{"name", ",", " ", "e", ",", " ", 
           RowBox[{"{", 
            RowBox[{"\[DoubleStruckV]", ",", " ", "\[DoubleStruckA]"}], 
            "}"}]}], "]"}], ",", " ", "\[IndentingNewLine]", 
         RowBox[{"ConV", "[", 
          RowBox[{"name", ",", " ", 
           RowBox[{"Con", "[", 
            RowBox[{
            "e", ",", " ", "\[DoubleStruckQ]", ",", " ", "\[DoubleStruckV]"}],
             "]"}], ",", " ", "t", ",", " ", "\[Phi]", ",", " ", "Kp", ",", 
           " ", "Kv", ",", " ", "n", ",", " ", "e"}], "]"}]}], 
        "\[IndentingNewLine]", "]"}]}]}], "\[IndentingNewLine]", "]"}]}], 
   ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"ConV", "[", 
     RowBox[{
     "name_", ",", " ", "expr_", ",", " ", "t_", ",", " ", "\[Phi]_", ",", 
      " ", "Kp_", ",", " ", "Kv_", ",", " ", "n_", ",", " ", 
      RowBox[{"h_:", "z1"}]}], "]"}], " ", ":=", " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"e", ",", " ", "Ja", ",", " ", "Jv"}], "}"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"e", " ", "=", " ", 
        RowBox[{"RBDExpandExpression", "[", "expr", "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"ValidCon", "[", 
          RowBox[{"name", ",", " ", "e", ",", " ", 
           RowBox[{"{", "\[DoubleStruckA]", "}"}], ",", " ", 
           RowBox[{"{", "\[DoubleStruckV]", "}"}]}], "]"}], ",", " ", 
         "\[IndentingNewLine]", 
         RowBox[{"ConA", "[", 
          RowBox[{"name", ",", " ", 
           RowBox[{
            RowBox[{"Con", "[", 
             RowBox[{
             "e", ",", " ", "\[DoubleStruckV]", ",", " ", 
              "\[DoubleStruckA]"}], "]"}], " ", "+", " ", 
            RowBox[{"Con", "[", 
             RowBox[{
             "e", ",", " ", "\[DoubleStruckQ]", ",", " ", 
              "\[DoubleStruckV]"}], "]"}]}], ",", " ", "t", ",", " ", 
           "\[Phi]", ",", " ", "Kp", ",", " ", "Kv", ",", " ", "n", ",", " ", 
           "h", ",", " ", "e"}], "]"}]}], "\[IndentingNewLine]", "]"}]}]}], 
     "\[IndentingNewLine]", "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"ConA", "[", 
     RowBox[{
     "name_", ",", " ", "expr_", ",", " ", "t_", ",", " ", "\[Phi]bool_", ",",
       " ", "Kp_", ",", " ", "Kv_", ",", " ", "n_", ",", " ", 
      RowBox[{"h_:", "z1"}], ",", " ", 
      RowBox[{"hdot_:", "z1"}]}], "]"}], " ", ":=", " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "e", ",", " ", "a", ",", " ", "J", ",", " ", "\[Phi]", ",", " ", "m", 
        ",", " ", "\[Eta]"}], "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{"compute", " ", "Jacobian"}], " ", "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"e", " ", "=", " ", 
        RowBox[{"StandardizeCon", "@", 
         RowBox[{"RBDExpandExpression", "[", "expr", "]"}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"(*", " ", 
        RowBox[{
         RowBox[{
         "convert", " ", "to", " ", "numbered", " ", "indexing", " ", "if", 
          " ", "string"}], "-", 
         RowBox[{"based", " ", "indexing", " ", "is", " ", "used"}]}], " ", 
        "*)"}], "\[IndentingNewLine]", 
       RowBox[{"a", " ", "=", " ", 
        RowBox[{"StandardizeCon", "@", 
         RowBox[{"DeleteDuplicates", "[", 
          RowBox[{"Cases", "[", 
           RowBox[{"e", ",", " ", "_\[DoubleStruckA]", ",", " ", 
            RowBox[{"{", 
             RowBox[{"-", "2"}], "}"}]}], "]"}], "]"}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"J", " ", "=", " ", 
        RowBox[{"Con", "[", 
         RowBox[{"e", ",", " ", "a", ",", " ", 
          RowBox[{"D", "[", 
           RowBox[{"a", ",", " ", 
            RowBox[{"{", 
             RowBox[{"RBDGetValue", "[", 
              RowBox[{
               RowBox[{"nx", "+", "1"}], ",", " ", 
               RowBox[{"3", "nq"}], ",", " ", 
               RowBox[{"\"\<n\>\"", " ", "\[Rule]", " ", "False"}]}], "]"}], 
             "}"}]}], "]"}], ",", " ", "zq"}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"\[Eta]", " ", "=", " ", 
        RowBox[{"RBDExpandExpression", "[", 
         RowBox[{"{", 
          RowBox[{"h", ",", " ", "hdot"}], "}"}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"(*", " ", 
        RowBox[{
        "is", " ", "expr", " ", "linear", " ", "in", " ", "\[DoubleStruckA]", 
         " ", "with", " ", "\[Eta]", " ", "only", " ", "a", " ", "function", 
         " ", "of", " ", "\[DoubleStruckQ]", " ", "and", " ", 
         RowBox[{"\[DoubleStruckV]", "?"}]}], " ", "*)"}], 
       "\[IndentingNewLine]", 
       RowBox[{"m", " ", "=", " ", 
        RowBox[{
         RowBox[{"ValidCon", "[", 
          RowBox[{"name", ",", " ", "J", ",", " ", 
           RowBox[{"{", "\[DoubleStruckA]", "}"}]}], "]"}], " ", "&&", " ", 
         RowBox[{"ValidCon", "[", 
          RowBox[{"name", ",", " ", 
           RowBox[{
           "\[Eta]", "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}], 
           ",", 
           RowBox[{"{", 
            RowBox[{"\[DoubleStruckV]", ",", " ", "\[DoubleStruckA]"}], 
            "}"}]}], "]"}]}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"m", " ", "=", " ", 
        RowBox[{"m", " ", "&&", " ", 
         RowBox[{"ValidCon", "[", 
          RowBox[{"name", ",", " ", 
           RowBox[{
           "\[Eta]", "\[LeftDoubleBracket]", "2", "\[RightDoubleBracket]"}], 
           ",", 
           RowBox[{"{", "\[DoubleStruckA]", "}"}]}], "]"}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{"m", ",", " ", "\[IndentingNewLine]", 
         RowBox[{"(*", " ", 
          RowBox[{"compute", " ", 
           RowBox[{"\[Phi]", "[", 
            RowBox[{"q", ",", " ", "v"}], "]"}]}], " ", "*)"}], 
         "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"\[Phi]", " ", "=", " ", 
           RowBox[{"RBDExpandExpression", "@", 
            RowBox[{"If", "[", 
             RowBox[{"\[Phi]bool", ",", " ", 
              RowBox[{"e", " ", "/.", " ", 
               RowBox[{"Thread", "[", 
                RowBox[{"a", " ", "\[Rule]", " ", "0"}], "]"}]}], ",", " ", 
              "z1"}], "]"}]}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"AddCon", "[", 
           RowBox[{"name", ",", " ", "t", ",", " ", "n", ",", " ", 
            RowBox[{"\"\<J\>\"", " ", "\[Rule]", " ", "J"}], ",", " ", 
            RowBox[{"\"\<\[Phi]\>\"", " ", "\[Rule]", " ", "\[Phi]"}], ",", 
            " ", 
            RowBox[{"\"\<\[Eta]\>\"", " ", "\[Rule]", " ", "\[Eta]"}], ",", 
            " ", 
            RowBox[{"\"\<K\>\"", " ", "\[Rule]", " ", 
             RowBox[{"{", 
              RowBox[{"Kp", ",", " ", "Kv"}], "}"}]}]}], "]"}]}]}], 
        "\[IndentingNewLine]", "]"}]}]}], "\[IndentingNewLine]", "]"}]}], 
   ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"ConB", "[", 
     RowBox[{"name_", ",", " ", 
      RowBox[{
       RowBox[{
        RowBox[{"Derivative", "[", "1", "]"}], "[", "\[DoubleStruckB]", "]"}],
        "[", "x__", "]"}], ",", " ", "t_", ",", " ", "rdot_", ",", "  ", 
      "Kp_", ",", " ", "Kv_", ",", " ", "n_", ",", " ", 
      RowBox[{"v_:", "1"}]}], "]"}], " ", ":=", " ", 
    RowBox[{"ConB", "[", 
     RowBox[{"name", ",", " ", 
      RowBox[{"\[DoubleStruckB]", "[", "x", "]"}], ",", " ", "t", ",", " ", 
      "rdot", ",", "  ", "Kp", ",", " ", "Kv", ",", " ", "n", ",", " ", "v"}],
      "]"}]}], ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"ConB", "[", 
    RowBox[{
    "name_", ",", " ", "expr_\[DoubleStruckB]", ",", " ", "t_", ",", " ", 
     "rdot_", ",", " ", "Kp_", ",", " ", "Kv_", ",", " ", "n_", ",", " ", 
     RowBox[{"v_:", "0"}]}], "]"}], " ", ":=", " ", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"b", ",", " ", "r", ",", " ", "Xcb", ",", " ", "o"}], "}"}], 
     ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{
       RowBox[{"{", 
        RowBox[{"b", ",", " ", "r", ",", " ", "Xcb", ",", " ", "o"}], "}"}], 
       " ", "=", " ", 
       RowBox[{"expr", " ", "/.", " ", 
        RowBox[{
         RowBox[{"\[DoubleStruckB]", "[", 
          RowBox[{"b_", ",", " ", "r_", ",", " ", "Xcb_", ",", " ", "o___"}], 
          "]"}], " ", "\[RuleDelayed]", " ", 
         RowBox[{"{", 
          RowBox[{"b", ",", " ", "r", ",", " ", "Xcb", ",", " ", 
           RowBox[{"{", "o", "}"}]}], "}"}]}]}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"o", " ", "=", " ", 
       RowBox[{"OptionValue", "[", 
        RowBox[{"\[DoubleStruckB]", ",", " ", "o", ",", " ", 
         RowBox[{"{", 
          RowBox[{"\"\<a\>\"", ",", " ", "\"\<o\>\""}], "}"}]}], "]"}]}], ";",
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"b", " ", "=", " ", 
       RowBox[{"RBDGetPositionIndex", "@", 
        RowBox[{"Prepend", "[", 
         RowBox[{"o", ",", " ", "b"}], "]"}]}]}], ";", "\[IndentingNewLine]", 
      
      RowBox[{"b", " ", "=", " ", 
       RowBox[{"Append", "[", 
        RowBox[{"b", ",", " ", "v"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"r", " ", "=", " ", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"IntegerQ", "[", "r", "]"}], ",", " ", 
         RowBox[{
          RowBox[{"Sign", "[", "r", "]"}], 
          RowBox[{"I6", "\[LeftDoubleBracket]", 
           RowBox[{"Abs", "@", "r"}], "\[RightDoubleBracket]"}]}], ",", " ", 
         "r"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"Xcb", " ", "=", " ", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"VectorQ", "[", "Xcb", "]"}], ",", " ", 
         RowBox[{"Xba", "[", 
          RowBox[{"PadLeft", "[", 
           RowBox[{"Xcb", ",", " ", "nm"}], "]"}], "]"}], ",", " ", "Xcb"}], 
        "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"r", " ", "=", " ", 
       RowBox[{"RBDExpandExpression", "[", "r", "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"Xcb", " ", "=", " ", 
       RowBox[{"RBDExpandExpression", "[", "Xcb", "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"AddCon", "[", 
       RowBox[{"name", ",", " ", "t", ",", " ", "n", ",", " ", 
        RowBox[{"\"\<b\>\"", " ", "\[Rule]", " ", "b"}], ",", " ", 
        RowBox[{"\"\<r\>\"", " ", "\[Rule]", " ", "r"}], ",", " ", 
        RowBox[{"\"\<X\>\"", " ", "\[Rule]", " ", "Xcb"}], ",", " ", 
        RowBox[{"\"\<rdot\>\"", " ", "\[Rule]", " ", "rdot"}], ",", " ", 
        RowBox[{"\"\<K\>\"", " ", "\[Rule]", " ", 
         RowBox[{"{", 
          RowBox[{"Kp", ",", " ", "Kv"}], "}"}]}]}], "]"}], ";"}]}], 
    "\[IndentingNewLine]", "]"}]}], ";"}]}], "Input",
 InitializationCell->
  True,ExpressionUUID->"002d863b-3d90-462a-b516-5ae22d725596"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"Options", "[", "AddCon", "]"}], " ", "=", " ", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"\"\<J\>\"", " ", "\[RuleDelayed]", " ", "zq"}], ",", " ", 
      RowBox[{"\"\<\[Phi]\>\"", " ", "\[Rule]", " ", "z1"}], ",", " ", 
      RowBox[{"\"\<b\>\"", " ", "\[Rule]", " ", 
       RowBox[{"{", "}"}]}], ",", " ", 
      RowBox[{"\"\<r\>\"", " ", "\[Rule]", " ", 
       RowBox[{"{", "}"}]}], ",", " ", 
      RowBox[{"\"\<X\>\"", " ", "\[Rule]", " ", 
       RowBox[{"{", "}"}]}], ",", " ", 
      RowBox[{"\"\<rdot\>\"", " ", "\[Rule]", " ", 
       RowBox[{"{", "}"}]}], ",", " ", 
      RowBox[{"\"\<\[Eta]\>\"", " ", "\[Rule]", " ", 
       RowBox[{"{", 
        RowBox[{"z1", ",", " ", "z1"}], "}"}]}], ",", " ", 
      RowBox[{"\"\<K\>\"", " ", "\[Rule]", " ", 
       RowBox[{"{", 
        RowBox[{"z1", ",", " ", "z1"}], "}"}]}]}], "}"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"AddCon", "::", "t"}], " ", "=", " ", 
    "\"\<A constraint in `1` corresponding to row `2` in J is not of type \
`3`.  It has type `4`.  Row `2` in J will stay type `3`.\>\""}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"AddCon", "::", "K"}], " ", "=", " ", 
    "\"\<Encountered different gain values, (Kp, Kv) = `4`, in constraint `1` \
corresponding to row `2` in \[Eta].  The gains will remain (Kp, Kv) = \
`3`.\>\""}], ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"AddCon", "[", 
    RowBox[{"name_", ",", " ", "t_", ",", " ", "n_", ",", " ", 
     RowBox[{"OptionsPattern", "[", "]"}]}], "]"}], " ", ":=", " ", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "m", ",", " ", "J", ",", " ", "\[Phi]", ",", " ", "\[Eta]", ",", " ", 
       "J\[Phi]\[Eta]", ",", " ", "b", ",", " ", "r", ",", " ", "X", ",", " ",
        "rdot", ",", " ", "brX", ",", " ", "K"}], "}"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"J\[Phi]\[Eta]", " ", "=", " ", 
       RowBox[{"{", 
        RowBox[{
        "\"\<J\>\"", ",", " ", "\"\<\[Phi]\>\"", ",", " ", "\"\<\[Eta]\>\""}],
         "}"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"J", ",", " ", "\[Phi]", ",", "\[Eta]"}], "}"}], " ", "=", 
       " ", 
       RowBox[{
        RowBox[{
         RowBox[{"OptionValue", "[", "#", "]"}], "&"}], " ", "/@", " ", 
        "J\[Phi]\[Eta]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"J\[Phi]\[Eta]", " ", "=", " ", 
       RowBox[{"{", 
        RowBox[{"J\[Phi]\[Eta]", ",", " ", 
         RowBox[{"{", 
          RowBox[{"J", ",", " ", "\[Phi]", ",", " ", "\[Eta]"}], "}"}]}], 
        "}"}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"brX", " ", "=", " ", 
       RowBox[{"{", 
        RowBox[{
        "\"\<b\>\"", ",", " ", "\"\<r\>\"", ",", " ", "\"\<X\>\"", ",", " ", 
         "\"\<rdot\>\""}], "}"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"OptionValue", "[", "\"\<b\>\"", "]"}], " ", "===", " ", 
         RowBox[{"{", "}"}]}], ",", " ", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{
          RowBox[{"{", 
           RowBox[{"b", ",", " ", "r", ",", " ", "X", ",", " ", "rdot"}], 
           "}"}], " ", "=", " ", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"{", "}"}], ",", " ", 
            RowBox[{"{", "}"}], ",", " ", 
            RowBox[{"{", "}"}], ",", " ", 
            RowBox[{"{", "}"}]}], "}"}]}], ";"}], ",", " ", 
        "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{
          RowBox[{"{", 
           RowBox[{"b", ",", " ", "r", ",", " ", "X", ",", " ", "rdot"}], 
           "}"}], " ", "=", "  ", 
          RowBox[{
           RowBox[{
            RowBox[{"{", 
             RowBox[{"OptionValue", "[", "#", "]"}], "}"}], "&"}], " ", "/@", 
           " ", "brX"}]}], ";"}]}], "\[IndentingNewLine]", "]"}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"brX", " ", "=", " ", 
       RowBox[{"{", 
        RowBox[{"brX", ",", " ", 
         RowBox[{"{", 
          RowBox[{"b", ",", " ", "r", ",", " ", "X", ",", " ", "rdot"}], 
          "}"}]}], "}"}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"K", " ", "=", " ", 
       RowBox[{"OptionValue", "[", "\"\<K\>\"", "]"}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
        RowBox[{"add", "/", "update"}], " ", "constraint", " ", "entry"}], 
       " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{"Which", "[", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"!", 
         RowBox[{"MissingQ", "[", 
          RowBox[{"rb", "[", 
           RowBox[{"C", ",", " ", "\"\<n\>\"", ",", " ", "n"}], "]"}], 
          "]"}]}], ",", "\[IndentingNewLine]", 
        RowBox[{"(*", " ", 
         RowBox[{
         "append", " ", "to", " ", "old", " ", "constraint", " ", "entry"}], 
         " ", "*)"}], "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"m", " ", "=", " ", 
          RowBox[{"rb", "[", 
           RowBox[{"C", ",", " ", "\"\<n\>\"", ",", " ", "n"}], "]"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"MapThread", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"(", 
             RowBox[{
              RowBox[{
               RowBox[{"rb", "\[LeftDoubleBracket]", 
                RowBox[{
                 RowBox[{"Key", "@", "C"}], ",", " ", "#1", ",", " ", "m"}], 
                "\[RightDoubleBracket]"}], " ", "+=", " ", "#2"}], ";"}], 
             ")"}], "&"}], ",", " ", "J\[Phi]\[Eta]"}], "]"}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"MapThread", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"(", 
             RowBox[{
              RowBox[{
               RowBox[{"rb", "\[LeftDoubleBracket]", 
                RowBox[{
                 RowBox[{"Key", "@", "C"}], ",", " ", "#1", ",", " ", "m"}], 
                "\[RightDoubleBracket]"}], " ", "=", " ", 
               RowBox[{"Join", "[", 
                RowBox[{
                 RowBox[{"rb", "\[LeftDoubleBracket]", 
                  RowBox[{
                   RowBox[{"Key", "@", "C"}], ",", " ", "#1", ",", " ", "m"}],
                   "\[RightDoubleBracket]"}], ",", " ", "#2"}], "]"}]}], 
              ";"}], ")"}], "&"}], ",", " ", "brX"}], "]"}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"(*", " ", 
          RowBox[{"are", " ", "constraints", " ", "the", " ", "same", " ", 
           RowBox[{"type", "?"}]}], " ", "*)"}], "\[IndentingNewLine]", 
         RowBox[{"b", " ", "=", " ", 
          RowBox[{"rb", "\[LeftDoubleBracket]", 
           RowBox[{
            RowBox[{"Key", "@", "C"}], ",", " ", "\"\<t\>\"", ",", " ", "m"}],
            "\[RightDoubleBracket]"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{"b", " ", "\[NotEqual]", " ", "t"}], ",", " ", 
           RowBox[{"Message", "[", 
            RowBox[{
             RowBox[{"AddCon", "::", "t"}], ",", " ", "name", ",", " ", "m", 
             ",", " ", "b", ",", " ", "t"}], "]"}]}], "]"}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"(*", " ", 
          RowBox[{"are", " ", "gains", " ", "the", " ", 
           RowBox[{"same", "?"}]}], " ", "*)"}], "\[IndentingNewLine]", 
         RowBox[{"b", " ", "=", " ", 
          RowBox[{"rb", "\[LeftDoubleBracket]", 
           RowBox[{
            RowBox[{"Key", "@", "C"}], ",", " ", "\"\<K\>\"", ",", " ", "m"}],
            "\[RightDoubleBracket]"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{"b", " ", "=!=", " ", "K"}], ",", " ", 
           RowBox[{"Message", "[", 
            RowBox[{
             RowBox[{"AddCon", "::", "K"}], ",", " ", "name", ",", " ", "m", 
             ",", " ", "b", ",", " ", "K"}], "]"}]}], "]"}], ";"}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{"!", 
         RowBox[{"MissingQ", "[", 
          RowBox[{"rb", "[", 
           RowBox[{"C", ",", " ", "\"\<n\>\""}], "]"}], "]"}]}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{"(*", " ", 
         RowBox[{
         "add", " ", "new", " ", "entry", " ", "to", " ", "constraint"}], " ",
          "*)"}], "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"MapThread", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"(", 
             RowBox[{
              RowBox[{
               RowBox[{"rb", "\[LeftDoubleBracket]", 
                RowBox[{
                 RowBox[{"Key", "@", "C"}], ",", " ", "#1"}], 
                "\[RightDoubleBracket]"}], " ", "=", " ", 
               RowBox[{"Join", "[", 
                RowBox[{
                 RowBox[{"rb", "[", 
                  RowBox[{"C", ",", " ", "#1"}], "]"}], ",", " ", 
                 RowBox[{"{", "#2", "}"}]}], "]"}]}], ";"}], ")"}], "&"}], 
           ",", " ", "J\[Phi]\[Eta]"}], "]"}], ";", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"rb", "[", 
           RowBox[{"C", ",", " ", "\"\<t\>\""}], "]"}], " ", "=", " ", 
          RowBox[{"Join", "[", 
           RowBox[{
            RowBox[{"rb", "[", 
             RowBox[{"C", ",", " ", "\"\<t\>\""}], "]"}], ",", " ", 
            RowBox[{"{", "t", "}"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"rb", "[", 
           RowBox[{"C", ",", " ", "\"\<K\>\""}], "]"}], " ", "=", " ", 
          RowBox[{"Join", "[", 
           RowBox[{
            RowBox[{"rb", "[", 
             RowBox[{"C", ",", " ", "\"\<K\>\""}], "]"}], ",", " ", 
            RowBox[{"{", "K", "}"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"m", " ", "=", " ", 
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{"n", " ", "===", " ", "Automatic"}], ",", " ", 
            RowBox[{
             RowBox[{"Max", "[", 
              RowBox[{"Keys", "@", 
               RowBox[{"rb", "[", 
                RowBox[{"C", ",", " ", "\"\<n\>\""}], "]"}]}], "]"}], "+", 
             "1"}], ",", " ", "n"}], "]"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"(*", " ", 
          RowBox[{
          "map", " ", "n", " ", "to", " ", "actual", " ", "index", " ", "in", 
           " ", "J"}], " ", "*)"}], "\[IndentingNewLine]", 
         RowBox[{"m", " ", "=", " ", 
          RowBox[{
           RowBox[{"rb", "[", 
            RowBox[{"C", ",", " ", "\"\<n\>\"", ",", " ", "m"}], "]"}], " ", 
           "=", " ", 
           RowBox[{"Length", "@", 
            RowBox[{"rb", "[", 
             RowBox[{"C", ",", " ", "\"\<J\>\""}], "]"}]}]}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"MapThread", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"(", 
             RowBox[{
              RowBox[{
               RowBox[{"rb", "[", 
                RowBox[{"C", ",", " ", "#1", ",", " ", "m"}], "]"}], " ", "=",
                " ", "#2"}], ";"}], ")"}], "&"}], ",", " ", "brX"}], "]"}], 
         ";"}], ",", "\[IndentingNewLine]", "True", ",", 
        "\[IndentingNewLine]", 
        RowBox[{"(*", " ", 
         RowBox[{"add", " ", "brand", " ", "new", " ", "constraint"}], " ", 
         "*)"}], "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"m", " ", "=", " ", 
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{"n", " ", "===", " ", "Automatic"}], ",", " ", "1", ",", 
            " ", "n"}], "]"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"rb", "[", "C", "]"}], " ", "=", " ", 
          RowBox[{"<|", 
           RowBox[{
            RowBox[{"\"\<n\>\"", " ", "\[Rule]", " ", 
             RowBox[{"<|", 
              RowBox[{"m", " ", "\[Rule]", " ", "1"}], "|>"}]}], ",", " ", 
            RowBox[{"\"\<t\>\"", " ", "\[Rule]", " ", 
             RowBox[{"{", "t", "}"}]}], ",", " ", 
            RowBox[{"\"\<K\>\"", " ", "\[Rule]", " ", 
             RowBox[{"{", "K", "}"}]}]}], "|>"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"AssociateTo", "[", 
          RowBox[{
           RowBox[{"rb", "[", "C", "]"}], ",", " ", 
           RowBox[{"MapThread", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"#1", " ", "\[Rule]", " ", 
               RowBox[{"{", "#2", "}"}]}], "&"}], ",", " ", "J\[Phi]\[Eta]"}],
             "]"}]}], "]"}], ";", "\[IndentingNewLine]", 
         RowBox[{"AssociateTo", "[", 
          RowBox[{
           RowBox[{"rb", "[", "C", "]"}], ",", " ", 
           RowBox[{"MapThread", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"#1", " ", "\[Rule]", " ", 
               RowBox[{"<|", 
                RowBox[{"1", " ", "\[Rule]", " ", "#2"}], "|>"}]}], "&"}], 
             ",", "  ", "brX"}], "]"}]}], "]"}], ";"}]}], 
       "\[IndentingNewLine]", "]"}], ";"}]}], "\[IndentingNewLine]", "]"}]}], 
  ";"}]}], "Input",
 InitializationCell->
  True,ExpressionUUID->"47bf5bdb-1b44-4beb-a980-436b213be2f3"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"MakeSparse", "[", "x_", "]"}], " ", ":=", " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", "d", "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
       "pad", " ", "ragged", " ", "arrays", " ", "to", " ", "full", " ", 
        "array", " ", "for", " ", "use", " ", "in", " ", "Compile"}], " ", 
       "*)"}], "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"d", " ", "=", " ", 
        RowBox[{"Map", "[", 
         RowBox[{"Dimensions", ",", " ", "x", ",", " ", 
          RowBox[{"{", "1", "}"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"d", " ", "=", " ", 
        RowBox[{"Prepend", "[", 
         RowBox[{
          RowBox[{"MapThread", "[", 
           RowBox[{"Max", ",", " ", "d"}], "]"}], ",", " ", 
          RowBox[{"Length", "@", "d"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"SparseArray", "@", 
        RowBox[{"PadRight", "[", 
         RowBox[{"x", ",", " ", "d"}], "]"}]}]}]}], "\[IndentingNewLine]", 
     "]"}]}], ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"ConBFunctions", "[", 
    RowBox[{"B_:", "True"}], "]"}], " ", ":=", " ", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "b", ",", " ", "r", ",", " ", "X", ",", " ", "dot", ",", " ", "rdot", 
       ",", " ", "Xdot", ",", " ", "bo", ",", " ", "ba", ",", " ", "bs", ",", 
       " ", "bx", ",", " ", "f"}], "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"b", " ", "=", " ", 
       RowBox[{"Select", "[", 
        RowBox[{
         RowBox[{"rb", "[", 
          RowBox[{"C", ",", " ", "\"\<b\>\""}], "]"}], ",", " ", 
         RowBox[{
          RowBox[{"#", " ", "=!=", " ", 
           RowBox[{"{", "}"}]}], "&"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"B", " ", "&&", " ", 
         RowBox[{"AssociationQ", "[", "b", "]"}], " ", "&&", " ", 
         RowBox[{
          RowBox[{"Length", "@", "b"}], " ", ">", " ", "0"}]}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"r", " ", "=", " ", 
          RowBox[{"Values", "@", 
           RowBox[{"Select", "[", 
            RowBox[{
             RowBox[{"rb", "[", 
              RowBox[{"C", ",", " ", "\"\<r\>\""}], "]"}], ",", " ", 
             RowBox[{
              RowBox[{"#", " ", "=!=", " ", 
               RowBox[{"{", "}"}]}], "&"}]}], "]"}]}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"X", " ", "=", " ", 
          RowBox[{"Values", "@", 
           RowBox[{"Select", "[", 
            RowBox[{
             RowBox[{"rb", "[", 
              RowBox[{"C", ",", " ", "\"\<X\>\""}], "]"}], ",", " ", 
             RowBox[{
              RowBox[{"#", " ", "=!=", " ", 
               RowBox[{"{", "}"}]}], "&"}]}], "]"}]}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"dot", " ", "=", " ", 
          RowBox[{"Values", "@", 
           RowBox[{"Select", "[", 
            RowBox[{
             RowBox[{"rb", "[", 
              RowBox[{"C", ",", " ", "\"\<rdot\>\""}], "]"}], ",", " ", 
             RowBox[{
              RowBox[{"#", " ", "=!=", " ", 
               RowBox[{"{", "}"}]}], "&"}]}], "]"}]}]}], ";", 
         "\[IndentingNewLine]", "\[IndentingNewLine]", 
         RowBox[{"(*", " ", 
          RowBox[{
          "make", " ", "X", " ", "into", " ", "translation", " ", "matrix"}], 
          " ", "*)"}], "\[IndentingNewLine]", 
         RowBox[{"Do", "[", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{
            RowBox[{"X", "\[LeftDoubleBracket]", 
             RowBox[{"i", ",", " ", "j", ",", " ", 
              RowBox[{"1", ";;", "3"}], ",", 
              RowBox[{"1", ";;", "3"}]}], "\[RightDoubleBracket]"}], " ", "=",
             " ", 
            RowBox[{
             RowBox[{"X", "\[LeftDoubleBracket]", 
              RowBox[{"i", ",", " ", "j", ",", " ", 
               RowBox[{"4", ";;", "6"}], ",", 
               RowBox[{"4", ";;", "6"}]}], "\[RightDoubleBracket]"}], " ", 
             "=", " ", "I3"}]}], ",", " ", "\[IndentingNewLine]", 
           RowBox[{"{", 
            RowBox[{"i", ",", " ", 
             RowBox[{"Length", "@", "X"}]}], "}"}], ",", " ", 
           RowBox[{"{", 
            RowBox[{"j", ",", " ", 
             RowBox[{"Length", "@", 
              RowBox[{
              "X", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}]}]}],
             "}"}]}], "\[IndentingNewLine]", "]"}], ";", 
         "\[IndentingNewLine]", "\[IndentingNewLine]", 
         RowBox[{"(*", " ", 
          RowBox[{
          "create", " ", "dots", " ", "based", " ", "on", " ", "Jdot", " ", 
           "options"}], " ", "*)"}], "\[IndentingNewLine]", 
         RowBox[{"f", " ", "=", " ", 
          RowBox[{
           RowBox[{"Table", "[", 
            RowBox[{
             RowBox[{"If", "[", 
              RowBox[{
               RowBox[{"dot", "\[LeftDoubleBracket]", 
                RowBox[{"i", ",", " ", "j"}], "\[RightDoubleBracket]"}], ",", 
               " ", 
               RowBox[{"#1", "\[LeftDoubleBracket]", 
                RowBox[{"i", ",", " ", "j"}], "\[RightDoubleBracket]"}], ",", 
               " ", "#2"}], "]"}], ",", " ", 
             RowBox[{"{", 
              RowBox[{"i", ",", " ", 
               RowBox[{"Length", "@", "b"}]}], "}"}], ",", " ", 
             RowBox[{"{", 
              RowBox[{"j", ",", " ", 
               RowBox[{"Length", "@", 
                RowBox[{
                "b", "\[LeftDoubleBracket]", "i", 
                 "\[RightDoubleBracket]"}]}]}], "}"}]}], "]"}], "&"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"rdot", " ", "=", " ", 
          RowBox[{"f", "[", 
           RowBox[{"r", ",", " ", "z6"}], "]"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"Xdot", " ", "=", " ", 
          RowBox[{"f", "[", 
           RowBox[{"X", ",", " ", "Z6"}], "]"}]}], ";", "\[IndentingNewLine]",
          "\[IndentingNewLine]", 
         RowBox[{"(*", " ", 
          RowBox[{
          "collapse", " ", "ragged", " ", "list", " ", "into", " ", "one", 
           " ", "big", " ", "linear", " ", "array"}], " ", "*)"}], 
         "\[IndentingNewLine]", 
         RowBox[{"(*", " ", 
          RowBox[{
           RowBox[{"b", "[", "i", "]"}], " ", "=", " ", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"b", " ", "=", " ", 
              RowBox[{"body", " ", "#"}]}], ",", " ", 
             RowBox[{"a", " ", "=", " ", 
              RowBox[{"stopping", " ", "#"}]}], ",", " ", 
             RowBox[{"o", " ", "=", " ", 
              RowBox[{"o", " ", "frame"}]}], ",", " ", 
             RowBox[{"v", " ", "=", " ", 
              RowBox[{"velocity", " ", "constraint", " ", "if", " ", "0"}]}], 
             ",", " ", 
             RowBox[{"i", " ", "=", " ", 
              RowBox[{"con", " ", "#", " ", "in", " ", "J"}]}]}], "}"}]}], 
          " ", "*)"}], "\[IndentingNewLine]", 
         RowBox[{"b", " ", "=", " ", 
          RowBox[{"Join", "@@", 
           RowBox[{"Table", "[", 
            RowBox[{
             RowBox[{"Join", "[", 
              RowBox[{"e", ",", " ", 
               RowBox[{"{", "k", "}"}]}], "]"}], ",", " ", 
             RowBox[{"{", 
              RowBox[{"k", ",", " ", 
               RowBox[{"Keys", "@", "b"}]}], "}"}], ",", " ", 
             RowBox[{"{", 
              RowBox[{"e", ",", " ", 
               RowBox[{"b", "[", "k", "]"}]}], "}"}]}], "]"}]}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"X", " ", "=", " ", 
          RowBox[{"Join", "@@", "X"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"r", " ", "=", " ", 
          RowBox[{"Join", "@@", "r"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"rdot", " ", "=", " ", 
          RowBox[{"Join", "@@", "rdot"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"Xdot", " ", "=", " ", 
          RowBox[{"Join", "@@", "Xdot"}]}], ";", "\[IndentingNewLine]", 
         "\[IndentingNewLine]", 
         RowBox[{"(*", " ", 
          RowBox[{"make", " ", "functions"}], " ", "*)"}], 
         "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"r", ",", " ", "X"}], "}"}], " ", "=", " ", 
          RowBox[{"ConvertToXLFunction", " ", "/@", " ", 
           RowBox[{"{", 
            RowBox[{"r", ",", " ", "X"}], "}"}]}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"rdot", ",", " ", "Xdot"}], "}"}], " ", "=", " ", 
          RowBox[{
           RowBox[{
            RowBox[{
             RowBox[{"ConvertToXLFunction", "[", 
              RowBox[{"#", ",", " ", 
               RowBox[{"\"\<dot\>\"", " ", "\[Rule]", " ", "True"}]}], "]"}], 
             "\[LeftDoubleBracket]", "2", "\[RightDoubleBracket]"}], "&"}], 
           " ", "/@", " ", 
           RowBox[{"{", 
            RowBox[{"rdot", ",", " ", "Xdot"}], "}"}]}]}], ";", 
         "\[IndentingNewLine]", "\[IndentingNewLine]", 
         RowBox[{"(*", " ", 
          RowBox[{"process", " ", "data"}], " ", "*)"}], 
         "\[IndentingNewLine]", 
         RowBox[{"(*", " ", 
          RowBox[{
          "no", " ", "point", " ", "in", " ", "having", " ", "body", " ", "a",
            " ", "in", " ", "a", " ", "different", " ", "branch", " ", "or", 
           " ", "a", " ", "child", " ", "of", " ", "b"}], " ", "*)"}], 
         "\[IndentingNewLine]", 
         RowBox[{"f", " ", "=", " ", 
          RowBox[{
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"#1", " ", ">", " ", "0"}], " ", "&&", " ", 
              RowBox[{"#2", " ", ">", " ", "0"}], " ", "&&", " ", 
              RowBox[{
               RowBox[{"nca", "\[LeftDoubleBracket]", 
                RowBox[{"#1", ",", " ", "#2"}], "\[RightDoubleBracket]"}], 
               " ", "\[NotEqual]", " ", "#2"}]}], ",", 
             RowBox[{
              RowBox[{"Message", "[", 
               RowBox[{
                RowBox[{"RBDConstraintFunctions", "::", "a"}], ",", " ", 
                RowBox[{"RBDGetValue", "[", "#2", "]"}], ",", " ", 
                RowBox[{"RBDGetValue", "[", "#1", "]"}], ",", " ", "Root"}], 
               "]"}], ";", " ", "0"}], ",", " ", 
             RowBox[{"(*", " ", "else", " ", "*)"}], " ", "#2"}], "]"}], 
           "&"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"(*", " ", 
          RowBox[{
          "project", " ", "a", " ", "to", " ", "root", " ", "if", " ", "a", 
           " ", "is", " ", "not", " ", "a", " ", "nearest", " ", "common", 
           " ", "ancestor", " ", 
           RowBox[{"(", "nca", ")"}], " ", "of", " ", "b"}], " ", "*)"}], 
         "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"b", "\[LeftDoubleBracket]", 
           RowBox[{"All", ",", " ", "2"}], "\[RightDoubleBracket]"}], " ", 
          "=", " ", 
          RowBox[{"MapThread", "[", 
           RowBox[{"f", ",", " ", 
            RowBox[{
             RowBox[{"b", "\[LeftDoubleBracket]", 
              RowBox[{"All", ",", " ", 
               RowBox[{"1", ";;", "2"}]}], "\[RightDoubleBracket]"}], 
             "\[Transpose]"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
         "\[IndentingNewLine]", 
         RowBox[{"(*", " ", 
          RowBox[{
          "save", " ", "computation", " ", "on", " ", "matrices", " ", "used",
            " ", "in", " ", "world", " ", "to", " ", "body", " ", 
           "transforms", " ", "XL0"}], " ", "*)"}], "\[IndentingNewLine]", 
         RowBox[{"(*", " ", 
          RowBox[{
           RowBox[{
            RowBox[{
             RowBox[{"include", " ", "b"}], " ", "&"}], " ", "o", " ", 
            "frames", " ", "in", " ", "bx"}], ",", " ", 
           RowBox[{"ignore", " ", "all", " ", "other", " ", "frames"}]}], " ",
           "*)"}], "\[IndentingNewLine]", 
         RowBox[{"f", " ", "=", " ", 
          RowBox[{"DeleteDuplicates", " ", "/@", " ", 
           RowBox[{"Transpose", "@", 
            RowBox[{"b", "\[LeftDoubleBracket]", 
             RowBox[{"All", ",", " ", 
              RowBox[{"{", 
               RowBox[{"1", ",", " ", "3"}], "}"}]}], 
             "\[RightDoubleBracket]"}]}]}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"f", " ", "=", 
          RowBox[{"GetPath", "@", "f"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"bs", " ", "=", " ", 
          RowBox[{"Sort", "@", 
           RowBox[{"DeleteDuplicates", "@", 
            RowBox[{"Flatten", "@", 
             RowBox[{
             "f", "\[LeftDoubleBracket]", "1", 
              "\[RightDoubleBracket]"}]}]}]}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{"bs", " ", "=!=", " ", 
            RowBox[{"{", "}"}]}], ",", " ", 
           RowBox[{
            RowBox[{"bs", " ", "=", " ", 
             RowBox[{"Rest", "@", "bs"}]}], ";"}]}], "]"}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"bx", " ", "=", " ", 
          RowBox[{"Sort", "@", 
           RowBox[{"DeleteDuplicates", "@", 
            RowBox[{"Flatten", "@", "f"}]}]}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{"bx", " ", "=!=", " ", 
            RowBox[{"{", "}"}]}], ",", " ", 
           RowBox[{
            RowBox[{"bx", " ", "=", " ", 
             RowBox[{"Rest", "@", "bx"}]}], ";"}]}], "]"}], ";", 
         "\[IndentingNewLine]", "\[IndentingNewLine]", 
         RowBox[{"(*", " ", 
          RowBox[{
           RowBox[{"w", "/", " ", "b"}], " ", "and", " ", "o", " ", "can", 
           " ", "move", " ", "r", " ", "to", " ", "final", " ", 
           "coordinate"}], " ", "*)"}], "\[IndentingNewLine]", 
         RowBox[{"bo", " ", "=", " ", 
          RowBox[{"b", "\[LeftDoubleBracket]", 
           RowBox[{"All", ",", " ", 
            RowBox[{"{", 
             RowBox[{"1", ",", " ", "3"}], "}"}]}], 
           "\[RightDoubleBracket]"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"(*", " ", 
          RowBox[{
           RowBox[{"w", "/", " ", "b"}], " ", "and", " ", "a", " ", 
           RowBox[{"(", 
            RowBox[{"and", " ", "i", " ", "and", " ", "k"}], ")"}], " ", 
           "can", " ", "compute", " ", "Jacobian", " ", 
           RowBox[{"w", ".", "r", ".", "t"}], " ", "to", " ", "#", " ", "of", 
           " ", 
           RowBox[{"b", "'"}], "s"}], " ", "*)"}], "\[IndentingNewLine]", 
         RowBox[{"(*", " ", 
          RowBox[{
           RowBox[{"i", ".", "e", "."}], ",", " ", 
           RowBox[{
           "take", " ", "fewer", " ", "trips", " ", "up", " ", "the", " ", 
            "chain"}]}], " ", "*)"}], "\[IndentingNewLine]", 
         RowBox[{"ba", " ", "=", " ", 
          RowBox[{"MapIndexed", "[", 
           RowBox[{
            RowBox[{
             RowBox[{"Join", "[", "##", "]"}], "&"}], ",", " ", 
            RowBox[{"b", "\[LeftDoubleBracket]", 
             RowBox[{"All", ",", " ", 
              RowBox[{"{", 
               RowBox[{"1", ",", " ", "2", ",", " ", "4", ",", " ", "5"}], 
               "}"}]}], "\[RightDoubleBracket]"}]}], "]"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"(*", " ", 
          RowBox[{
           RowBox[{"ba", "[", "i", "]"}], " ", "=", " ", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"b", " ", "=", " ", 
              RowBox[{"body", " ", "#"}]}], ",", " ", 
             RowBox[{"a", " ", "=", " ", 
              RowBox[{"stopping", " ", "#"}]}], ",", " ", 
             RowBox[{"v", " ", "=", " ", 
              RowBox[{"velocity", " ", "constraint", " ", "if", " ", "0"}]}], 
             ",", " ", 
             RowBox[{"i", " ", "=", " ", 
              RowBox[{"con", " ", "#", " ", "in", " ", "J"}]}], ",", " ", 
             RowBox[{"k", " ", "=", " ", 
              RowBox[{"flattened", " ", "constraint", " ", "position"}]}]}], 
            "}"}]}], " ", "*)"}], "\[IndentingNewLine]", 
         RowBox[{"(*", " ", 
          RowBox[{
          "convert", " ", "ragged", " ", "lists", " ", "into", " ", "proper", 
           " ", "tensors"}], " ", "*)"}], "\[IndentingNewLine]", 
         RowBox[{"ba", " ", "=", " ", 
          RowBox[{"Normal", "@", 
           RowBox[{"MakeSparse", "@", 
            RowBox[{"GatherBy", "[", 
             RowBox[{"ba", ",", " ", 
              RowBox[{
               RowBox[{"#", "\[LeftDoubleBracket]", 
                RowBox[{"1", ";;", "2"}], "\[RightDoubleBracket]"}], "&"}]}], 
             "]"}]}]}]}], ";"}], ",", "\[IndentingNewLine]", 
        RowBox[{"(*", " ", "else", " ", "*)"}], "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"r", " ", "=", " ", 
          RowBox[{"X", "=", " ", 
           RowBox[{"rdot", " ", "=", " ", 
            RowBox[{"Xdot", " ", "=", " ", 
             RowBox[{"(", 
              RowBox[{
               RowBox[{"{", "}"}], "&"}], ")"}]}]}]}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"bo", " ", "=", " ", 
          RowBox[{"ba", " ", "=", " ", 
           RowBox[{"bs", " ", "=", " ", 
            RowBox[{"bx", " ", "=", " ", 
             RowBox[{"{", "}"}]}]}]}]}], ";"}]}], "\[IndentingNewLine]", 
       "]"}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"<|", 
       RowBox[{
        RowBox[{"\"\<r\>\"", " ", "\[Rule]", " ", "r"}], ",", " ", 
        RowBox[{"\"\<Tcb\>\"", " ", "\[Rule]", " ", "X"}], ",", " ", 
        RowBox[{"\"\<rdot\>\"", " ", "\[Rule]", " ", "rdot"}], ",", " ", 
        RowBox[{"\"\<Tcbdot\>\"", " ", "\[Rule]", " ", "Xdot"}], ",", " ", 
        RowBox[{"\"\<bo\>\"", " ", "\[Rule]", " ", "bo"}], ",", " ", 
        RowBox[{"\"\<ba\>\"", " ", "\[Rule]", " ", "ba"}], ",", " ", 
        RowBox[{"\"\<bs\>\"", " ", "\[Rule]", " ", "bs"}], ",", " ", 
        RowBox[{"\"\<bx\>\"", " ", "\[Rule]", " ", "bx"}]}], "|>"}]}]}], 
    "\[IndentingNewLine]", "]"}]}], ";"}]}], "Input",
 InitializationCell->
  True,ExpressionUUID->"ca812002-45c6-4972-bb86-c062db6aea58"]
}, Open  ]]
}, Open  ]],

Cell[CellGroupData[{

Cell["End Package", \
"Section",ExpressionUUID->"cd25305d-89ca-4874-b469-b84effc784b0"],

Cell[BoxData[{
 RowBox[{"End", "[", "]"}], "\[IndentingNewLine]", 
 RowBox[{"EndPackage", "[", "]"}]}], "Input",
 InitializationCell->
  True,ExpressionUUID->"aa2c11f7-81d1-4181-9320-98bfd137bd0f"]
}, Open  ]]
},
AutoGeneratedPackage->Automatic,
Evaluator->"Local",
WindowSize->{1373, 1505},
WindowMargins->{{0, Automatic}, {0, Automatic}},
PrivateNotebookOptions->{"FileOutlineCache"->False},
CellContext->"Global`",
TrackCellChangeTimes->False,
FrontEndVersion->"11.3 for Linux x86 (64-bit) (March 6, 2018)",
StyleDefinitions->"Default.nb"
]

