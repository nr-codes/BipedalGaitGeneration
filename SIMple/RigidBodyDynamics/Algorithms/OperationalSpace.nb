Notebook[{
Cell[BoxData[
 RowBox[{"(*", "\n", 
  RowBox[{
   RowBox[{"OperationalSpace", ".", 
    RowBox[{"nb", ":", " ", 
     RowBox[{
     "An", " ", "implementation", " ", "of", " ", "the", " ", "OSIM", " ", 
      "algorithm", "\n", "and", " ", "its", " ", 
      RowBox[{"derivative", ".", "\n", "Copyright"}], " ", 
      RowBox[{"(", "C", ")"}], " ", "2014", " ", "Nelson", " ", "Rosa", " ", 
      RowBox[{"Jr", ".", "\n", "\n", "This"}], " ", "program", " ", "is", " ",
       "free", " ", "software"}], ":", " ", 
     RowBox[{"you", " ", "can", " ", "redistribute", " ", "it", " ", 
      RowBox[{"and", "/", "or"}], " ", "modify", "\n", "it", " ", "under", 
      " ", "the", " ", "terms", " ", "of", " ", "the", " ", "GNU", " ", 
      "General", " ", "Public", " ", "License", " ", "as", " ", "published", 
      " ", "by", "\n", 
      RowBox[{"the", " ", "Free", " ", "Software", " ", "Foundation"}]}]}]}], 
   ",", " ", 
   RowBox[{
   "either", " ", "version", " ", "3", " ", "of", " ", "the", " ", 
    "License"}], ",", " ", 
   RowBox[{"or", "\n", 
    RowBox[{"(", 
     RowBox[{"at", " ", "your", " ", "option"}], ")"}], " ", "any", " ", 
    "later", " ", 
    RowBox[{"version", ".", " ", "This"}], " ", "program", " ", "is", " ", 
    "distributed", " ", "in", " ", "the", " ", "\n", "hope", " ", "that", " ",
     "it", " ", "will", " ", "be", " ", "useful"}], ",", " ", 
   RowBox[{
    RowBox[{"but", " ", "WITHOUT", " ", "ANY", " ", "WARRANTY"}], ";", " ", 
    RowBox[{
    "without", " ", "even", " ", "the", " ", "\n", "implied", " ", "warranty",
      " ", "of", " ", "MERCHANTABILITY", " ", "or", " ", "FITNESS", " ", 
     "FOR", " ", "A", " ", "PARTICULAR", " ", 
     RowBox[{"PURPOSE", ".", "\n", "See"}], " ", "the", " ", "GNU", " ", 
     "General", " ", "Public", " ", "License", " ", "for", " ", "more", " ", 
     RowBox[{"details", ".", " ", "You"}], " ", "should", " ", "have", " ", 
     "\n", "received", " ", "a", " ", "copy", " ", "of", " ", "the", " ", 
     "GNU", " ", "General", " ", "Public", " ", "License", " ", "along", " ", 
     "with", " ", "this", " ", 
     RowBox[{"program", ".", "\n", "If"}], " ", "not"}]}], ",", " ", 
   RowBox[{
    RowBox[{"see", " ", "<", 
     RowBox[{"http", ":"}]}], "//", 
    RowBox[{
     RowBox[{
      RowBox[{
       RowBox[{"www", ".", "gnu", ".", "org"}], "/", "licenses"}], "/"}], ">",
      "."}]}]}], "\n", "*)"}]], "Code",
 InitializationCell->
  True,ExpressionUUID->"80d6764f-9ed1-4e45-b557-d6116ad20c1f"],

Cell[CellGroupData[{

Cell["Begin Package", \
"Section",ExpressionUUID->"2981765b-1ae0-4662-8c4b-44fc1173c359"],

Cell[BoxData[{
 RowBox[{"BeginPackage", "[", 
  RowBox[{
  "\"\<RigidBodyDynamics`\>\"", ",", " ", "\"\<GlobalVariables`\>\""}], 
  "]"}], "\[IndentingNewLine]", 
 RowBox[{"Begin", "[", "\"\<`Private`\>\"", "]"}]}], "Input",
 InitializationCell->
  True,ExpressionUUID->"3a398533-f5fe-4be6-9faf-3d6fb0b1f99c"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", " ", 
   RowBox[{
    RowBox[{
     RowBox[{
     "Jacobian", " ", "maps", " ", "velocities", " ", "from", " ", "C"}], "-", 
     RowBox[{"space", " ", "to", " ", "O"}], "-", "space"}], ",", " ", 
    RowBox[{"J", " ", "=", " ", 
     RowBox[{"R", ".", "X", ".", "S"}]}]}], " ", "*)"}], 
  "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{
   "a", " ", "constraint", " ", "is", " ", "placed", " ", "somewhere", " ", 
    "on", " ", "body", " ", "b", " ", "represented", " ", "in", " ", "frame", 
    " ", "o"}], " ", "*)"}], "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{
   "moving", " ", "the", " ", "frame", " ", "around", " ", "increases", " ", 
    "the", " ", "degrees", " ", "of", " ", "freedom", " ", "a"}], " ", "*)"}],
   "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{
    RowBox[{"constraint", " ", 
     RowBox[{"has", ".", "  ", "for"}], " ", "example"}], ",", " ", 
    RowBox[{
     RowBox[{"a", " ", "constraint", " ", "where", " ", "o"}], " ", "=", " ", 
     
     RowBox[{"b", " ", "only", " ", "constrains"}]}]}], " ", "*)"}], 
  "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{
    RowBox[{
     RowBox[{
     "a", " ", "joint", " ", "space", " ", "variable", " ", "at", " ", "body",
       " ", "b", " ", "for", " ", "a", " ", "1"}], "-", 
     RowBox[{"dof", " ", "link"}]}], ";", " ", 
    RowBox[{"however", " ", "if"}]}], " ", "*)"}], " ", "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{
    RowBox[{"o", " ", "=", " ", "Root"}], ",", " ", 
    RowBox[{
    "then", " ", "all", " ", "joints", " ", "from", " ", "b", " ", "to", " ", 
     "Root", " ", "can", " ", "satisfy", " ", "the", " ", "constraint"}]}], 
   " ", "*)"}], "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{"at", " ", 
    RowBox[{"b", "."}]}], " ", "*)"}], "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{
    RowBox[{"b", " ", "=", " ", 
     RowBox[{"constraint", " ", "body", " ", "#"}]}], ",", " ", 
    RowBox[{
    "where", " ", "the", " ", "constraint", " ", "Xcb", " ", "is", " ", 
     "applied"}]}], " ", "*)"}], "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{"a", " ", "=", " ", 
    RowBox[{"ancestor", " ", "of", " ", "b"}]}], " ", "*)"}], 
  "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{"w", " ", "=", " ", 
    RowBox[{"Root", " ", "=", " ", 
     RowBox[{"0", " ", "or", " ", "world", " ", "frame"}]}]}], " ", "*)"}], 
  "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{"o", " ", "=", " ", 
    RowBox[{"origin", " ", "frame"}]}], " ", "*)"}], "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{"i", " ", "=", " ", 
    RowBox[{"constraint", " ", "number"}]}], " ", "*)"}], 
  "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{
    RowBox[{"the", " ", "following", " ", "computes", " ", 
     RowBox[{"J", "[", 
      RowBox[{"i", ",", "j"}], "]"}]}], " ", "=", " ", 
    RowBox[{
     RowBox[{"r", "[", "c", "]"}], ".", 
     RowBox[{"W", "[", 
      RowBox[{"c", ",", "b"}], "]"}], ".", 
     RowBox[{"X", "[", 
      RowBox[{"b", ",", "j"}], "]"}], ".", 
     RowBox[{"s", "[", "j", "]"}]}]}], " ", "*)"}], "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{"where", " ", 
    RowBox[{"W", "[", 
     RowBox[{"c", ",", "b"}], "]"}], " ", "expresses", " ", 
    RowBox[{"v", "[", "b", "]"}], " ", "in", " ", "a", " ", "frame", " ", 
    "located", " ", "at"}], " ", "*)"}], "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{"c", " ", "=", " ", 
    RowBox[{
     RowBox[{"(", 
      RowBox[{"px", ",", " ", "py", ",", " ", "pz"}], ")"}], " ", "with", " ",
      "an", " ", "orientation", " ", 
     RowBox[{"(", 
      RowBox[{"rx", ",", " ", "ry", ",", " ", "rz"}], ")"}]}]}], " ", "*)"}], 
  "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{"aligned", " ", "with", " ", "the", " ", "world", " ", "frame"}], 
   " ", "*)"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{
    RowBox[{
     RowBox[{
      RowBox[{"d", "/", "dt"}], " ", "Xba"}], " ", "=", " ", 
     RowBox[{
      RowBox[{"(", 
       RowBox[{"vba", " ", "-", " ", "vbb"}], ")"}], " ", "x", " ", "Xba"}]}],
     ",", " ", 
    RowBox[{
    "where", " ", "x", " ", "is", " ", "vector", " ", "cross", " ", 
     "product"}]}], " ", "*)"}], "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{
    RowBox[{
    "for", " ", "our", " ", "purposes", " ", "this", " ", "reduces", " ", 
     "to"}], " ", "-", 
    RowBox[{"vbb", " ", "x", " ", "Xba", " ", 
     RowBox[{"b", "/", "c"}], " ", "of", " ", "the", " ", "world", " ", 
     "frame"}]}], 
   "*)"}]}]], "Input",ExpressionUUID->"1bb6363c-e4f6-4a7f-9daa-b44b327d3d2d"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Task Jacobian", \
"Section",ExpressionUUID->"c8ac8437-8d1b-420f-9b78-8453ee275e39"],

Cell[CellGroupData[{

Cell["\<\
The task Jacobian is a transformation from joint velocties to \
operational-space velocities.\
\>", "Subsection",ExpressionUUID->"98092051-af53-4c02-bdaa-eb9ca01366f2"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", " ", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"user", " ", 
      RowBox[{"inputs", ":", " ", "none"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"zeroed", " ", 
      RowBox[{"inputs", ":", " ", "XL0"}]}]}], ",", " ", "X0L", ",", " ", 
    "XL0dot", ",", " ", 
    RowBox[{"X0Ldot", ";", "\[IndentingNewLine]", 
     RowBox[{"model", " ", 
      RowBox[{"data", ":", " ", "XL"}]}]}], ",", " ", "XLdot", ",", " ", 
    "parent", ",", " ", 
    RowBox[{"nq", ";", "\[IndentingNewLine]", 
     RowBox[{"modifies", ":", " ", "XL0"}]}], ",", " ", "X0L", ",", " ", 
    "XL0dot", ",", " ", 
    RowBox[{"X0Ldot", ";", "\[IndentingNewLine]", 
     RowBox[{"output", ":", " ", "XL0"}]}], ",", " ", "X0L", ",", " ", 
    "XL0dot", ",", " ", 
    RowBox[{"X0Ldot", " ", 
     RowBox[{"(", 
      RowBox[{"transforms", " ", 
       RowBox[{"from", "/", "to"}], " ", "root"}], ")"}]}]}], 
   "\[IndentingNewLine]", "*)"}], "\[IndentingNewLine]", 
  "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"X0", "[", "]"}], " ", ":=", " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"p", ",", " ", "X", ",", " ", "R", ",", " ", "P"}], "}"}], ",",
       "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{"compute", " ", "transform", " ", 
        RowBox[{"X", "[", 
         RowBox[{"b", ",", " ", "0"}], "]"}], " ", "or", " ", 
        RowBox[{"X", "[", 
         RowBox[{"o", ",", " ", "0"}], "]"}]}], " ", "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"XL0", " ", "=", " ", "XL"}], ";", "\[IndentingNewLine]", 
       RowBox[{"Do", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"p", " ", "=", " ", 
           RowBox[{
           "parent", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}]}],
           ";", "  ", 
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{"p", " ", ">", " ", "0"}], ",", " ", 
            RowBox[{
             RowBox[{"X", " ", "=", " ", 
              RowBox[{
              "XL0", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}]}],
              ";", " ", 
             RowBox[{
              RowBox[{
              "XL0", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}], 
              " ", "=", " ", 
              RowBox[{"X", ".", 
               RowBox[{
               "XL0", "\[LeftDoubleBracket]", "p", 
                "\[RightDoubleBracket]"}]}]}]}]}], "]"}], ";"}], ",", " ", 
         RowBox[{"{", 
          RowBox[{"i", ",", " ", "bx"}], "}"}]}], "]"}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"(*", " ", 
        RowBox[{"compute", " ", "inverse", " ", "transform"}], " ", "*)"}], 
       "\[IndentingNewLine]", 
       RowBox[{"X0L", " ", "=", " ", "XL0"}], ";", "\[IndentingNewLine]", 
       RowBox[{"Do", "[", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{
          RowBox[{"R", " ", "=", " ", 
           RowBox[{
            RowBox[{"X0L", "\[LeftDoubleBracket]", 
             RowBox[{"i", ",", 
              RowBox[{"1", ";;", "3"}], ",", 
              RowBox[{"1", ";;", "3"}]}], "\[RightDoubleBracket]"}], 
            "\[Transpose]"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"P", " ", "=", " ", 
           RowBox[{"-", 
            RowBox[{"X0L", "\[LeftDoubleBracket]", 
             RowBox[{"i", ",", 
              RowBox[{"4", ";;", "6"}], ",", 
              RowBox[{"1", ";;", "3"}]}], "\[RightDoubleBracket]"}]}]}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"X0L", "\[LeftDoubleBracket]", 
            RowBox[{"i", ",", 
             RowBox[{"1", ";;", "3"}], ",", 
             RowBox[{"1", ";;", "3"}]}], "\[RightDoubleBracket]"}], " ", "=", 
           " ", "R"}], ";", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"X0L", "\[LeftDoubleBracket]", 
            RowBox[{"i", ",", 
             RowBox[{"4", ";;", "6"}], ",", 
             RowBox[{"4", ";;", "6"}]}], "\[RightDoubleBracket]"}], " ", "=", 
           " ", "R"}], ";", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"X0L", "\[LeftDoubleBracket]", 
            RowBox[{"i", ",", 
             RowBox[{"4", ";;", "6"}], ",", 
             RowBox[{"1", ";;", "3"}]}], "\[RightDoubleBracket]"}], " ", "=", 
           " ", 
           RowBox[{"R", ".", "P", ".", "R"}]}], ";"}], ",", 
         "\[IndentingNewLine]", 
         RowBox[{"{", 
          RowBox[{"i", ",", " ", "bx"}], "}"}]}], "\[IndentingNewLine]", 
        "]"}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"(*", " ", 
        RowBox[{
        "create", " ", "corresponding", " ", "rotation", " ", "matrices"}], 
        " ", "*)"}], "\[IndentingNewLine]", 
       RowBox[{"RL0", " ", "=", " ", "XL0"}], ";", "\[IndentingNewLine]", 
       RowBox[{"Do", "[", 
        RowBox[{
         RowBox[{
          RowBox[{
           RowBox[{"RL0", "\[LeftDoubleBracket]", 
            RowBox[{"i", ",", " ", 
             RowBox[{"4", ";;", "6"}], ",", " ", 
             RowBox[{"1", ";;", "3"}]}], "\[RightDoubleBracket]"}], " ", "=", 
           " ", "Z3"}], ";"}], " ", ",", 
         RowBox[{"{", 
          RowBox[{"i", ",", " ", "bx"}], "}"}]}], "]"}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"R0L", " ", "=", " ", 
        RowBox[{"Transpose", "[", 
         RowBox[{"RL0", ",", " ", 
          RowBox[{"{", 
           RowBox[{"1", ",", " ", "3", ",", " ", "2"}], "}"}]}], "]"}]}], 
       ";"}]}], "\[IndentingNewLine]", "]"}]}], ";"}]}]], "Input",
 InitializationCell->
  True,ExpressionUUID->"769e96cd-2080-4e10-b0ab-ef2499419334"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
    RowBox[{"posX", " ", "=", " ", 
     RowBox[{
      RowBox[{"Join", "[", 
       RowBox[{"z3", ",", " ", 
        RowBox[{"position", "[", "#", "]"}]}], "]"}], "&"}]}], ";"}], "*)"}], 
  "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{"assuming", " ", "singularities", " ", 
    RowBox[{"won", "'"}], "t", " ", "occur"}], " ", "*)"}], 
  "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{
    RowBox[{"angX", " ", "=", " ", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        RowBox[{"ArcTan", "[", 
         RowBox[{
          RowBox[{"#", "\[LeftDoubleBracket]", 
           RowBox[{"3", ",", "3"}], "\[RightDoubleBracket]"}], ",", " ", 
          RowBox[{"-", 
           RowBox[{"#", "\[LeftDoubleBracket]", 
            RowBox[{"3", ",", "2"}], "\[RightDoubleBracket]"}]}]}], "]"}], 
        ",", " ", 
        RowBox[{"ArcSin", "[", 
         RowBox[{"#", "\[LeftDoubleBracket]", 
          RowBox[{"3", ",", "1"}], "\[RightDoubleBracket]"}], "]"}], ",", " ", 
        RowBox[{"ArcTan", "[", 
         RowBox[{
          RowBox[{"#", "\[LeftDoubleBracket]", 
           RowBox[{"1", ",", "1"}], "\[RightDoubleBracket]"}], ",", " ", 
          RowBox[{"-", 
           RowBox[{"#", "\[LeftDoubleBracket]", 
            RowBox[{"2", ",", "1"}], "\[RightDoubleBracket]"}]}]}], "]"}]}], 
       "}"}], "&"}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
    RowBox[{"posX", " ", "=", " ", 
     RowBox[{
      RowBox[{"position", "[", "#", "]"}], "&"}]}], ";"}], "*)"}], 
  "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"posX", " ", "=", " ", 
     RowBox[{
      RowBox[{"Join", "[", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{
          RowBox[{"ArcTan", "[", 
           RowBox[{
            RowBox[{"#2", "\[LeftDoubleBracket]", 
             RowBox[{"3", ",", "3"}], "\[RightDoubleBracket]"}], ",", " ", 
            RowBox[{"-", 
             RowBox[{"#2", "\[LeftDoubleBracket]", 
              RowBox[{"3", ",", "2"}], "\[RightDoubleBracket]"}]}]}], "]"}], 
          ",", " ", 
          RowBox[{"ArcSin", "[", 
           RowBox[{"#2", "\[LeftDoubleBracket]", 
            RowBox[{"3", ",", "1"}], "\[RightDoubleBracket]"}], "]"}], ",", 
          " ", 
          RowBox[{"ArcTan", "[", 
           RowBox[{
            RowBox[{"#2", "\[LeftDoubleBracket]", 
             RowBox[{"1", ",", "1"}], "\[RightDoubleBracket]"}], ",", " ", 
            RowBox[{"-", 
             RowBox[{"#2", "\[LeftDoubleBracket]", 
              RowBox[{"2", ",", "1"}], "\[RightDoubleBracket]"}]}]}], "]"}]}],
          "}"}], ",", " ", 
        RowBox[{"position", "[", "#1", "]"}]}], "]"}], "&"}]}], ";"}], 
   "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"V", "[", "]"}], " ", ":=", " ", 
     RowBox[{"Module", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"p", ",", " ", "vJ"}], "}"}], ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"v", " ", "=", " ", "zspat"}], ";", "\[IndentingNewLine]", 
        RowBox[{"Do", "[", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{
           RowBox[{"p", " ", "=", " ", 
            RowBox[{
            "parent", "\[LeftDoubleBracket]", "i", 
             "\[RightDoubleBracket]"}]}], ";", "\[IndentingNewLine]", 
           RowBox[{"vJ", " ", "=", " ", 
            RowBox[{
             RowBox[{
             "s", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}], " ", 
             RowBox[{
             "qd", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}]}]}],
            ";", "\[IndentingNewLine]", 
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{"p", " ", "\[Equal]", " ", "0"}], ",", " ", 
             "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{
               RowBox[{
               "v", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}], 
               " ", "=", " ", "vJ"}], ";"}], ",", " ", "\[IndentingNewLine]", 
             
             RowBox[{
              RowBox[{
               RowBox[{
               "v", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}], 
               " ", "=", " ", 
               RowBox[{
                RowBox[{
                 RowBox[{
                 "XL", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}],
                  ".", 
                 RowBox[{
                 "v", "\[LeftDoubleBracket]", "p", 
                  "\[RightDoubleBracket]"}]}], " ", "+", " ", "vJ"}]}], 
              ";"}]}], "\[IndentingNewLine]", "]"}], ";"}], ",", " ", 
          "\[IndentingNewLine]", 
          RowBox[{"{", 
           RowBox[{"i", ",", " ", "nq"}], "}"}]}], "\[IndentingNewLine]", 
         "]"}], ";"}]}], "\[IndentingNewLine]", "]"}]}], ";"}], 
   "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"rs0", "[", "]"}], " ", ":=", " ", 
     RowBox[{"Module", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
        "Xdot", ",", " ", "va", ",", " ", "vo0", ",", " ", "vX", ",", " ", 
         "b", ",", " ", "o", ",", " ", "X", ",", " ", "R"}], "}"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"(*", " ", 
        RowBox[{
        "move", " ", "joint", " ", "and", " ", "constraint", " ", "vectors", 
         " ", "into", " ", "world", " ", "frame"}], " ", "*)"}], 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"sj", " ", "=", " ", "s"}], ";", " ", 
        RowBox[{"(*", " ", 
         RowBox[{
          RowBox[{"move", " ", "s", " ", "into", " ", "world", " ", "frame"}],
           ",", " ", 
          RowBox[{"sj", " ", "=", " ", 
           RowBox[{
            RowBox[{"X", "[", 
             RowBox[{"0", ",", " ", "j"}], "]"}], ".", 
            RowBox[{"s", "[", 
             RowBox[{"j", ",", " ", "j"}], "]"}]}]}]}], " ", "*)"}], 
        "\[IndentingNewLine]", 
        RowBox[{"sjdot", " ", "=", " ", "sdot"}], ";", " ", 
        RowBox[{"(*", " ", 
         RowBox[{
         "move", " ", "sdot", " ", "into", " ", "world", " ", "frame"}], " ", 
         "*)"}], "\[IndentingNewLine]", 
        RowBox[{"Do", "[", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{
           RowBox[{
            RowBox[{
            "sj", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}], " ",
             "=", " ", 
            RowBox[{
             RowBox[{
             "X0L", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}], 
             ".", 
             RowBox[{
             "s", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}]}]}], 
           ";", "\[IndentingNewLine]", 
           RowBox[{"vX", " ", "=", " ", 
            RowBox[{
             RowBox[{
             "X0L", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}], 
             ".", 
             RowBox[{
             "v", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}]}]}], 
           ";", "\[IndentingNewLine]", 
           RowBox[{"Xdot", " ", "=", " ", 
            RowBox[{"mxX", "[", 
             RowBox[{"vX", ",", " ", 
              RowBox[{
              "X0L", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}]}],
              "]"}]}], ";", "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{
            "sjdot", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}], 
            " ", "=", " ", 
            RowBox[{
             RowBox[{
              RowBox[{
              "X0L", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}], 
              ".", 
              RowBox[{
              "sdot", "\[LeftDoubleBracket]", "i", 
               "\[RightDoubleBracket]"}]}], " ", "+", " ", 
             RowBox[{"Xdot", ".", 
              RowBox[{
              "s", "\[LeftDoubleBracket]", "i", 
               "\[RightDoubleBracket]"}]}]}]}], ";"}], ",", 
          "\[IndentingNewLine]", 
          RowBox[{"{", 
           RowBox[{"i", ",", " ", "bs"}], "}"}]}], "\[IndentingNewLine]", 
         "]"}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
        RowBox[{"Xo0", " ", "=", " ", "Tcb"}], ";", "\[IndentingNewLine]", 
        RowBox[{"ro", " ", "=", " ", "r"}], ";", "\[IndentingNewLine]", 
        RowBox[{"rodot", " ", "=", " ", "rdot"}], ";", "\[IndentingNewLine]", 
        
        RowBox[{"posXco", " ", "=", " ", "zpos"}], ";", "\[IndentingNewLine]",
         "\[IndentingNewLine]", 
        RowBox[{"Do", "[", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{
           RowBox[{"b", " ", "=", " ", 
            RowBox[{"bo", "\[LeftDoubleBracket]", 
             RowBox[{"k", ",", " ", "1"}], "\[RightDoubleBracket]"}]}], ";", 
           "\[IndentingNewLine]", 
           RowBox[{"o", " ", "=", " ", 
            RowBox[{"bo", "\[LeftDoubleBracket]", 
             RowBox[{"k", ",", " ", "2"}], "\[RightDoubleBracket]"}]}], ";", 
           "\[IndentingNewLine]", "\[IndentingNewLine]", 
           RowBox[{"(*", " ", 
            RowBox[{
            "compute", " ", "X", " ", "transform", " ", "from", " ", "0", " ", 
             RowBox[{"(", 
              RowBox[{
               RowBox[{"root", "/", "world"}], " ", "frame"}], ")"}], " ", 
             "to", " ", "o"}], " ", "*)"}], "\[IndentingNewLine]", 
           RowBox[{"(*", " ", 
            RowBox[{
             RowBox[{
              RowBox[{"transforms", " ", "are", " ", "root"}], " ", "\[Rule]",
               " ", 
              RowBox[{"b", " ", "\[Rule]", " ", 
               RowBox[{"c", " ", "\[Rule]", " ", "0"}]}]}], ",", " ", 
             RowBox[{"i", ".", "e"}], ",", " ", 
             RowBox[{
              RowBox[{"X", "[", 
               RowBox[{"o", ",", " ", "c"}], "]"}], ".", 
              RowBox[{"X", "[", 
               RowBox[{"c", ",", " ", "b"}], "]"}], ".", 
              RowBox[{"X", "[", 
               RowBox[{"b", ",", " ", "0"}], "]"}]}]}], " ", "*)"}], 
           "\[IndentingNewLine]", 
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{"o", " ", "\[Equal]", " ", "0"}], ",", " ", 
             "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{
               RowBox[{
               "Xo0", "\[LeftDoubleBracket]", "k", "\[RightDoubleBracket]"}], 
               " ", "=", " ", 
               RowBox[{
                RowBox[{
                "R0L", "\[LeftDoubleBracket]", "b", "\[RightDoubleBracket]"}],
                 ".", 
                RowBox[{
                "Tcb", "\[LeftDoubleBracket]", "k", "\[RightDoubleBracket]"}],
                 ".", 
                RowBox[{
                "XL0", "\[LeftDoubleBracket]", "b", 
                 "\[RightDoubleBracket]"}]}]}], ";", "\[IndentingNewLine]", 
              RowBox[{"R", " ", "=", " ", 
               RowBox[{
               "RL0", "\[LeftDoubleBracket]", "b", 
                "\[RightDoubleBracket]"}]}], ";", "\[IndentingNewLine]", 
              RowBox[{"X", " ", "=", " ", 
               RowBox[{
               "Xo0", "\[LeftDoubleBracket]", "k", 
                "\[RightDoubleBracket]"}]}], ";"}], ",", " ", 
             "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{
               RowBox[{
               "Xo0", "\[LeftDoubleBracket]", "k", "\[RightDoubleBracket]"}], 
               " ", "=", " ", 
               RowBox[{
                RowBox[{
                "RL0", "\[LeftDoubleBracket]", "o", "\[RightDoubleBracket]"}],
                 ".", 
                RowBox[{
                "R0L", "\[LeftDoubleBracket]", "b", "\[RightDoubleBracket]"}],
                 ".", 
                RowBox[{
                "Tcb", "\[LeftDoubleBracket]", "k", "\[RightDoubleBracket]"}],
                 ".", 
                RowBox[{
                "XL0", "\[LeftDoubleBracket]", "b", 
                 "\[RightDoubleBracket]"}]}]}], ";", "\[IndentingNewLine]", 
              RowBox[{"R", " ", "=", " ", 
               RowBox[{
                RowBox[{
                "RL0", "\[LeftDoubleBracket]", "b", "\[RightDoubleBracket]"}],
                 ".", 
                RowBox[{
                "R0L", "\[LeftDoubleBracket]", "o", 
                 "\[RightDoubleBracket]"}]}]}], ";", "\[IndentingNewLine]", 
              RowBox[{"X", " ", "=", " ", 
               RowBox[{
                RowBox[{
                "Xo0", "\[LeftDoubleBracket]", "k", "\[RightDoubleBracket]"}],
                 ".", 
                RowBox[{
                "X0L", "\[LeftDoubleBracket]", "o", 
                 "\[RightDoubleBracket]"}]}]}], ";"}]}], 
            "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
           "\[IndentingNewLine]", 
           RowBox[{"(*", " ", 
            RowBox[{
            "spatial", " ", "position", " ", "of", " ", "constraint", " ", 
             "in", " ", "o", " ", "frame"}], " ", "*)"}], 
           "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{
            "posXco", "\[LeftDoubleBracket]", "k", "\[RightDoubleBracket]"}], 
            " ", "=", " ", 
            RowBox[{
             RowBox[{
             "r", "\[LeftDoubleBracket]", "k", "\[RightDoubleBracket]"}], ".", 
             RowBox[{"posX", "[", 
              RowBox[{"X", ",", " ", "R"}], "]"}]}]}], ";", 
           "\[IndentingNewLine]", "\[IndentingNewLine]", 
           RowBox[{"(*", " ", 
            RowBox[{
             RowBox[{
             "move", " ", "r", " ", "into", " ", "world", " ", "frame"}], ",",
              " ", 
             RowBox[{"ro", " ", "=", " ", 
              RowBox[{
               RowBox[{"r", "[", 
                RowBox[{"o", ",", " ", "o"}], "]"}], ".", 
               RowBox[{"X", "[", 
                RowBox[{"o", ",", " ", "0"}], "]"}]}]}]}], " ", "*)"}], 
           "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{
            "ro", "\[LeftDoubleBracket]", "k", "\[RightDoubleBracket]"}], " ",
             "=", " ", 
            RowBox[{
             RowBox[{
             "r", "\[LeftDoubleBracket]", "k", "\[RightDoubleBracket]"}], ".", 
             RowBox[{
             "Xo0", "\[LeftDoubleBracket]", "k", 
              "\[RightDoubleBracket]"}]}]}], ";", "\[IndentingNewLine]", 
           "\[IndentingNewLine]", 
           RowBox[{"(*", " ", 
            RowBox[{
             RowBox[{
             "move", " ", "rdot", " ", "into", " ", "world", " ", "frame"}], 
             ",", " ", 
             RowBox[{"rodot", " ", "=", " ", 
              RowBox[{
               RowBox[{"d", "/", "dt"}], 
               RowBox[{"(", 
                RowBox[{
                 RowBox[{"r", "[", 
                  RowBox[{"o", ",", " ", "o"}], "]"}], ".", 
                 RowBox[{"X", "[", 
                  RowBox[{"o", ",", " ", "0"}], "]"}]}], ")"}]}]}]}], " ", 
            "*)"}], "\[IndentingNewLine]", 
           RowBox[{"va", " ", "=", " ", 
            RowBox[{
            "v", "\[LeftDoubleBracket]", "b", "\[RightDoubleBracket]"}]}], 
           ";", "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"va", "\[LeftDoubleBracket]", 
             RowBox[{"4", ";;", "6"}], "\[RightDoubleBracket]"}], " ", "=", 
            " ", "z3"}], ";", " ", 
           RowBox[{"(*", " ", 
            RowBox[{
            "only", " ", "angular", " ", "vel", " ", "of", " ", "vb"}], " ", 
            "*)"}], "\[IndentingNewLine]", 
           RowBox[{"vo0", " ", "=", " ", 
            RowBox[{
             RowBox[{
              RowBox[{
              "R0L", "\[LeftDoubleBracket]", "b", "\[RightDoubleBracket]"}], 
              ".", "va"}], "-", 
             RowBox[{
              RowBox[{
              "R0L", "\[LeftDoubleBracket]", "b", "\[RightDoubleBracket]"}], 
              ".", 
              RowBox[{
              "Tcb", "\[LeftDoubleBracket]", "k", "\[RightDoubleBracket]"}], 
              ".", 
              RowBox[{
              "v", "\[LeftDoubleBracket]", "b", 
               "\[RightDoubleBracket]"}]}]}]}], ";", " ", 
           RowBox[{"(*", " ", 
            RowBox[{
             RowBox[{"vel", " ", 
              RowBox[{"w", "/", " ", "o"}]}], " ", "=", " ", "0"}], " ", 
            "*)"}], "\[IndentingNewLine]", 
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{"o", " ", "\[NotEqual]", "  ", "0"}], ",", " ", 
             "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{"va", " ", "=", " ", 
               RowBox[{
               "v", "\[LeftDoubleBracket]", "o", "\[RightDoubleBracket]"}]}], 
              ";", "\[IndentingNewLine]", 
              RowBox[{
               RowBox[{"va", "\[LeftDoubleBracket]", 
                RowBox[{"4", ";;", "6"}], "\[RightDoubleBracket]"}], " ", "=",
                " ", "z3"}], ";", " ", 
              RowBox[{"(*", " ", 
               RowBox[{
               "only", " ", "angular", " ", "vel", " ", "of", " ", "vo"}], 
               " ", "*)"}], "\[IndentingNewLine]", 
              RowBox[{"vo0", " ", "=", " ", 
               RowBox[{
                RowBox[{
                 RowBox[{
                 "RL0", "\[LeftDoubleBracket]", "o", 
                  "\[RightDoubleBracket]"}], ".", "vo0"}], " ", "-", " ", 
                "va"}]}], ";"}]}], "\[IndentingNewLine]", "]"}], ";", 
           "\[IndentingNewLine]", 
           RowBox[{"Xdot", " ", "=", " ", 
            RowBox[{"mxX", "[", 
             RowBox[{"vo0", ",", " ", 
              RowBox[{
              "Xo0", "\[LeftDoubleBracket]", "k", "\[RightDoubleBracket]"}]}],
              "]"}]}], ";", "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{
            "rodot", "\[LeftDoubleBracket]", "k", "\[RightDoubleBracket]"}], 
            " ", "=", "  ", 
            RowBox[{
             RowBox[{
              RowBox[{
              "rdot", "\[LeftDoubleBracket]", "k", "\[RightDoubleBracket]"}], 
              ".", 
              RowBox[{
              "Xo0", "\[LeftDoubleBracket]", "k", "\[RightDoubleBracket]"}]}],
              " ", "+", " ", 
             RowBox[{
              RowBox[{
              "r", "\[LeftDoubleBracket]", "k", "\[RightDoubleBracket]"}], 
              ".", "Xdot"}]}]}], ";"}], ",", " ", "\[IndentingNewLine]", 
          RowBox[{"{", 
           RowBox[{"k", ",", " ", 
            RowBox[{"Length", "@", "bo"}]}], "}"}]}], "\[IndentingNewLine]", 
         "]"}], ";"}]}], "\[IndentingNewLine]", "]"}]}], ";"}]}]}]], "Input",
 InitializationCell->
  True,ExpressionUUID->"4f11343e-9caf-4b31-bb64-e922ec7ae3a3"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", " ", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"user", " ", 
      RowBox[{"inputs", ":", " ", "x"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"zeroed", " ", 
      RowBox[{"inputs", ":", " ", "J"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"mode", " ", 
      RowBox[{"data", ":", " ", "r"}]}]}], ",", " ", "s", ",", " ", "XL", ",",
     " ", "parent", ",", " ", "bodies", ",", " ", "mb", ",", " ", 
    RowBox[{
     RowBox[{"X0L", " ", "and", " ", "friends"}], ";", "\[IndentingNewLine]", 
     
     RowBox[{"modifies", ":", " ", "J"}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{
       RowBox[{"output", ":", " ", "J"}], " ", "&"}], " ", "\[Phi]", " ", 
      RowBox[{"(", 
       RowBox[{
       "joint", " ", "velocities", " ", "to", " ", "os", " ", "velocities"}], 
       ")"}]}]}]}], "\[IndentingNewLine]", "*)"}], "\[IndentingNewLine]", 
  "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"JOSIM", "[", "]"}], " ", ":=", " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "b", ",", " ", "aa", ",", " ", "oo", ",", " ", "ii", ",", " ", "j", 
        ",", " ", "kk", ",", " ", "n", ",", " ", "in", ",", " ", "kn", ",", 
        " ", "nn"}], "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
        RowBox[{
         RowBox[{
         "compute", " ", "J", " ", "and", " ", "\[Phi]", " ", "in", " ", 
          RowBox[{"J", ".", "a"}]}], " ", "+", " ", "\[Phi]"}], " ", "=", " ",
         "0"}], "*)"}], "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"Do", "[", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{
          RowBox[{"b", " ", "=", " ", 
           RowBox[{"ba", "\[LeftDoubleBracket]", 
            RowBox[{"c", ",", " ", "1", ",", " ", "1"}], 
            "\[RightDoubleBracket]"}]}], ";", " ", 
          RowBox[{"(*", " ", 
           RowBox[{"all", " ", 
            RowBox[{"c", "'"}], "s", " ", "have", " ", "same", " ", "b", " ", 
            "and", " ", "a"}], " ", "*)"}], "\[IndentingNewLine]", 
          RowBox[{"aa", " ", "=", " ", 
           RowBox[{"ba", "\[LeftDoubleBracket]", 
            RowBox[{"c", ",", " ", "1", ",", " ", "2"}], 
            "\[RightDoubleBracket]"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"(*", " ", 
           RowBox[{"get", " ", "all", " ", "constraint", " ", 
            RowBox[{"i", "'"}], "s", " ", "and", " ", "corresponding", " ", 
            RowBox[{"k", "'"}], "s", " ", "that", " ", "would", " ", 
            "traverse"}], " ", "*)"}], 
          RowBox[{"(*", " ", 
           RowBox[{
           "the", " ", "same", " ", "path", " ", "up", " ", "the", " ", 
            "tree"}], " ", "*)"}], "\[IndentingNewLine]", 
          RowBox[{"n", " ", "=", " ", 
           RowBox[{"Length", "@", 
            RowBox[{
            "ba", "\[LeftDoubleBracket]", "c", "\[RightDoubleBracket]"}]}]}], 
          ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{"ii", ",", " ", "kk"}], "}"}], " ", "=", " ", 
           RowBox[{
            RowBox[{"Select", "[", 
             RowBox[{
              RowBox[{"ba", "\[LeftDoubleBracket]", 
               RowBox[{"c", ",", " ", 
                RowBox[{"1", ";;", "n"}], ",", " ", 
                RowBox[{"4", ";;", "5"}]}], "\[RightDoubleBracket]"}], ",", 
              " ", 
              RowBox[{
               RowBox[{
                RowBox[{
                "#", "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}], 
                " ", "\[NotEqual]", " ", "0"}], "&"}]}], "]"}], 
            "\[Transpose]"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"nn", " ", "=", " ", 
           RowBox[{"Length", "@", "ii"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"(*", 
           RowBox[{
            RowBox[{"ii", " ", "=", " ", 
             RowBox[{"ba", "\[LeftDoubleBracket]", 
              RowBox[{"c", ",", " ", 
               RowBox[{"1", ";;", "n"}], ",", " ", "3"}], 
              "\[RightDoubleBracket]"}]}], ";", "\[IndentingNewLine]", 
            RowBox[{"kk", " ", "=", " ", 
             RowBox[{"ba", "\[LeftDoubleBracket]", 
              RowBox[{"c", ",", " ", 
               RowBox[{"1", ";;", "n"}], ",", " ", "4"}], 
              "\[RightDoubleBracket]"}]}], ";"}], "*)"}], 
          "\[IndentingNewLine]", "\[IndentingNewLine]", 
          RowBox[{"(*", " ", 
           RowBox[{
            RowBox[{"compute", " ", "i"}], "-", 
            RowBox[{
            "th", " ", "constraint", " ", "starting", " ", "with", " ", 
             "body", " ", "b"}]}], " ", "*)"}], "\[IndentingNewLine]", 
          RowBox[{"Do", "[", "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{
             RowBox[{"in", " ", "=", " ", 
              RowBox[{
              "ii", "\[LeftDoubleBracket]", "cc", "\[RightDoubleBracket]"}]}],
              ";", "\[IndentingNewLine]", 
             RowBox[{"kn", " ", "=", " ", 
              RowBox[{
              "kk", "\[LeftDoubleBracket]", "cc", "\[RightDoubleBracket]"}]}],
              ";", "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{"J", "\[LeftDoubleBracket]", 
               RowBox[{"in", ",", " ", "b"}], "\[RightDoubleBracket]"}], " ", 
              "=", " ", 
              RowBox[{
               RowBox[{"J", "\[LeftDoubleBracket]", 
                RowBox[{"in", ",", " ", "b"}], "\[RightDoubleBracket]"}], " ",
                "+", " ", 
               RowBox[{
                RowBox[{
                "ro", "\[LeftDoubleBracket]", "kn", "\[RightDoubleBracket]"}],
                 ".", 
                RowBox[{
                "sj", "\[LeftDoubleBracket]", "b", 
                 "\[RightDoubleBracket]"}]}]}]}], ";", "\[IndentingNewLine]", 
             
             RowBox[{"(*", " ", 
              RowBox[{"\[Phi]", " ", "=", " ", 
               RowBox[{"\[Phi]", " ", "+", " ", 
                RowBox[{"Jdot", " ", "qd"}]}]}], " ", "*)"}], 
             "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{
              "\[Phi]", "\[LeftDoubleBracket]", "in", 
               "\[RightDoubleBracket]"}], " ", "=", " ", 
              RowBox[{
               RowBox[{
               "\[Phi]", "\[LeftDoubleBracket]", "in", 
                "\[RightDoubleBracket]"}], " ", "+", " ", 
               RowBox[{
                RowBox[{"(", 
                 RowBox[{
                  RowBox[{
                   RowBox[{
                   "rodot", "\[LeftDoubleBracket]", "kn", 
                    "\[RightDoubleBracket]"}], ".", 
                   RowBox[{
                   "sj", "\[LeftDoubleBracket]", "b", 
                    "\[RightDoubleBracket]"}]}], " ", "+", " ", 
                  RowBox[{
                   RowBox[{
                   "ro", "\[LeftDoubleBracket]", "kn", 
                    "\[RightDoubleBracket]"}], ".", 
                   RowBox[{
                   "sjdot", "\[LeftDoubleBracket]", "b", 
                    "\[RightDoubleBracket]"}]}]}], ")"}], 
                RowBox[{
                "qd", "\[LeftDoubleBracket]", "b", 
                 "\[RightDoubleBracket]"}]}]}]}], ";"}], ",", " ", 
            "\[IndentingNewLine]", 
            RowBox[{"{", 
             RowBox[{"cc", ",", " ", "nn"}], "}"}]}], "\[IndentingNewLine]", 
           "]"}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
          RowBox[{"(*", " ", 
           RowBox[{
            RowBox[{
            "below", " ", "we", " ", "have", " ", "errors", " ", "if", " ", 
             "adding", " ", "to", " ", "same", " ", "ii"}], ",", " ", 
            RowBox[{"e", ".", "g", "."}], ",", " ", 
            RowBox[{"ii", " ", "=", " ", 
             RowBox[{"{", 
              RowBox[{"1", ",", " ", "1"}], "}"}]}], ",", " ", 
            RowBox[{"kk", " ", "=", " ", 
             RowBox[{
              RowBox[{"{", 
               RowBox[{"1", ",", " ", "2"}], "}"}], "."}]}]}], " ", "*)"}], 
          "\[IndentingNewLine]", 
          RowBox[{"(*", 
           RowBox[{
            RowBox[{
             RowBox[{"J", "\[LeftDoubleBracket]", 
              RowBox[{"ii", ",", " ", "b"}], "\[RightDoubleBracket]"}], " ", 
             "=", " ", 
             RowBox[{
              RowBox[{"J", "\[LeftDoubleBracket]", 
               RowBox[{"ii", ",", " ", "b"}], "\[RightDoubleBracket]"}], " ", 
              "+", " ", 
              RowBox[{
               RowBox[{
               "ro", "\[LeftDoubleBracket]", "kk", "\[RightDoubleBracket]"}], 
               ".", 
               RowBox[{
               "sj", "\[LeftDoubleBracket]", "b", 
                "\[RightDoubleBracket]"}]}]}]}], ";"}], "*)"}], 
          "\[IndentingNewLine]", 
          RowBox[{"(*", " ", 
           RowBox[{"\[Phi]", " ", "=", " ", 
            RowBox[{"\[Phi]", " ", "+", " ", 
             RowBox[{"Jdot", " ", "qd"}]}]}], " ", "*)"}], 
          "\[IndentingNewLine]", 
          RowBox[{"(*", 
           RowBox[{
            RowBox[{
             RowBox[{
             "\[Phi]", "\[LeftDoubleBracket]", "ii", 
              "\[RightDoubleBracket]"}], " ", "=", " ", 
             RowBox[{
              RowBox[{
              "\[Phi]", "\[LeftDoubleBracket]", "ii", 
               "\[RightDoubleBracket]"}], " ", "+", " ", 
              RowBox[{
               RowBox[{"(", 
                RowBox[{
                 RowBox[{
                  RowBox[{
                  "rodot", "\[LeftDoubleBracket]", "kk", 
                   "\[RightDoubleBracket]"}], ".", 
                  RowBox[{
                  "sj", "\[LeftDoubleBracket]", "b", 
                   "\[RightDoubleBracket]"}]}], " ", "+", " ", 
                 RowBox[{
                  RowBox[{
                  "ro", "\[LeftDoubleBracket]", "kk", 
                   "\[RightDoubleBracket]"}], ".", 
                  RowBox[{
                  "sjdot", "\[LeftDoubleBracket]", "b", 
                   "\[RightDoubleBracket]"}]}]}], ")"}], 
               RowBox[{
               "qd", "\[LeftDoubleBracket]", "b", 
                "\[RightDoubleBracket]"}]}]}]}], ";"}], "*)"}], 
          "\[IndentingNewLine]", "\[IndentingNewLine]", 
          RowBox[{"(*", " ", 
           RowBox[{"and", " ", "ending", " ", "at", " ", "root"}], " ", 
           "*)"}], "\[IndentingNewLine]", 
          RowBox[{"j", " ", "=", " ", 
           RowBox[{
           "parent", "\[LeftDoubleBracket]", "b", "\[RightDoubleBracket]"}]}],
           ";", "\[IndentingNewLine]", 
          RowBox[{"While", "[", 
           RowBox[{
            RowBox[{
             RowBox[{"j", " ", "\[NotEqual]", " ", "0"}], " ", "&&", " ", 
             RowBox[{"j", "  ", "\[GreaterEqual]", " ", "aa"}]}], ",", 
            "\[IndentingNewLine]", 
            RowBox[{"(*", 
             RowBox[{
              RowBox[{
               RowBox[{"J", "\[LeftDoubleBracket]", 
                RowBox[{"ii", ",", " ", "j"}], "\[RightDoubleBracket]"}], " ",
                "=", " ", 
               RowBox[{
                RowBox[{"J", "\[LeftDoubleBracket]", 
                 RowBox[{"ii", ",", " ", "j"}], "\[RightDoubleBracket]"}], 
                " ", "+", 
                RowBox[{
                 RowBox[{
                 "ro", "\[LeftDoubleBracket]", "kk", 
                  "\[RightDoubleBracket]"}], ".", 
                 RowBox[{
                 "sj", "\[LeftDoubleBracket]", "j", 
                  "\[RightDoubleBracket]"}]}]}]}], ";"}], "*)"}], 
            "\[IndentingNewLine]", 
            RowBox[{"(*", 
             RowBox[{
              RowBox[{
               RowBox[{
               "\[Phi]", "\[LeftDoubleBracket]", "ii", 
                "\[RightDoubleBracket]"}], " ", "=", " ", 
               RowBox[{
                RowBox[{
                "\[Phi]", "\[LeftDoubleBracket]", "ii", 
                 "\[RightDoubleBracket]"}], " ", "+", " ", 
                RowBox[{
                 RowBox[{"(", 
                  RowBox[{
                   RowBox[{
                    RowBox[{
                    "rodot", "\[LeftDoubleBracket]", "kk", 
                    "\[RightDoubleBracket]"}], ".", 
                    RowBox[{
                    "sj", "\[LeftDoubleBracket]", "j", 
                    "\[RightDoubleBracket]"}]}], " ", "+", " ", 
                   RowBox[{
                    RowBox[{
                    "ro", "\[LeftDoubleBracket]", "kk", 
                    "\[RightDoubleBracket]"}], ".", 
                    RowBox[{
                    "sjdot", "\[LeftDoubleBracket]", "j", 
                    "\[RightDoubleBracket]"}]}]}], ")"}], " ", 
                 RowBox[{
                 "qd", "\[LeftDoubleBracket]", "j", 
                  "\[RightDoubleBracket]"}]}]}]}], ";"}], "*)"}], 
            "\[IndentingNewLine]", "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{"Do", "[", "\[IndentingNewLine]", 
              RowBox[{
               RowBox[{
                RowBox[{"in", " ", "=", " ", 
                 RowBox[{
                 "ii", "\[LeftDoubleBracket]", "cc", 
                  "\[RightDoubleBracket]"}]}], ";", "\[IndentingNewLine]", 
                RowBox[{"kn", " ", "=", " ", 
                 RowBox[{
                 "kk", "\[LeftDoubleBracket]", "cc", 
                  "\[RightDoubleBracket]"}]}], ";", "\[IndentingNewLine]", 
                RowBox[{
                 RowBox[{"J", "\[LeftDoubleBracket]", 
                  RowBox[{"in", ",", " ", "j"}], "\[RightDoubleBracket]"}], 
                 " ", "=", " ", 
                 RowBox[{
                  RowBox[{"J", "\[LeftDoubleBracket]", 
                   RowBox[{"in", ",", " ", "j"}], "\[RightDoubleBracket]"}], 
                  " ", "+", " ", 
                  RowBox[{
                   RowBox[{
                   "ro", "\[LeftDoubleBracket]", "kn", 
                    "\[RightDoubleBracket]"}], ".", 
                   RowBox[{
                   "sj", "\[LeftDoubleBracket]", "j", 
                    "\[RightDoubleBracket]"}]}]}]}], ";", 
                "\[IndentingNewLine]", 
                RowBox[{
                 RowBox[{
                 "\[Phi]", "\[LeftDoubleBracket]", "in", 
                  "\[RightDoubleBracket]"}], " ", "=", " ", 
                 RowBox[{
                  RowBox[{
                  "\[Phi]", "\[LeftDoubleBracket]", "in", 
                   "\[RightDoubleBracket]"}], " ", "+", " ", 
                  RowBox[{
                   RowBox[{"(", 
                    RowBox[{
                    RowBox[{
                    RowBox[{
                    "rodot", "\[LeftDoubleBracket]", "kn", 
                    "\[RightDoubleBracket]"}], ".", 
                    RowBox[{
                    "sj", "\[LeftDoubleBracket]", "j", 
                    "\[RightDoubleBracket]"}]}], " ", "+", " ", 
                    RowBox[{
                    RowBox[{
                    "ro", "\[LeftDoubleBracket]", "kn", 
                    "\[RightDoubleBracket]"}], ".", 
                    RowBox[{
                    "sjdot", "\[LeftDoubleBracket]", "j", 
                    "\[RightDoubleBracket]"}]}]}], ")"}], 
                   RowBox[{
                   "qd", "\[LeftDoubleBracket]", "j", 
                    "\[RightDoubleBracket]"}]}]}]}], ";"}], ",", " ", 
               "\[IndentingNewLine]", 
               RowBox[{"{", 
                RowBox[{"cc", ",", " ", "nn"}], "}"}]}], 
              "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
             "\[IndentingNewLine]", 
             RowBox[{"j", " ", "=", " ", 
              RowBox[{
              "parent", "\[LeftDoubleBracket]", "j", 
               "\[RightDoubleBracket]"}]}], ";"}]}], "\[IndentingNewLine]", 
           "]"}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
          RowBox[{"(*", " ", 
           RowBox[{"\[Eta]", " ", "=", " ", 
            RowBox[{
             RowBox[{"(", 
              RowBox[{"h", ",", " ", "hdot"}], ")"}], " ", 
             RowBox[{"(", 
              RowBox[{
               RowBox[{"ideally", " ", "\[Eta]"}], " ", "=", " ", "0"}], 
              ")"}]}]}], " ", "*)"}], "\[IndentingNewLine]", 
          RowBox[{"(*", " ", "h", " ", "*)"}], "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{"oo", ",", " ", "ii", ",", " ", "kk"}], "}"}], " ", "=", 
           " ", 
           RowBox[{
            RowBox[{"Select", "[", 
             RowBox[{
              RowBox[{"ba", "\[LeftDoubleBracket]", 
               RowBox[{"c", ",", " ", 
                RowBox[{"1", ";;", "n"}], ",", " ", 
                RowBox[{"3", ";;", "5"}]}], "\[RightDoubleBracket]"}], ",", 
              " ", 
              RowBox[{
               RowBox[{
                RowBox[{
                 RowBox[{
                 "#", "\[LeftDoubleBracket]", "2", "\[RightDoubleBracket]"}], 
                 " ", "\[NotEqual]", " ", "0"}], " ", "&&", " ", 
                RowBox[{
                 RowBox[{
                 "#", "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}], 
                 " ", "\[LessEqual]", " ", "0"}]}], "&"}]}], "]"}], 
            "\[Transpose]"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"\[Eta]", "\[LeftDoubleBracket]", 
            RowBox[{"1", ",", " ", "ii"}], "\[RightDoubleBracket]"}], " ", 
           "=", " ", 
           RowBox[{
            RowBox[{"\[Eta]", "\[LeftDoubleBracket]", 
             RowBox[{"1", ",", " ", "ii"}], "\[RightDoubleBracket]"}], " ", 
            "+", " ", 
            RowBox[{
            "posXco", "\[LeftDoubleBracket]", "kk", 
             "\[RightDoubleBracket]"}]}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"(*", " ", "hdot", " ", "*)"}], "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{"oo", ",", " ", "ii", ",", " ", "kk"}], "}"}], " ", "=", 
           " ", 
           RowBox[{
            RowBox[{"Select", "[", 
             RowBox[{
              RowBox[{"ba", "\[LeftDoubleBracket]", 
               RowBox[{"c", ",", " ", 
                RowBox[{"1", ";;", "n"}], ",", " ", 
                RowBox[{"3", ";;", "5"}]}], "\[RightDoubleBracket]"}], ",", 
              " ", 
              RowBox[{
               RowBox[{
                RowBox[{
                 RowBox[{
                 "#", "\[LeftDoubleBracket]", "2", "\[RightDoubleBracket]"}], 
                 " ", "\[NotEqual]", " ", "0"}], " ", "&&", " ", 
                RowBox[{
                 RowBox[{
                 "#", "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}], 
                 " ", "\[LessEqual]", " ", "1"}]}], "&"}]}], "]"}], 
            "\[Transpose]"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"\[Eta]", "\[LeftDoubleBracket]", 
            RowBox[{"2", ",", " ", "ii"}], "\[RightDoubleBracket]"}], " ", 
           "=", " ", 
           RowBox[{
            RowBox[{"\[Eta]", "\[LeftDoubleBracket]", 
             RowBox[{"2", ",", " ", "ii"}], "\[RightDoubleBracket]"}], " ", 
            "+", " ", 
            RowBox[{
             RowBox[{
             "J", "\[LeftDoubleBracket]", "ii", "\[RightDoubleBracket]"}], 
             ".", "qd"}]}]}], ";"}], ",", " ", "\[IndentingNewLine]", 
         RowBox[{"{", 
          RowBox[{"c", ",", " ", 
           RowBox[{"Length", "@", "ba"}]}], "}"}]}], "\[IndentingNewLine]", 
        "]"}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"(*", " ", 
        RowBox[{
         RowBox[{"v", " ", "=", " ", 
          RowBox[{"K", ".", "\[Eta]"}]}], ";", " ", 
         RowBox[{
          RowBox[{
           RowBox[{
           "useful", " ", "for", " ", "constraint", " ", "stabilization"}], 
           " ", "&"}], " ", "HZD", " ", "feedback", " ", "control"}]}], " ", 
        "*)"}], "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"Length", "@", "ba"}], " ", ">", " ", "0"}], ",", " ", 
         RowBox[{"\[Phi]", " ", "=", " ", 
          RowBox[{"\[Phi]", " ", "+", " ", 
           RowBox[{
            RowBox[{
            "K", "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}], ".", 
            
            RowBox[{
            "\[Eta]", "\[LeftDoubleBracket]", "1", 
             "\[RightDoubleBracket]"}]}], " ", "+", " ", 
           RowBox[{
            RowBox[{
            "K", "\[LeftDoubleBracket]", "2", "\[RightDoubleBracket]"}], ".", 
            
            RowBox[{
            "\[Eta]", "\[LeftDoubleBracket]", "2", 
             "\[RightDoubleBracket]"}]}]}]}]}], "]"}], ";"}]}], 
     "\[IndentingNewLine]", "]"}]}], ";"}]}]], "Input",
 InitializationCell->
  True,ExpressionUUID->"a9c652f7-7c0c-47d0-b426-48b41d3617ff"]
}, Open  ]]
}, Open  ]],

Cell[CellGroupData[{

Cell["End Package", \
"Section",ExpressionUUID->"e7c13ee3-781c-4fda-82e2-df2d0817ec72"],

Cell[BoxData[{
 RowBox[{"End", "[", "]"}], "\[IndentingNewLine]", 
 RowBox[{"EndPackage", "[", "]"}]}], "Input",
 InitializationCell->
  True,ExpressionUUID->"4d3abfac-2b5e-4279-8475-ac09ba58c6ba"]
}, Open  ]]
},
AutoGeneratedPackage->Automatic,
Evaluator->"Local",
WindowSize->{718, 715},
WindowMargins->{{Automatic, 0}, {Automatic, 300}},
PrivateNotebookOptions->{"FileOutlineCache"->False},
CellContext->"Global`",
TrackCellChangeTimes->False,
FrontEndVersion->"11.3 for Linux x86 (64-bit) (March 6, 2018)",
StyleDefinitions->"Default.nb"
]

