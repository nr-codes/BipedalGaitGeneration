Notebook[{

Cell[CellGroupData[{
Cell["Begin Package", \
"Section",ExpressionUUID->"39e9dbc5-5d7b-4441-82c6-0811eadac5b2"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"BeginPackage", "[", 
   RowBox[{"\"\<BipedalLocomotion`Model`\>\"", ",", " ", 
    RowBox[{"{", 
     RowBox[{
     "\"\<GlobalVariables`\>\"", ",", " ", "\"\<Derivatives`\>\"", ",", " ", 
      "\"\<RigidBodyDynamics`\>\"", ",", " ", "\"\<BipedalLocomotion`\>\"", 
      ",", " ", "\"\<HybridDynamics`\>\""}], "}"}]}], "]"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{"Begin", "[", "\"\<`Private`\>\"", "]"}]}], "Input",
 InitializationCell->
  True,ExpressionUUID->"2b48c04c-aed4-40f4-8f8c-f7daa783cbb0"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Fix angles and impact map coordinate system", \
"Section",ExpressionUUID->"4e4f3495-7405-44bd-b231-44032f82e8c3"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"Options", "[", "BLGetSwitchingTimes", "]"}], " ", "=", " ", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"\"\<m\>\"", " ", "\[Rule]", " ", "Automatic"}], ",", " ", 
     RowBox[{"\"\<DT\>\"", " ", "\[Rule]", " ", "Automatic"}]}], "}"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"BLGetSwitchingTimes", "[", 
    RowBox[{"c_", ",", " ", 
     RowBox[{"OptionsPattern", "[", "]"}]}], "]"}], " ", ":=", " ", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"m", ",", " ", "c0", ",", " ", "DT", ",", " ", "n"}], "}"}], 
     ",", "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{"get", " ", "mode"}], " ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"m", " ", "=", " ", 
       RowBox[{"OptionValue", "[", "\"\<m\>\"", "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"m", " ", "===", " ", "Automatic"}], ",", " ", 
        RowBox[{
         RowBox[{"m", " ", "=", " ", 
          RowBox[{"BLbiped", "[", "\"\<m[0]\>\"", "]"}]}], ";"}]}], "]"}], 
      ";", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
       "get", " ", "indices", " ", "of", " ", "switching", " ", "times"}], 
       " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{"DT", " ", "=", " ", 
       RowBox[{"OptionValue", "[", "\"\<DT\>\"", "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"DT", " ", "===", " ", "Automatic"}], ",", " ", 
        RowBox[{
         RowBox[{"DT", " ", "=", " ", 
          RowBox[{"BLbiped", "[", 
           RowBox[{"\"\<t\>\"", ",", " ", "m"}], "]"}]}], ";"}]}], "]"}], ";",
       "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
        RowBox[{
        "flatten", " ", "c", " ", "for", " ", "linear", " ", "indexing"}], 
        ";", " ", 
        RowBox[{"argument", " ", "could", " ", "be", " ", 
         RowBox[{"devec", "[", "c", "]"}]}]}], " ", "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"c0", " ", "=", " ", 
       RowBox[{"Flatten", "@", "c"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{"how", " ", "long", " ", "is", " ", "parameter", " ", 
        RowBox[{"vector", "?"}]}], " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
        RowBox[{"assume", " ", "c"}], " ", "=", " ", 
        RowBox[{
         RowBox[{"vec", "[", 
          RowBox[{"{", 
           RowBox[{"p", ",", " ", "dp", ",", " ", "..."}], "}"}], "]"}], " ", 
         "is", " ", "not", " ", "an", " ", "option"}]}], " ", "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"n", " ", "=", " ", 
       RowBox[{"Min", "[", 
        RowBox[{
         RowBox[{"Length", "@", 
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{"VectorQ", "[", "c", "]"}], ",", " ", "c", ",", " ", 
            RowBox[{
            "c", "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}]}], 
           "]"}]}], ",", " ", "nc"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
        RowBox[{"get", " ", "switching", " ", "times"}], ",", " ", 
        RowBox[{
        "which", " ", "are", " ", "mapped", " ", "at", " ", "end", " ", "of", 
         " ", "parameter", " ", "vector"}]}], " ", "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{"#", " ", "\[Equal]", " ", "0"}], ",", " ", "0", ",", " ", 
          RowBox[{"c0", "\[LeftDoubleBracket]", 
           RowBox[{"n", "-", 
            RowBox[{"Abs", "[", "#", "]"}], "+", "1"}], 
           "\[RightDoubleBracket]"}]}], "]"}], "&"}], " ", "/@", " ", 
       "DT"}]}]}], "\[IndentingNewLine]", "]"}]}], ";"}]}], "Input",
 InitializationCell->
  True,ExpressionUUID->"1f29b794-9859-410e-bc9b-ed8c13fcde12"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"BLSwitchingTimes", "::", "indices"}], " ", "=", " ", 
   "\"\<Switching time indices have to be -'ve or zero.\>\""}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"BLSwitchingTimes", "[", "n_Integer", "]"}], " ", ":=", " ", 
   RowBox[{"BLSwitchingTimes", "[", 
    RowBox[{"Range", "[", 
     RowBox[{
      RowBox[{"-", "n"}], ",", " ", 
      RowBox[{"-", "1"}]}], "]"}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"BLSwitchingTimes", "[", "T_", "]"}], " ", ":=", " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"Or", "@@", 
          RowBox[{"Positive", "[", "T", "]"}]}], ",", " ", 
         RowBox[{"Message", "[", 
          RowBox[{"BLSwitchingTimes", "::", "indices"}], "]"}]}], "]"}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"Select", "[", 
        RowBox[{"T", ",", " ", "Negative"}], "]"}]}]}], "\[IndentingNewLine]",
      "]"}]}], ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"BLControlDesignParameters", "[", 
     RowBox[{"n_", ",", " ", 
      RowBox[{"T_:", "0"}]}], "]"}], " ", ":=", " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", "m", "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"IntegerQ", "[", "n", "]"}], ",", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"m", " ", "=", " ", 
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{"T", " ", "===", " ", 
             RowBox[{"{", "}"}]}], ",", " ", "0", ",", " ", 
            RowBox[{"Min", "@", "T"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
         
         RowBox[{"Range", "[", 
          RowBox[{
           RowBox[{"m", "-", "n"}], ",", " ", 
           RowBox[{"m", "-", "1"}]}], "]"}]}], ",", "\[IndentingNewLine]", 
        RowBox[{"(*", " ", "else", " ", "*)"}], "\[IndentingNewLine]", "n"}], 
       "\[IndentingNewLine]", "]"}]}], "\[IndentingNewLine]", "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"BLPolynomialCoefficients", "[", "\[Alpha]_", "]"}], " ", ":=", 
    " ", "\[Alpha]"}], ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 

 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"BLRemoveStates", "[", 
     RowBox[{"base_", ",", " ", "q_", ",", " ", "v_"}], "]"}], " ", ":=", " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "a", ",", " ", "f", ",", " ", "b", ",", " ", "b0", ",", " ", "b1", ",",
         " ", "b2", ",", " ", "b3"}], "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"a", " ", "=", " ", 
        RowBox[{"RBDGetValue", "[", 
         RowBox[{"1", ",", " ", "nx", ",", " ", 
          RowBox[{"\"\<n\>\"", " ", "\[Rule]", " ", "True"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"b0", " ", "=", " ", 
        RowBox[{"BLValues", "[", 
         RowBox[{"\"\<\[Theta]\>\"", ",", " ", "\"\<\>\"", ",", " ", 
          RowBox[{"\"\<n\>\"", " ", "\[Rule]", " ", 
           RowBox[{"{", 
            RowBox[{"\[DoubleStruckQ]", ",", " ", "\[DoubleStruckV]"}], 
            "}"}]}]}], "]"}]}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"b", " ", "=", " ", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{
           RowBox[{"VectorQ", "[", "base", "]"}], " ", "&&", " ", 
           RowBox[{
            RowBox[{
            "base", "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}], 
            " ", "===", " ", "Automatic"}]}], ")"}], " ", "||", " ", 
         RowBox[{"(", 
          RowBox[{"base", " ", "===", " ", "Automatic"}], ")"}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"b", " ", "=", " ", 
        RowBox[{"If", "[", 
         RowBox[{"b", ",", " ", 
          RowBox[{"BLGetBipedBase", "[", "base", "]"}], ",", " ", "base"}], 
         "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"b1", ",", " ", "b2"}], "}"}], " ", "=", " ", 
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{"VectorQ", "[", "b", "]"}], ",", " ", "b", ",", " ", 
          RowBox[{"{", 
           RowBox[{"b", ",", " ", "\"\<p\>\""}], "}"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"b1", " ", "=", " ", 
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{"b", " ", "===", " ", "None"}], ",", " ", 
          RowBox[{"{", "}"}], ",", " ", 
          RowBox[{"BLValues", "[", 
           RowBox[{"b1", ",", " ", "b2", ",", " ", 
            RowBox[{"\"\<n\>\"", " ", "\[Rule]", " ", 
             RowBox[{"{", 
              RowBox[{"\[DoubleStruckQ]", ",", " ", "\[DoubleStruckV]"}], 
              "}"}]}]}], "]"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"f", " ", "=", " ", 
        RowBox[{
         RowBox[{"Flatten", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"BLValues", "[", 
             RowBox[{"Sequence", "@@", "#"}], "]"}], "&"}], "/@", " ", "#"}], 
          "]"}], "&"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"b2", " ", "=", " ", 
        RowBox[{"Which", "[", 
         RowBox[{
          RowBox[{"b", " ", "===", " ", "None"}], ",", " ", 
          RowBox[{"{", "}"}], ",", " ", 
          RowBox[{"ListQ", "[", "q", "]"}], ",", " ", 
          RowBox[{"f", "[", "q", "]"}], ",", " ", "True", ",", " ", 
          RowBox[{"f", "[", 
           RowBox[{"{", 
            RowBox[{"{", 
             RowBox[{"q", ",", " ", "\"\<\>\""}], "}"}], "}"}], "]"}]}], 
         "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"f", " ", "=", " ", 
        RowBox[{
         RowBox[{"Flatten", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"BLValues", "[", 
             RowBox[{
              RowBox[{"Sequence", "@@", "#"}], ",", " ", 
              RowBox[{
              "\"\<n\>\"", " ", "\[Rule]", " ", "\[DoubleStruckV]"}]}], "]"}],
             "&"}], "/@", " ", "#"}], "]"}], "&"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"b3", " ", "=", " ", 
        RowBox[{"Which", "[", 
         RowBox[{
          RowBox[{"b", " ", "===", " ", "None"}], ",", " ", 
          RowBox[{"{", "}"}], ",", " ", 
          RowBox[{"ListQ", "[", "v", "]"}], ",", " ", 
          RowBox[{"f", "[", "v", "]"}], ",", " ", "True", ",", " ", 
          RowBox[{"f", "[", 
           RowBox[{"{", 
            RowBox[{"{", 
             RowBox[{"v", ",", " ", "\"\<\>\""}], "}"}], "}"}], "]"}]}], 
         "]"}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"RBDGetIndex", "@", 
        RowBox[{"DeleteCases", "[", 
         RowBox[{"a", ",", " ", 
          RowBox[{"Alternatives", "@@", 
           RowBox[{"Join", "[", 
            RowBox[{"b0", ",", " ", "b1", ",", " ", "b2", ",", " ", "b3"}], 
            "]"}]}]}], "]"}]}]}]}], "\[IndentingNewLine]", "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"BLTimeBasedceq", "[", 
     RowBox[{"T_", ",", " ", "a_"}], "]"}], " ", ":=", " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"t", ",", " ", "ceq"}], "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"ceq", " ", "=", " ", 
        RowBox[{"ConstantArray", "[", 
         RowBox[{"0", ",", " ", "nc"}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"ceq", "\[LeftDoubleBracket]", 
         RowBox[{"RBDGetIndex", "[", 
          RowBox[{"\[DoubleStruckV]", "[", 
           RowBox[{"\"\<\[Theta]\>\"", ",", " ", "1"}], "]"}], "]"}], 
         "\[RightDoubleBracket]"}], " ", "=", " ", "1"}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{
         RowBox[{
          RowBox[{
          "ceq", "\[LeftDoubleBracket]", "T", "\[RightDoubleBracket]"}], " ", 
          "=", " ", 
          RowBox[{
           RowBox[{"Slot", "[", "1", "]"}], " ", 
           RowBox[{"Range", "@", 
            RowBox[{"Length", "@", "T"}]}]}]}], ";"}], "*)"}], 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"ceq", "\[LeftDoubleBracket]", "T", "\[RightDoubleBracket]"}],
         " ", "=", " ", 
        RowBox[{"Slot", " ", "/@", " ", 
         RowBox[{"Range", "@", 
          RowBox[{"Length", "@", "T"}]}]}]}], ";", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"Evaluate", "@", 
         RowBox[{
         "ceq", "\[LeftDoubleBracket]", "a", "\[RightDoubleBracket]"}]}], 
        "&"}]}]}], "\[IndentingNewLine]", "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"Options", "[", "BLContinuationParameters", "]"}], " ", "=", " ", 
    
    RowBox[{"{", 
     RowBox[{
      RowBox[{"\"\<base\>\"", " ", "\[Rule]", " ", "Automatic"}], ",", " ", 
      RowBox[{"\"\<q\>\"", " ", "\[Rule]", " ", 
       RowBox[{"{", "}"}]}], ",", " ", 
      RowBox[{"\"\<v\>\"", " ", "\[Rule]", " ", 
       RowBox[{"{", "}"}]}], ",", " ", 
      RowBox[{"\"\<\[Alpha]\>\"", " ", "\[Rule]", " ", 
       RowBox[{"{", "}"}]}], ",", " ", 
      RowBox[{"\"\<\[Mu]\>\"", " ", "\[Rule]", " ", 
       RowBox[{"{", "}"}]}], ",", " ", 
      RowBox[{"\"\<T\>\"", " ", "\[Rule]", " ", 
       RowBox[{"{", 
        RowBox[{"-", "1"}], "}"}]}], ",", " ", 
      RowBox[{"\"\<c[p]\>\"", " ", "\[Rule]", " ", 
       RowBox[{"(", 
        RowBox[{"#", "&"}], ")"}]}], ",", " ", 
      RowBox[{"\"\<c[T]\>\"", " ", "\[Rule]", " ", 
       RowBox[{"(", 
        RowBox[{"#", "&"}], ")"}]}], ",", " ", 
      RowBox[{"\"\<c[eq]\>\"", " ", "\[Rule]", " ", "BLTimeBasedceq"}], ",", 
      " ", 
      RowBox[{"Association", " ", "\[Rule]", " ", 
       RowBox[{"<|", "|>"}]}]}], "}"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"BLContinuationParameters", "[", 
     RowBox[{"OptionsPattern", "[", "]"}], "]"}], " ", ":=", " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "base", ",", " ", "q", ",", " ", "v", ",", " ", "\[Alpha]", ",", " ", 
        "\[Mu]", ",", " ", "T", ",", " ", "x", ",", " ", "a", ",", " ", "t", 
        ",", " ", "u", ",", " ", "i", ",", " ", "p", ",", " ", "cT", ",", " ",
         "ceq"}], "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"base", " ", "=", " ", 
        RowBox[{"BLGetBipedBase", "[", 
         RowBox[{"OptionValue", "[", "\"\<base\>\"", "]"}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"q", " ", "=", " ", 
        RowBox[{"OptionValue", "[", "\"\<q\>\"", "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"v", " ", "=", " ", 
        RowBox[{"OptionValue", "[", "\"\<v\>\"", "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"\[Alpha]", " ", "=", " ", 
        RowBox[{"OptionValue", "[", "\"\<\[Alpha]\>\"", "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"\[Mu]", " ", "=", " ", 
        RowBox[{"OptionValue", "[", "\"\<\[Mu]\>\"", "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"T", " ", "=", " ", 
        RowBox[{"OptionValue", "[", "\"\<T\>\"", "]"}]}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"x", " ", "=", " ", 
        RowBox[{"BLRemoveStates", "[", 
         RowBox[{"base", ",", " ", "q", ",", " ", "v"}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"a", " ", "=", " ", 
        RowBox[{"BLPolynomialCoefficients", "[", "\[Alpha]", "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"t", " ", "=", " ", 
        RowBox[{"BLSwitchingTimes", "[", "T", "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"u", " ", "=", " ", 
        RowBox[{"BLControlDesignParameters", "[", 
         RowBox[{"\[Mu]", ",", " ", "t"}], "]"}]}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"i", " ", "=", " ", 
        RowBox[{"Join", "[", 
         RowBox[{"x", ",", " ", "a", " ", ",", " ", "u", ",", "t"}], "]"}]}], 
       ";", "\[IndentingNewLine]", 
       RowBox[{"ceq", " ", "=", " ", 
        RowBox[{
         RowBox[{"OptionValue", "[", "\"\<c[eq]\>\"", "]"}], "[", 
         RowBox[{"t", ",", " ", "i"}], "]"}]}], " ", ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"p", " ", "=", " ", 
        RowBox[{"ConstantArray", "[", 
         RowBox[{"0", ",", " ", "nc"}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"p", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}], 
        " ", "=", " ", 
        RowBox[{"Array", "[", 
         RowBox[{"\[DoubleStruckC]", ",", " ", 
          RowBox[{"Length", "@", "i"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"p", "\[LeftDoubleBracket]", 
         RowBox[{"nq", "+", "1"}], "\[RightDoubleBracket]"}], " ", "=", " ", 
        "1"}], ";", "\[IndentingNewLine]", 
       RowBox[{"p", " ", "=", " ", 
        RowBox[{
         RowBox[{"OptionValue", "[", "\"\<c[p]\>\"", "]"}], "@", "p"}]}], ";",
        "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"cT", " ", "=", " ", 
        RowBox[{
         RowBox[{"OptionValue", "[", "\"\<c[T]\>\"", "]"}], "@", 
         RowBox[{"Join", "[", 
          RowBox[{
           RowBox[{"Array", "[", 
            RowBox[{"\[DoubleStruckX]", ",", " ", "nx"}], "]"}], ",", " ", 
           RowBox[{"Array", "[", 
            RowBox[{"\[DoubleStruckC]", ",", " ", 
             RowBox[{"nc", "-", "nx"}], ",", " ", 
             RowBox[{"nx", "+", "1"}]}], "]"}]}], "]"}]}]}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"q", " ", "=", " ", 
        RowBox[{"\"\<c\>\"", " ", "\[Rule]", " ", 
         RowBox[{"Association", "[", 
          RowBox[{
           RowBox[{"\"\<x\>\"", " ", "\[Rule]", " ", "x"}], ",", " ", 
           RowBox[{"\"\<\[Alpha]\>\"", " ", "\[Rule]", " ", "a"}], ",", " ", 
           RowBox[{"\"\<\[Mu]\>\"", " ", "\[Rule]", " ", "u"}], ",", " ", 
           RowBox[{"\"\<T\>\"", " ", "\[Rule]", " ", "t"}]}], "]"}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"v", " ", "=", " ", 
        RowBox[{"\"\<\[DoubleStruckC]\>\"", " ", "\[Rule]", " ", 
         RowBox[{"Association", "[", 
          RowBox[{
           RowBox[{"\"\<p\>\"", " ", "\[Rule]", " ", "p"}], ",", " ", 
           RowBox[{"\"\<T\>\"", " ", "\[Rule]", " ", "cT"}], ",", " ", 
           RowBox[{"\"\<eq\>\"", " ", "\[Rule]", " ", "ceq"}]}], "]"}]}]}], 
       ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"(*", " ", 
        RowBox[{
         RowBox[{
         "get", " ", "mapping", " ", "of", " ", "variables", " ", "in", " ", 
          "p"}], "-", 
         RowBox[{
          RowBox[{"(", 
           RowBox[{"stc", "-"}], ")"}], "space"}]}], " ", "*)"}], 
       "\[IndentingNewLine]", 
       RowBox[{"i", " ", "=", " ", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{
            "\"\<x\>\"", ",", " ", "\"\<\[Alpha]\>\"", ",", " ", 
             "\"\<\[Mu]\>\"", ",", " ", "\"\<T\>\""}], "}"}], ",", " ", 
           RowBox[{"Length", " ", "/@", " ", 
            RowBox[{"{", 
             RowBox[{"x", ",", " ", "a", " ", ",", " ", "u", ",", "t"}], 
             "}"}]}]}], "}"}], "\[Transpose]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"i", " ", "=", " ", 
        RowBox[{"Select", "[", 
         RowBox[{"i", ",", " ", 
          RowBox[{
           RowBox[{
            RowBox[{
            "#", "\[LeftDoubleBracket]", "2", "\[RightDoubleBracket]"}], " ", 
            ">", " ", "0"}], "&"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"\[Alpha]", " ", "=", " ", 
        RowBox[{"Rest", "@", 
         RowBox[{"FoldList", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"Range", "[", 
             RowBox[{
              RowBox[{
               RowBox[{"#1", "\[LeftDoubleBracket]", 
                RowBox[{"-", "1"}], "\[RightDoubleBracket]"}], "+", "1"}], 
              ",", " ", 
              RowBox[{
               RowBox[{"#1", "\[LeftDoubleBracket]", 
                RowBox[{"-", "1"}], "\[RightDoubleBracket]"}], "+", "#2"}]}], 
             "]"}], "&"}], ",", " ", 
           RowBox[{"{", "0", "}"}], ",", " ", 
           RowBox[{"i", "\[LeftDoubleBracket]", 
            RowBox[{"All", ",", " ", "2"}], "\[RightDoubleBracket]"}]}], 
          "]"}]}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"(*", " ", 
        RowBox[{
         RowBox[{
         "add", " ", "zero", " ", "length", " ", "variables", " ", "back", 
          " ", "into", " ", "p"}], "-", 
         RowBox[{
          RowBox[{"(", 
           RowBox[{"stc", "-"}], ")"}], "space"}]}], " ", "*)"}], 
       "\[IndentingNewLine]", 
       RowBox[{"i", " ", "=", " ", 
        RowBox[{"Join", "[", 
         RowBox[{
          RowBox[{"i", "\[LeftDoubleBracket]", 
           RowBox[{"All", ",", " ", "1"}], "\[RightDoubleBracket]"}], ",", 
          " ", 
          RowBox[{"Complement", "[", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{
             "\"\<x\>\"", ",", " ", "\"\<\[Alpha]\>\"", ",", " ", 
              "\"\<\[Mu]\>\"", ",", " ", "\"\<T\>\""}], "}"}], ",", " ", 
            RowBox[{"i", "\[LeftDoubleBracket]", 
             RowBox[{"All", ",", " ", "1"}], "\[RightDoubleBracket]"}]}], 
           "]"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"\[Alpha]", " ", "=", " ", 
        RowBox[{"PadRight", "[", 
         RowBox[{"\[Alpha]", ",", " ", 
          RowBox[{"Length", "@", "i"}], ",", " ", 
          RowBox[{"{", 
           RowBox[{"{", "}"}], "}"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"\[Alpha]", " ", "=", " ", 
        RowBox[{"\"\<p\>\"", " ", "\[Rule]", " ", 
         RowBox[{"AssociationThread", "[", 
          RowBox[{"i", " ", "\[Rule]", " ", "\[Alpha]"}], "]"}]}]}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"Association", "[", 
        RowBox[{"q", ",", " ", "v", ",", " ", "\[Alpha]", ",", " ", 
         RowBox[{"OptionValue", "[", "Association", "]"}]}], "]"}]}]}], 
     "\[IndentingNewLine]", "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"SetAttributes", "[", 
   RowBox[{"BLSummary", ",", " ", "Listable"}], "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"BLSummary", "::", "name"}], " ", "=", " ", 
    "\"\<`1` is not a valid mode.  Valid modes are `2`.\>\""}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"BLSummary", "[", "]"}], " ", ":=", " ", 
    RowBox[{"BLSummary", "[", 
     RowBox[{"Keys", "@", 
      RowBox[{"BLbiped", "[", "\"\<m\>\"", "]"}]}], "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"BLSummary", "[", "name_", "]"}], " ", ":=", " ", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "a", ",", " ", "p", ",", " ", "m", ",", " ", "v", ",", " ", "b"}], 
      "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"MissingQ", "[", 
         RowBox[{"BLbiped", "[", 
          RowBox[{"\"\<BLSummary\>\"", ",", " ", "name"}], "]"}], "]"}], ",", 
        " ", "\[IndentingNewLine]", 
        RowBox[{"Return", "@", 
         RowBox[{"Message", "[", 
          RowBox[{
           RowBox[{"BLSummary", "::", "name"}], ",", " ", "name", ",", " ", 
           RowBox[{"Keys", "@", 
            RowBox[{"BLbiped", "[", "\"\<BLSummary\>\"", "]"}]}]}], "]"}]}]}],
        "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
       "get", " ", "actuated", " ", "links", " ", "during", " ", "regime", 
        " ", 
        RowBox[{"(", 
         RowBox[{
          RowBox[{"most", " ", "likely", " ", "post"}], "-", "impact"}], 
         ")"}]}], " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{"v", " ", "=", " ", 
       RowBox[{"Lookup", "[", 
        RowBox[{
         RowBox[{"BLbiped", "[", 
          RowBox[{"\"\<BLSummary\>\"", ",", " ", "name"}], "]"}], ",", " ", 
         "\"\<V\>\"", ",", " ", 
         RowBox[{"{", "}"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"m", " ", "=", " ", 
       RowBox[{"Lookup", "[", 
        RowBox[{
         RowBox[{"BLbiped", "[", 
          RowBox[{"\"\<BLSummary\>\"", ",", " ", "name"}], "]"}], ",", " ", 
         "\"\<B\>\"", ",", " ", "Automatic"}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"p", " ", "=", " ", 
       RowBox[{"BLConstraints", "[", 
        RowBox[{
         RowBox[{"{", "}"}], ",", " ", "v", ",", " ", 
         RowBox[{"{", "}"}], ",", " ", "m"}], "]"}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"m", " ", "=", " ", 
       RowBox[{
        RowBox[{"RBDGetIndex", "@", 
         RowBox[{"p", "[", "\"\<B\>\"", "]"}]}], "-", "nq"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"a", " ", "=", " ", 
       RowBox[{"ConstantArray", "[", 
        RowBox[{"\"\<u\>\"", ",", " ", "nq"}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"b", " ", "=", " ", 
       RowBox[{"ConstantArray", "[", 
        RowBox[{"0", ",", " ", "nq"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"Do", "[", 
       RowBox[{
        RowBox[{
         RowBox[{
          RowBox[{"a", "\[LeftDoubleBracket]", 
           RowBox[{
           "m", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}], 
           "\[RightDoubleBracket]"}], " ", "=", " ", 
          RowBox[{"p", "\[LeftDoubleBracket]", 
           RowBox[{"\"\<M\>\"", ",", " ", "i"}], "\[RightDoubleBracket]"}]}], 
         ";", " ", 
         RowBox[{
          RowBox[{"b", "\[LeftDoubleBracket]", 
           RowBox[{
           "m", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}], 
           "\[RightDoubleBracket]"}], " ", "=", " ", "i"}], ";"}], ",", " ", 
        RowBox[{"{", 
         RowBox[{"i", ",", " ", 
          RowBox[{"Length", "@", "m"}]}], "}"}]}], "]"}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
        RowBox[{"get", " ", "pre"}], "-", 
        RowBox[{"impact", " ", "dependent", " ", "variables"}]}], " ", "*)"}],
       "\[IndentingNewLine]", 
      RowBox[{"p", " ", "=", " ", 
       RowBox[{"BLbiped", "[", 
        RowBox[{"\"\<c\>\"", ",", " ", "name", ",", " ", "\"\<x\>\""}], 
        "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"v", " ", "=", " ", 
       RowBox[{"ConstantArray", "[", 
        RowBox[{"\"\<d\>\"", ",", " ", "nx"}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"v", "\[LeftDoubleBracket]", "p", "\[RightDoubleBracket]"}], 
       " ", "=", " ", "\"\<i\>\""}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
        RowBox[{"get", " ", "pre"}], "-", 
        RowBox[{"impact", " ", "state"}]}], " ", "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"p", " ", "=", " ", 
       RowBox[{"Array", "[", 
        RowBox[{"\[DoubleStruckC]", ",", " ", 
         RowBox[{"Total", "[", 
          RowBox[{"Length", "/@", 
           RowBox[{"BLbiped", "[", 
            RowBox[{"\"\<c\>\"", ",", " ", "name"}], "]"}]}], "]"}]}], 
        "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"p", " ", "=", " ", 
       RowBox[{"Quiet", "@", 
        RowBox[{"Flatten", "@", 
         RowBox[{
          RowBox[{"BLbiped", "[", 
           RowBox[{
           "\"\<\[DoubleStruckC]\>\"", ",", " ", "name", ",", " ", 
            "\"\<p\>\""}], "]"}], "[", 
          RowBox[{"{", 
           RowBox[{"p", ",", " ", 
            RowBox[{"{", "}"}], ",", " ", 
            RowBox[{"{", "}"}]}], "}"}], "]"}]}]}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"p", " ", "=", " ", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"p", "\[LeftDoubleBracket]", 
          RowBox[{"1", ";;", "nq"}], "\[RightDoubleBracket]"}], ",", " ", 
         RowBox[{"p", "\[LeftDoubleBracket]", 
          RowBox[{
           RowBox[{"nq", "+", "1"}], ";;", "nx"}], 
          "\[RightDoubleBracket]"}]}], "}"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"v", " ", "=", " ", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"v", "\[LeftDoubleBracket]", 
          RowBox[{"1", ";;", "nq"}], "\[RightDoubleBracket]"}], ",", " ", 
         RowBox[{"v", "\[LeftDoubleBracket]", 
          RowBox[{
           RowBox[{"nq", "+", "1"}], ";;", "nx"}], 
          "\[RightDoubleBracket]"}]}], "}"}]}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"p", " ", "=", " ", 
       RowBox[{"Join", "[", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"RBDGetValue", "[", 
           RowBox[{"1", ",", " ", "nq", ",", " ", 
            RowBox[{"\"\<n\>\"", " ", "\[Rule]", " ", "True"}]}], "]"}], 
          "}"}], ",", " ", "v", ",", " ", "p", ",", " ", 
         RowBox[{"{", 
          RowBox[{"a", ",", " ", "b"}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{"q", "-", 
        RowBox[{"/", "v"}], "-", " ", 
        RowBox[{
        "are", " ", "variables", " ", "in", " ", "previous", " ", "mode", " ",
          "that", " ", "affect", " ", "name", " ", "regime"}]}], " ", "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"v", " ", "=", " ", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"Range", "@", "nq"}], ",", " ", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"\"\<q \>\"", " ", "<>", " ", "name"}], ",", " ", 
           "\"\<q-/i\>\"", ",", " ", "\"\<v-/i\>\"", ",", " ", "\"\<q-\>\"", 
           ",", " ", "\"\<v-\>\"", ",", " ", "\"\<B+\>\"", ",", " ", 
           "\"\<B\>\""}], "}"}]}], "}"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"TableForm", "[", 
       RowBox[{
        RowBox[{"Transpose", "@", "p"}], ",", " ", 
        RowBox[{"TableHeadings", "\[Rule]", "v"}]}], "]"}]}]}], 
    "\[IndentingNewLine]", "]"}]}], ";"}]}], "Input",
 InitializationCell->
  True,ExpressionUUID->"e16d4c35-7b02-4dc7-aa74-015a85de3d53"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"BLA", "[", 
    RowBox[{
     RowBox[{"ind1_:", 
      RowBox[{"{", "}"}]}], ",", " ", 
     RowBox[{"ind0_:", 
      RowBox[{"{", "}"}]}], ",", " ", 
     RowBox[{"r_:", 
      RowBox[{"{", 
       RowBox[{"\"\<rx\>\"", ",", " ", "\"\<ry\>\"", ",", " ", "\"\<rz\>\""}],
        "}"}]}]}], "]"}], " ", ":=", " ", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"A", ",", " ", "k", ",", " ", "f", ",", " ", "I"}], "}"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{"compute", " ", "body", " ", "parts", " ", "to", " ", "swap"}], 
      " ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"k", " ", "=", " ", 
       RowBox[{"RigidBodyDynamics`Private`rb", "[", 
        RowBox[{"Links", ",", " ", "TreeForm"}], "]"}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{"get", " ", "A"}], " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{"k", " ", "=", " ", 
       RowBox[{"KeyValueMap", "[", 
        RowBox[{"List", ",", " ", "k"}], "]"}]}], ";", "\[IndentingNewLine]", 
      
      RowBox[{"(*", " ", 
       RowBox[{
       "naming", " ", "convention", " ", "allows", " ", "for", " ", 
        "grouping", " ", "of", " ", "left", " ", "and", " ", "right"}], " ", 
       "*)"}], "\[IndentingNewLine]", 
      RowBox[{"f", " ", "=", " ", 
       RowBox[{
        RowBox[{"StringJoin", "@", 
         RowBox[{
          RowBox[{"StringSplit", "[", 
           RowBox[{
            RowBox[{
            "#", "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}], ",", 
            " ", 
            RowBox[{
            "\"\<_\>\"", "|", "\"\<-\>\"", "|", "\"\<.\>\"", "|", 
             "\"\< \>\""}]}], "]"}], "\[LeftDoubleBracket]", 
          RowBox[{
           RowBox[{"-", "2"}], ";;", 
           RowBox[{"-", "1"}]}], "\[RightDoubleBracket]"}]}], "&"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"k", " ", "=", " ", 
       RowBox[{"GroupBy", "[", 
        RowBox[{"k", ",", " ", "f"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"k", " ", "=", " ", 
       RowBox[{"k", "\[LeftDoubleBracket]", 
        RowBox[{"All", ",", " ", "All", ",", " ", "2"}], 
        "\[RightDoubleBracket]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"k", " ", "=", " ", 
       RowBox[{
        RowBox[{
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"Length", "@", "#"}], " ", "\[Equal]", " ", "1"}], ",", 
           " ", 
           RowBox[{"Join", "[", 
            RowBox[{"#", ",", "#"}], "]"}], ",", " ", "#"}], "]"}], "&"}], 
        " ", "/@", " ", "k"}]}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{"initialize", " ", "A"}], " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{"A", " ", "=", " ", 
       RowBox[{"ConstantArray", "[", 
        RowBox[{"0", ",", " ", 
         RowBox[{"{", 
          RowBox[{"nq", ",", " ", "nq"}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{
        RowBox[{"(", 
         RowBox[{
          RowBox[{"A", "\[LeftDoubleBracket]", 
           RowBox[{
            RowBox[{
            "#", "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}], ",", 
            " ", 
            RowBox[{
            "#", "\[LeftDoubleBracket]", "2", "\[RightDoubleBracket]"}]}], 
           "\[RightDoubleBracket]"}], " ", "=", " ", 
          RowBox[{
           RowBox[{"A", "\[LeftDoubleBracket]", 
            RowBox[{
             RowBox[{
             "#", "\[LeftDoubleBracket]", "2", "\[RightDoubleBracket]"}], ",",
              " ", 
             RowBox[{
             "#", "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}]}], 
            "\[RightDoubleBracket]"}], " ", "=", " ", "1"}]}], ")"}], "&"}], 
       " ", "/@", " ", "k"}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{"fix", " ", "A"}], " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
        RowBox[{"ind1", " ", "=", " ", 
         RowBox[{
          RowBox[{
           RowBox[{"{", 
            RowBox[{"{", 
             RowBox[{"a", ",", " ", "b"}], "}"}], "}"}], " ", "makes", " ", 
           RowBox[{"A", "\[LeftDoubleBracket]", 
            RowBox[{"a", ",", " ", "b"}], "\[RightDoubleBracket]"}], " ", 
           "and", " ", 
           RowBox[{"A", "\[LeftDoubleBracket]", 
            RowBox[{"b", ",", " ", "a"}], "\[RightDoubleBracket]"}]}], " ", 
          "=", " ", 
          RowBox[{"-", "1"}]}]}], ",", " ", 
        RowBox[{"etc", "."}]}], " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
        RowBox[{
         RowBox[{
          RowBox[{"it", "'"}], "s", " ", "OK", " ", "if", " ", "a"}], " ", 
         "=", " ", "b"}], ",", " ", 
        RowBox[{
        "but", " ", "they", " ", "must", " ", "come", " ", "in", " ", 
         "pairs"}]}], " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{"f", " ", "=", " ", 
       RowBox[{
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{"IntegerQ", "[", "#", "]"}], ",", " ", "#", ",", " ", 
          RowBox[{"RBDGetIndex", "@", "#"}]}], "]"}], "&"}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"I", " ", "=", " ", 
       RowBox[{"Map", "[", 
        RowBox[{"f", ",", " ", "ind1", ",", " ", 
         RowBox[{"{", "2", "}"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"Do", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"A", "\[LeftDoubleBracket]", 
          RowBox[{"Sequence", "@@", "i"}], "\[RightDoubleBracket]"}], " ", 
         "=", " ", 
         RowBox[{
          RowBox[{"A", "\[LeftDoubleBracket]", 
           RowBox[{"Sequence", "@@", 
            RowBox[{"Reverse", "@", "i"}]}], "\[RightDoubleBracket]"}], " ", 
          "=", " ", 
          RowBox[{"-", "1"}]}]}], ",", " ", 
        RowBox[{"{", 
         RowBox[{"i", ",", " ", "I"}], "}"}]}], "]"}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"I", " ", "=", " ", 
       RowBox[{"Map", "[", 
        RowBox[{"f", ",", " ", "ind0", ",", " ", 
         RowBox[{"{", "2", "}"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"Do", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"A", "\[LeftDoubleBracket]", 
          RowBox[{"Sequence", "@@", "i"}], "\[RightDoubleBracket]"}], " ", 
         "=", " ", 
         RowBox[{
          RowBox[{"A", "\[LeftDoubleBracket]", 
           RowBox[{"Sequence", "@@", 
            RowBox[{"Reverse", "@", "i"}]}], "\[RightDoubleBracket]"}], " ", 
          "=", " ", "0"}]}], ",", " ", 
        RowBox[{"{", 
         RowBox[{"i", ",", " ", "I"}], "}"}]}], "]"}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"ArrayFlatten", "[", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"A", ",", " ", "0"}], "}"}], ",", " ", 
         RowBox[{"{", 
          RowBox[{"0", ",", " ", "A"}], "}"}]}], "}"}], "]"}]}]}], 
    "\[IndentingNewLine]", "]"}]}], ";"}]], "Input",
 InitializationCell->
  True,ExpressionUUID->"d38af8e9-0cef-41ac-b716-f6ce4bf4e1fd"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Map from continuation parameters to parameter vector", \
"Section",ExpressionUUID->"be6b99c5-1d37-4065-8d91-a1a4630bf13b"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"SetAttributes", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"BLGetIndex", ",", " ", "BLGetValue"}], "}"}], ",", " ", 
     "Listable"}], "]"}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"Options", "[", "BLGetIndex", "]"}], " ", "=", " ", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"\"\<m\>\"", " ", "\[Rule]", " ", "Automatic"}], ",", " ", 
      RowBox[{"\"\<n\>\"", " ", "\[Rule]", " ", "1"}], ",", " ", 
      RowBox[{"\"\<x\>\"", " ", "\[Rule]", " ", "Automatic"}]}], "}"}]}], 
   ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"BLGetIndex", "[", 
     RowBox[{"i_Integer", ",", " ", 
      RowBox[{"o", ":", 
       RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], " ", ":=", " ", 
    RowBox[{"BLGetIndex", "[", 
     RowBox[{
      RowBox[{"RBDGetValue", "[", "i", "]"}], ",", " ", "o"}], "]"}]}], ";"}],
   "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"BLGetIndex", "[", 
     RowBox[{"s_String", ",", " ", 
      RowBox[{"o", ":", 
       RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], " ", ":=", " ", 
    RowBox[{"BLGetIndex", "[", 
     RowBox[{
      RowBox[{"\[DoubleStruckQ]", "[", 
       RowBox[{"s", ",", " ", 
        RowBox[{"OptionValue", "[", "\"\<n\>\"", "]"}]}], "]"}], ",", " ", 
      "o"}], "]"}]}], ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"BLGetIndex", "[", 
     RowBox[{"q_", ",", " ", 
      RowBox[{"OptionsPattern", "[", "]"}]}], "]"}], " ", ":=", " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"n", ",", " ", "m"}], "}"}], ",", " ", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"m", " ", "=", " ", 
        RowBox[{"OptionValue", "[", "\"\<m\>\"", "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"m", " ", "===", " ", "Automatic"}], ",", " ", 
         RowBox[{"m", " ", "=", " ", 
          RowBox[{"BLbiped", "[", "\"\<m[0]\>\"", "]"}]}]}], "]"}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"n", " ", "=", " ", 
        RowBox[{"OptionValue", "[", "\"\<x\>\"", "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"Which", "[", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"n", " ", "===", " ", "Automatic"}], ",", " ", 
         RowBox[{"n", " ", "=", " ", 
          RowBox[{"BLbiped", "[", 
           RowBox[{"\"\<c\>\"", ",", " ", "m", ",", " ", "\"\<x\>\""}], 
           "]"}]}], ",", "\[IndentingNewLine]", 
         RowBox[{"!", 
          RowBox[{"VectorQ", "[", 
           RowBox[{"n", ",", " ", "IntegerQ"}], "]"}]}], ",", " ", 
         RowBox[{"n", " ", "=", " ", 
          RowBox[{"BLRemoveStates", "@@", "n"}]}]}], "\[IndentingNewLine]", 
        "]"}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"n", " ", "=", " ", 
        RowBox[{"Position", "[", 
         RowBox[{
          RowBox[{"RBDGetValue", "@", "n"}], ",", " ", 
          RowBox[{"RBDGetValue", "@", 
           RowBox[{"RBDGetIndex", "@", "q"}]}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"n", " ", "=", " ", 
        RowBox[{"Flatten", "@", "n"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"n", " ", "===", " ", 
          RowBox[{"{", "}"}]}], ",", " ", "n", ",", " ", 
         RowBox[{"First", "@", "n"}]}], "]"}]}]}], "\[IndentingNewLine]", 
     "]"}]}], ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"BLGetValue", "[", 
    RowBox[{"i_", ",", " ", 
     RowBox[{"m0_:", "Automatic"}]}], "]"}], " ", ":=", " ", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "m", ",", " ", "c", ",", " ", "p", ",", " ", "x", ",", " ", 
       "\[Lambda]"}], "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"m", " ", "=", " ", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"m0", " ", "===", " ", "Automatic"}], ",", " ", 
         RowBox[{"BLbiped", "[", "\"\<m[0]\>\"", "]"}], ",", " ", "m0"}], 
        "]"}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"p", " ", "=", " ", 
       RowBox[{"BLbiped", "[", 
        RowBox[{"\"\<p\>\"", ",", " ", "m", ",", " ", "\"\<x\>\""}], "]"}]}], 
      ";", "\[IndentingNewLine]", 
      RowBox[{"c", " ", "=", " ", 
       RowBox[{"BLbiped", "[", 
        RowBox[{"\"\<c\>\"", ",", " ", "m"}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"x", " ", "=", " ", 
       RowBox[{"c", "[", "\"\<x\>\"", "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"\[Lambda]", " ", "=", " ", 
       RowBox[{"Flatten", "@", 
        RowBox[{"Values", "@", 
         RowBox[{"KeyDrop", "[", 
          RowBox[{"c", ",", " ", "\"\<x\>\""}], "]"}]}]}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"MemberQ", "[", 
         RowBox[{"p", ",", " ", "i"}], "]"}], ",", " ", 
        RowBox[{"RBDGetValue", "@", 
         RowBox[{
         "x", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}]}], ",", 
        " ", 
        RowBox[{"\[DoubleStruckC]", "[", 
         RowBox[{"\[Lambda]", "\[LeftDoubleBracket]", 
          RowBox[{"i", "-", 
           RowBox[{"Length", "@", "x"}]}], "\[RightDoubleBracket]"}], "]"}]}],
        "]"}]}]}], "\[IndentingNewLine]", "]"}]}], ";"}]}], "Input",
 InitializationCell->
  True,ExpressionUUID->"986fc73e-cd17-4a58-a748-2373f325e5dc"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"p2c", "::", "ncp"}], " ", "=", " ", 
   "\"\<No continuation parameters have been set.\>\""}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"p2c", "[", 
     RowBox[{"c_", ",", " ", "n_"}], "]"}], " ", ":=", " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "ncp", ",", " ", "f", ",", " ", "v", ",", " ", "r", ",", " ", "d", ",",
         " ", "Dc"}], "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
       "assume", " ", "\"\<p\>\"", " ", "is", " ", "in", " ", "absolute", " ",
         "indexing", " ", "order"}], " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"ncp", " ", "=", " ", 
        RowBox[{"Max", "@", 
         RowBox[{"Lookup", "[", 
          RowBox[{"BLbiped", ",", " ", "\"\<p\>\"", ",", " ", "0"}], 
          "]"}]}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"ncp", " ", ">", " ", "0"}], ",", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"v", " ", "=", " ", 
           RowBox[{"{", 
            RowBox[{"{", 
             RowBox[{"\[DoubleStruckC]", ",", " ", "ncp"}], "}"}], "}"}]}], 
          ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
          RowBox[{"Dc", " ", "=", " ", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"IdentityMatrix", "[", "ncp", "]"}], ",", " ", 
             RowBox[{"ConstantArray", "[", 
              RowBox[{"0", ",", " ", 
               RowBox[{"{", 
                RowBox[{"ncp", ",", " ", "ncp", ",", "ncp"}], "}"}]}], 
              "]"}]}], "}"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"d", " ", "=", " ", 
           RowBox[{"List", "@", 
            RowBox[{"Derivatives`Private`CreateArguments", "[", 
             RowBox[{
              RowBox[{"Evaluate", "@", 
               RowBox[{"v", "\[LeftDoubleBracket]", 
                RowBox[{"All", ",", "1"}], "\[RightDoubleBracket]"}]}], ",", 
              " ", "n"}], "]"}]}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"d", " ", "=", " ", 
           RowBox[{"MapIndexed", "[", 
            RowBox[{
             RowBox[{
              RowBox[{
               RowBox[{"HoldPattern", "[", "#1", "]"}], " ", "\[Rule]", " ", 
               RowBox[{"Dc", "\[LeftDoubleBracket]", 
                RowBox[{
                "#2", "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}], 
                "\[RightDoubleBracket]"}]}], "&"}], ",", " ", 
             RowBox[{"d", "\[LeftDoubleBracket]", 
              RowBox[{"2", ";;", 
               RowBox[{"n", "+", "1"}]}], "\[RightDoubleBracket]"}]}], 
            "]"}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
          RowBox[{"f", " ", "=", " ", 
           RowBox[{
            RowBox[{"N", "@", 
             RowBox[{"First", "@", 
              RowBox[{"Df", "[", 
               RowBox[{
                RowBox[{"{", 
                 RowBox[{
                  RowBox[{"{", "c", "}"}], ",", " ", "v"}], "}"}], ",", " ", 
                "\"\<ch\>\"", ",", " ", 
                RowBox[{"D", "\[Rule]", "n"}]}], "]"}]}]}], " ", "/.", " ", 
            "d"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"f", " ", "=", " ", 
           RowBox[{"DfToCompiledFunction", "[", 
            RowBox[{"f", ",", " ", "v", ",", " ", 
             RowBox[{"{", "_Real", "}"}], ",", " ", 
             RowBox[{
             "CompilationTarget", " ", "\[Rule]", " ", "\"\<WVM\>\""}]}], 
            "]"}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
          RowBox[{"d", " ", "=", " ", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"Hold", "[", 
              RowBox[{
               RowBox[{"Slot", "[", "1", "]"}], "\[LeftDoubleBracket]", "1", 
               "\[RightDoubleBracket]"}], "]"}], ",", " ", 
             RowBox[{"{", "}"}], ",", " ", 
             RowBox[{"{", "}"}]}], "}"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"r", " ", "=", " ", 
           RowBox[{
            RowBox[{"With", "[", 
             RowBox[{
              RowBox[{"{", 
               RowBox[{"a", " ", "=", " ", 
                RowBox[{"Sequence", "@@", 
                 RowBox[{"d", "\[LeftDoubleBracket]", 
                  RowBox[{"1", ";;", 
                   RowBox[{
                   "#2", "\[LeftDoubleBracket]", "1", 
                    "\[RightDoubleBracket]"}]}], 
                  "\[RightDoubleBracket]"}]}]}], "}"}], ",", " ", 
              RowBox[{
               RowBox[{"Hold", "[", "#1", "]"}], "[", "a", "]"}]}], "]"}], 
            "&"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"f", " ", "=", " ", 
           RowBox[{"MapIndexed", "[", 
            RowBox[{"r", ",", " ", "f"}], "]"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"With", "[", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"a", " ", "=", " ", "f"}], "}"}], ",", " ", 
             RowBox[{"a", "&"}]}], "]"}], " ", "/.", " ", 
           RowBox[{
            RowBox[{"Hold", "[", "a_", "]"}], " ", "\[RuleDelayed]", " ", 
            "a"}]}]}], ",", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"Message", "[", 
           RowBox[{"p2c", "::", "ncp"}], "]"}], ";", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"{", "}"}], "&"}]}]}], "\[IndentingNewLine]", "]"}]}]}], 
     "\[IndentingNewLine]", "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"c2c", "::", "nc"}], " ", "=", " ", 
   "\"\<No parameters have been set.\>\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"c2c", "[", 
    RowBox[{"c_", ",", " ", "n_"}], "]"}], " ", ":=", " ", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "f", ",", " ", "v", ",", " ", "r", ",", " ", "d", ",", " ", "p"}], 
      "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"nc", " ", ">", " ", "0"}], ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"v", " ", "=", " ", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{"\[DoubleStruckX]", ",", " ", "nx"}], "}"}], ",", " ", 
           RowBox[{"{", 
            RowBox[{"\[DoubleStruckC]", ",", " ", "nc"}], "}"}]}], "}"}]}], 
        ";", "\[IndentingNewLine]", 
        RowBox[{"d", " ", "=", " ", 
         RowBox[{"Table", "[", 
          RowBox[{
           RowBox[{"p", "[", 
            RowBox[{
             RowBox[{"Slot", "[", "i", "]"}], ",", " ", "j"}], "]"}], ",", 
           " ", 
           RowBox[{"{", 
            RowBox[{"i", ",", " ", 
             RowBox[{"Length", "@", "v"}]}], "}"}], ",", " ", 
           RowBox[{"{", 
            RowBox[{"j", ",", " ", 
             RowBox[{"n", "+", "1"}]}], "}"}]}], "]"}]}], ";", 
        "\[IndentingNewLine]", "\[IndentingNewLine]", 
        RowBox[{"f", " ", "=", " ", 
         RowBox[{"N", "@", 
          RowBox[{"First", "@", 
           RowBox[{"Df", "[", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{
               RowBox[{"{", "c", "}"}], ",", " ", "v"}], "}"}], ",", " ", 
             "\"\<ch\>\"", ",", " ", 
             RowBox[{"D", "\[Rule]", "n"}]}], "]"}]}]}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"f", " ", "=", " ", 
         RowBox[{"DfToCompiledFunction", "[", 
          RowBox[{"f", ",", " ", "v", ",", " ", "_Real", ",", " ", 
           RowBox[{
           "CompilationTarget", " ", "\[Rule]", " ", "\"\<WVM\>\""}]}], 
          "]"}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
        RowBox[{"r", " ", "=", " ", 
         RowBox[{
          RowBox[{"With", "[", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"a", " ", "=", " ", 
              RowBox[{"Sequence", "@@", 
               RowBox[{"Flatten", "@", 
                RowBox[{"d", "\[LeftDoubleBracket]", 
                 RowBox[{"All", ",", " ", 
                  RowBox[{"1", ";;", 
                   RowBox[{
                   "#2", "\[LeftDoubleBracket]", "1", 
                    "\[RightDoubleBracket]"}]}]}], 
                 "\[RightDoubleBracket]"}]}]}]}], "}"}], ",", " ", 
            RowBox[{
             RowBox[{"Hold", "[", "#1", "]"}], "[", "a", "]"}]}], "]"}], 
          "&"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"f", " ", "=", " ", 
         RowBox[{"MapIndexed", "[", 
          RowBox[{"r", ",", " ", "f"}], "]"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{
          RowBox[{"With", "[", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"a", " ", "=", " ", "f"}], "}"}], ",", " ", 
            RowBox[{"a", "&"}]}], "]"}], " ", "/.", " ", 
          RowBox[{
           RowBox[{"Hold", "[", "a_", "]"}], " ", "\[RuleDelayed]", " ", 
           "a"}]}], " ", "/.", " ", 
         RowBox[{"p", " ", "\[Rule]", " ", "Part"}]}]}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"Message", "[", 
         RowBox[{"c2c", "::", "nc"}], "]"}], ";", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"{", "}"}], "&"}]}]}], "\[IndentingNewLine]", "]"}]}], 
    "\[IndentingNewLine]", "]"}]}], ";"}]}], "Input",
 InitializationCell->
  True,ExpressionUUID->"6b1231fd-56c0-4dd6-9513-63fbfe8375ed"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"BLContinuationIndices", "[", 
     RowBox[{
      RowBox[{"ap_:", 
       RowBox[{"{", "}"}]}], ",", " ", 
      RowBox[{"dp_:", 
       RowBox[{"{", "}"}]}]}], "]"}], " ", ":=", " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"a", ",", " ", "n", ",", " ", "m", ",", " ", "p"}], "}"}], ",",
       "\[IndentingNewLine]", 
      RowBox[{"(*", " ", "deprecated", " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"Throw", "[", "BLContinuationIndices", "]"}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"a", " ", "=", " ", 
        RowBox[{"Flatten", "@", "angles"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"a", " ", "=", " ", 
        RowBox[{"Join", "[", 
         RowBox[{"a", ",", " ", 
          RowBox[{"a", "+", "nq"}], ",", " ", "ap"}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"a", " ", "=", " ", 
        RowBox[{"DeleteCases", "[", 
         RowBox[{"a", ",", " ", 
          RowBox[{"Alternatives", "@@", "dp"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"n", " ", "=", " ", 
        RowBox[{"Length", "@", "a"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"p", " ", "=", " ", 
        RowBox[{"ConstantArray", "[", 
         RowBox[{"0", ",", " ", "nc"}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"p", "\[LeftDoubleBracket]", "a", "\[RightDoubleBracket]"}], 
        " ", "=", " ", 
        RowBox[{"Array", "[", 
         RowBox[{"\[DoubleStruckC]", ",", " ", "n"}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"p", "\[LeftDoubleBracket]", 
         RowBox[{"nq", "+", "1"}], "\[RightDoubleBracket]"}], " ", "=", " ", 
        "1"}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"{", 
        RowBox[{"a", ",", " ", "p"}], "}"}]}]}], "\[IndentingNewLine]", 
     "]"}]}], ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"BLCreateContinuationParameters", "[", 
    RowBox[{"begin_", ",", " ", "CP_"}], "]"}], " ", ":=", " ", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"A", ",", " ", "a", ",", " ", "t", ",", " ", "x"}], "}"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
       RowBox[{"flip", " ", "order", " ", "of", " ", "keys"}], ",", " ", 
       RowBox[{"KeyValueMap", " ", "flips"}], ",", " ", 
       RowBox[{
        RowBox[{"Assoc", "..."}], " ", "make", " ", "into", " ", "list", " ", 
        "of", " ", 
        RowBox[{"<|", "|>"}]}]}], " ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"A", " ", "=", " ", 
       RowBox[{
        RowBox[{"(", 
         RowBox[{
          RowBox[{"Keys", "@", "#2"}], " ", "\[Rule]", " ", 
          RowBox[{"(", 
           RowBox[{"Association", " ", "/@", " ", 
            RowBox[{"Thread", "[", 
             RowBox[{"#1", " ", "\[Rule]", " ", 
              RowBox[{"Values", "@", "#2"}]}], "]"}]}], ")"}]}], ")"}], 
        "&"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"A", " ", "=", " ", 
       RowBox[{"AssociationThread", "/@", 
        RowBox[{"KeyValueMap", "[", 
         RowBox[{"A", ",", " ", "CP"}], "]"}]}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"A", " ", "=", " ", 
       RowBox[{"Merge", "[", 
        RowBox[{"A", ",", " ", 
         RowBox[{
          RowBox[{"Join", "@@", "#"}], "&"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", "p", " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{"blmp", "[", 
       RowBox[{"A", "\[LeftDoubleBracket]", 
        RowBox[{
        "\"\<\[DoubleStruckC]\>\"", ",", " ", "All", ",", " ", "\"\<p\>\""}], 
        "\[RightDoubleBracket]"}], "]"}], ";", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", "cT", " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{"blmcT", "[", 
       RowBox[{"A", "\[LeftDoubleBracket]", 
        RowBox[{
        "\"\<\[DoubleStruckC]\>\"", ",", " ", "All", ",", " ", "\"\<T\>\""}], 
        "\[RightDoubleBracket]"}], "]"}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"BLbiped", "[", "\"\<m[0]\>\"", "]"}], " ", "=", " ", 
       "begin"}], ";", "\[IndentingNewLine]", 
      RowBox[{"BLbiped", " ", "=", " ", 
       RowBox[{"Join", "[", 
        RowBox[{"BLbiped", ",", " ", "A"}], "]"}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{"update", " ", "angles"}], " ", "*)"}], "\[IndentingNewLine]", 
      
      RowBox[{"BLSetAngles", "[", "]"}], ";"}]}], "\[IndentingNewLine]", 
    "]"}]}], ";"}]}], "Input",
 InitializationCell->
  True,ExpressionUUID->"026d3576-8d7a-4e30-9aa4-0a5cee057660"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Alternative to FindBifurcation for gaits where du/dx = 0", \
"Section",ExpressionUUID->"e243fd71-441a-45db-8c74-248125dde4ee"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"BLLinearizedDynamics", "[", 
    RowBox[{"m_", ",", " ", "ceq_"}], "]"}], " ", ":=", " ", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "T", ",", " ", "DT", ",", " ", "mi", ",", " ", "xi", ",", " ", "ci", 
       ",", " ", "fi", ",", " ", "Ai", ",", " ", "I", ",", " ", "x", ",", " ",
        "eAt"}], "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{"to", " ", 
       RowBox[{"(", 
        RowBox[{
         RowBox[{"m", "-"}], ",", " ", 
         RowBox[{"x", "-"}], ",", " ", 
         RowBox[{"c", "-"}]}], ")"}]}], " ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{
       RowBox[{"{", 
        RowBox[{"mi", ",", " ", "xi", ",", " ", "ci"}], "}"}], " ", "=", " ", 
       
       RowBox[{"BLmxcp", "[", 
        RowBox[{"m", ",", " ", "ceq"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"xi", " ", "=", " ", 
       RowBox[{"devec", "[", 
        RowBox[{"xi", ",", " ", "nx"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"ci", " ", "=", " ", 
       RowBox[{"devec", "[", 
        RowBox[{"ci", ",", " ", "nc"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"DT", " ", "=", " ", 
       RowBox[{"BLbiped", "[", 
        RowBox[{"\"\<t\>\"", ",", " ", "mi"}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"T", " ", "=", " ", 
       RowBox[{"BLGetSwitchingTimes", "[", 
        RowBox[{"ci", ",", " ", 
         RowBox[{"\"\<m\>\"", " ", "\[Rule]", " ", "mi"}], ",", " ", 
         RowBox[{"\"\<DT\>\"", " ", "\[Rule]", " ", "DT"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
       "only", " ", "phase", " ", "variable", " ", "changes", " ", "along", 
        " ", "trajectory"}], " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{"I", " ", "=", " ", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"IdentityMatrix", "[", "nx", "]"}], ",", " ", 
         RowBox[{"IdentityMatrix", "[", 
          RowBox[{"{", 
           RowBox[{"nc", ",", " ", "nx"}], "}"}], "]"}]}], "}"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"x", " ", "=", " ", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{
          RowBox[{"Prepend", "[", 
           RowBox[{
            RowBox[{"xi", "\[LeftDoubleBracket]", 
             RowBox[{"1", ",", " ", 
              RowBox[{"2", ";;"}]}], "\[RightDoubleBracket]"}], ",", " ", 
            "#1"}], "]"}], ",", " ", 
          RowBox[{
          "I", "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}]}], 
         "}"}], "&"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"Ai", " ", "=", " ", 
       RowBox[{
        RowBox[{
         RowBox[{"devec", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"BLbiped", "[", 
             RowBox[{"\"\<f\>\"", ",", " ", "mi"}], "]"}], "[", 
            RowBox[{
             RowBox[{"x", "[", "#", "]"}], ",", " ", 
             RowBox[{"{", 
              RowBox[{
               RowBox[{
               "ci", "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}], 
               ",", " ", 
               RowBox[{
               "I", "\[LeftDoubleBracket]", "2", "\[RightDoubleBracket]"}]}], 
              "}"}]}], "]"}], ",", " ", "nx"}], "]"}], "\[LeftDoubleBracket]",
          "2", "\[RightDoubleBracket]"}], "&"}]}], ";", "\[IndentingNewLine]",
       "\[IndentingNewLine]", 
      RowBox[{"I", " ", "=", " ", 
       RowBox[{"Reap", "[", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{
          RowBox[{"Sow", "[", 
           RowBox[{"mi", ",", " ", "\"\<m\>\""}], "]"}], ";", 
          RowBox[{"Sow", "[", 
           RowBox[{"ci", ",", " ", "\"\<c\>\""}], "]"}], ";", 
          RowBox[{"Sow", "[", 
           RowBox[{"xi", ",", " ", "\"\<x-\>\""}], "]"}], ";", 
          RowBox[{"Sow", "[", 
           RowBox[{"xi", ",", " ", "\"\<x+\>\""}], "]"}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"Do", "[", "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{
             RowBox[{"If", "[", 
              RowBox[{
               RowBox[{
                RowBox[{
                "DT", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}], 
                " ", "\[NotEqual]", " ", "0"}], ",", "\[IndentingNewLine]", 
               RowBox[{
                RowBox[{"fi", " ", "=", " ", 
                 RowBox[{"devec", "[", 
                  RowBox[{
                   RowBox[{
                    RowBox[{"BLbiped", "[", 
                    RowBox[{"\"\<f\>\"", ",", " ", "mi"}], "]"}], "[", 
                    RowBox[{"xi", ",", " ", "ci"}], "]"}], ",", " ", "nx"}], 
                  "]"}]}], ";", "\[IndentingNewLine]", 
                RowBox[{
                 RowBox[{"xi", "\[LeftDoubleBracket]", 
                  RowBox[{"2", ",", " ", "All", ",", " ", 
                   RowBox[{
                   "DT", "\[LeftDoubleBracket]", "i", 
                    "\[RightDoubleBracket]"}]}], "\[RightDoubleBracket]"}], 
                 " ", "+=", " ", 
                 RowBox[{
                 "fi", "\[LeftDoubleBracket]", "1", 
                  "\[RightDoubleBracket]"}]}], ";"}]}], "\[IndentingNewLine]",
               "]"}], ";", "\[IndentingNewLine]", 
             RowBox[{"Sow", "[", 
              RowBox[{"xi", ",", " ", "\"\<x-\>\""}], "]"}], ";", 
             "\[IndentingNewLine]", "\[IndentingNewLine]", 
             RowBox[{"(*", " ", 
              RowBox[{"to", " ", 
               RowBox[{"(", 
                RowBox[{
                 RowBox[{"m", "+"}], ",", " ", 
                 RowBox[{"x", "+"}], ",", " ", 
                 RowBox[{"c", "+"}]}], ")"}]}], " ", "*)"}], 
             "\[IndentingNewLine]", 
             RowBox[{"mi", " ", "=", " ", 
              RowBox[{
               RowBox[{"BLbiped", "[", 
                RowBox[{"\"\<m\>\"", ",", " ", "mi"}], "]"}], "[", 
               RowBox[{"xi", ",", " ", "ci"}], "]"}]}], ";", 
             "\[IndentingNewLine]", 
             RowBox[{"xi", " ", "=", " ", 
              RowBox[{"devec", "[", 
               RowBox[{
                RowBox[{
                 RowBox[{"BLbiped", "[", 
                  RowBox[{"\"\<h\>\"", ",", " ", "mi"}], "]"}], "[", 
                 RowBox[{"xi", ",", " ", "ci"}], "]"}], ",", " ", "nx"}], 
               "]"}]}], ";", "\[IndentingNewLine]", 
             RowBox[{"ci", " ", "=", " ", 
              RowBox[{"devec", "[", 
               RowBox[{
                RowBox[{"BLc", "[", 
                 RowBox[{"mi", ",", " ", "xi", ",", " ", "ci"}], "]"}], ",", 
                " ", "nc"}], "]"}]}], ";", "\[IndentingNewLine]", 
             "\[IndentingNewLine]", 
             RowBox[{"If", "[", 
              RowBox[{
               RowBox[{
                RowBox[{
                "DT", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}], 
                " ", "\[NotEqual]", " ", "0"}], ",", "\[IndentingNewLine]", 
               RowBox[{
                RowBox[{"fi", " ", "=", " ", 
                 RowBox[{"devec", "[", 
                  RowBox[{
                   RowBox[{
                    RowBox[{"BLbiped", "[", 
                    RowBox[{"\"\<f\>\"", ",", " ", "mi"}], "]"}], "[", 
                    RowBox[{"xi", ",", " ", "ci"}], "]"}], ",", " ", "nx"}], 
                  "]"}]}], ";", "\[IndentingNewLine]", 
                RowBox[{
                 RowBox[{"xi", "\[LeftDoubleBracket]", 
                  RowBox[{"2", ",", " ", "All", ",", " ", 
                   RowBox[{
                   "DT", "\[LeftDoubleBracket]", "i", 
                    "\[RightDoubleBracket]"}]}], "\[RightDoubleBracket]"}], 
                 " ", "-=", " ", 
                 RowBox[{
                 "fi", "\[LeftDoubleBracket]", "1", 
                  "\[RightDoubleBracket]"}]}], ";"}]}], "\[IndentingNewLine]",
               "]"}], ";", "\[IndentingNewLine]", 
             RowBox[{"Sow", "[", 
              RowBox[{"mi", ",", " ", "\"\<m\>\""}], "]"}], ";", 
             RowBox[{"Sow", "[", 
              RowBox[{"ci", ",", " ", "\"\<c\>\""}], "]"}], ";", 
             RowBox[{"Sow", "[", 
              RowBox[{"xi", ",", " ", "\"\<x+\>\""}], "]"}], ";", 
             "\[IndentingNewLine]", "\[IndentingNewLine]", 
             RowBox[{"eAt", " ", "=", " ", 
              RowBox[{"MatrixExp", "[", 
               RowBox[{
                RowBox[{"Ai", "[", 
                 RowBox[{"T", "\[LeftDoubleBracket]", 
                  RowBox[{"i", "+", "1"}], "\[RightDoubleBracket]"}], "]"}], 
                RowBox[{"(", 
                 RowBox[{
                  RowBox[{"T", "\[LeftDoubleBracket]", 
                   RowBox[{"i", "+", "1"}], "\[RightDoubleBracket]"}], "-", 
                  RowBox[{
                  "T", "\[LeftDoubleBracket]", "i", 
                   "\[RightDoubleBracket]"}]}], ")"}]}], "]"}]}], ";", 
             "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{
              "xi", "\[LeftDoubleBracket]", "2", "\[RightDoubleBracket]"}], 
              " ", "=", " ", 
              RowBox[{"eAt", ".", 
               RowBox[{
               "xi", "\[LeftDoubleBracket]", "2", 
                "\[RightDoubleBracket]"}]}]}], ";"}], ",", 
            "\[IndentingNewLine]", 
            RowBox[{"{", 
             RowBox[{"i", ",", " ", 
              RowBox[{
               RowBox[{"Length", "@", "T"}], "-", "1"}]}], "}"}]}], 
           "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
          "\[IndentingNewLine]", 
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{
             RowBox[{"DT", "\[LeftDoubleBracket]", 
              RowBox[{"-", "1"}], "\[RightDoubleBracket]"}], " ", 
             "\[NotEqual]", " ", "0"}], ",", "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{"fi", " ", "=", " ", 
              RowBox[{"devec", "[", 
               RowBox[{
                RowBox[{
                 RowBox[{"BLbiped", "[", 
                  RowBox[{"\"\<f\>\"", ",", " ", "mi"}], "]"}], "[", 
                 RowBox[{"xi", ",", " ", "ci"}], "]"}], ",", " ", "nx"}], 
               "]"}]}], ";", "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{"xi", "\[LeftDoubleBracket]", 
               RowBox[{"2", ",", " ", "All", ",", " ", 
                RowBox[{"DT", "\[LeftDoubleBracket]", 
                 RowBox[{"-", "1"}], "\[RightDoubleBracket]"}]}], 
               "\[RightDoubleBracket]"}], " ", "+=", " ", 
              RowBox[{
              "fi", "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}]}], 
             ";"}]}], "\[IndentingNewLine]", "]"}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"Sow", "[", 
           RowBox[{"xi", ",", " ", "\"\<x-\>\""}], "]"}], ";"}], ",", " ", 
         "_", ",", " ", "Rule"}], "\[IndentingNewLine]", "]"}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"x", " ", "=", " ", 
       RowBox[{"BLbiped", "[", 
        RowBox[{"\"\<c\>\"", ",", " ", "m", ",", " ", "\"\<x\>\""}], "]"}]}], 
      ";", "\[IndentingNewLine]", 
      RowBox[{"<|", 
       RowBox[{
        RowBox[{"\"\<R\>\"", " ", "\[Rule]", " ", 
         RowBox[{
          RowBox[{"xi", "\[LeftDoubleBracket]", 
           RowBox[{"All", ",", " ", "x"}], "\[RightDoubleBracket]"}], "-", 
          RowBox[{"ci", "\[LeftDoubleBracket]", 
           RowBox[{"All", ",", " ", "x"}], "\[RightDoubleBracket]"}]}]}], ",",
         " ", 
        RowBox[{"Rest", "@", "I"}], ",", " ", 
        RowBox[{"\"\<T\>\"", " ", "\[Rule]", " ", "T"}]}], "|>"}]}]}], 
    "\[IndentingNewLine]", "]"}]}], ";"}]], "Input",
 InitializationCell->
  True,ExpressionUUID->"80c8b36d-1636-492e-ad9f-b728a8e5299a"]
}, Open  ]],

Cell[CellGroupData[{

Cell["End Package", "Section",
 InitializationCell->
  True,ExpressionUUID->"89ca9acb-4053-4b62-ae07-011985e5c6d0"],

Cell[BoxData[{
 RowBox[{"End", "[", "]"}], "\n", 
 RowBox[{"EndPackage", "[", "]"}]}], "Input",
 InitializationCell->
  True,ExpressionUUID->"4658df9e-a842-4ee0-aa85-339f6974490e"]
}, Open  ]]
},
AutoGeneratedPackage->Automatic,
Evaluator->"Local",
WindowSize->{1373, 1505},
WindowMargins->{{Automatic, 0}, {0, Automatic}},
PrivateNotebookOptions->{"FileOutlineCache"->False},
CellContext->"Global`",
TrackCellChangeTimes->False,
FrontEndVersion->"11.3 for Linux x86 (64-bit) (March 6, 2018)",
StyleDefinitions->"Default.nb"
]

