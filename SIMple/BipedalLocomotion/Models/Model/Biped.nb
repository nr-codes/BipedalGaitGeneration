Notebook[{

Cell[CellGroupData[{
Cell["Begin Package", \
"Section",ExpressionUUID->"39e9dbc5-5d7b-4441-82c6-0811eadac5b2"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"BeginPackage", "[", 
   RowBox[{"\"\<BipedalLocomotion`Model`\>\"", ",", " ", 
    RowBox[{"{", 
     RowBox[{
     "\"\<GlobalVariables`\>\"", ",", " ", "\"\<Derivatives`\>\"", ",", " ", 
      "\"\<RigidBodyDynamics`\>\"", ",", " ", "\"\<BipedalLocomotion`\>\"", 
      ",", " ", "\"\<HybridDynamics`\>\""}], "}"}]}], "]"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{"Begin", "[", "\"\<`Private`\>\"", "]"}]}], "Input",
 InitializationCell->True,
 CellLabel->
  "In[1014]:=",ExpressionUUID->"2b48c04c-aed4-40f4-8f8c-f7daa783cbb0"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Pick a side", \
"Section",ExpressionUUID->"c6d4db97-53c6-4902-801c-71424e600f67"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"BLSide", "[", 
    RowBox[{"s_", ",", " ", 
     RowBox[{"f_:", "Automatic"}], ",", " ", 
     RowBox[{"i_:", "All"}]}], "]"}], " ", ":=", " ", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", "F", "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"F", " ", "=", " ", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"f", " ", "===", " ", "Automatic"}], ",", " ", 
         RowBox[{"{", 
          RowBox[{"\"\<left\>\"", ",", " ", "\"\<right\>\""}], "}"}], ",", 
         " ", "f"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"StringContainsQ", "[", 
          RowBox[{"s", ",", " ", "\"\<left\>\"", ",", " ", 
           RowBox[{"IgnoreCase", "\[Rule]", "True"}]}], "]"}], ",", " ", "F", 
         ",", " ", 
         RowBox[{"Reverse", "@", "F"}]}], "]"}], "\[LeftDoubleBracket]", "i", 
       "\[RightDoubleBracket]"}]}]}], "\[IndentingNewLine]", "]"}]}], 
  ";"}]], "Input",
 InitializationCell->True,
 CellLabel->
  "In[1016]:=",ExpressionUUID->"d7ddfa87-56c8-4d4b-b412-8c7c9adb0336"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Fix angles and impact map coordinate system", \
"Section",ExpressionUUID->"4e4f3495-7405-44bd-b231-44032f82e8c3"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{" ", 
    RowBox[{"a", " ", "=", " ", 
     RowBox[{
      RowBox[{"2", "\[Pi]"}], " ", "=", 
      RowBox[{
       RowBox[{">", " ", "\[Theta]"}], " ", "\[Element]", " ", 
       RowBox[{"(", 
        RowBox[{
         RowBox[{"-", "pi"}], " ", "pi"}]}]}]}]}], "]"}], " ", "*)"}], 
  "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"SetAttributes", "[", 
     RowBox[{"BLAngle", ",", " ", "Listable"}], "]"}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"BLAngle", "[", 
      RowBox[{"q_", ",", " ", 
       RowBox[{"a_:", "2", "\[Pi]"}]}], "]"}], " ", ":=", " ", 
     RowBox[{"Module", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"x", " ", "=", " ", 
         RowBox[{"Mod", "[", 
          RowBox[{"q", ",", " ", "a"}], "]"}]}], "}"}], ",", " ", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"x", ">", "\[Pi]"}], ",", " ", 
         RowBox[{"x", " ", "-", " ", "a"}], ",", " ", "x"}], "]"}]}], "]"}]}],
     ";"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"BLSetAngles", "[", 
      RowBox[{"r_:", 
       RowBox[{"{", 
        RowBox[{
        "\"\<rx\>\"", ",", " ", "\"\<ry\>\"", ",", " ", "\"\<rz\>\""}], 
        "}"}]}], "]"}], " ", ":=", " ", 
     RowBox[{"Module", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"m", ",", " ", "f", ",", " ", "n"}], "}"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"angles", " ", "=", " ", 
         RowBox[{"BLIndices", "[", 
          RowBox[{"\"\<\>\"", ",", " ", "r"}], "]"}]}], ";", 
        "\[IndentingNewLine]", "\[IndentingNewLine]", 
        RowBox[{"(*", " ", 
         RowBox[{
         "get", " ", "all", " ", "reduced", " ", "space", " ", "variables"}], 
         " ", "*)"}], "\[IndentingNewLine]", 
        RowBox[{"m", " ", "=", " ", 
         RowBox[{"BLbiped", "[", "\"\<m[0]\>\"", "]"}]}], ";", 
        "\[IndentingNewLine]", "\[IndentingNewLine]", 
        RowBox[{"(*", " ", 
         RowBox[{
         "has", " ", "BLCreateContinuationParametes", " ", "been", " ", 
          RowBox[{"called", "?"}]}], " ", "*)"}], "\[IndentingNewLine]", 
        RowBox[{"angs", " ", "=", " ", 
         RowBox[{"RBDGetValue", "[", 
          RowBox[{
           RowBox[{"BLbiped", "[", 
            RowBox[{"\"\<c\>\"", ",", " ", "m", ",", " ", "\"\<x\>\""}], 
            "]"}], ",", " ", 
           RowBox[{"\"\<n\>\"", " ", "\[Rule]", " ", "True"}]}], "]"}]}], ";",
         "\[IndentingNewLine]", "\[IndentingNewLine]", 
        RowBox[{"(*", " ", 
         RowBox[{
         "keep", " ", "angles", " ", "in", " ", "reduced", " ", "space"}], 
         " ", "*)"}], "\[IndentingNewLine]", 
        RowBox[{"n", " ", "=", " ", 
         RowBox[{"Range", "@", 
          RowBox[{"Length", "@", "angs"}]}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"f", " ", "=", " ", 
         RowBox[{
          RowBox[{
           RowBox[{
            RowBox[{"Head", "[", 
             RowBox[{
             "angs", "\[LeftDoubleBracket]", "#", "\[RightDoubleBracket]"}], 
             "]"}], " ", "===", " ", "\[DoubleStruckQ]"}], " ", "&&", " ", 
           RowBox[{"StringContainsQ", "[", 
            RowBox[{
             RowBox[{"angs", "\[LeftDoubleBracket]", 
              RowBox[{"#", ",", " ", "2"}], "\[RightDoubleBracket]"}], ",", 
             " ", "r"}], "]"}]}], "&"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"angs", " ", "=", " ", 
         RowBox[{"Transpose", "@", 
          RowBox[{"List", "@", 
           RowBox[{"Select", "[", 
            RowBox[{"n", ",", " ", "f"}], "]"}]}]}]}], ";"}]}], 
      "\[IndentingNewLine]", "]"}]}], ";"}], "\[IndentingNewLine]", 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"Options", "[", "BLState", "]"}], " ", "=", " ", 
     RowBox[{"{", 
      RowBox[{"\"\<a\>\"", " ", "\[Rule]", " ", "True"}], "}"}]}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"BLState", "[", 
      RowBox[{"x_", ",", " ", 
       RowBox[{"OptionsPattern", "[", "]"}]}], "]"}], " ", ":=", " ", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"OptionValue", "[", "\"\<a\>\"", "]"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"(*", " ", 
        RowBox[{"assume", " ", "reduced", " ", "coordinates"}], " ", "*)"}], 
       "\[IndentingNewLine]", 
       RowBox[{"MapAt", "[", 
        RowBox[{"BLAngle", ",", " ", "x", ",", " ", "angs"}], "]"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"(*", " ", 
        RowBox[{"else", " ", "full", " ", "coordinates"}], " ", "*)"}], 
       "\[IndentingNewLine]", 
       RowBox[{"MapAt", "[", 
        RowBox[{"BLAngle", ",", " ", "x", ",", " ", "angles"}], "]"}]}], 
      "\[IndentingNewLine]", "]"}]}], ";"}]}]}]], "Input",
 InitializationCell->True,
 CellLabel->
  "In[1017]:=",ExpressionUUID->"c6e2239b-4b6c-4ccb-8e34-a1a3bc10ef55"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Feet at pre- and post-impacts", \
"Section",ExpressionUUID->"d21fd076-bbf3-45c2-9ef6-c220c5969dbf"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"BLGetBipedBase", "[", 
    RowBox[{"base_:", "Automatic"}], "]"}], " ", ":=", " ", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"i", ",", " ", "b"}], "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"b", " ", "=", " ", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"VectorQ", "[", "base", "]"}], ",", " ", 
         RowBox[{
         "base", "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}], ",", 
         " ", "base"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"b", " ", "===", " ", "Automatic"}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"b", " ", "=", " ", 
          RowBox[{"KeyDrop", "[", 
           RowBox[{
            RowBox[{"RBDGetLinkInfo", "[", "\"\<p\>\"", "]"}], ",", " ", 
            "\"\<\[Theta]\>\""}], "]"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"b", " ", "=", " ", 
          RowBox[{"First", "@", 
           RowBox[{"Keys", "@", 
            RowBox[{"Select", "[", 
             RowBox[{"b", ",", " ", 
              RowBox[{
               RowBox[{"#", " ", "===", " ", "Root"}], "&"}]}], "]"}]}]}]}], 
         ";", "\[IndentingNewLine]", 
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{"VectorQ", "[", "base", "]"}], ",", " ", 
           RowBox[{"b", " ", "=", " ", 
            RowBox[{"Prepend", "[", 
             RowBox[{
              RowBox[{"base", "\[LeftDoubleBracket]", 
               RowBox[{"2", ";;"}], "\[RightDoubleBracket]"}], ",", " ", 
              "b"}], "]"}]}]}], "]"}], ";"}]}], "\[IndentingNewLine]", "]"}], 
      ";", "\[IndentingNewLine]", "b"}]}], "\[IndentingNewLine]", "]"}]}], 
  ";"}]], "Input",
 InitializationCell->True,
 CellLabel->
  "In[1022]:=",ExpressionUUID->"4de0103b-35a6-432d-a8b7-a15315b43b61"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"BLFeet", "[", 
     RowBox[{"feet_", ",", " ", "Automatic"}], "]"}], " ", ":=", " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", "d", "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"d", " ", "=", " ", 
        RowBox[{
         RowBox[{"BLValues", "[", 
          RowBox[{
           RowBox[{"BLGetBipedBase", "[", "]"}], ",", " ", "\"\<p\>\""}], 
          "]"}], "\[LeftDoubleBracket]", 
         RowBox[{"All", ",", " ", "2"}], "\[RightDoubleBracket]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"d", " ", "=", " ", 
        RowBox[{"d", " ", "/.", " ", 
         RowBox[{"Thread", "[", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{
            "\"\<px\>\"", ",", " ", "\"\<py\>\"", ",", " ", "\"\<pz\>\""}], 
            "}"}], "\[Rule]", " ", 
           RowBox[{"Range", "[", 
            RowBox[{
             RowBox[{"mm", "+", "1"}], ",", " ", "nm"}], "]"}]}], "]"}]}]}], 
       ";", "\[IndentingNewLine]", 
       RowBox[{"BLFeet", "[", 
        RowBox[{"feet", ",", " ", "d"}], "]"}]}]}], "\[IndentingNewLine]", 
     "]"}]}], ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"BLFeet", "[", 
    RowBox[{"feet_", ",", " ", "2"}], "]"}], " ", ":=", " ", 
   RowBox[{"BLFeet", "[", 
    RowBox[{"feet", ",", " ", 
     RowBox[{"Range", "[", 
      RowBox[{
       RowBox[{"mm", "+", "1"}], ",", " ", 
       RowBox[{"nm", "-", "1"}]}], "]"}]}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"BLFeet", "[", 
     RowBox[{"feet_", ",", " ", "3"}], "]"}], " ", ":=", " ", 
    RowBox[{"BLFeet", "[", 
     RowBox[{"feet", ",", " ", 
      RowBox[{"Range", "[", 
       RowBox[{
        RowBox[{"mm", "+", "1"}], ",", " ", "nm"}], "]"}]}], "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"BLFeet", "[", 
     RowBox[{"feet_", ",", " ", "dof_"}], "]"}], " ", ":=", " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"f", ",", " ", "b", ",", " ", "d"}], "}"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"Which", "[", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"feet", " ", "===", " ", 
          RowBox[{"{", "}"}]}], ",", " ", 
         RowBox[{"Return", "@", 
          RowBox[{"<|", "|>"}]}], ",", "\[IndentingNewLine]", 
         RowBox[{"StringQ", "[", 
          RowBox[{
          "feet", "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}], 
          "]"}], ",", " ", 
         RowBox[{
          RowBox[{"f", " ", "=", " ", 
           RowBox[{"{", "feet", "}"}]}], ";"}], ",", " ", 
         "\[IndentingNewLine]", "True", ",", " ", 
         RowBox[{
          RowBox[{"f", " ", "=", " ", "feet"}], ";"}]}], 
        "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"b", " ", "=", " ", 
        RowBox[{"Table", "[", 
         RowBox[{
          RowBox[{"\[DoubleStruckB]", "[", 
           RowBox[{
            RowBox[{
            "i", "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}], ",", 
            " ", "j", ",", " ", 
            RowBox[{
            "i", "\[LeftDoubleBracket]", "2", "\[RightDoubleBracket]"}]}], 
           "]"}], ",", " ", 
          RowBox[{"{", 
           RowBox[{"i", ",", " ", "f"}], "}"}], ",", " ", 
          RowBox[{"{", 
           RowBox[{"j", ",", " ", "dof"}], "}"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"b", " ", "=", " ", 
        RowBox[{"Table", "[", 
         RowBox[{
          RowBox[{"i", " ", "\[Rule]", " ", 
           RowBox[{
           "b", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}]}], ",",
           " ", 
          RowBox[{"{", 
           RowBox[{"i", ",", " ", 
            RowBox[{"Length", "@", "b"}]}], "}"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"<|", 
        RowBox[{"Prepend", "[", 
         RowBox[{"b", ",", " ", 
          RowBox[{"\"\<f\>\"", " ", "\[Rule]", " ", "f"}]}], "]"}], 
        "|>"}]}]}], "\[IndentingNewLine]", "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"BLGetFootFalls", "[", "\[CurlyPhi]_", "]"}], " ", ":=", " ", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "xpre", ",", " ", "xpost", ",", " ", "x", ",", " ", "c", ",", " ", "f", 
       ",", " ", "p", ",", " ", "a", ",", " ", "b"}], "}"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{
       RowBox[{"{", 
        RowBox[{"c", ",", " ", "xpre", ",", " ", "xpost"}], "}"}], " ", "=", 
       " ", 
       RowBox[{"Values", "@", 
        RowBox[{"\[CurlyPhi]", "\[LeftDoubleBracket]", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{
           "\"\<c\>\"", ",", " ", "\"\<x-\>\"", ",", " ", "\"\<x+\>\""}], 
           "}"}], ",", " ", 
          RowBox[{"2", ";;"}]}], "\[RightDoubleBracket]"}]}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{
         RowBox[{
          RowBox[{"Length", "@", "c"}], " ", "\[LessEqual]", " ", "1"}], " ", 
         "||", " ", 
         RowBox[{
          RowBox[{"Length", "@", "xpre"}], " ", "\[LessEqual]", " ", "1"}], 
         " ", "||", " ", 
         RowBox[{
          RowBox[{"Length", "@", "xpost"}], " ", "\[LessEqual]", " ", "1"}]}],
         ",", " ", 
        RowBox[{"Return", "@", 
         RowBox[{"{", "}"}]}]}], "]"}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"x", " ", "=", " ", 
       RowBox[{"MapThread", "[", 
        RowBox[{"List", ",", " ", 
         RowBox[{"{", 
          RowBox[{"xpost", ",", " ", 
           RowBox[{"xpre", "\[LeftDoubleBracket]", 
            RowBox[{"2", ";;"}], "\[RightDoubleBracket]"}]}], "}"}]}], 
        "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"f", " ", "=", " ", 
       RowBox[{"BLbiped", "[", "\"\<feet\>\"", "]"}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{"p", " ", "=", " ", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{
            RowBox[{"x0", " ", "=", " ", 
             RowBox[{"{", 
              RowBox[{
               RowBox[{"6", "D", " ", "foot", " ", "location"}], ",", " ", 
               RowBox[{"6", "D", " ", "foot", " ", "location"}]}], "}"}]}], 
            ",", " ", "xf"}], "}"}], ",", " ", 
          RowBox[{"{", 
           RowBox[{"x0", ",", " ", "xf"}], "}"}], ",", " ", "...", ","}], " ",
          "}"}]}], " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{"p", " ", "=", " ", 
       RowBox[{"Table", "[", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"RBDSpatialPosition", "[", 
          RowBox[{
           RowBox[{"f", "\[LeftDoubleBracket]", 
            RowBox[{"k", ",", " ", "2"}], "\[RightDoubleBracket]"}], ",", " ", 
           RowBox[{"f", "\[LeftDoubleBracket]", 
            RowBox[{"k", ",", " ", "1"}], "\[RightDoubleBracket]"}], ",", " ", 
           RowBox[{"\"\<x\>\"", " ", "\[Rule]", " ", 
            RowBox[{"x", "\[LeftDoubleBracket]", 
             RowBox[{"i", ",", " ", "j"}], "\[RightDoubleBracket]"}]}], ",", 
           " ", 
           RowBox[{"\"\<\[Lambda]\>\"", " ", "\[Rule]", " ", 
            RowBox[{
            "c", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}]}]}], 
          "]"}], ",", "\[IndentingNewLine]", 
         RowBox[{"{", 
          RowBox[{"i", ",", " ", 
           RowBox[{"Length", "@", "c"}]}], "}"}], ",", " ", 
         RowBox[{"{", 
          RowBox[{"j", ",", " ", 
           RowBox[{"Length", "@", 
            RowBox[{
            "x", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}]}]}], 
          "}"}], ",", " ", 
         RowBox[{"{", 
          RowBox[{"k", ",", " ", 
           RowBox[{"Length", "@", "f"}]}], "}"}]}], "\[IndentingNewLine]", 
        "]"}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
        RowBox[{"order", " ", "p", " ", 
         RowBox[{"s", ".", "t", ".", " ", 
          RowBox[{"p", "\[LeftDoubleBracket]", 
           RowBox[{"i", ",", " ", "k"}], "\[RightDoubleBracket]"}]}]}], " ", 
        "=", " ", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"stance", " ", "foot"}], ",", " ", 
          RowBox[{"swing", " ", "foot"}]}], "}"}]}], " ", "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"f", " ", "=", " ", 
       RowBox[{
        RowBox[{"First", "@", 
         RowBox[{"Ordering", "[", 
          RowBox[{"(", 
           RowBox[{"Norm", " ", "/@", " ", 
            RowBox[{"Join", "[", 
             RowBox[{
              RowBox[{"#1", "-", "#2"}], ",", " ", 
              RowBox[{
               RowBox[{"Reverse", "@", "#1"}], " ", "-", " ", "#2"}]}], 
             "]"}]}], ")"}], "]"}]}], "&"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"Table", "[", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{
         RowBox[{"a", " ", "=", " ", 
          RowBox[{"p", "\[LeftDoubleBracket]", 
           RowBox[{"i", ",", " ", "1"}], "\[RightDoubleBracket]"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"b", " ", "=", " ", 
          RowBox[{"p", "\[LeftDoubleBracket]", 
           RowBox[{"i", ",", " ", "2"}], "\[RightDoubleBracket]"}]}], ";", 
         "\[IndentingNewLine]", "\[IndentingNewLine]", 
         RowBox[{"Switch", "[", 
          RowBox[{
           RowBox[{"f", "[", 
            RowBox[{"a", ",", " ", "b"}], "]"}], ",", "\[IndentingNewLine]", 
           "1", ",", " ", 
           RowBox[{"{", 
            RowBox[{"a", ",", " ", "b"}], "}"}], ",", "\[IndentingNewLine]", 
           "2", ",", " ", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"Reverse", "@", "a"}], ",", " ", 
             RowBox[{"Reverse", "@", "b"}]}], "}"}], ",", 
           "\[IndentingNewLine]", "3", ",", " ", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"Reverse", "@", "a"}], ",", " ", "b"}], "}"}], ",", 
           "\[IndentingNewLine]", "4", ",", " ", 
           RowBox[{"{", 
            RowBox[{"a", ",", " ", 
             RowBox[{"Reverse", "@", "b"}]}], "}"}]}], "\[IndentingNewLine]", 
          "]"}]}], ",", "\[IndentingNewLine]", 
        RowBox[{"{", 
         RowBox[{"i", ",", " ", 
          RowBox[{"Length", "@", "p"}]}], "}"}]}], "\[IndentingNewLine]", 
       "]"}]}]}], "\[IndentingNewLine]", "]"}]}], ";"}]}], "Input",
 InitializationCell->True,
 CellLabel->
  "In[1023]:=",ExpressionUUID->"afa50212-b452-4158-8ab9-4892bcbb14ee"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"Options", "[", "BLLinks", "]"}], " ", "=", " ", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"\"\<b\>\"", " ", "\[RuleDelayed]", " ", 
       RowBox[{"RBDLinks", "[", "]"}]}], ",", " ", 
      RowBox[{"\"\<i\>\"", " ", "\[Rule]", " ", "False"}], ",", " ", 
      RowBox[{"Not", " ", "\[Rule]", " ", "False"}]}], "}"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"BLLinks", "[", 
     RowBox[{"form_", ",", " ", 
      RowBox[{"opts", ":", 
       RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], " ", ":=", " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"b", ",", " ", "i", ",", " ", "f"}], "}"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"b", " ", "=", " ", 
        RowBox[{"OptionValue", "[", "\"\<b\>\"", "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"f", " ", "=", " ", 
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{"OptionValue", "[", "Not", "]"}], ",", " ", "StringFreeQ", 
          ",", " ", "StringContainsQ"}], "]"}]}], ";", "\[IndentingNewLine]", 
       
       RowBox[{"i", " ", "=", " ", 
        RowBox[{"Select", "[", 
         RowBox[{
          RowBox[{"Range", "@", 
           RowBox[{"Length", "@", "b"}]}], ",", " ", 
          RowBox[{
           RowBox[{"f", "[", 
            RowBox[{
             RowBox[{"b", "\[LeftDoubleBracket]", 
              RowBox[{"#", ",", " ", "1"}], "\[RightDoubleBracket]"}], ",", 
             " ", "form"}], "]"}], "&"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"(*", " ", 
        RowBox[{"return", " ", "indices", " ", "or", " ", 
         RowBox[{"sublist", "?"}]}], " ", "*)"}], "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"OptionValue", "[", "\"\<i\>\"", "]"}], ",", " ", "i", ",", 
         " ", 
         RowBox[{
         "b", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}]}], 
        "]"}]}]}], "\[IndentingNewLine]", "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Options", "[", "BLValues", "]"}], " ", "=", " ", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"\"\<n\>\"", " ", "\[Rule]", " ", "\[DoubleStruckQ]"}], ",", " ", 
     RowBox[{"BLLinks", " ", "\[Rule]", " ", 
      RowBox[{"{", "}"}]}], ",", " ", 
     RowBox[{"Not", " ", "\[Rule]", " ", "False"}]}], "}"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"BLValues", "[", 
     RowBox[{"fb_", ",", " ", 
      RowBox[{"fd_:", "\"\<\>\""}], ",", " ", 
      RowBox[{"opts", ":", 
       RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], " ", ":=", " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"q", ",", " ", "n", ",", " ", "b", ",", " ", "f"}], "}"}], ",",
       " ", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
       "get", " ", "links", " ", "that", " ", "match", " ", "form", " ", 
        "fb"}], " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"b", " ", "=", " ", 
        RowBox[{"BLLinks", "[", 
         RowBox[{"fb", ",", " ", 
          RowBox[{"OptionValue", "[", "BLLinks", "]"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"(*", " ", 
        RowBox[{"get", " ", "string", " ", "name", " ", "for", " ", "dof"}], 
        " ", "*)"}], "\[IndentingNewLine]", 
       RowBox[{"q", " ", "=", " ", 
        RowBox[{"Flatten", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"RBDGetDOF", "[", 
            RowBox[{"\[DoubleStruckQ]", "[", 
             RowBox[{
              RowBox[{
              "#", "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}], 
              ",", " ", "Values"}], "]"}], "]"}], "&"}], " ", "/@", " ", 
          "b"}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"(*", " ", 
        RowBox[{
        "get", " ", "dofs", " ", "that", " ", "match", " ", "form", " ", 
         "fd"}], " ", "*)"}], "\[IndentingNewLine]", 
       RowBox[{"f", " ", "=", " ", 
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{"OptionValue", "[", "Not", "]"}], ",", " ", "StringFreeQ", 
          ",", " ", "StringContainsQ"}], "]"}]}], ";", "\[IndentingNewLine]", 
       
       RowBox[{"q", " ", "=", " ", 
        RowBox[{"Cases", "[", 
         RowBox[{"q", ",", " ", 
          RowBox[{
           RowBox[{"\[DoubleStruckQ]", "[", 
            RowBox[{"_", ",", " ", "n_"}], "]"}], " ", "/;", " ", 
           RowBox[{"f", "[", 
            RowBox[{"n", ",", " ", "fd"}], "]"}]}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"(*", " ", 
        RowBox[{"change", " ", "head"}], " ", "*)"}], "\[IndentingNewLine]", 
       RowBox[{"n", " ", "=", " ", 
        RowBox[{"OptionValue", "[", "\"\<n\>\"", "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"VectorQ", "[", "n", "]"}], ",", " ", 
         RowBox[{"Flatten", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"q", " ", "/.", " ", 
             RowBox[{"\[DoubleStruckQ]", " ", "\[Rule]", " ", "#"}]}], "&"}], 
           " ", "/@", " ", "n"}], "]"}], ",", " ", 
         RowBox[{"q", " ", "/.", " ", 
          RowBox[{"\[DoubleStruckQ]", " ", "\[Rule]", " ", "n"}]}]}], 
        "]"}]}]}], "\[IndentingNewLine]", "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"BLIndices", "[", 
   RowBox[{"fb_", ",", " ", 
    RowBox[{"fd_:", "\"\<\>\""}], ",", " ", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], " ", ":=", " ", 
  RowBox[{"RBDGetIndex", "@", 
   RowBox[{"BLValues", "[", 
    RowBox[{"fb", ",", " ", "fd", ",", " ", "opts"}], "]"}]}]}]}], "Input",
 InitializationCell->True,
 CellLabel->
  "In[1028]:=",ExpressionUUID->"265410aa-8c24-40c1-bd9a-dd581233f642"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Compute Eigenvalues", \
"Section",ExpressionUUID->"48ae6b94-01cf-48ac-a276-43975f7d6e1d"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"BLJacobian", "[", "p_", "]"}], " ", ":=", " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "i", ",", " ", "M", ",", " ", "m", ",", " ", "\[Sigma]T", ",", " ", 
        "\[Sigma]0", ",", " ", "x", ",", " ", "c", ",", " ", "\[Sigma]", ",", 
        " ", "S", ",", " ", "dSdT", ",", " ", "dSdc", ",", " ", "dTdc", ",", 
        " ", "f", ",", " ", "A"}], "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"M", " ", "=", " ", 
        RowBox[{"BLSim", "[", "p", "]"}]}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"m", " ", "=", " ", 
        RowBox[{"M", "\[LeftDoubleBracket]", 
         RowBox[{"\"\<m\>\"", ",", " ", "1"}], "\[RightDoubleBracket]"}]}], 
       ";", "\[IndentingNewLine]", 
       RowBox[{"i", " ", "=", " ", 
        RowBox[{"BLbiped", "[", 
         RowBox[{"\"\<c\>\"", ",", " ", "m", ",", " ", "\"\<x\>\""}], "]"}]}],
        ";", "\[IndentingNewLine]", 
       RowBox[{"A", " ", "=", " ", 
        RowBox[{"Lookup", "[", 
         RowBox[{"BLbiped", ",", " ", "\"\<A\>\"", ",", " ", 
          RowBox[{"BLA", "[", "]"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"A", " ", "=", " ", 
        RowBox[{"A", "\[LeftDoubleBracket]", 
         RowBox[{"i", ",", " ", "i"}], "\[RightDoubleBracket]"}]}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"m", " ", "=", " ", 
        RowBox[{"M", "\[LeftDoubleBracket]", 
         RowBox[{"\"\<m\>\"", ",", " ", 
          RowBox[{"-", "1"}]}], "\[RightDoubleBracket]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"c", " ", "=", " ", 
        RowBox[{"devec", "[", 
         RowBox[{
          RowBox[{"M", "\[LeftDoubleBracket]", 
           RowBox[{"\"\<c\>\"", ",", " ", 
            RowBox[{"-", "1"}]}], "\[RightDoubleBracket]"}], ",", " ", "nc"}],
          "]"}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"(*", " ", 
        RowBox[{"t", " ", "=", " ", "0"}], " ", "*)"}], "\[IndentingNewLine]", 
       RowBox[{"x", " ", "=", " ", 
        RowBox[{"devec", "[", 
         RowBox[{
          RowBox[{"M", "\[LeftDoubleBracket]", 
           RowBox[{"\"\<x+\>\"", ",", " ", "2"}], "\[RightDoubleBracket]"}], 
          ",", " ", "nx"}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"\[Sigma]0", " ", "=", " ", 
        RowBox[{
         RowBox[{"devec", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"BLbiped", "[", 
             RowBox[{"\"\<\[Sigma]\>\"", ",", " ", "m"}], "]"}], "[", 
            RowBox[{"x", ",", " ", "c"}], "]"}], ",", " ", "mm"}], "]"}], 
         "\[LeftDoubleBracket]", 
         RowBox[{"All", ",", " ", "3"}], "\[RightDoubleBracket]"}]}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"(*", " ", 
        RowBox[{"t", " ", "=", " ", "T"}], " ", "*)"}], "\[IndentingNewLine]", 
       RowBox[{"x", " ", "=", " ", 
        RowBox[{"devec", "[", 
         RowBox[{
          RowBox[{"M", "\[LeftDoubleBracket]", 
           RowBox[{"\"\<x-\>\"", ",", " ", 
            RowBox[{"-", "1"}]}], "\[RightDoubleBracket]"}], ",", " ", "nx"}],
          "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"\[Sigma]T", " ", "=", " ", 
        RowBox[{
         RowBox[{"devec", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"BLbiped", "[", 
             RowBox[{"\"\<\[Sigma]\>\"", ",", " ", "m"}], "]"}], "[", 
            RowBox[{"x", ",", " ", "c"}], "]"}], ",", " ", "mm"}], "]"}], 
         "\[LeftDoubleBracket]", 
         RowBox[{"All", ",", " ", "3"}], "\[RightDoubleBracket]"}]}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"\[Sigma]", " ", "=", " ", 
        RowBox[{"\[Sigma]T", "-", "\[Sigma]0"}]}], ";", "\[IndentingNewLine]",
        "\[IndentingNewLine]", 
       RowBox[{"(*", " ", "dTdc", " ", "*)"}], "\[IndentingNewLine]", 
       RowBox[{"S", " ", "=", " ", 
        RowBox[{"Sin", "[", 
         RowBox[{
         "\[Sigma]", "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}], 
         "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"dSdT", " ", "=", " ", 
        RowBox[{
         RowBox[{"Cos", "[", 
          RowBox[{
          "\[Sigma]", "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}], 
          "]"}], " ", 
         RowBox[{"\[Sigma]", "\[LeftDoubleBracket]", 
          RowBox[{"2", ",", " ", 
           RowBox[{"-", "1"}]}], "\[RightDoubleBracket]"}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"dSdc", " ", "=", " ", 
        RowBox[{
         RowBox[{"Cos", "[", 
          RowBox[{
          "\[Sigma]", "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}], 
          "]"}], " ", 
         RowBox[{
         "\[Sigma]", "\[LeftDoubleBracket]", "2", 
          "\[RightDoubleBracket]"}]}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"dTdc", " ", "=", " ", 
        RowBox[{
         RowBox[{"-", "dSdc"}], "/", "dSdT"}]}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"(*", " ", 
        RowBox[{
         RowBox[{"get", " ", "state"}], "-", 
         RowBox[{"based", " ", "derivative"}]}], " ", "*)"}], 
       "\[IndentingNewLine]", 
       RowBox[{"f", " ", "=", " ", 
        RowBox[{"x", "\[LeftDoubleBracket]", 
         RowBox[{"2", ",", " ", "All", ",", " ", 
          RowBox[{"-", "1"}]}], "\[RightDoubleBracket]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"f", "=", " ", 
        RowBox[{"KroneckerProduct", "[", 
         RowBox[{"f", ",", " ", "dTdc"}], "]"}]}], ";", "\[IndentingNewLine]",
        "\[IndentingNewLine]", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"A", ".", 
          RowBox[{"(", 
           RowBox[{
            RowBox[{"x", "\[LeftDoubleBracket]", 
             RowBox[{"2", ",", " ", "i"}], "\[RightDoubleBracket]"}], " ", 
            "+", " ", 
            RowBox[{
            "f", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}]}], 
           ")"}]}], ",", " ", 
         RowBox[{"A", ".", 
          RowBox[{"x", "\[LeftDoubleBracket]", 
           RowBox[{"2", ",", " ", "i"}], "\[RightDoubleBracket]"}]}]}], 
        "}"}]}]}], "\[IndentingNewLine]", "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"JFD", "[", 
     RowBox[{"c_", ",", " ", 
      RowBox[{"tol_:", 
       RowBox[{"10", "^", 
        RowBox[{"-", "5"}]}]}]}], "]"}], " ", ":=", " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "m", ",", " ", "i", ",", " ", "f", ",", " ", "Jtb", ",", " ", "Jeb", 
        ",", " ", "A"}], "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"m", " ", "=", " ", 
        RowBox[{"BLbiped", "[", "\"\<m[0]\>\"", "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"i", " ", "=", " ", 
        RowBox[{"BLbiped", "[", 
         RowBox[{"\"\<c\>\"", ",", " ", "m", ",", " ", "\"\<x\>\""}], "]"}]}],
        ";", "\[IndentingNewLine]", 
       RowBox[{"f", " ", "=", " ", 
        RowBox[{
         RowBox[{
          RowBox[{"blstate", "[", "#", "]"}], "\[LeftDoubleBracket]", 
          RowBox[{"\"\<x-\>\"", ",", " ", 
           RowBox[{"-", "1"}], ",", " ", "i"}], "\[RightDoubleBracket]"}], 
         "&"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"Jeb", " ", "=", " ", 
        RowBox[{
         RowBox[{"FiniteDifferenceJacobian", "[", 
          RowBox[{"f", ",", " ", "c", ",", " ", 
           RowBox[{"N", "@", "tol"}]}], "]"}], "\[Transpose]"}]}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"f", " ", "=", " ", 
        RowBox[{
         RowBox[{
          RowBox[{"BLSim", "[", "#", "]"}], "\[LeftDoubleBracket]", 
          RowBox[{"\"\<x-\>\"", ",", " ", 
           RowBox[{"-", "1"}], ",", " ", "i"}], "\[RightDoubleBracket]"}], 
         "&"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"Jtb", " ", "=", " ", 
        RowBox[{
         RowBox[{"FiniteDifferenceJacobian", "[", 
          RowBox[{"f", ",", " ", "c", ",", " ", 
           RowBox[{"N", "@", "tol"}]}], "]"}], "\[Transpose]"}]}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"A", " ", "=", " ", 
        RowBox[{"Lookup", "[", 
         RowBox[{"BLbiped", ",", " ", "\"\<A\>\"", ",", " ", 
          RowBox[{"BLA", "[", "]"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"A", ".", "Jeb"}], ",", " ", 
         RowBox[{"A", ".", "Jtb"}]}], "}"}]}]}], "\[IndentingNewLine]", 
     "]"}]}], ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"BLEigenvalues", "[", 
   RowBox[{"man_", ",", " ", 
    RowBox[{"max_:", "True"}]}], "]"}], " ", ":=", " ", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
     "m", ",", " ", "i", ",", " ", "j", ",", " ", "J", ",", " ", "eigs", ",", 
      " ", "c"}], "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"m", " ", "=", " ", 
      RowBox[{"BLbiped", "[", "\"\<m[0]\>\"", "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"j", " ", "=", " ", 
      RowBox[{"BLbiped", "[", 
       RowBox[{"\"\<p\>\"", ",", " ", "m", ",", " ", "\"\<x\>\""}], "]"}]}], 
     ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
       RowBox[{
       "fancier", " ", "select", " ", "would", " ", "ensure", " ", "dSdT"}], 
       " ", "\[NotEqual]", " ", "0"}], " ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{"c", " ", "=", " ", 
      RowBox[{"Select", "[", 
       RowBox[{
        RowBox[{"man", "\[LeftDoubleBracket]", 
         RowBox[{"All", ",", "1"}], "\[RightDoubleBracket]"}], ",", " ", 
        RowBox[{
         RowBox[{"!", 
          RowBox[{"PossibleZeroQ", "[", 
           RowBox[{"Norm", "[", 
            RowBox[{
            "#", "\[LeftDoubleBracket]", "j", "\[RightDoubleBracket]"}], 
            "]"}], "]"}]}], "&"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"J", " ", "=", " ", 
      RowBox[{
       RowBox[{
        RowBox[{
         RowBox[{"BLJacobian", "[", "#", "]"}], "\[LeftDoubleBracket]", 
         RowBox[{"All", ",", " ", "All", ",", " ", "j"}], 
         "\[RightDoubleBracket]"}], "&"}], " ", "/@", " ", "c"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"eigs", " ", "=", " ", 
      RowBox[{"Map", "[", 
       RowBox[{"Eigenvalues", ",", " ", "J", ",", " ", 
        RowBox[{"{", "2", "}"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{"max", ",", " ", 
       RowBox[{"Map", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"Max", "@", 
           RowBox[{"Abs", "@", "#"}]}], "&"}], ",", " ", "eigs", ",", " ", 
         RowBox[{"{", "2", "}"}]}], "]"}], ",", " ", "eigs"}], "]"}]}]}], 
   "\[IndentingNewLine]", "]"}]}]}], "Input",
 InitializationCell->True,
 CellLabel->
  "In[1035]:=",ExpressionUUID->"f9e363c1-da44-422f-851e-79ea59b64b80"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Animation", \
"Section",ExpressionUUID->"03ff5911-bbbb-4d8f-a853-ae3f69447370"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"Options", "[", "BLWalk", "]"}], " ", "=", " ", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"BLAnimateBiped", " ", "\[Rule]", " ", 
      RowBox[{"{", "}"}]}], ",", " ", 
     RowBox[{"\"\<e\>\"", " ", "\[Rule]", " ", "False"}], ",", " ", 
     RowBox[{"\"\<T\>\"", " ", "\[Rule]", " ", 
      RowBox[{"-", "1"}]}]}], "}"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"BLWalk", "::", "k"}], " ", "=", " ", 
    "\"\<`` `` does not exist.  Valid ones are: ``.\>\""}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"BLWalk", "[", 
     RowBox[{"A_Association", ",", " ", 
      RowBox[{"k_", "?", "VectorQ"}], ",", " ", 
      RowBox[{"n_:", "1"}], ",", " ", 
      RowBox[{"opts", ":", 
       RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], " ", ":=", " ", 
    RowBox[{"If", "[", 
     RowBox[{
      RowBox[{"KeyExistsQ", "[", 
       RowBox[{"A", ",", " ", "k"}], "]"}], ",", " ", 
      RowBox[{"BLWalk", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"A", "[", "k", "]"}], "\[LeftDoubleBracket]", "1", 
         "\[RightDoubleBracket]"}], ",", " ", "n", ",", " ", "opts"}], "]"}], 
      ",", " ", 
      RowBox[{"Message", "[", 
       RowBox[{
        RowBox[{"BLWalk", "::", "k"}], ",", " ", "\"\<Key\>\"", ",", " ", "k",
         ",", " ", 
        RowBox[{"Keys", "@", "A"}]}], "]"}]}], "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"BLWalk", "[", 
     RowBox[{"A_Association", ",", " ", "k_Integer", ",", " ", 
      RowBox[{"n_:", "1"}], ",", " ", 
      RowBox[{"opts", ":", 
       RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], " ", ":=", " ", 
    RowBox[{"If", "[", 
     RowBox[{
      RowBox[{
       RowBox[{"Length", "@", "A"}], " ", ">", " ", "k"}], ",", " ", 
      RowBox[{"BLWalk", "[", 
       RowBox[{
        RowBox[{"A", "\[LeftDoubleBracket]", 
         RowBox[{"k", ",", " ", "1"}], "\[RightDoubleBracket]"}], ",", " ", 
        "n", ",", " ", "opts"}], "]"}], ",", " ", 
      RowBox[{"Message", "[", 
       RowBox[{
        RowBox[{"BLWalk", "::", "k"}], ",", " ", "\"\<Index\>\"", ",", " ", 
        "k", ",", " ", 
        RowBox[{"\"\<1 <= k <= \>\"", " ", "<>", " ", 
         RowBox[{"ToString", "@", 
          RowBox[{"Length", "@", "A"}]}]}]}], "]"}]}], "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"BLWalk", "[", 
     RowBox[{"c_", ",", " ", 
      RowBox[{"n_:", "1"}], ",", " ", 
      RowBox[{"opts", ":", 
       RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], " ", ":=", " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"o", ",", " ", "e", ",", " ", "T"}], "}"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"o", " ", "=", " ", 
        RowBox[{"OptionValue", "[", "BLAnimateBiped", "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"e", " ", "=", " ", 
        RowBox[{"OptionValue", "[", "\"\<e\>\"", "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"T", " ", "=", " ", 
        RowBox[{"OptionValue", "[", "\"\<T\>\"", "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{"e", ",", " ", "\[IndentingNewLine]", 
         RowBox[{"(*", " ", 
          RowBox[{"state", "-", "based"}], " ", "*)"}], "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"e", " ", "=", " ", 
           RowBox[{"state", "[", 
            RowBox[{"c", ",", " ", "n"}], "]"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"T", " ", "=", " ", 
           RowBox[{
            RowBox[{
            "c", "\[LeftDoubleBracket]", "T", "\[RightDoubleBracket]"}], 
            RowBox[{"{", 
             RowBox[{"0", ",", " ", "n"}], "}"}]}]}], ";"}], ",", 
         "\[IndentingNewLine]", 
         RowBox[{"(*", " ", "else", " ", "*)"}], "\[IndentingNewLine]", 
         RowBox[{"(*", " ", 
          RowBox[{"time", "-", "based"}], " ", "*)"}], "\[IndentingNewLine]", 
         
         RowBox[{
          RowBox[{"e", " ", "=", " ", "c"}], ";", "\[IndentingNewLine]", 
          RowBox[{"T", " ", "=", " ", 
           RowBox[{
            RowBox[{
            "c", "\[LeftDoubleBracket]", "T", "\[RightDoubleBracket]"}], 
            RowBox[{"Range", "[", 
             RowBox[{"0", ",", " ", "n"}], "]"}]}]}], ";"}]}], 
        "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"BLAnimateBiped", "[", 
        RowBox[{"e", ",", " ", "o", ",", " ", 
         RowBox[{"BLSim", " ", "\[Rule]", " ", 
          RowBox[{"{", 
           RowBox[{"\"\<T\>\"", " ", "\[Rule]", " ", "T"}], "}"}]}]}], 
        "]"}]}]}], "\[IndentingNewLine]", "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"BL\[Sigma]", "[", 
     RowBox[{"c_", "?", "VectorQ"}], "]"}], " ", ":=", 
    RowBox[{"BL\[Sigma]", "@@", 
     RowBox[{"BLmxcp", "[", 
      RowBox[{
       RowBox[{"BLbiped", "[", "\"\<m[0]\>\"", "]"}], ",", " ", "c"}], 
      "]"}]}]}], ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"BL\[Sigma]", "[", 
     RowBox[{"m_", ",", " ", 
      RowBox[{"x_", "?", "VectorQ"}], ",", " ", 
      RowBox[{"c_", "?", "VectorQ"}]}], "]"}], " ", ":=", 
    RowBox[{"BL\[Sigma]", "[", 
     RowBox[{"m", ",", " ", 
      RowBox[{"devec", "[", 
       RowBox[{"x", ",", " ", "nx"}], "]"}], ",", " ", 
      RowBox[{"devec", "[", 
       RowBox[{"c", ",", " ", "nc"}], "]"}]}], "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"BL\[Sigma]", "[", 
     RowBox[{"m_", ",", " ", "x_", ",", " ", "c_"}], "]"}], " ", ":=", 
    RowBox[{"devec", "[", 
     RowBox[{
      RowBox[{
       RowBox[{"BLbiped", "[", 
        RowBox[{"\"\<\[Sigma]\>\"", ",", " ", "m"}], "]"}], "[", 
       RowBox[{"x", ",", " ", "c"}], "]"}], ",", " ", "mm"}], "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"blevent", "[", 
     RowBox[{"m_", ",", " ", 
      RowBox[{"x_", "?", "VectorQ"}], ",", " ", 
      RowBox[{"c_", "?", "VectorQ"}]}], "]"}], " ", ":=", " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"X", ",", " ", "C", ",", " ", "\[Sigma]", ",", " ", "n"}], 
       "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"X", " ", "=", " ", 
        RowBox[{"devec", "[", 
         RowBox[{"x", ",", " ", "nx"}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"C", " ", "=", " ", 
        RowBox[{"devec", "[", 
         RowBox[{"c", ",", " ", "nc"}], "]"}]}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{
         RowBox[{"n", " ", "=", " ", 
          RowBox[{
           RowBox[{"First", "@", 
            RowBox[{"Complement", "[", 
             RowBox[{
              RowBox[{"Range", "[", 
               RowBox[{
                RowBox[{"mm", "+", "1"}], ",", " ", "nm"}], "]"}], ",", "  ", 
              "ax"}], "]"}]}], "-", "mm"}]}], ";"}], "*)"}], 
       "\[IndentingNewLine]", 
       RowBox[{"n", " ", "=", " ", "mm"}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{
         RowBox[{"\[Sigma]", " ", "=", " ", 
          RowBox[{
           RowBox[{
            RowBox[{"BL\[Sigma]", "[", 
             RowBox[{"\"\<left\>\"", ",", " ", "X", ",", " ", "C"}], "]"}], 
            "\[LeftDoubleBracket]", 
            RowBox[{"1", ",", " ", "n"}], "\[RightDoubleBracket]"}], "-", 
           RowBox[{
            RowBox[{"BL\[Sigma]", "[", 
             RowBox[{"\"\<left\>\"", ",", " ", 
              RowBox[{"C", "\[LeftDoubleBracket]", 
               RowBox[{"All", ",", " ", 
                RowBox[{"1", ";;", "nx"}]}], "\[RightDoubleBracket]"}], ",", 
              " ", "C"}], "]"}], "\[LeftDoubleBracket]", 
            RowBox[{"1", ",", " ", "n"}], "\[RightDoubleBracket]"}]}]}], 
         ";"}], "*)"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"\[Sigma]", " ", "=", " ", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{
           RowBox[{
           "x", "\[LeftDoubleBracket]", "4", "\[RightDoubleBracket]"}], "+", 
           RowBox[{"0.5", 
            RowBox[{
            "x", "\[LeftDoubleBracket]", "5", "\[RightDoubleBracket]"}]}]}], 
          ")"}], "-", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{
           "c", "\[LeftDoubleBracket]", "4", "\[RightDoubleBracket]"}], "+", 
           RowBox[{"0.5", 
            RowBox[{
            "c", "\[LeftDoubleBracket]", "5", "\[RightDoubleBracket]"}]}]}], 
          ")"}]}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"Sin", "[", "\[Sigma]", "]"}]}]}], "\[IndentingNewLine]", 
     "]"}]}], ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"blstate", "[", 
    RowBox[{"p_", ",", " ", 
     RowBox[{"n_Integer:", "1"}]}], "]"}], " ", ":=", " ", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "Tc", ",", " ", "m", ",", " ", "x", ",", " ", "c", ",", " ", "esw", ",",
        " ", "r"}], "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Tc", " ", "=", " ", 
       RowBox[{"p", "\[LeftDoubleBracket]", 
        RowBox[{"-", "1"}], "\[RightDoubleBracket]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"m", " ", "=", " ", 
       RowBox[{"BLbiped", "[", "\"\<m[0]\>\"", "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"m", ",", " ", "x", ",", " ", "c"}], "}"}], " ", "=", " ", 
       RowBox[{"BLmxcp", "[", 
        RowBox[{"m", ",", " ", "p"}], "]"}]}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"esw", " ", "=", " ", 
       RowBox[{"{", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"WhenEvent", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"\[DoubleStruckT]", "-", "0"}], "\[Equal]", "0"}], ",", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{
              RowBox[{"\[DoubleStruckX]", "[", "\[DoubleStruckT]", "]"}], 
              "\[Rule]", 
              RowBox[{"HybridDynamics`Private`TF", "[", 
               RowBox[{
                RowBox[{"\[DoubleStruckM]", "[", "\[DoubleStruckT]", "]"}], 
                ",", 
                RowBox[{"\[DoubleStruckX]", "[", "\[DoubleStruckT]", "]"}], 
                ",", 
                RowBox[{"\[DoubleStruckC]", "[", "\[DoubleStruckT]", "]"}], 
                ",", "0"}], "]"}]}], ",", 
             RowBox[{
              RowBox[{"\[DoubleStruckM]", "[", "\[DoubleStruckT]", "]"}], 
              "\[Rule]", 
              RowBox[{"HybridDynamics`Private`m", "[", 
               RowBox[{
                RowBox[{"\[DoubleStruckM]", "[", "\[DoubleStruckT]", "]"}], 
                ",", 
                RowBox[{"\[DoubleStruckX]", "[", "\[DoubleStruckT]", "]"}], 
                ",", 
                RowBox[{"\[DoubleStruckC]", "[", "\[DoubleStruckT]", "]"}]}], 
               "]"}]}], ",", 
             RowBox[{
              RowBox[{"\[DoubleStruckX]", "[", "\[DoubleStruckT]", "]"}], 
              "\[Rule]", 
              RowBox[{"HybridDynamics`Private`h", "[", 
               RowBox[{
                RowBox[{"\[DoubleStruckM]", "[", "\[DoubleStruckT]", "]"}], 
                ",", 
                RowBox[{"\[DoubleStruckX]", "[", "\[DoubleStruckT]", "]"}], 
                ",", 
                RowBox[{"\[DoubleStruckC]", "[", "\[DoubleStruckT]", "]"}]}], 
               "]"}]}], ",", 
             RowBox[{
              RowBox[{"\[DoubleStruckC]", "[", "\[DoubleStruckT]", "]"}], 
              "\[Rule]", 
              RowBox[{"HybridDynamics`Private`d", "[", 
               RowBox[{
                RowBox[{"\[DoubleStruckM]", "[", "\[DoubleStruckT]", "]"}], 
                ",", 
                RowBox[{"\[DoubleStruckX]", "[", "\[DoubleStruckT]", "]"}], 
                ",", 
                RowBox[{"\[DoubleStruckC]", "[", "\[DoubleStruckT]", "]"}]}], 
               "]"}]}], ",", 
             RowBox[{
              RowBox[{"\[DoubleStruckX]", "[", "\[DoubleStruckT]", "]"}], 
              "\[Rule]", 
              RowBox[{"HybridDynamics`Private`T0", "[", 
               RowBox[{
                RowBox[{"\[DoubleStruckM]", "[", "\[DoubleStruckT]", "]"}], 
                ",", 
                RowBox[{"\[DoubleStruckX]", "[", "\[DoubleStruckT]", "]"}], 
                ",", 
                RowBox[{"\[DoubleStruckC]", "[", "\[DoubleStruckT]", "]"}], 
                ",", "0"}], "]"}]}], ",", "\"\<RemoveEvent\>\""}], "}"}], ",", 
           RowBox[{"{", 
            RowBox[{"\"\<Priority\>\"", "\[Rule]", "1"}], "}"}]}], "]"}], ",",
          "\[IndentingNewLine]", "\[IndentingNewLine]", 
         RowBox[{"WhenEvent", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"blevent", "[", 
             RowBox[{
              RowBox[{"\[DoubleStruckM]", "[", "\[DoubleStruckT]", "]"}], ",",
               " ", 
              RowBox[{"\[DoubleStruckX]", "[", "\[DoubleStruckT]", "]"}], ",",
               " ", 
              RowBox[{"\[DoubleStruckC]", "[", "\[DoubleStruckT]", "]"}]}], 
             "]"}], " ", ">", " ", "0"}], ",", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{
              RowBox[{"Print", "[", 
               RowBox[{"\[DoubleStruckT]", ",", " ", "\"\< \>\"", ",", " ", 
                RowBox[{"\[DoubleStruckM]", "[", "\[DoubleStruckT]", "]"}], 
                ",", " ", "\"\< \>\"", ",", " ", 
                RowBox[{"blevent", "[", 
                 RowBox[{
                  RowBox[{"\[DoubleStruckM]", "[", "\[DoubleStruckT]", "]"}], 
                  ",", " ", 
                  RowBox[{"\[DoubleStruckX]", "[", "\[DoubleStruckT]", "]"}], 
                  ",", " ", 
                  RowBox[{
                  "\[DoubleStruckC]", "[", "\[DoubleStruckT]", "]"}]}], 
                 "]"}]}], "]"}], ";", 
              RowBox[{
               RowBox[{"\[DoubleStruckX]", "[", "\[DoubleStruckT]", "]"}], 
               "\[Rule]", 
               RowBox[{"HybridDynamics`Private`TF", "[", 
                RowBox[{
                 RowBox[{"\[DoubleStruckM]", "[", "\[DoubleStruckT]", "]"}], 
                 ",", 
                 RowBox[{"\[DoubleStruckX]", "[", "\[DoubleStruckT]", "]"}], 
                 ",", 
                 RowBox[{"\[DoubleStruckC]", "[", "\[DoubleStruckT]", "]"}], 
                 ",", "0"}], "]"}]}]}], ",", 
             RowBox[{
              RowBox[{"\[DoubleStruckM]", "[", "\[DoubleStruckT]", "]"}], 
              "\[Rule]", 
              RowBox[{"HybridDynamics`Private`m", "[", 
               RowBox[{
                RowBox[{"\[DoubleStruckM]", "[", "\[DoubleStruckT]", "]"}], 
                ",", 
                RowBox[{"\[DoubleStruckX]", "[", "\[DoubleStruckT]", "]"}], 
                ",", 
                RowBox[{"\[DoubleStruckC]", "[", "\[DoubleStruckT]", "]"}]}], 
               "]"}]}], ",", 
             RowBox[{
              RowBox[{"\[DoubleStruckX]", "[", "\[DoubleStruckT]", "]"}], 
              "\[Rule]", 
              RowBox[{"HybridDynamics`Private`h", "[", 
               RowBox[{
                RowBox[{"\[DoubleStruckM]", "[", "\[DoubleStruckT]", "]"}], 
                ",", 
                RowBox[{"\[DoubleStruckX]", "[", "\[DoubleStruckT]", "]"}], 
                ",", 
                RowBox[{"\[DoubleStruckC]", "[", "\[DoubleStruckT]", "]"}]}], 
               "]"}]}], ",", 
             RowBox[{
              RowBox[{"\[DoubleStruckC]", "[", "\[DoubleStruckT]", "]"}], 
              "\[Rule]", 
              RowBox[{"HybridDynamics`Private`d", "[", 
               RowBox[{
                RowBox[{"\[DoubleStruckM]", "[", "\[DoubleStruckT]", "]"}], 
                ",", 
                RowBox[{"\[DoubleStruckX]", "[", "\[DoubleStruckT]", "]"}], 
                ",", 
                RowBox[{"\[DoubleStruckC]", "[", "\[DoubleStruckT]", "]"}]}], 
               "]"}]}], ",", 
             RowBox[{
              RowBox[{"\[DoubleStruckX]", "[", "\[DoubleStruckT]", "]"}], 
              "\[Rule]", 
              RowBox[{"HybridDynamics`Private`T0", "[", 
               RowBox[{
                RowBox[{"\[DoubleStruckM]", "[", "\[DoubleStruckT]", "]"}], 
                ",", 
                RowBox[{"\[DoubleStruckX]", "[", "\[DoubleStruckT]", "]"}], 
                ",", 
                RowBox[{"\[DoubleStruckC]", "[", "\[DoubleStruckT]", "]"}], 
                ",", "0"}], "]"}]}]}], "}"}], ",", 
           RowBox[{"{", 
            RowBox[{"\"\<Priority\>\"", "\[Rule]", "2"}], "}"}]}], "]"}]}], 
        "\[IndentingNewLine]", "}"}]}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"\[CurlyPhi]", "[", 
       RowBox[{"m", ",", " ", "x", ",", " ", "c", ",", " ", 
        RowBox[{"{", 
         RowBox[{"0", ",", " ", 
          RowBox[{"n", " ", "Tc"}]}], "}"}], ",", " ", 
        RowBox[{"\"\<e\>\"", " ", "\[Rule]", " ", "esw"}]}], "]"}]}]}], 
    "\[IndentingNewLine]", "]"}]}], ";"}]}], "Input",
 InitializationCell->
  True,ExpressionUUID->"a88115f1-27f7-4e75-bb90-559eaf5eccfa"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"\[Sigma]", "[", "q_", "]"}], " ", ":=", 
    RowBox[{
     RowBox[{"q", "\[LeftDoubleBracket]", "4", "\[RightDoubleBracket]"}], "+", 
     RowBox[{"0.5", 
      RowBox[{
      "q", "\[LeftDoubleBracket]", "5", "\[RightDoubleBracket]"}]}]}]}], 
   ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"be", "[", 
     RowBox[{
      RowBox[{"x_", "?", "VectorQ"}], ",", " ", 
      RowBox[{"c_", "?", "VectorQ"}]}], "]"}], " ", ":=", " ", 
    RowBox[{"Sin", "[", 
     RowBox[{
      RowBox[{"\[Sigma]", "[", "x", "]"}], "-", 
      RowBox[{"\[Sigma]", "[", "c", "]"}]}], "]"}]}], ";"}], 
  "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{
    RowBox[{
     RowBox[{"be", "[", 
      RowBox[{"m_", ",", " ", 
       RowBox[{"x_", "?", "VectorQ"}], ",", " ", 
       RowBox[{"c_", "?", "VectorQ"}]}], "]"}], " ", ":=", " ", 
     RowBox[{"Module", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"X", ",", " ", "C"}], "}"}], ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"X", " ", "=", " ", 
         RowBox[{"devec", "[", 
          RowBox[{"x", ",", " ", "nx"}], "]"}]}], ";", "\[IndentingNewLine]", 
        
        RowBox[{"C", " ", "=", " ", 
         RowBox[{"devec", "[", 
          RowBox[{"c", ",", " ", "nc"}], "]"}]}], ";", "\[IndentingNewLine]", 
        
        RowBox[{"Sin", "[", 
         RowBox[{
          RowBox[{"BL\[Sigma]", "[", 
           RowBox[{"m", ",", " ", "X", ",", " ", "C"}], "]"}], "-", 
          RowBox[{"BL\[Sigma]", "[", 
           RowBox[{"m", ",", " ", 
            RowBox[{"C", "\[LeftDoubleBracket]", 
             RowBox[{"All", ",", " ", 
              RowBox[{"1", ";;", "nx"}]}], "\[RightDoubleBracket]"}], ",", 
            " ", "C"}], "]"}]}], "]"}]}]}], "\[IndentingNewLine]", "]"}]}], 
    ";"}], "*)"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{"for", " ", "simulation"}], " ", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"state", "[", 
    RowBox[{"p_", ",", " ", 
     RowBox[{"n_Integer:", "1"}]}], "]"}], " ", ":=", " ", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "Tc", ",", " ", "m", ",", " ", "x", ",", " ", "c", ",", " ", "DTsw", 
       ",", " ", "Tsw", ",", " ", "esw", ",", " ", "r"}], "}"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Tc", " ", "=", " ", 
       RowBox[{"p", "\[LeftDoubleBracket]", 
        RowBox[{"-", "1"}], "\[RightDoubleBracket]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"m", " ", "=", " ", 
       RowBox[{"BLbiped", "[", "\"\<m[0]\>\"", "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"m", ",", " ", "x", ",", " ", "c"}], "}"}], " ", "=", " ", 
       RowBox[{"BLmxcp", "[", 
        RowBox[{"m", ",", " ", "p"}], "]"}]}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"esw", " ", "=", " ", 
       RowBox[{"{", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"WhenEvent", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"\[DoubleStruckT]", "-", "0"}], "\[Equal]", "0"}], ",", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{
              RowBox[{"\[DoubleStruckX]", "[", "\[DoubleStruckT]", "]"}], 
              "\[Rule]", 
              RowBox[{"HybridDynamics`Private`TF", "[", 
               RowBox[{
                RowBox[{"\[DoubleStruckM]", "[", "\[DoubleStruckT]", "]"}], 
                ",", 
                RowBox[{"\[DoubleStruckX]", "[", "\[DoubleStruckT]", "]"}], 
                ",", 
                RowBox[{"\[DoubleStruckC]", "[", "\[DoubleStruckT]", "]"}], 
                ",", "0"}], "]"}]}], ",", 
             RowBox[{
              RowBox[{"\[DoubleStruckM]", "[", "\[DoubleStruckT]", "]"}], 
              "\[Rule]", 
              RowBox[{"HybridDynamics`Private`m", "[", 
               RowBox[{
                RowBox[{"\[DoubleStruckM]", "[", "\[DoubleStruckT]", "]"}], 
                ",", 
                RowBox[{"\[DoubleStruckX]", "[", "\[DoubleStruckT]", "]"}], 
                ",", 
                RowBox[{"\[DoubleStruckC]", "[", "\[DoubleStruckT]", "]"}]}], 
               "]"}]}], ",", 
             RowBox[{
              RowBox[{"\[DoubleStruckX]", "[", "\[DoubleStruckT]", "]"}], 
              "\[Rule]", 
              RowBox[{"HybridDynamics`Private`h", "[", 
               RowBox[{
                RowBox[{"\[DoubleStruckM]", "[", "\[DoubleStruckT]", "]"}], 
                ",", 
                RowBox[{"\[DoubleStruckX]", "[", "\[DoubleStruckT]", "]"}], 
                ",", 
                RowBox[{"\[DoubleStruckC]", "[", "\[DoubleStruckT]", "]"}]}], 
               "]"}]}], ",", 
             RowBox[{
              RowBox[{"\[DoubleStruckC]", "[", "\[DoubleStruckT]", "]"}], 
              "\[Rule]", 
              RowBox[{"HybridDynamics`Private`d", "[", 
               RowBox[{
                RowBox[{"\[DoubleStruckM]", "[", "\[DoubleStruckT]", "]"}], 
                ",", 
                RowBox[{"\[DoubleStruckX]", "[", "\[DoubleStruckT]", "]"}], 
                ",", 
                RowBox[{"\[DoubleStruckC]", "[", "\[DoubleStruckT]", "]"}]}], 
               "]"}]}], ",", 
             RowBox[{
              RowBox[{"\[DoubleStruckX]", "[", "\[DoubleStruckT]", "]"}], 
              "\[Rule]", 
              RowBox[{"HybridDynamics`Private`T0", "[", 
               RowBox[{
                RowBox[{"\[DoubleStruckM]", "[", "\[DoubleStruckT]", "]"}], 
                ",", 
                RowBox[{"\[DoubleStruckX]", "[", "\[DoubleStruckT]", "]"}], 
                ",", 
                RowBox[{"\[DoubleStruckC]", "[", "\[DoubleStruckT]", "]"}], 
                ",", "0"}], "]"}]}], ",", "\"\<RemoveEvent\>\""}], "}"}], ",", 
           RowBox[{"{", 
            RowBox[{"\"\<Priority\>\"", "\[Rule]", "1"}], "}"}]}], "]"}], ",",
          "\[IndentingNewLine]", "\[IndentingNewLine]", 
         RowBox[{"WhenEvent", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"be", "[", 
             RowBox[{
              RowBox[{"\[DoubleStruckX]", "[", "\[DoubleStruckT]", "]"}], ",",
               " ", 
              RowBox[{"\[DoubleStruckC]", "[", "\[DoubleStruckT]", "]"}]}], 
             "]"}], " ", ">", " ", "0"}], ",", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{
              RowBox[{"\[DoubleStruckX]", "[", "\[DoubleStruckT]", "]"}], 
              "\[Rule]", 
              RowBox[{"HybridDynamics`Private`TF", "[", 
               RowBox[{
                RowBox[{"\[DoubleStruckM]", "[", "\[DoubleStruckT]", "]"}], 
                ",", 
                RowBox[{"\[DoubleStruckX]", "[", "\[DoubleStruckT]", "]"}], 
                ",", 
                RowBox[{"\[DoubleStruckC]", "[", "\[DoubleStruckT]", "]"}], 
                ",", "0"}], "]"}]}], ",", 
             RowBox[{
              RowBox[{"\[DoubleStruckM]", "[", "\[DoubleStruckT]", "]"}], 
              "\[Rule]", 
              RowBox[{"HybridDynamics`Private`m", "[", 
               RowBox[{
                RowBox[{"\[DoubleStruckM]", "[", "\[DoubleStruckT]", "]"}], 
                ",", 
                RowBox[{"\[DoubleStruckX]", "[", "\[DoubleStruckT]", "]"}], 
                ",", 
                RowBox[{"\[DoubleStruckC]", "[", "\[DoubleStruckT]", "]"}]}], 
               "]"}]}], ",", 
             RowBox[{
              RowBox[{"\[DoubleStruckX]", "[", "\[DoubleStruckT]", "]"}], 
              "\[Rule]", 
              RowBox[{"HybridDynamics`Private`h", "[", 
               RowBox[{
                RowBox[{"\[DoubleStruckM]", "[", "\[DoubleStruckT]", "]"}], 
                ",", 
                RowBox[{"\[DoubleStruckX]", "[", "\[DoubleStruckT]", "]"}], 
                ",", 
                RowBox[{"\[DoubleStruckC]", "[", "\[DoubleStruckT]", "]"}]}], 
               "]"}]}], ",", 
             RowBox[{
              RowBox[{"\[DoubleStruckC]", "[", "\[DoubleStruckT]", "]"}], 
              "\[Rule]", 
              RowBox[{"HybridDynamics`Private`d", "[", 
               RowBox[{
                RowBox[{"\[DoubleStruckM]", "[", "\[DoubleStruckT]", "]"}], 
                ",", 
                RowBox[{"\[DoubleStruckX]", "[", "\[DoubleStruckT]", "]"}], 
                ",", 
                RowBox[{"\[DoubleStruckC]", "[", "\[DoubleStruckT]", "]"}]}], 
               "]"}]}], ",", 
             RowBox[{
              RowBox[{"\[DoubleStruckX]", "[", "\[DoubleStruckT]", "]"}], 
              "\[Rule]", 
              RowBox[{"HybridDynamics`Private`T0", "[", 
               RowBox[{
                RowBox[{"\[DoubleStruckM]", "[", "\[DoubleStruckT]", "]"}], 
                ",", 
                RowBox[{"\[DoubleStruckX]", "[", "\[DoubleStruckT]", "]"}], 
                ",", 
                RowBox[{"\[DoubleStruckC]", "[", "\[DoubleStruckT]", "]"}], 
                ",", "0"}], "]"}]}]}], "}"}], ",", 
           RowBox[{"{", 
            RowBox[{"\"\<Priority\>\"", "\[Rule]", "2"}], "}"}]}], "]"}]}], 
        "\[IndentingNewLine]", "}"}]}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"\[CurlyPhi]", "[", 
       RowBox[{"m", ",", " ", "x", ",", " ", "c", ",", " ", 
        RowBox[{"{", 
         RowBox[{"0", ",", " ", 
          RowBox[{"n", " ", "Tc"}]}], "}"}], ",", " ", 
        RowBox[{"\"\<e\>\"", " ", "\[Rule]", " ", "esw"}]}], "]"}]}]}], 
    "\[IndentingNewLine]", "]"}]}], ";"}]}], "Input",
 InitializationCell->True,
 CellLabel->
  "In[1048]:=",ExpressionUUID->"72ee8b39-0e79-4b36-b0be-6209b9230b34"]
}, Open  ]],

Cell[CellGroupData[{

Cell["End Package", "Section",
 InitializationCell->
  True,ExpressionUUID->"89ca9acb-4053-4b62-ae07-011985e5c6d0"],

Cell[BoxData[{
 RowBox[{"End", "[", "]"}], "\n", 
 RowBox[{"EndPackage", "[", "]"}]}], "Input",
 InitializationCell->True,
 CellLabel->
  "In[1051]:=",ExpressionUUID->"4658df9e-a842-4ee0-aa85-339f6974490e"]
}, Open  ]]
},
AutoGeneratedPackage->Automatic,
Evaluator->"Local",
WindowSize->{1373, 1505},
WindowMargins->{{Automatic, 0}, {0, Automatic}},
PrivateNotebookOptions->{"FileOutlineCache"->False},
CellContext->"Global`",
TrackCellChangeTimes->False,
FrontEndVersion->"11.3 for Linux x86 (64-bit) (March 6, 2018)",
StyleDefinitions->"Default.nb"
]

