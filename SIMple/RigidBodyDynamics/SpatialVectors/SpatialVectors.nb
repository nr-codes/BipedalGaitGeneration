Notebook[{
Cell[BoxData[
 RowBox[{"(*", "\n", 
  RowBox[{
   RowBox[{"SpatialVectors", ".", 
    RowBox[{"nb", ":", " ", 
     RowBox[{
     "A", " ", "spatial", " ", "vector", " ", "algebra", " ", "package", " ", 
      "based", " ", "\n", "on", " ", 
      RowBox[{"Featherstone", "'"}], "s", " ", "Spatial_v2", " ", "software", 
      " ", "\n", 
      RowBox[{
       RowBox[{"(", 
        RowBox[{
         RowBox[{"http", ":"}], "//", 
         RowBox[{
          RowBox[{
           RowBox[{
            RowBox[{"royfeatherstone", ".", "org"}], "/", "spatial"}], "/", 
           "v2"}], "/", 
          RowBox[{"index", ".", "html"}]}]}], ")"}], ".", "\n", "Copyright"}],
       " ", 
      RowBox[{"(", "C", ")"}], " ", "2014", " ", "Nelson", " ", "Rosa", " ", 
      RowBox[{"Jr", ".", "\n", "\n", "This"}], " ", "program", " ", "is", " ",
       "free", " ", "software"}], ":", " ", 
     RowBox[{"you", " ", "can", " ", "redistribute", " ", "it", " ", 
      RowBox[{"and", "/", "or"}], " ", "modify", "\n", "it", " ", "under", 
      " ", "the", " ", "terms", " ", "of", " ", "the", " ", "GNU", " ", 
      "General", " ", "Public", " ", "License", " ", "as", " ", "published", 
      " ", "by", "\n", 
      RowBox[{"the", " ", "Free", " ", "Software", " ", "Foundation"}]}]}]}], 
   ",", " ", 
   RowBox[{
   "either", " ", "version", " ", "3", " ", "of", " ", "the", " ", 
    "License"}], ",", " ", 
   RowBox[{"or", "\n", 
    RowBox[{"(", 
     RowBox[{"at", " ", "your", " ", "option"}], ")"}], " ", "any", " ", 
    "later", " ", 
    RowBox[{"version", ".", " ", "This"}], " ", "program", " ", "is", " ", 
    "distributed", " ", "in", " ", "the", " ", "\n", "hope", " ", "that", " ",
     "it", " ", "will", " ", "be", " ", "useful"}], ",", " ", 
   RowBox[{
    RowBox[{"but", " ", "WITHOUT", " ", "ANY", " ", "WARRANTY"}], ";", " ", 
    RowBox[{
    "without", " ", "even", " ", "the", " ", "\n", "implied", " ", "warranty",
      " ", "of", " ", "MERCHANTABILITY", " ", "or", " ", "FITNESS", " ", 
     "FOR", " ", "A", " ", "PARTICULAR", " ", 
     RowBox[{"PURPOSE", ".", "\n", "See"}], " ", "the", " ", "GNU", " ", 
     "General", " ", "Public", " ", "License", " ", "for", " ", "more", " ", 
     RowBox[{"details", ".", " ", "You"}], " ", "should", " ", "have", " ", 
     "\n", "received", " ", "a", " ", "copy", " ", "of", " ", "the", " ", 
     "GNU", " ", "General", " ", "Public", " ", "License", " ", "along", " ", 
     "with", " ", "this", " ", 
     RowBox[{"program", ".", "\n", "If"}], " ", "not"}]}], ",", " ", 
   RowBox[{
    RowBox[{"see", " ", "<", 
     RowBox[{"http", ":"}]}], "//", 
    RowBox[{
     RowBox[{
      RowBox[{
       RowBox[{"www", ".", "gnu", ".", "org"}], "/", "licenses"}], "/"}], ">",
      "."}]}]}], "\n", "*)"}]], "Code",
 InitializationCell->
  True,ExpressionUUID->"461d5058-d610-4530-b7f5-3d724742dada"],

Cell[CellGroupData[{

Cell["TODO:", \
"Section",ExpressionUUID->"69668757-b033-46b9-a675-17b9d6cec5e0"],

Cell["\<\
fix GetJointLocations and MechanicalQuantities functions Xip and \
InitSpatialQtys will change.

fix RBDSpatialPosition[\[DoubleStruckB][....]], need to use option \
\[OpenCurlyDoubleQuote]a\[CloseCurlyDoubleQuote] in computing spatial position

Add derivatives of I and X w.r.t. to a velocity vector to compute dI/dt and \
dX/dt, see Featherstone\[CloseCurlyQuote]s book & code in OperationalSpace\
\>", "Text",ExpressionUUID->"d3bbb3df-6e2c-484a-916e-bcd6b62f355f"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Begin Package", \
"Section",ExpressionUUID->"3bfc55e3-73c4-45d1-a335-3bcd53004cab"],

Cell[BoxData[{
 RowBox[{"BeginPackage", "[", 
  RowBox[{
  "\"\<RigidBodyDynamics`\>\"", ",", " ", "\"\<GlobalVariables`\>\""}], 
  "]"}], "\[IndentingNewLine]", 
 RowBox[{"Begin", "[", "\"\<`Private`\>\"", "]"}]}], "Input",
 InitializationCell->
  True,ExpressionUUID->"d1260a39-ddc9-47f9-882e-0aa6ac61158e"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Spatial Vector Cross Product", \
"Section",ExpressionUUID->"e544ea0c-b8b8-4fd4-b17b-a28c9c1ad119"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", " ", 
   RowBox[{"rotate", " ", "the", " ", "frame", " ", "\"\<foward\>\""}], " ", 
   "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{
     RowBox[{"rot3", "[", 
      RowBox[{"q_", ",", " ", "a_"}], "]"}], " ", ":=", " ", 
     RowBox[{"RotationMatrix", "[", 
      RowBox[{
       RowBox[{"-", "q"}], ",", " ", "a"}], "]"}]}], ";"}], 
   "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{"(*", " ", 
    RowBox[{
    "take", " ", "3", "x3", " ", "matrices", " ", "and", " ", "make", " ", 
     "a", " ", "6", "x6", " ", "matrix"}], " ", "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"Mat6", "[", 
     RowBox[{"M11_", ",", " ", "M12_", ",", " ", "M21_", ",", " ", "M22_"}], 
     "]"}], " ", ":=", " ", 
    RowBox[{"ArrayFlatten", "[", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"M11", ",", " ", "M12"}], "}"}], ",", " ", 
       RowBox[{"{", 
        RowBox[{"M21", ",", " ", "M22"}], "}"}]}], "}"}], 
     "]"}]}]}]}]], "Input",
 InitializationCell->
  True,ExpressionUUID->"064fc558-b33c-47ca-a5bb-1a1f98091141"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", " ", 
   RowBox[{
    RowBox[{"cross", " ", "products"}], ",", " ", 
    RowBox[{
    "useful", " ", "for", " ", "coordinate", " ", "transforms", " ", "of", 
     " ", "spatial", " ", "velocities", " ", "and", " ", "forces"}]}], " ", 
   "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{
     RowBox[{"skew", "[", "x_", "]"}], " ", ":=", 
     RowBox[{"(", "\[NoBreak]", GridBox[{
        {"0", 
         RowBox[{"-", 
          RowBox[{
          "x", "\[LeftDoubleBracket]", "3", "\[RightDoubleBracket]"}]}], 
         RowBox[{
         "x", "\[LeftDoubleBracket]", "2", "\[RightDoubleBracket]"}]},
        {
         RowBox[{"x", "\[LeftDoubleBracket]", "3", "\[RightDoubleBracket]"}], 
         "0", 
         RowBox[{"-", 
          RowBox[{
          "x", "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}]}]},
        {
         RowBox[{"-", 
          RowBox[{
          "x", "\[LeftDoubleBracket]", "2", "\[RightDoubleBracket]"}]}], 
         RowBox[{"x", "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}], 
         "0"}
       }], "\[NoBreak]", ")"}]}], ";"}], "\[IndentingNewLine]", 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"deskew", "[", "S_", "]"}], " ", ":=", 
     RowBox[{
      RowBox[{"1", "/", "2"}], 
      RowBox[{"{", 
       RowBox[{
        RowBox[{
         RowBox[{"S", "\[LeftDoubleBracket]", 
          RowBox[{"3", ",", "2"}], "\[RightDoubleBracket]"}], "-", 
         RowBox[{"S", "\[LeftDoubleBracket]", 
          RowBox[{"2", ",", "3"}], "\[RightDoubleBracket]"}]}], ",", " ", 
        RowBox[{
         RowBox[{"S", "\[LeftDoubleBracket]", 
          RowBox[{"1", ",", "3"}], "\[RightDoubleBracket]"}], "-", 
         RowBox[{"S", "\[LeftDoubleBracket]", 
          RowBox[{"3", ",", "1"}], "\[RightDoubleBracket]"}]}], ",", " ", 
        RowBox[{
         RowBox[{"S", "\[LeftDoubleBracket]", 
          RowBox[{"2", ",", "1"}], "\[RightDoubleBracket]"}], " ", "-", " ", 
         RowBox[{"S", "\[LeftDoubleBracket]", 
          RowBox[{"1", ",", "2"}], "\[RightDoubleBracket]"}]}]}], "}"}]}]}], 
    ";"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"mx", "[", "m_", "]"}], " ", ":=", " ", 
     RowBox[{"Mat6", "[", 
      RowBox[{
       RowBox[{"skew", "@", 
        RowBox[{"m", "\[LeftDoubleBracket]", 
         RowBox[{"1", ";;", "3"}], "\[RightDoubleBracket]"}]}], ",", " ", 
       "Z3", ",", " ", 
       RowBox[{"skew", "@", 
        RowBox[{"m", "\[LeftDoubleBracket]", 
         RowBox[{"4", ";;", "6"}], "\[RightDoubleBracket]"}]}], ",", " ", 
       RowBox[{"skew", "@", 
        RowBox[{"m", "\[LeftDoubleBracket]", 
         RowBox[{"1", ";;", "3"}], "\[RightDoubleBracket]"}]}]}], "]"}]}], 
    ";"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"mxstar", "[", "m_", "]"}], " ", ":=", " ", 
     RowBox[{"-", 
      RowBox[{
       RowBox[{"mx", "[", "m", "]"}], "\[Transpose]"}]}]}], ";"}], 
   "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{"(*", " ", 
    RowBox[{
    "primarily", " ", "used", " ", "to", " ", "get", " ", "compilable", " ", 
     "code"}], " ", "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"mxv", " ", "=", " ", 
     RowBox[{
      RowBox[{
       RowBox[{"mx", "[", "#1", "]"}], ".", "#2"}], "&"}]}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"mxX", " ", "=", " ", "mxv"}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"mxstarf", " ", "=", " ", 
     RowBox[{
      RowBox[{
       RowBox[{"mxstar", "[", "#1", "]"}], ".", "#2"}], "&"}]}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"mxstarIv", " ", "=", " ", 
     RowBox[{
      RowBox[{"mxstarf", "[", 
       RowBox[{"#1", ",", " ", 
        RowBox[{"#2", ".", "#3"}]}], "]"}], "&"}]}], ";"}]}]}]], "Input",
 InitializationCell->
  True,ExpressionUUID->"b755f28b-46b4-4db2-86b4-d0f54f934321"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Plucker Coordinate Transformations", \
"Section",ExpressionUUID->"432d5fb2-a277-41e9-b07b-8fbd301e7c20"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"transX", "[", "x_", "]"}], " ", ":=", 
   RowBox[{"Mat6", "[", 
    RowBox[{"I3", ",", " ", "Z3", ",", "  ", 
     RowBox[{
      RowBox[{"-", 
       RowBox[{"skew", "@", 
        RowBox[{
        "I3", "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}]}]}], " ",
       "x"}], ",", " ", "I3"}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"transY", "[", "y_", "]"}], " ", ":=", 
   RowBox[{"Mat6", "[", 
    RowBox[{"I3", ",", " ", "Z3", ",", "  ", 
     RowBox[{
      RowBox[{"-", 
       RowBox[{"skew", "@", 
        RowBox[{
        "I3", "\[LeftDoubleBracket]", "2", "\[RightDoubleBracket]"}]}]}], " ",
       "y"}], ",", " ", "I3"}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"transZ", "[", "z_", "]"}], " ", ":=", 
   RowBox[{"Mat6", "[", 
    RowBox[{"I3", ",", " ", "Z3", ",", "  ", 
     RowBox[{
      RowBox[{"-", 
       RowBox[{"skew", "@", 
        RowBox[{
        "I3", "\[LeftDoubleBracket]", "3", "\[RightDoubleBracket]"}]}]}], " ",
       "z"}], ",", " ", "I3"}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"trans", "[", "r_", "]"}], " ", ":=", 
    RowBox[{
     RowBox[{"transZ", "[", 
      RowBox[{"r", "\[LeftDoubleBracket]", "3", "\[RightDoubleBracket]"}], 
      "]"}], ".", 
     RowBox[{"transY", "[", 
      RowBox[{"r", "\[LeftDoubleBracket]", "2", "\[RightDoubleBracket]"}], 
      "]"}], ".", 
     RowBox[{"transX", "[", 
      RowBox[{"r", "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}], 
      "]"}]}]}], ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"rotX", "[", "\[CurlyPhi]_", "]"}], " ", ":=", " ", 
   RowBox[{"Mat6", "[", 
    RowBox[{
     RowBox[{"rot3", "[", 
      RowBox[{"\[CurlyPhi]", ",", " ", 
       RowBox[{"I3", "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}]}],
       "]"}], ",", " ", "Z3", ",", " ", "Z3", ",", " ", 
     RowBox[{"rot3", "[", 
      RowBox[{"\[CurlyPhi]", ",", " ", 
       RowBox[{"I3", "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}]}],
       "]"}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"rotY", "[", "\[Theta]_", "]"}], " ", ":=", " ", 
   RowBox[{"Mat6", "[", 
    RowBox[{
     RowBox[{"rot3", "[", 
      RowBox[{"\[Theta]", ",", " ", 
       RowBox[{"I3", "\[LeftDoubleBracket]", "2", "\[RightDoubleBracket]"}]}],
       "]"}], ",", " ", "Z3", ",", " ", "Z3", ",", " ", 
     RowBox[{"rot3", "[", 
      RowBox[{"\[Theta]", ",", " ", 
       RowBox[{"I3", "\[LeftDoubleBracket]", "2", "\[RightDoubleBracket]"}]}],
       "]"}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"rotZ", "[", "\[Psi]_", "]"}], " ", ":=", " ", 
   RowBox[{"Mat6", "[", 
    RowBox[{
     RowBox[{"rot3", "[", 
      RowBox[{"\[Psi]", ",", " ", 
       RowBox[{"I3", "\[LeftDoubleBracket]", "3", "\[RightDoubleBracket]"}]}],
       "]"}], ",", " ", "Z3", ",", " ", "Z3", ",", " ", 
     RowBox[{"rot3", "[", 
      RowBox[{"\[Psi]", ",", " ", 
       RowBox[{"I3", "\[LeftDoubleBracket]", "3", "\[RightDoubleBracket]"}]}],
       "]"}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"rot", "[", "q_", "]"}], " ", ":=", " ", 
    RowBox[{
     RowBox[{"rotZ", "[", 
      RowBox[{"q", "\[LeftDoubleBracket]", "3", "\[RightDoubleBracket]"}], 
      "]"}], ".", 
     RowBox[{"rotY", "[", 
      RowBox[{"q", "\[LeftDoubleBracket]", "2", "\[RightDoubleBracket]"}], 
      "]"}], ".", 
     RowBox[{"rotX", "[", 
      RowBox[{"q", "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}], 
      "]"}]}]}], ";"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{
   "transform", " ", "from", " ", "a", " ", "to", " ", "b", " ", 
    "coordinates"}], " ", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Xba", "[", "x_", "]"}], " ", ":=", " ", 
   RowBox[{
    RowBox[{"rot", "[", 
     RowBox[{"x", "\[LeftDoubleBracket]", 
      RowBox[{"1", ";;", "3"}], "\[RightDoubleBracket]"}], "]"}], ".", 
    RowBox[{"trans", "[", 
     RowBox[{"x", "\[LeftDoubleBracket]", 
      RowBox[{"4", ";;", "6"}], "\[RightDoubleBracket]"}], "]"}]}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"Xstarba", "[", "x_", "]"}], " ", ":=", " ", 
    RowBox[{
     RowBox[{"Inverse", "@", 
      RowBox[{"Xba", "[", "x", "]"}]}], "\[Transpose]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"InvXba", "[", 
    RowBox[{"xba_", "?", "VectorQ"}], "]"}], " ", ":=", " ", 
   RowBox[{"InvXba", "[", 
    RowBox[{"Xba", "[", "xba", "]"}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"InvXba", "[", "Xba_", "]"}], " ", ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"X", ",", " ", "R", ",", " ", "p"}], "}"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"X", " ", "=", " ", "Xba"}], ";", "\[IndentingNewLine]", 
      RowBox[{"R", " ", "=", " ", 
       RowBox[{
        RowBox[{"X", "\[LeftDoubleBracket]", 
         RowBox[{
          RowBox[{"1", ";;", "3"}], ",", 
          RowBox[{"1", ";;", "3"}]}], "\[RightDoubleBracket]"}], 
        "\[Transpose]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"p", " ", "=", " ", 
       RowBox[{"-", 
        RowBox[{"X", "\[LeftDoubleBracket]", 
         RowBox[{
          RowBox[{"4", ";;", "6"}], ",", 
          RowBox[{"1", ";;", "3"}]}], "\[RightDoubleBracket]"}]}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"X", "\[LeftDoubleBracket]", 
        RowBox[{
         RowBox[{"1", ";;", "3"}], ",", 
         RowBox[{"1", ";;", "3"}]}], "\[RightDoubleBracket]"}], " ", "=", " ",
        "R"}], ";", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"X", "\[LeftDoubleBracket]", 
        RowBox[{
         RowBox[{"4", ";;", "6"}], ",", 
         RowBox[{"4", ";;", "6"}]}], "\[RightDoubleBracket]"}], " ", "=", " ",
        "R"}], ";", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"X", "\[LeftDoubleBracket]", 
        RowBox[{
         RowBox[{"4", ";;", "6"}], ",", 
         RowBox[{"1", ";;", "3"}]}], "\[RightDoubleBracket]"}], " ", "=", " ", 
       RowBox[{"R", ".", "p", ".", "R"}]}], ";", "\[IndentingNewLine]", 
      "X"}]}], "\[IndentingNewLine]", "]"}]}], ";"}]}], "Input",
 InitializationCell->
  True,ExpressionUUID->"79ede1b0-1809-4f5d-beca-aef5142e34f7"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Spatial Inertia Functions", \
"Section",ExpressionUUID->"b833f929-65fc-4cc3-a703-50599ddeef14"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", " ", 
   RowBox[{"inertia", " ", "coordinate", " ", "transformation"}], " ", "*)"}],
   "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{
     RowBox[{"Io", "[", 
      RowBox[{"m_", ",", " ", "x_", ",", " ", "Ic_"}], "]"}], " ", ":=", " ", 
     
     RowBox[{"Module", "[", 
      RowBox[{
       RowBox[{"{", "I", "}"}], ",", "\[IndentingNewLine]", 
       RowBox[{"(*", " ", 
        RowBox[{
        "I", " ", "is", " ", "about", " ", "com", " ", "of", " ", "link"}], 
        " ", "*)"}], "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"I", " ", "=", " ", 
         RowBox[{
          RowBox[{"KroneckerProduct", "[", 
           RowBox[{
            RowBox[{"(", "\[NoBreak]", GridBox[{
               {"1", "0"},
               {"0", "0"}
              }], "\[NoBreak]", ")"}], ",", " ", "Ic"}], "]"}], " ", "+", " ", 
          RowBox[{"KroneckerProduct", "[", 
           RowBox[{
            RowBox[{"(", "\[NoBreak]", GridBox[{
               {"0", "0"},
               {"0", "1"}
              }], "\[NoBreak]", ")"}], ",", " ", 
            RowBox[{"m", " ", "I3"}]}], "]"}]}]}], ";", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{
          RowBox[{"Xba", "[", "x", "]"}], "\[Transpose]"}], ".", "I", ".", 
         RowBox[{"Xba", "[", "x", "]"}]}]}]}], " ", 
      RowBox[{"(*", " ", 
       RowBox[{
        RowBox[{"formula", " ", "from", " ", 
         RowBox[{"Springer", "'"}], "s", " ", "HoR"}], ",", " ", 
        RowBox[{"(", "3.32", ")"}]}], " ", "*)"}], "\[IndentingNewLine]", 
      "]"}]}], ";"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"mcI", "[", "Io_", "]"}], " ", ":=", " ", 
     RowBox[{"Module", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"m", ",", " ", "c", ",", " ", "I"}], "}"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"m", " ", "=", " ", 
         RowBox[{"Io", "\[LeftDoubleBracket]", 
          RowBox[{"4", ",", "4"}], "\[RightDoubleBracket]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"I", " ", "=", " ", 
         RowBox[{"Io", "\[LeftDoubleBracket]", 
          RowBox[{
           RowBox[{"1", ";;", "3"}], ",", " ", 
           RowBox[{"4", ";;", "6"}]}], "\[RightDoubleBracket]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{"m", " ", "\[NotEqual]", " ", "0"}], ",", " ", 
          RowBox[{
           RowBox[{"I", " ", "/=", " ", "m"}], ";"}]}], "]"}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"(*", " ", 
         RowBox[{
          RowBox[{"based", " ", "on", " ", "expanding", " ", "Io"}], ",", " ", 
          RowBox[{
          "rotations", " ", "always", " ", "cancel", " ", "out", " ", "of", 
           " ", "equation"}]}], " ", "*)"}], "\[IndentingNewLine]", 
        RowBox[{"c", " ", "=", " ", 
         RowBox[{"Join", "[", 
          RowBox[{"z3", ",", " ", 
           RowBox[{"deskew", "[", "I", "]"}]}], "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"I", " ", "=", " ", 
         RowBox[{
          RowBox[{"Io", "\[LeftDoubleBracket]", 
           RowBox[{
            RowBox[{"1", ";;", "3"}], ",", " ", 
            RowBox[{"1", ";;", "3"}]}], "\[RightDoubleBracket]"}], " ", "-", 
          " ", 
          RowBox[{"I", ".", 
           RowBox[{"Io", "\[LeftDoubleBracket]", 
            RowBox[{
             RowBox[{"4", ";;", "6"}], ",", " ", 
             RowBox[{"1", ";;", "3"}]}], "\[RightDoubleBracket]"}]}]}]}], ";",
         "\[IndentingNewLine]", 
        RowBox[{"Flatten", "[", 
         RowBox[{"{", 
          RowBox[{"m", ",", " ", "c", ",", " ", "I"}], "}"}], "]"}]}]}], 
      "\[IndentingNewLine]", "]"}]}], ";"}], "\[IndentingNewLine]", 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"Itot", "[", "\[DoubleStruckCapitalI]c__", "]"}], " ", ":=", " ", 
     RowBox[{"Module", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"m", ",", " ", "Icom", ",", " ", "pos", ",", " ", "I"}], 
        "}"}], ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"I", " ", "=", " ", 
         RowBox[{
          RowBox[{
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{"VectorQ", "[", "#", "]"}], ",", " ", "#", ",", " ", 
             RowBox[{"Sequence", "@@", "#"}]}], "]"}], "&"}], " ", "/@", " ", 
          
          RowBox[{"{", "\[DoubleStruckCapitalI]c", "}"}]}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"(*", " ", 
         RowBox[{
         "add", " ", "the", " ", "spatial", " ", "inertias", " ", "assuming", 
          " ", "same", " ", "origin", " ", "O"}], " ", "*)"}], 
        "\[IndentingNewLine]", 
        RowBox[{"Plus", "@@", 
         RowBox[{"Table", "[", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{
            RowBox[{"m", " ", "=", " ", 
             RowBox[{
             "si", "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}]}], 
            ";", "\[IndentingNewLine]", 
            RowBox[{"pos", " ", "=", " ", 
             RowBox[{"si", "\[LeftDoubleBracket]", 
              RowBox[{"2", ";;", "7"}], "\[RightDoubleBracket]"}]}], ";", 
            "\[IndentingNewLine]", 
            RowBox[{"If", "[", 
             RowBox[{
              RowBox[{
               RowBox[{"Length", "[", "si", "]"}], " ", "\[Equal]", " ", 
               "10"}], ",", " ", "\[IndentingNewLine]", 
              RowBox[{
               RowBox[{"Icom", " ", "=", " ", 
                RowBox[{"DiagonalMatrix", "[", 
                 RowBox[{"si", "\[LeftDoubleBracket]", 
                  RowBox[{"8", ";;", "10"}], "\[RightDoubleBracket]"}], 
                 "]"}]}], ";"}], ",", " ", "\[IndentingNewLine]", 
              RowBox[{"(*", " ", "else", " ", "*)"}], "\[IndentingNewLine]", 
              RowBox[{
               RowBox[{"Icom", " ", "=", " ", 
                RowBox[{"Partition", "[", 
                 RowBox[{
                  RowBox[{"si", "\[LeftDoubleBracket]", 
                   RowBox[{"8", ";;", "16"}], "\[RightDoubleBracket]"}], ",", 
                  " ", "3"}], "]"}]}], ";"}]}], "\[IndentingNewLine]", "]"}], 
            ";", "\[IndentingNewLine]", 
            RowBox[{"Io", "[", 
             RowBox[{"m", ",", " ", "pos", ",", " ", "Icom"}], "]"}]}], ",", 
           "\[IndentingNewLine]", 
           RowBox[{"{", 
            RowBox[{"si", ",", " ", "I"}], "}"}]}], "\[IndentingNewLine]", 
          "]"}]}]}]}], "\[IndentingNewLine]", "]"}]}], ";"}]}]}]], "Input",
 InitializationCell->
  True,ExpressionUUID->"e1f7f68d-8f82-484c-9cba-1625951c9237"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Spatial Kinematic and Dynamic Functions", \
"Section",ExpressionUUID->"8ce4e066-1ccd-4d44-ab6c-d5639d28e959"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"agfun", "::", "g"}], " ", "=", " ", 
    "\"\<Gravity not set.  Default is zero g.  Call RBDGravity[...] to \
change.\>\""}], ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"agfun", "[", 
     RowBox[{
      RowBox[{"x_:", 
       RowBox[{"{", "}"}]}], ",", " ", 
      RowBox[{"\[Lambda]_:", 
       RowBox[{"{", "}"}]}]}], "]"}], " ", ":=", " ", 
    RowBox[{
     RowBox[{"Lookup", "[", 
      RowBox[{"rb", ",", " ", "\"\<g\>\"", ",", " ", 
       RowBox[{
        RowBox[{"Message", "[", 
         RowBox[{"agfun", "::", "g"}], "]"}], ";", " ", 
        RowBox[{"(", 
         RowBox[{"z6", "&"}], ")"}]}]}], "]"}], "[", 
     RowBox[{
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"x", " ", "===", " ", 
         RowBox[{"{", "}"}]}], ",", " ", 
        RowBox[{"Array", "[", 
         RowBox[{"\[DoubleStruckX]", ",", " ", "nx"}], "]"}], ",", " ", "x"}],
        "]"}], ",", " ", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"\[Lambda]", " ", "===", " ", 
         RowBox[{"{", "}"}]}], ",", " ", 
        RowBox[{"Array", "[", 
         RowBox[{"\[DoubleStruckC]", ",", " ", "nc"}], "]"}], ",", " ", 
        "\[Lambda]"}], "]"}]}], "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"XLfun", "[", 
     RowBox[{
      RowBox[{"x_:", 
       RowBox[{"{", "}"}]}], ",", " ", 
      RowBox[{"\[Lambda]_:", 
       RowBox[{"{", "}"}]}]}], "]"}], " ", ":=", " ", 
    RowBox[{"EvaluateSpatialFunction", "[", 
     RowBox[{"\"\<XL\>\"", ",", " ", "x", ",", " ", "\[Lambda]"}], "]"}]}], 
   ";"}], " "}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"sfun", "[", 
    RowBox[{
     RowBox[{"x_:", 
      RowBox[{"{", "}"}]}], ",", " ", 
     RowBox[{"\[Lambda]_:", 
      RowBox[{"{", "}"}]}]}], "]"}], " ", ":=", " ", 
   RowBox[{"EvaluateSpatialFunction", "[", 
    RowBox[{"\"\<s\>\"", ",", " ", "x", ",", " ", "\[Lambda]"}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"\[DoubleStruckCapitalI]fun", "[", 
     RowBox[{
      RowBox[{"x_:", 
       RowBox[{"{", "}"}]}], ",", " ", 
      RowBox[{"\[Lambda]_:", 
       RowBox[{"{", "}"}]}]}], "]"}], " ", ":=", " ", 
    RowBox[{"EvaluateSpatialFunction", "[", 
     RowBox[{
     "\"\<\[DoubleStruckCapitalI]\>\"", ",", " ", "x", ",", " ", 
      "\[Lambda]"}], "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"sdotfun", "[", 
     RowBox[{
      RowBox[{"x_:", 
       RowBox[{"{", "}"}]}], ",", " ", 
      RowBox[{"\[Lambda]_:", 
       RowBox[{"{", "}"}]}]}], "]"}], " ", ":=", " ", 
    RowBox[{"EvaluateSpatialFunction", "[", 
     RowBox[{"\"\<sdot\>\"", ",", " ", "x", ",", " ", "\[Lambda]"}], "]"}]}], 
   ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"XL0fun", "[", 
     RowBox[{
      RowBox[{"x_:", 
       RowBox[{"{", "}"}]}], ",", " ", 
      RowBox[{"\[Lambda]_:", 
       RowBox[{"{", "}"}]}]}], "]"}], " ", ":=", " ", 
    RowBox[{"Block", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"bx", " ", "=", " ", "nq"}], " ", 
       RowBox[{"(*", " ", 
        RowBox[{"compute", " ", "all", " ", "XL0"}], " ", "*)"}], "}"}], ",", 
      " ", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"XL", " ", "=", " ", 
        RowBox[{"XLfun", "[", 
         RowBox[{"x", ",", " ", "\[Lambda]"}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"X0", "[", "]"}], ";", "\[IndentingNewLine]", "XL0"}]}], 
     "\[IndentingNewLine]", "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"EvaluateSpatialFunction", "[", 
    RowBox[{"spat_", ",", " ", 
     RowBox[{"x_:", 
      RowBox[{"{", "}"}]}], ",", " ", 
     RowBox[{"\[Lambda]_:", 
      RowBox[{"{", "}"}]}]}], "]"}], " ", ":=", " ", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"f", ",", " ", "a", ",", " ", "b"}], "}"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"a", " ", "=", " ", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"x", " ", "===", " ", 
          RowBox[{"{", "}"}]}], ",", " ", 
         RowBox[{"Array", "[", 
          RowBox[{"\[DoubleStruckX]", ",", " ", "nx"}], "]"}], ",", " ", 
         "x"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"b", " ", "=", " ", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"\[Lambda]", " ", "===", " ", 
          RowBox[{"{", "}"}]}], ",", " ", 
         RowBox[{"Array", "[", 
          RowBox[{"\[DoubleStruckC]", ",", " ", "nc"}], "]"}], ",", " ", 
         "\[Lambda]"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"f", " ", "=", " ", 
       RowBox[{"Flatten", "@", 
        RowBox[{"Values", "@", 
         RowBox[{"RBDGetLinkInfo", "[", 
          RowBox[{"spat", ",", " ", "False"}], "]"}]}]}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"Through", "[", 
       RowBox[{"f", "[", 
        RowBox[{"a", ",", " ", "b"}], "]"}], "]"}]}]}], "\[IndentingNewLine]",
     "]"}]}], ";"}]}], "Input",
 InitializationCell->
  True,ExpressionUUID->"33f25ff6-b701-4d39-9f2e-7c7befe3f434"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"SetAttributes", "[", 
    RowBox[{"RBDSpatialFunctions", ",", " ", "Listable"}], "]"}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"RBDSpatialFunctions", "[", "]"}], " ", ":=", " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"GetExpandedTree", "[", "]"}], ";", " ", 
       RowBox[{"(*", " ", 
        RowBox[{"calls", " ", 
         RowBox[{"GetTree", "[", "...", "]"}], " ", "internally"}], " ", 
        "*)"}], "\[IndentingNewLine]", 
       RowBox[{"(*", " ", 
        RowBox[{
         RowBox[{"get", " ", "link", " ", "names"}], ",", " ", 
         RowBox[{"if", " ", "they", " ", "exist"}]}], " ", "*)"}], 
       "\[IndentingNewLine]", 
       RowBox[{"RBDSpatialFunctions", "[", 
        RowBox[{"Keys", "@", 
         RowBox[{"Lookup", "[", 
          RowBox[{"rb", ",", " ", "TreeForm", ",", " ", 
           RowBox[{"{", "}"}]}], "]"}]}], "]"}]}]}], "\[IndentingNewLine]", 
     "]"}]}], ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"RBDSpatialFunctions", "[", "b_", "]"}], " ", ":=", " ", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "n", ",", " ", "k", ",", " ", "jc", ",", " ", "S", ",", " ", "XT", ",", 
       " ", "sfun", ",", " ", "sdotfun", ",", " ", "Xfun", 
       RowBox[{"(*", 
        RowBox[{",", " ", "Xdotfun"}], "*)"}], ",", " ", "Ifun"}], "}"}], ",",
      "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"jc", " ", "=", " ", 
       RowBox[{"rb", "[", 
        RowBox[{"b", ",", " ", "\"\<joint\>\""}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"S", " ", "=", " ", 
       RowBox[{"joint", "[", "jc", "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"n", " ", "=", " ", 
       RowBox[{"Max", "[", 
        RowBox[{"1", ",", " ", 
         RowBox[{"Length", "@", "S"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
      
      RowBox[{"sfun", " ", "=", " ", 
       RowBox[{"Xfun", " ", "=", " ", 
        RowBox[{"Ifun", " ", "=", " ", 
         RowBox[{"Table", "[", 
          RowBox[{"0", ",", " ", "n"}], "]"}]}]}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
        RowBox[{
        "create", " ", "pure", " ", "functions", " ", "for", " ", "s"}], ",", 
        " ", "X", ",", " ", "I"}], " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"VectorQ", "[", 
         RowBox[{"S", ",", " ", "StringQ"}], "]"}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"jc", " ", "=", " ", "S"}], ";", " ", 
         RowBox[{"(*", " ", 
          RowBox[{"save", " ", "names"}], " ", "*)"}], "\[IndentingNewLine]", 
         
         RowBox[{"Do", "[", "\[IndentingNewLine]", 
          RowBox[{"(*", " ", 
           RowBox[{
           "set", " ", "motion", " ", "freedoms", " ", "for", " ", "expanded",
             " ", "links"}], " ", "*)"}], "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{
            RowBox[{
             RowBox[{
             "sfun", "\[LeftDoubleBracket]", "k", "\[RightDoubleBracket]"}], 
             " ", "=", " ", 
             RowBox[{
              RowBox[{"joint", "[", 
               RowBox[{
               "jc", "\[LeftDoubleBracket]", "k", "\[RightDoubleBracket]"}], 
               "]"}], "[", 
              RowBox[{"\[DoubleStruckQ]", "[", 
               RowBox[{"b", ",", "k"}], "]"}], "]"}]}], ";", 
            "\[IndentingNewLine]", "\[IndentingNewLine]", 
            RowBox[{"(*", " ", 
             RowBox[{
             "links", " ", "2", " ", "to", " ", "n", " ", "are", " ", 
              "coincident", " ", "with", " ", "link", " ", "1"}], " ", "*)"}],
             "\[IndentingNewLine]", 
            RowBox[{"XT", " ", "=", " ", "I6"}], ";", "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{
             "Xfun", "\[LeftDoubleBracket]", "k", "\[RightDoubleBracket]"}], 
             " ", "=", " ", 
             RowBox[{
              RowBox[{
               RowBox[{"XJ", "[", 
                RowBox[{
                "jc", "\[LeftDoubleBracket]", "k", "\[RightDoubleBracket]"}], 
                "]"}], "[", 
               RowBox[{"\[DoubleStruckQ]", "[", 
                RowBox[{"b", ",", "k"}], "]"}], "]"}], ".", "XT"}]}], ";", 
            "\[IndentingNewLine]", "\[IndentingNewLine]", 
            RowBox[{"(*", " ", 
             RowBox[{
              RowBox[{
              "zero", " ", "inertia", " ", "for", " ", "links", " ", "1", " ",
                "to", " ", "n"}], "-", "1"}], " ", "*)"}], 
            "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{"Ifun", "\[LeftDoubleBracket]", 
              RowBox[{"k", "-", "1"}], "\[RightDoubleBracket]"}], " ", "=", 
             " ", "Z6"}], ";"}], ",", "\[IndentingNewLine]", 
           RowBox[{"{", 
            RowBox[{"k", ",", " ", "2", ",", " ", "n"}], "}"}]}], 
          "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
         "\[IndentingNewLine]", 
         RowBox[{"(*", " ", 
          RowBox[{
           RowBox[{"now", " ", "get", " ", "1"}], "-", 
           RowBox[{
           "dof", " ", "code", " ", "of", " ", "first", " ", "expanded", " ", 
            "joint", " ", "of", " ", "i"}]}], " ", "*)"}], 
         "\[IndentingNewLine]", 
         RowBox[{"jc", " ", "=", " ", 
          RowBox[{
          "jc", " ", "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}]}],
          ";", "\[IndentingNewLine]", 
         RowBox[{"S", " ", "=", " ", 
          RowBox[{"joint", "[", "jc", "]"}]}], ";"}]}], "\[IndentingNewLine]",
        "]"}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
        RowBox[{
        "set", " ", "up", " ", "first", " ", "and", " ", "last", " ", 
         "links"}], ";", " ", 
        RowBox[{
         RowBox[{"these", " ", "are", " ", "equal", " ", "for", " ", "1"}], 
         "-", 
         RowBox[{"dof", " ", "links"}]}]}], " ", "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"sfun", "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}],
        " ", "=", " ", 
       RowBox[{"S", "[", 
        RowBox[{"\[DoubleStruckQ]", "[", 
         RowBox[{"b", ",", "1"}], "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"XT", " ", "=", " ", 
       RowBox[{"Xba", "[", 
        RowBox[{"rb", "[", 
         RowBox[{"b", ",", " ", "\"\<frame\>\""}], "]"}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"Xfun", "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}],
        " ", "=", " ", 
       RowBox[{
        RowBox[{
         RowBox[{"XJ", "[", "jc", "]"}], "[", 
         RowBox[{"\[DoubleStruckQ]", "[", 
          RowBox[{"b", ",", "1"}], "]"}], "]"}], ".", "XT"}]}], ";", " ", 
      RowBox[{"(*", " ", 
       RowBox[{"parent", " ", "to", " ", "child", " ", "transform"}], " ", 
       "*)"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"Ifun", "\[LeftDoubleBracket]", 
        RowBox[{"-", "1"}], "\[RightDoubleBracket]"}], " ", "=", " ", 
       RowBox[{"Itot", "[", 
        RowBox[{"rb", "[", 
         RowBox[{"b", ",", " ", "\"\<inertia\>\""}], "]"}], "]"}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{"make", " ", "pure", " ", "functions"}], " ", "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"S", " ", "=", " ", 
       RowBox[{
        RowBox[{
         RowBox[{"ConvertToXLFunction", "[", 
          RowBox[{"#", ",", " ", 
           RowBox[{"\"\<dot\>\"", " ", "\[Rule]", " ", "True"}]}], "]"}], 
         "\[LeftDoubleBracket]", "2", "\[RightDoubleBracket]"}], "&"}]}], ";",
       "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", "sdotfun", 
        RowBox[{"(*", 
         RowBox[{",", " ", "Xdotfun"}], "*)"}], "}"}], " ", "=", " ", 
       RowBox[{"Map", "[", 
        RowBox[{"S", ",", " ", 
         RowBox[{"{", "sfun", 
          RowBox[{"(*", 
           RowBox[{",", " ", "Xfun"}], "*)"}], "}"}], ",", " ", 
         RowBox[{"{", "2", "}"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"sfun", ",", " ", "Xfun", ",", " ", "Ifun"}], "}"}], " ", "=",
        " ", 
       RowBox[{"Map", "[", 
        RowBox[{"ConvertToXLFunction", ",", " ", 
         RowBox[{"{", 
          RowBox[{"sfun", ",", " ", "Xfun", ",", " ", "Ifun"}], "}"}], ",", 
         " ", 
         RowBox[{"{", "2", "}"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"S", " ", "=", " ", 
       RowBox[{"{", 
        RowBox[{"sfun", ",", " ", "sdotfun", ",", " ", "Xfun", 
         RowBox[{"(*", 
          RowBox[{",", " ", "Xdotfun"}], "*)"}], ",", " ", "Ifun"}], "}"}]}], 
      ";", "\[IndentingNewLine]", 
      RowBox[{"S", " ", "=", " ", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{
         "\"\<s\>\"", ",", " ", "\"\<sdot\>\"", ",", " ", "\"\<XL\>\"", 
          RowBox[{"(*", 
           RowBox[{",", " ", "\"\<XLdot\>\""}], "*)"}], ",", " ", 
          "\"\<\[DoubleStruckCapitalI]\>\""}], "}"}], " ", "\[Rule]", " ", 
        "S"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"AssociateTo", "[", 
       RowBox[{
        RowBox[{"rb", "[", "b", "]"}], ",", " ", 
        RowBox[{"AssociationThread", "[", "S", "]"}]}], "]"}]}]}], 
    "\[IndentingNewLine]", "]"}]}], ";"}]}], "Input",
 InitializationCell->
  True,ExpressionUUID->"7f90d05f-2894-4262-96b9-2e6b3b4e4811"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Spatial Position Functions", \
"Section",ExpressionUUID->"7014d913-9c0c-40f0-aa56-4d03f73e1e7a"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"MovePoint", "[", 
    RowBox[{"X_", ",", " ", "p_"}], "]"}], " ", ":=", " ", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"R", ",", " ", "fr"}], "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{"SE", 
       RowBox[{"(", "3", ")"}], " ", "transformation"}], " ", "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"R", " ", "=", " ", 
       RowBox[{"X", "\[LeftDoubleBracket]", 
        RowBox[{
         RowBox[{"1", ";;", "3"}], ",", 
         RowBox[{"1", ";;", "3"}]}], "\[RightDoubleBracket]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"fr", " ", "=", " ", 
       RowBox[{
        RowBox[{"R", "\[Transpose]"}], ".", 
        RowBox[{"X", "\[LeftDoubleBracket]", 
         RowBox[{
          RowBox[{"4", ";;", "6"}], ",", 
          RowBox[{"1", ";;", "3"}]}], "\[RightDoubleBracket]"}]}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"fr", " ", "=", " ", 
       RowBox[{"-", 
        RowBox[{"deskew", "[", "fr", "]"}]}]}], ";", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{
        RowBox[{"R", "\[Transpose]"}], ".", "p"}], " ", "+", " ", "fr"}]}]}], 
    "\[IndentingNewLine]", "]"}]}], ";"}]], "Input",
 InitializationCell->
  True,ExpressionUUID->"25303bc1-9c03-4fa2-ac61-84b3d362069d"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"position", "[", "X_", "]"}], " ", ":=", " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", "fr", "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"fr", " ", "=", " ", 
        RowBox[{
         RowBox[{
          RowBox[{"X", "\[LeftDoubleBracket]", 
           RowBox[{
            RowBox[{"1", ";;", "3"}], ",", 
            RowBox[{"1", ";;", "3"}]}], "\[RightDoubleBracket]"}], 
          "\[Transpose]"}], ".", 
         RowBox[{"X", "\[LeftDoubleBracket]", 
          RowBox[{
           RowBox[{"4", ";;", "6"}], ",", 
           RowBox[{"1", ";;", "3"}]}], "\[RightDoubleBracket]"}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"-", 
        RowBox[{"deskew", "[", "fr", "]"}]}]}]}], "\[IndentingNewLine]", 
     "]"}]}], ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"angle", "[", "E_", "]"}], " ", ":=", " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"x", ",", " ", "y", ",", " ", "z"}], "}"}], ",", " ", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
       "spatial", " ", "transforms", " ", "E", " ", "rotate", " ", "the", " ", 
        RowBox[{"parent", "'"}], "s", " ", "frame", " ", "\"\<backwards\>\"", 
        " ", "writing", " ", "the", " ", "frame", " ", "in", " ", "the", " ", 
        
        RowBox[{"child", "'"}], "s", " ", "coordinate", " ", "system"}], " ", 
       "*)"}], "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"Which", "[", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{
          RowBox[{"E", "\[LeftDoubleBracket]", 
           RowBox[{"3", ",", "1"}], "\[RightDoubleBracket]"}], " ", 
          "\[Equal]", " ", 
          RowBox[{"-", "1"}]}], ",", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"z", " ", "=", " ", "0"}], ";", "\[IndentingNewLine]", 
          RowBox[{"y", " ", "=", " ", 
           RowBox[{
            RowBox[{"-", "\[Pi]"}], "/", "2"}]}], ";", "\[IndentingNewLine]", 
          
          RowBox[{"x", " ", "=", " ", 
           RowBox[{"ArcTan", "[", 
            RowBox[{
             RowBox[{"E", "\[LeftDoubleBracket]", 
              RowBox[{"1", ",", "3"}], "\[RightDoubleBracket]"}], ",", " ", 
             RowBox[{"E", "\[LeftDoubleBracket]", 
              RowBox[{"2", ",", "3"}], "\[RightDoubleBracket]"}]}], "]"}]}], 
          ";"}], ",", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"E", "\[LeftDoubleBracket]", 
           RowBox[{"3", ",", "1"}], "\[RightDoubleBracket]"}], " ", 
          "\[Equal]", " ", "1"}], ",", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"z", " ", "=", " ", "0"}], ";", "\[IndentingNewLine]", 
          RowBox[{"y", " ", "=", " ", 
           RowBox[{"\[Pi]", "/", "2"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"x", " ", "=", " ", 
           RowBox[{"ArcTan", "[", 
            RowBox[{
             RowBox[{"E", "\[LeftDoubleBracket]", 
              RowBox[{"2", ",", "2"}], "\[RightDoubleBracket]"}], ",", " ", 
             RowBox[{"E", "\[LeftDoubleBracket]", 
              RowBox[{"2", ",", "3"}], "\[RightDoubleBracket]"}]}], "]"}]}], 
          ";"}], ",", "\[IndentingNewLine]", "True", ",", 
         "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"z", " ", "=", " ", 
           RowBox[{"ArcTan", "[", 
            RowBox[{
             RowBox[{"E", "\[LeftDoubleBracket]", 
              RowBox[{"1", ",", "1"}], "\[RightDoubleBracket]"}], ",", " ", 
             RowBox[{"-", 
              RowBox[{"E", "\[LeftDoubleBracket]", 
               RowBox[{"2", ",", "1"}], "\[RightDoubleBracket]"}]}]}], 
            "]"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"y", " ", "=", " ", 
           RowBox[{"ArcSin", "[", 
            RowBox[{"E", "\[LeftDoubleBracket]", 
             RowBox[{"3", ",", "1"}], "\[RightDoubleBracket]"}], "]"}]}], ";",
           "\[IndentingNewLine]", 
          RowBox[{"x", " ", "=", " ", 
           RowBox[{"ArcTan", "[", 
            RowBox[{
             RowBox[{"E", "\[LeftDoubleBracket]", 
              RowBox[{"3", ",", "3"}], "\[RightDoubleBracket]"}], ",", " ", 
             RowBox[{"-", 
              RowBox[{"E", "\[LeftDoubleBracket]", 
               RowBox[{"3", ",", "2"}], "\[RightDoubleBracket]"}]}]}], 
            "]"}]}], ";"}]}], "\[IndentingNewLine]", "]"}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"{", 
        RowBox[{"x", ",", " ", "y", ",", " ", "z"}], "}"}]}]}], 
     "\[IndentingNewLine]", "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Tba", "[", "X_", "]"}], " ", ":=", " ", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"E", ",", " ", "r"}], "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
      "from", " ", "6", "x6", " ", "spatial", " ", "coordinates", " ", "to", 
       " ", "4", "x4", " ", "homogenous", " ", "coordinates"}], " ", "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"E", " ", "=", " ", 
       RowBox[{"X", "\[LeftDoubleBracket]", 
        RowBox[{
         RowBox[{"1", ";;", "3"}], ",", " ", 
         RowBox[{"1", ";;", "3"}]}], "\[RightDoubleBracket]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"r", " ", "=", " ", 
       RowBox[{"position", "[", "X", "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"r", " ", "=", " ", 
       RowBox[{"-", 
        RowBox[{"E", ".", "r"}]}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"ArrayFlatten", "[", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"E", ",", " ", 
           RowBox[{
            RowBox[{"{", "r", "}"}], "\[Transpose]"}]}], "}"}], ",", " ", 
         RowBox[{"{", 
          RowBox[{"0", ",", " ", "1"}], "}"}]}], "}"}], "]"}]}]}], 
    "\[IndentingNewLine]", "]"}]}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"Options", "[", "RBDSpatialPosition", "]"}], " ", "=", " ", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"\"\<Ep\>\"", " ", "\[Rule]", " ", "False"}], ",", " ", 
      RowBox[{"\"\<o\>\"", " ", "\[Rule]", " ", "Root"}], ",", " ", 
      RowBox[{"\"\<x\>\"", " ", "\[Rule]", " ", 
       RowBox[{"{", "}"}]}], ",", " ", 
      RowBox[{"\"\<\[Lambda]\>\"", " ", "\[Rule]", " ", 
       RowBox[{"{", "}"}]}]}], "}"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"RBDSpatialPosition", "[", 
     RowBox[{
      RowBox[{"X_", "?", "MatrixQ"}], ",", " ", 
      RowBox[{"OptionsPattern", "[", "]"}]}], "]"}], " ", ":=", " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"E", ",", " ", "p"}], "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"E", " ", "=", " ", 
        RowBox[{"X", "\[LeftDoubleBracket]", 
         RowBox[{
          RowBox[{"1", ";;", "3"}], ",", " ", 
          RowBox[{"1", ";;", "3"}]}], "\[RightDoubleBracket]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"p", " ", "=", " ", 
        RowBox[{"position", "[", "X", "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"Which", "[", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"OptionValue", "[", "\"\<Ep\>\"", "]"}], ",", " ", 
         RowBox[{"{", 
          RowBox[{"E", ",", " ", "p"}], "}"}], ",", "\[IndentingNewLine]", 
         RowBox[{"MatrixQ", "[", 
          RowBox[{"E", ",", " ", "NumericQ"}], "]"}], ",", " ", 
         RowBox[{"Join", "[", 
          RowBox[{
           RowBox[{"EulerAngles", "[", 
            RowBox[{
             RowBox[{"E", "\[Transpose]"}], " ", 
             RowBox[{"(*", " ", 
              RowBox[{"R", " ", "\[Element]", " ", 
               RowBox[{"SO", 
                RowBox[{"(", "3", ")"}]}]}], " ", "*)"}], ",", " ", 
             RowBox[{"{", 
              RowBox[{"1", ",", "2", ",", "3"}], "}"}]}], "]"}], ",", " ", 
           "p"}], "]"}], ",", "\[IndentingNewLine]", "True", ",", " ", 
         RowBox[{"Join", "[", 
          RowBox[{"z3", ",", " ", "p"}], "]"}]}], "\[IndentingNewLine]", 
        "]"}]}]}], "\[IndentingNewLine]", "]"}]}], ";"}], 
  "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{"bug", " ", "need", " ", "to", " ", "use", " ", 
    RowBox[{"OptionValue", "[", "\"\<a\>\"", "]"}], " ", "as", " ", "well"}], 
   " ", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"RBDSpatialPosition", "[", 
     RowBox[{"\[DoubleStruckB]", "[", 
      RowBox[{"b_", ",", " ", "r_", ",", " ", "Xcb_", ",", " ", 
       RowBox[{"opts", ":", 
        RowBox[{"OptionsPattern", "[", "\[DoubleStruckB]", "]"}]}]}], "]"}], 
     "]"}], " ", ":=", " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"n", ",", " ", "x", ",", " ", "o"}], "}"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{"redirect", " ", 
        RowBox[{"\[DoubleStruckB]", "[", 
         RowBox[{"b", ",", " ", "r", ",", " ", "Xcb", ",", " ", "o"}], "]"}], 
        " ", "here"}], " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"o", " ", "=", " ", 
        RowBox[{"OptionValue", "[", 
         RowBox[{"\[DoubleStruckB]", ",", " ", 
          RowBox[{"{", "opts", "}"}], ",", " ", "\"\<o\>\""}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"x", " ", "=", " ", 
        RowBox[{"RBDGetValue", "[", 
         RowBox[{"1", ",", " ", "nx"}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"x", " ", "=", " ", 
        RowBox[{"RBDSpatialPosition", "[", 
         RowBox[{"Xcb", ",", " ", "b", ",", " ", 
          RowBox[{"\"\<x\>\"", " ", "\[Rule]", " ", "x"}], ",", " ", 
          RowBox[{"\"\<Ep\>\"", " ", "\[Rule]", " ", "False"}], ",", " ", 
          RowBox[{"\"\<o\>\"", " ", "\[Rule]", " ", "o"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"o", " ", "=", " ", 
        RowBox[{
         RowBox[{
          RowBox[{"IntegerQ", "[", "#", "]"}], " ", "&&", " ", 
          RowBox[{
          "1", " ", "\[LessEqual]", " ", "#", " ", "\[LessEqual]", " ", 
           "nm"}]}], "&"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"IntegerQ", "[", "r", "]"}], " ", "||", " ", 
          RowBox[{"VectorQ", "[", 
           RowBox[{"r", ",", " ", "o"}], "]"}]}], ",", " ", 
         RowBox[{
          RowBox[{"Sign", "[", "r", "]"}], 
          RowBox[{"x", "\[LeftDoubleBracket]", 
           RowBox[{"Abs", "[", "r", "]"}], "\[RightDoubleBracket]"}]}], ",", 
         " ", 
         RowBox[{"r", ".", "x"}]}], "]"}]}]}], "\[IndentingNewLine]", "]"}]}],
    ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"RBDSpatialPosition", "[", 
     RowBox[{
      RowBox[{"XL0_", " ", "/;", " ", 
       RowBox[{"MatrixQ", "[", 
        RowBox[{"XL0", "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}],
         "]"}]}], ",", " ", "Xcb_", ",", " ", "b_", ",", " ", 
      RowBox[{"opts", ":", 
       RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], " ", ":=", " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"i", ",", " ", "j", ",", " ", "X"}], "}"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
       "when", " ", "animating", " ", "use", " ", "this", " ", "version"}], 
       " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"i", " ", "=", " ", 
        RowBox[{"RBDGetPositionIndex", "[", "b", "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"j", " ", "=", " ", 
        RowBox[{"RBDGetPositionIndex", "[", 
         RowBox[{"OptionValue", "[", "\"\<o\>\"", "]"}], "]"}]}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"X", " ", "=", " ", 
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{"VectorQ", "[", "Xcb", "]"}], ",", " ", 
          RowBox[{"Xba", "[", 
           RowBox[{"PadLeft", "[", 
            RowBox[{"Xcb", ",", " ", "nm"}], "]"}], "]"}], ",", " ", "Xcb"}], 
         "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"X", " ", "=", " ", 
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{"i", " ", "\[Equal]", " ", "0"}], ",", " ", "X", ",", " ", 
          RowBox[{"X", ".", 
           RowBox[{
           "XL0", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}]}]}], 
         "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"X", " ", "=", " ", 
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{"j", " ", "\[Equal]", " ", "0"}], ",", " ", "X", ",", " ", 
          RowBox[{"X", ".", 
           RowBox[{"InvXba", "[", 
            RowBox[{
            "XL0", "\[LeftDoubleBracket]", "j", "\[RightDoubleBracket]"}], 
            "]"}]}]}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"RBDSpatialPosition", "[", 
        RowBox[{"X", ",", " ", "opts"}], "]"}]}]}], "\[IndentingNewLine]", 
     "]"}]}], ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"RBDSpatialPosition", "[", 
    RowBox[{"Xcb_", ",", " ", "b_", ",", " ", 
     RowBox[{"opts", ":", 
      RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], " ", ":=", " ", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "i", ",", " ", "j", ",", " ", "p", ",", " ", "X", ",", " ", "XL", ",", 
       " ", "up"}], "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
      "in", " ", "general", " ", "this", " ", "is", " ", "fastest", " ", "if",
        " ", "path", " ", "is", " ", "less", " ", "than", " ", "nq", " ", 
       "nodes"}], " ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"i", " ", "=", " ", 
       RowBox[{"RBDGetPositionIndex", "[", "b", "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"j", " ", "=", " ", 
       RowBox[{"RBDGetPositionIndex", "[", 
        RowBox[{"OptionValue", "[", "\"\<o\>\"", "]"}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"p", " ", "=", " ", 
       RowBox[{"GetPath", "[", 
        RowBox[{"i", ",", " ", "j"}], "]"}]}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"X", " ", "=", " ", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"VectorQ", "[", "Xcb", "]"}], ",", " ", 
         RowBox[{"Xba", "[", 
          RowBox[{"PadLeft", "[", 
           RowBox[{"Xcb", ",", " ", "nm"}], "]"}], "]"}], ",", " ", "Xcb"}], 
        "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"XL", " ", "=", " ", 
       RowBox[{"XLfun", "[", 
        RowBox[{
         RowBox[{"OptionValue", "[", "\"\<x\>\"", "]"}], ",", " ", 
         RowBox[{"OptionValue", "[", "\"\<\[Lambda]\>\"", "]"}]}], "]"}]}], 
      ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"up", " ", "=", " ", "True"}], ";", "\[IndentingNewLine]", 
      RowBox[{"Do", "[", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{
         RowBox[{"Which", "[", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"j", " ", "\[Equal]", " ", "0"}], ",", " ", 
           RowBox[{
            RowBox[{"up", " ", "=", " ", "False"}], ";"}], ",", 
           "\[IndentingNewLine]", "up", ",", " ", 
           RowBox[{
            RowBox[{"X", " ", "=", " ", 
             RowBox[{"X", ".", 
              RowBox[{
              "XL", "\[LeftDoubleBracket]", "j", 
               "\[RightDoubleBracket]"}]}]}], ";"}], ",", 
           "\[IndentingNewLine]", "True", ",", " ", 
           RowBox[{
            RowBox[{"X", " ", "=", " ", 
             RowBox[{"X", ".", 
              RowBox[{"InvXba", "[", 
               RowBox[{
               "XL", "\[LeftDoubleBracket]", "j", "\[RightDoubleBracket]"}], 
               "]"}]}]}], ";"}]}], "\[IndentingNewLine]", "]"}], ";"}], ",", 
        " ", "\[IndentingNewLine]", 
        RowBox[{"{", 
         RowBox[{"j", ",", " ", "p"}], "}"}]}], "\[IndentingNewLine]", "]"}], 
      ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"RBDSpatialPosition", "[", 
       RowBox[{"X", ",", " ", "opts"}], "]"}]}]}], "\[IndentingNewLine]", 
    "]"}]}], ";"}]}], "Input",
 InitializationCell->
  True,ExpressionUUID->"c1fcae6f-43c9-420f-910e-2dd139a81c8b"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Mechanical Quantities", \
"Section",ExpressionUUID->"57f94afe-0b81-4686-b049-68925b8e2c33"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", " ", 
   RowBox[{
    RowBox[{
    "compute", " ", "the", " ", "kinetic", " ", "and", " ", "potential", " ", 
     "energy"}], ",", " ", 
    RowBox[{"spatial", " ", "momentum"}], ",", " ", 
    RowBox[{"spatial", " ", "inertia"}], ",", " ", "mass", ",", " ", 
    RowBox[{
    "position", " ", "of", " ", "the", " ", "center", " ", "of", " ", 
     "mass"}], ",", " ", 
    RowBox[{
     RowBox[{
     "and", " ", "the", " ", "linear", " ", "velocity", " ", "of", " ", "the",
       " ", "center", " ", "of", " ", "mass", " ", "of", " ", "the", " ", 
      "entire", " ", "system"}], ";", " ", 
     RowBox[{
     "vector", " ", "quantities", " ", "are", " ", "in", " ", "link", " ", 
      "0", " ", 
      RowBox[{"coordinates", "."}]}]}]}], " ", "*)"}], "\[IndentingNewLine]", 
  
  RowBox[{
   RowBox[{
    RowBox[{"RBDMechanicalQuantities", "[", "]"}], " ", ":=", " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "p", ",", " ", "vJ", ",", " ", "v", ",", " ", "hc", ",", " ", "KE", 
        ",", " ", "PE", ",", " ", "htot", ",", " ", "Itot", ",", " ", "m", 
        ",", " ", "mC", ",", " ", "I", ",", " ", "com", ",", " ", "vcom", ",",
         " ", "IC"}], "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"v", " ", "=", " ", "zspat"}], ";", "\[IndentingNewLine]", 
       RowBox[{"hc", " ", "=", " ", "zspat"}], ";", "\[IndentingNewLine]", 
       RowBox[{"KE", " ", "=", " ", "zq"}], ";", "\[IndentingNewLine]", 
       RowBox[{"IC", " ", "=", " ", "\[DoubleStruckCapitalI]"}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"Do", "[", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{
          RowBox[{"p", " ", "=", " ", 
           RowBox[{
           "parent", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}]}],
           ";", "\[IndentingNewLine]", 
          RowBox[{"vJ", " ", "=", " ", 
           RowBox[{
            RowBox[{
            "s", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}], " ", 
            
            RowBox[{
            "qd", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}]}]}], 
          ";", "\[IndentingNewLine]", 
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{"p", " ", "\[Equal]", " ", "0"}], ",", 
            "\[IndentingNewLine]", 
            RowBox[{"(*", " ", 
             RowBox[{
             "only", " ", "use", " ", "relative", " ", "link", " ", 
              "velocity"}], " ", "*)"}], "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{
              RowBox[{
              "v", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}], 
              " ", "=", " ", "vJ"}], ";"}], ",", " ", "\[IndentingNewLine]", 
            RowBox[{"(*", " ", "else", " ", "*)"}], "\[IndentingNewLine]", 
            RowBox[{"(*", " ", 
             RowBox[{"add", " ", 
              RowBox[{"parent", "'"}], "s", " ", "value"}], " ", "*)"}], 
            "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{
              RowBox[{
              "v", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}], 
              " ", "=", " ", 
              RowBox[{
               RowBox[{
                RowBox[{
                "XL", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}], 
                ".", 
                RowBox[{
                "v", "\[LeftDoubleBracket]", "p", "\[RightDoubleBracket]"}]}],
                " ", "+", " ", "vJ"}]}], ";"}]}], "\[IndentingNewLine]", 
           "]"}], ";", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{
           "hc", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}], "=", 
           
           RowBox[{
            RowBox[{
            "IC", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}], ".", 
            RowBox[{
            "v", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}]}]}], 
          ";", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{
           "KE", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}], "=", 
           
           RowBox[{
            RowBox[{"1", "/", "2"}], " ", 
            RowBox[{
             RowBox[{
             "v", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}], ".", 
             RowBox[{
             "hc", "\[LeftDoubleBracket]", "i", 
              "\[RightDoubleBracket]"}]}]}]}], ";"}], ",", " ", 
         "\[IndentingNewLine]", 
         RowBox[{"{", 
          RowBox[{"i", ",", " ", "nq"}], "}"}]}], "\[IndentingNewLine]", 
        "]"}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"Itot", " ", "=", " ", "Z6"}], ";", " ", 
       RowBox[{"(*", " ", 
        RowBox[{"rotational", " ", "inertia"}], " ", "*)"}], 
       "\[IndentingNewLine]", 
       RowBox[{"htot", " ", "=", " ", "z6"}], ";", " ", 
       RowBox[{"(*", " ", 
        RowBox[{"angular", " ", "and", " ", "linear", " ", "momentum"}], " ", 
        "*)"}], "\[IndentingNewLine]", 
       RowBox[{"Do", "[", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{
          RowBox[{"p", " ", "=", " ", 
           RowBox[{
           "parent", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}]}],
           ";", "\[IndentingNewLine]", 
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{"p", " ", "\[NotEqual]", " ", "0"}], ",", " ", 
            "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{
              RowBox[{
              "IC", "\[LeftDoubleBracket]", "p", "\[RightDoubleBracket]"}], 
              " ", "=", " ", 
              RowBox[{
               RowBox[{
               "IC", "\[LeftDoubleBracket]", "p", "\[RightDoubleBracket]"}], 
               " ", "+", " ", 
               RowBox[{
                RowBox[{
                 RowBox[{
                 "XL", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}],
                  "\[Transpose]"}], ".", 
                RowBox[{
                "IC", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}], 
                ".", 
                RowBox[{
                "XL", "\[LeftDoubleBracket]", "i", 
                 "\[RightDoubleBracket]"}]}]}]}], ";", "\[IndentingNewLine]", 
             
             RowBox[{
              RowBox[{
              "hc", "\[LeftDoubleBracket]", "p", "\[RightDoubleBracket]"}], 
              " ", "=", " ", 
              RowBox[{
               RowBox[{
               "hc", "\[LeftDoubleBracket]", "p", "\[RightDoubleBracket]"}], 
               " ", "+", " ", 
               RowBox[{
                RowBox[{
                 RowBox[{
                 "XL", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}],
                  "\[Transpose]"}], ".", 
                RowBox[{
                "hc", "\[LeftDoubleBracket]", "i", 
                 "\[RightDoubleBracket]"}]}]}]}], ";"}], ",", 
            "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{"Itot", "=", 
              RowBox[{"Itot", "+", 
               RowBox[{
                RowBox[{
                 RowBox[{
                 "XL", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}],
                  "\[Transpose]"}], ".", 
                RowBox[{
                "IC", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}], 
                ".", 
                RowBox[{
                "XL", "\[LeftDoubleBracket]", "i", 
                 "\[RightDoubleBracket]"}]}]}]}], ";", "\[IndentingNewLine]", 
             
             RowBox[{"htot", "=", 
              RowBox[{"htot", "+", 
               RowBox[{
                RowBox[{
                 RowBox[{
                 "XL", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}],
                  "\[Transpose]"}], ".", 
                RowBox[{
                "hc", "\[LeftDoubleBracket]", "i", 
                 "\[RightDoubleBracket]"}]}]}]}], ";"}]}], 
           "\[IndentingNewLine]", "]"}], ";"}], ",", "\[IndentingNewLine]", 
         RowBox[{"{", 
          RowBox[{"i", ",", " ", "nq", ",", " ", "1", ",", " ", 
           RowBox[{"-", "1"}]}], "}"}]}], "\[IndentingNewLine]", "]"}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"Itot", " ", "=", " ", 
        RowBox[{"mcI", "[", "Itot", "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"m", " ", "=", " ", 
        RowBox[{
        "Itot", "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}]}], ";",
        " ", 
       RowBox[{"(*", " ", 
        RowBox[{"total", " ", "mass"}], " ", "*)"}], "\[IndentingNewLine]", 
       RowBox[{"com", " ", "=", " ", 
        RowBox[{"Itot", "\[LeftDoubleBracket]", 
         RowBox[{"5", ";;", "7"}], "\[RightDoubleBracket]"}]}], ";", " ", 
       RowBox[{"(*", " ", 
        RowBox[{"center", " ", "of", " ", "mass"}], " ", "*)"}], 
       "\[IndentingNewLine]", 
       RowBox[{"vcom", " ", "=", " ", 
        RowBox[{
         RowBox[{"htot", "\[LeftDoubleBracket]", 
          RowBox[{"4", ";;", "6"}], "\[RightDoubleBracket]"}], "/", "m"}]}], 
       ";", " ", 
       RowBox[{"(*", " ", 
        RowBox[{"center", " ", "of", " ", "mass", " ", "velocity"}], " ", 
        "*)"}], "\[IndentingNewLine]", 
       RowBox[{"I", " ", "=", " ", 
        RowBox[{"Partition", "[", 
         RowBox[{
          RowBox[{"Itot", "\[LeftDoubleBracket]", 
           RowBox[{"8", ";;"}], "\[RightDoubleBracket]"}], ",", " ", "mm"}], 
         "]"}]}], ";", " ", 
       RowBox[{"(*", " ", 
        RowBox[{"rotational", " ", "inertia", " ", "about", " ", "com"}], " ",
         "*)"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"PE", " ", "=", " ", 
        RowBox[{"m", " ", 
         RowBox[{
          RowBox[{"ag", "\[LeftDoubleBracket]", 
           RowBox[{"4", ";;", "6"}], "\[RightDoubleBracket]"}], ".", 
          "com"}]}]}], ";", " ", 
       RowBox[{"(*", " ", 
        RowBox[{"total", " ", "potential", " ", "energy"}], " ", "*)"}], 
       "\[IndentingNewLine]", 
       RowBox[{"KE", " ", "=", " ", 
        RowBox[{"Total", "[", "KE", "]"}]}], ";", " ", 
       RowBox[{"(*", " ", 
        RowBox[{"total", " ", "kinetic", " ", "energy"}], " ", "*)"}], 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"{", 
        RowBox[{
        "KE", ",", " ", "PE", ",", " ", "htot", ",", " ", "m", ",", " ", "I", 
         ",", " ", "com", ",", " ", "vcom"}], "}"}]}]}], 
     "\[IndentingNewLine]", "]"}]}], ";"}]}]], "Input",
 InitializationCell->
  True,ExpressionUUID->"1fafaa9b-4bc3-4c29-befe-cc019135b184"]
}, Open  ]],

Cell[CellGroupData[{

Cell["End Package", \
"Section",ExpressionUUID->"274f91f7-44aa-4816-8235-9c83a6f3d606"],

Cell[BoxData[{
 RowBox[{"End", "[", "]"}], "\[IndentingNewLine]", 
 RowBox[{"EndPackage", "[", "]"}]}], "Input",
 InitializationCell->
  True,ExpressionUUID->"bacdc053-e0ee-40d3-8266-203bda83585a"]
}, Open  ]]
},
AutoGeneratedPackage->Automatic,
Evaluator->"Local",
WindowSize->{718, 718},
WindowMargins->{{Automatic, 0}, {Automatic, 240}},
PrivateNotebookOptions->{"FileOutlineCache"->False},
CellContext->"Global`",
TrackCellChangeTimes->False,
FrontEndVersion->"11.3 for Linux x86 (64-bit) (March 6, 2018)",
StyleDefinitions->"Default.nb"
]

