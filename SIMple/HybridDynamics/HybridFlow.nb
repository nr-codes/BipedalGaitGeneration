Notebook[{
Cell[BoxData[
 RowBox[{"(*", "\n", 
  RowBox[{
   RowBox[{"SimplestModel", ".", 
    RowBox[{"nb", ":", " ", 
     RowBox[{
     "An", " ", "implementation", " ", "of", " ", "various", " ", 
      "continuation", " ", 
      RowBox[{"methods", ".", "\n", "Copyright"}], " ", 
      RowBox[{"(", "C", ")"}], " ", "2017", " ", "Nelson", " ", "Rosa", " ", 
      RowBox[{"Jr", ".", "\n", "\n", "This"}], " ", "program", " ", "is", " ",
       "free", " ", "software"}], ":", " ", 
     RowBox[{"you", " ", "can", " ", "redistribute", " ", "it", " ", 
      RowBox[{"and", "/", "or"}], " ", "modify", "\n", "it", " ", "under", 
      " ", "the", " ", "terms", " ", "of", " ", "the", " ", "GNU", " ", 
      "General", " ", "Public", " ", "License", " ", "as", " ", "published", 
      " ", "by", "\n", 
      RowBox[{"the", " ", "Free", " ", "Software", " ", "Foundation"}]}]}]}], 
   ",", " ", 
   RowBox[{
   "either", " ", "version", " ", "3", " ", "of", " ", "the", " ", 
    "License"}], ",", " ", 
   RowBox[{"or", "\n", 
    RowBox[{"(", 
     RowBox[{"at", " ", "your", " ", "option"}], ")"}], " ", "any", " ", 
    "later", " ", 
    RowBox[{"version", ".", " ", "This"}], " ", "program", " ", "is", " ", 
    "distributed", " ", "in", " ", "the", " ", "\n", "hope", " ", "that", " ",
     "it", " ", "will", " ", "be", " ", "useful"}], ",", " ", 
   RowBox[{
    RowBox[{"but", " ", "WITHOUT", " ", "ANY", " ", "WARRANTY"}], ";", " ", 
    RowBox[{
    "without", " ", "even", " ", "the", " ", "\n", "implied", " ", "warranty",
      " ", "of", " ", "MERCHANTABILITY", " ", "or", " ", "FITNESS", " ", 
     "FOR", " ", "A", " ", "PARTICULAR", " ", 
     RowBox[{"PURPOSE", ".", "\n", "See"}], " ", "the", " ", "GNU", " ", 
     "General", " ", "Public", " ", "License", " ", "for", " ", "more", " ", 
     RowBox[{"details", ".", " ", "You"}], " ", "should", " ", "have", " ", 
     "\n", "received", " ", "a", " ", "copy", " ", "of", " ", "the", " ", 
     "GNU", " ", "General", " ", "Public", " ", "License", " ", "along", " ", 
     "with", " ", "this", " ", 
     RowBox[{"program", ".", "\n", "If"}], " ", "not"}]}], ",", " ", 
   RowBox[{
    RowBox[{"see", " ", "<", 
     RowBox[{"http", ":"}]}], "//", 
    RowBox[{
     RowBox[{
      RowBox[{
       RowBox[{"www", ".", "gnu", ".", "org"}], "/", "licenses"}], "/"}], ">",
      "."}]}]}], "\n", "*)"}]], "Code",
 InitializationCell->
  True,ExpressionUUID->"bdd16de3-b081-422d-bf19-ad04f5c7fa5b"],

Cell[CellGroupData[{

Cell["Begin Package", "Section",
 InitializationCell->
  True,ExpressionUUID->"ffc4eb86-334d-4138-9d93-a94ad2ffa2b2"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"BeginPackage", "[", 
   RowBox[{"\"\<HybridDynamics`\>\"", ",", " ", "\"\<GlobalVariables`\>\""}], 
   "]"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{"Begin", "[", "\"\<`Private`\>\"", "]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"rbd", " ", "=", " ", 
   RowBox[{"<|", "|>"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"e", " ", "=", " ", 
   RowBox[{"{", "}"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"o", " ", "=", " ", "0"}], ";"}]}], "Input",
 InitializationCell->
  True,ExpressionUUID->"dd4cc13e-61c0-4bd2-9d55-ae41946e57b7"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Switching Events", \
"Section",ExpressionUUID->"1988e040-07fb-4905-8e13-34fc6839c894"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"SetAttributes", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"DefaultSwitchingEvent", ",", " ", "AddSwitchingEvent"}], "}"}],
      ",", " ", "HoldFirst"}], "]"}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"Options", "[", "DefaultSwitchingEvent", "]"}], " ", "=", " ", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"\"\<i\>\"", " ", "\[Rule]", " ", 
       RowBox[{"2", ";;", 
        RowBox[{"-", "2"}]}]}], ",", " ", 
      RowBox[{"\"\<p\>\"", " ", "\[Rule]", " ", 
       RowBox[{"{", "}"}]}], ",", " ", 
      RowBox[{"\"\<a\>\"", " ", "\[Rule]", " ", 
       RowBox[{"{", "}"}]}], ",", " ", 
      RowBox[{"WhenEvent", " ", "\[Rule]", " ", 
       RowBox[{"{", "}"}]}], ",", " ", 
      RowBox[{"\"\<DT\>\"", " ", "\[Rule]", " ", "0"}]}], "}"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"Events", "[", 
     RowBox[{"k_:", "0"}], "]"}], " ", ":=", " ", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{
       RowBox[{"\[DoubleStruckX]", "[", "\[DoubleStruckT]", "]"}], " ", 
       "\[Rule]", " ", 
       RowBox[{"TF", "[", 
        RowBox[{
         RowBox[{"\[DoubleStruckM]", "[", "\[DoubleStruckT]", "]"}], ",", " ", 
         RowBox[{"\[DoubleStruckX]", "[", "\[DoubleStruckT]", "]"}], ",", " ", 
         RowBox[{"\[DoubleStruckC]", "[", "\[DoubleStruckT]", "]"}], ",", " ",
          "k"}], "]"}]}], ",", " ", 
      RowBox[{
       RowBox[{"\[DoubleStruckM]", "[", "\[DoubleStruckT]", "]"}], " ", 
       "\[Rule]", " ", 
       RowBox[{"m", "[", 
        RowBox[{
         RowBox[{"\[DoubleStruckM]", "[", "\[DoubleStruckT]", "]"}], ",", " ", 
         RowBox[{"\[DoubleStruckX]", "[", "\[DoubleStruckT]", "]"}], ",", " ", 
         RowBox[{"\[DoubleStruckC]", "[", "\[DoubleStruckT]", "]"}]}], 
        "]"}]}], ",", " ", 
      RowBox[{
       RowBox[{"\[DoubleStruckX]", "[", "\[DoubleStruckT]", "]"}], " ", 
       "\[Rule]", " ", 
       RowBox[{"h", "[", 
        RowBox[{
         RowBox[{"\[DoubleStruckM]", "[", "\[DoubleStruckT]", "]"}], ",", " ", 
         RowBox[{"\[DoubleStruckX]", "[", "\[DoubleStruckT]", "]"}], ",", " ", 
         RowBox[{"\[DoubleStruckC]", "[", "\[DoubleStruckT]", "]"}]}], 
        "]"}]}], ",", " ", 
      RowBox[{
       RowBox[{"\[DoubleStruckC]", "[", "\[DoubleStruckT]", "]"}], " ", 
       "\[Rule]", " ", 
       RowBox[{"d", "[", 
        RowBox[{
         RowBox[{"\[DoubleStruckM]", "[", "\[DoubleStruckT]", "]"}], ",", " ", 
         RowBox[{"\[DoubleStruckX]", "[", "\[DoubleStruckT]", "]"}], ",", " ", 
         RowBox[{"\[DoubleStruckC]", "[", "\[DoubleStruckT]", "]"}]}], 
        "]"}]}], ",", " ", 
      RowBox[{
       RowBox[{"\[DoubleStruckX]", "[", "\[DoubleStruckT]", "]"}], " ", 
       "\[Rule]", " ", 
       RowBox[{"T0", "[", 
        RowBox[{
         RowBox[{"\[DoubleStruckM]", "[", "\[DoubleStruckT]", "]"}], ",", " ", 
         RowBox[{"\[DoubleStruckX]", "[", "\[DoubleStruckT]", "]"}], ",", " ", 
         RowBox[{"\[DoubleStruckC]", "[", "\[DoubleStruckT]", "]"}], ",", " ",
          "k"}], "]"}]}]}], "}"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"DefaultSwitchingEvent", "[", 
     RowBox[{"evnt_", ",", " ", 
      RowBox[{"opts", ":", 
       RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], " ", ":=", " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", "a", "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"a", " ", "=", " ", 
        RowBox[{"Events", "[", 
         RowBox[{"OptionValue", "[", "\"\<DT\>\"", "]"}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"a", " ", "=", " ", 
        RowBox[{"Join", "[", 
         RowBox[{
          RowBox[{"OptionValue", "[", "\"\<p\>\"", "]"}], ",", " ", 
          RowBox[{"a", "\[LeftDoubleBracket]", 
           RowBox[{"OptionValue", "[", "\"\<i\>\"", "]"}], 
           "\[RightDoubleBracket]"}], ",", " ", 
          RowBox[{"OptionValue", "[", "\"\<a\>\"", "]"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"With", "[", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"e", " ", "=", " ", "a"}], ",", " ", 
           RowBox[{"o", " ", "=", " ", 
            RowBox[{"OptionValue", "[", "WhenEvent", "]"}]}]}], "}"}], ",", 
         " ", 
         RowBox[{"WhenEvent", "[", 
          RowBox[{"evnt", ",", " ", "e", ",", " ", "o"}], "]"}]}], "]"}]}]}], 
     "\[IndentingNewLine]", "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"AddSwitchingTimeEvents", "[", 
     RowBox[{"T_", ",", " ", 
      RowBox[{"DT_:", "Automatic"}], ",", " ", 
      RowBox[{"opts", ":", 
       RowBox[{"OptionsPattern", "[", "DefaultSwitchingEvent", "]"}]}]}], 
     "]"}], " ", ":=", " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "t0", ",", " ", "tf", ",", " ", "p", ",", " ", "a", ",", " ", "k", ",",
         " ", "n"}], "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
        RowBox[{
        "T", " ", "contains", " ", "indices", " ", "in", " ", 
         "\[DoubleStruckC]"}], ",", " ", 
        RowBox[{"with", " ", 
         RowBox[{
         "\[DoubleStruckC]", "\[LeftDoubleBracket]", "i", 
          "\[RightDoubleBracket]"}], " ", "being", " ", "absolute", " ", 
         "time", " ", "from", " ", "t0", " ", 
         RowBox[{
          RowBox[{"(", 
           RowBox[{"=", " ", "0"}], ")"}], "."}]}]}], " ", "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
        RowBox[{
        "assumes", " ", "T", " ", "is", " ", "in", " ", "ascending", " ", 
         "order", " ", "0"}], " ", "<=", " ", 
        RowBox[{"T", "[", "i", "]"}], " ", "<=", " ", 
        RowBox[{"T", "[", 
         RowBox[{"i", "+", "1"}], "]"}]}], " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"n", " ", "=", " ", 
        RowBox[{"Length", "@", "T"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"Table", "[", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{
          RowBox[{"k", " ", "=", " ", 
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"VectorQ", "[", "DT", "]"}], " ", "&&", " ", 
              RowBox[{"DT", " ", "=!=", " ", 
               RowBox[{"{", "}"}]}]}], ",", " ", 
             RowBox[{
             "DT", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}], 
             ",", " ", "0"}], "]"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"(*", " ", 
           RowBox[{
           "final", " ", "switching", " ", "time", " ", "derivative"}], " ", 
           "*)"}], "\[IndentingNewLine]", 
          RowBox[{"tf", " ", "=", " ", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"\[DoubleStruckX]", "[", "\[DoubleStruckT]", "]"}], " ", 
             "\[Rule]", " ", 
             RowBox[{"TF", "[", 
              RowBox[{
               RowBox[{"\[DoubleStruckM]", "[", "\[DoubleStruckT]", "]"}], 
               ",", " ", 
               RowBox[{"\[DoubleStruckX]", "[", "\[DoubleStruckT]", "]"}], 
               ",", " ", 
               RowBox[{"\[DoubleStruckC]", "[", "\[DoubleStruckT]", "]"}], 
               ",", " ", "k"}], "]"}]}], "}"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"p", " ", "=", " ", 
           RowBox[{"\"\<p\>\"", " ", "\[Rule]", " ", "tf"}]}], ";", 
          "\[IndentingNewLine]", "\[IndentingNewLine]", 
          RowBox[{"(*", " ", 
           RowBox[{
           "start", " ", "switching", " ", "time", " ", "derivative"}], " ", 
           "*)"}], "\[IndentingNewLine]", 
          RowBox[{"t0", " ", "=", " ", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"\[DoubleStruckX]", "[", "\[DoubleStruckT]", "]"}], " ", 
             "\[Rule]", " ", 
             RowBox[{"T0", "[", 
              RowBox[{
               RowBox[{"\[DoubleStruckM]", "[", "\[DoubleStruckT]", "]"}], 
               ",", " ", 
               RowBox[{"\[DoubleStruckX]", "[", "\[DoubleStruckT]", "]"}], 
               ",", " ", 
               RowBox[{"\[DoubleStruckC]", "[", "\[DoubleStruckT]", "]"}], 
               ",", " ", "k"}], "]"}]}], "}"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"a", " ", "=", " ", 
           RowBox[{"\"\<a\>\"", " ", "\[Rule]", " ", 
            RowBox[{"Append", "[", 
             RowBox[{
              RowBox[{"If", "[", 
               RowBox[{
                RowBox[{"i", " ", "<", " ", "n"}], ",", " ", "t0", ",", " ", 
                RowBox[{"{", "}"}]}], "]"}], ",", " ", 
              "\"\<RemoveEvent\>\""}], "]"}]}]}], ";", "\[IndentingNewLine]", 
          "\[IndentingNewLine]", 
          RowBox[{"(*", " ", 
           RowBox[{"final", " ", "switching", " ", 
            RowBox[{"time", "?"}]}], " ", "*)"}], "\[IndentingNewLine]", 
          RowBox[{"k", " ", "=", " ", 
           RowBox[{"\"\<i\>\"", " ", "\[Rule]", " ", 
            RowBox[{"If", "[", 
             RowBox[{
              RowBox[{"i", " ", "<", " ", "n"}], ",", " ", 
              RowBox[{"OptionValue", "[", 
               RowBox[{"DefaultSwitchingEvent", ",", " ", "\"\<i\>\""}], 
               "]"}], ",", " ", 
              RowBox[{"{", "}"}]}], "]"}]}]}], ";", "\[IndentingNewLine]", 
          "\[IndentingNewLine]", 
          RowBox[{"(*", " ", 
           RowBox[{"create", " ", "event"}], " ", "*)"}], 
          "\[IndentingNewLine]", 
          RowBox[{"k", " ", "=", " ", 
           RowBox[{"With", "[", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"j", " ", "=", " ", 
               RowBox[{
               "T", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}]}], 
              "}"}], ",", " ", 
             RowBox[{"DefaultSwitchingEvent", "[", 
              RowBox[{
               RowBox[{
                RowBox[{"\[DoubleStruckT]", " ", "-", " ", "j"}], " ", 
                "\[Equal]", " ", "0"}], ",", " ", "p", ",", " ", "a", ",", 
               " ", "k", ",", " ", 
               RowBox[{"WhenEvent", " ", "\[Rule]", " ", 
                RowBox[{"Join", "[", 
                 RowBox[{
                  RowBox[{"{", 
                   RowBox[{"\"\<Priority\>\"", " ", "\[Rule]", " ", "i"}], 
                   "}"}], ",", " ", 
                  RowBox[{"OptionValue", "@", "WhenEvent"}]}], "]"}]}], ",", 
               " ", "opts"}], "]"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
          "\[IndentingNewLine]", 
          RowBox[{"(*", " ", 
           RowBox[{
           "allow", " ", "for", " ", "parameters", " ", "in", " ", "T"}], " ",
            "*)"}], "\[IndentingNewLine]", 
          RowBox[{"k", " ", "/.", " ", 
           RowBox[{
            RowBox[{"\[DoubleStruckC]", "[", "k_Integer", "]"}], " ", 
            "\[RuleDelayed]", " ", 
            RowBox[{
            "\[DoubleStruckC]", "\[LeftDoubleBracket]", "k", 
             "\[RightDoubleBracket]"}]}]}]}], ",", "\[IndentingNewLine]", 
         RowBox[{"{", 
          RowBox[{"i", ",", " ", "n"}], "}"}]}], "\[IndentingNewLine]", 
        "]"}]}]}], "\[IndentingNewLine]", "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"AddSwitchingEvent", "[", 
     RowBox[{"evnt_", ",", " ", 
      RowBox[{"opts", ":", 
       RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], " ", ":=", " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", "a", "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"a", " ", "=", 
        RowBox[{"DefaultSwitchingEvent", "[", 
         RowBox[{"evnt", ",", " ", "opts"}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"Last", "@", 
        RowBox[{"AppendTo", "[", 
         RowBox[{"e", ",", " ", "a"}], "]"}]}]}]}], "\[IndentingNewLine]", 
     "]"}]}], ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"RemoveSwitchingEvent", "[", 
    RowBox[{"form_:", 
     RowBox[{"(", "_WhenEvent", ")"}]}], "]"}], " ", ":=", " ", 
   RowBox[{"e", " ", "=", " ", 
    RowBox[{"DeleteCases", "[", 
     RowBox[{"e", ",", " ", "form"}], "]"}]}]}], ";"}]}], "Input",
 InitializationCell->
  True,ExpressionUUID->"e0cbfc26-509b-46bf-ae25-902f54cf266a"]
}, Open  ]],

Cell["Dimensions of Various Spaces", \
"Section",ExpressionUUID->"9f876c75-bac9-4ecd-9a73-e270e67afed2"],

Cell[CellGroupData[{

Cell["Hybrid Dynamics (flow: swing + impact)", \
"Section",ExpressionUUID->"143a6573-fe08-4752-9b2c-2b1d44fde21c"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"rkopts", "[", 
    RowBox[{"b_", ",", " ", "T_", ",", " ", "n_"}], "]"}], " ", ":=", " ", 
   RowBox[{"If", "[", 
    RowBox[{
     RowBox[{"n", " ", ">", " ", "0"}], ",", " ", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"MaxStepFraction", "\[Rule]", "Infinity"}], ",", " ", 
       RowBox[{"Method", "\[Rule]", " ", 
        RowBox[{"{", 
         RowBox[{"\"\<FixedStep\>\"", ",", " ", 
          RowBox[{"\"\<StepSize\>\"", " ", "\[Rule]", " ", 
           RowBox[{"T", "/", "n"}]}], ",", "\[IndentingNewLine]", 
          RowBox[{"Method", "\[Rule]", 
           RowBox[{"{", 
            RowBox[{"RKODE", ",", " ", 
             RowBox[{"\"\<b\>\"", " ", "\[Rule]", " ", "b"}]}], "}"}]}]}], 
         "}"}]}]}], "}"}], ",", " ", 
     RowBox[{"{", "}"}]}], "]"}]}], ";"}]], "Input",
 InitializationCell->
  True,ExpressionUUID->"3a23196e-617d-4f6b-90f9-cf0b99b2aeaa"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"devec", "[", "\"\<o\>\"", "]"}], " ", ":=", " ", "o"}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"devec", "[", 
     RowBox[{"d_", ",", " ", "n_"}], "]"}], " ", ":=", " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "m", ",", " ", "N", ",", " ", "x", ",", " ", "dx", ",", " ", "ddx"}], 
       "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"N", " ", "=", " ", 
        RowBox[{
         RowBox[{"Length", "[", "d", "]"}], "/", "n"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"m", " ", "=", " ", 
        RowBox[{"Switch", "[", 
         RowBox[{"o", ",", " ", "0", ",", " ", "0", ",", " ", "1", ",", " ", 
          RowBox[{"N", "-", "1"}], ",", " ", "2", ",", " ", 
          RowBox[{
           RowBox[{"(", 
            RowBox[{
             RowBox[{"-", "1"}], "+", 
             RowBox[{"Sqrt", "[", 
              RowBox[{"1", "-", 
               RowBox[{"4", 
                RowBox[{"(", 
                 RowBox[{"1", "-", "N"}], ")"}]}]}], "]"}]}], ")"}], "/", 
           "2"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"o", " ", "\[GreaterEqual]", " ", "0"}], ",", " ", 
         RowBox[{
          RowBox[{"x", " ", "=", " ", 
           RowBox[{"d", "\[LeftDoubleBracket]", 
            RowBox[{"1", ";;", "n"}], "\[RightDoubleBracket]"}]}], ";"}]}], 
        "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"o", " ", "\[GreaterEqual]", " ", "1"}], ",", " ", 
         RowBox[{
          RowBox[{"dx", " ", "=", " ", 
           RowBox[{"ArrayReshape", "[", 
            RowBox[{
             RowBox[{"d", "\[LeftDoubleBracket]", 
              RowBox[{
               RowBox[{"n", "+", "1"}], ";;", 
               RowBox[{"n", " ", 
                RowBox[{"(", 
                 RowBox[{"m", "+", "1"}], ")"}]}]}], 
              "\[RightDoubleBracket]"}], ",", " ", 
             RowBox[{"{", 
              RowBox[{"n", ",", " ", "m"}], "}"}]}], "]"}]}], ";"}]}], "]"}], 
       ";", "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"o", " ", "\[GreaterEqual]", " ", "2"}], ",", " ", 
         RowBox[{
          RowBox[{"ddx", " ", "=", " ", 
           RowBox[{"ArrayReshape", "[", 
            RowBox[{
             RowBox[{"d", "\[LeftDoubleBracket]", 
              RowBox[{
               RowBox[{
                RowBox[{"n", " ", 
                 RowBox[{"(", 
                  RowBox[{"m", "+", "1"}], ")"}]}], "+", "1"}], ";;", 
               RowBox[{"n", 
                RowBox[{"(", 
                 RowBox[{
                  RowBox[{"m", "^", "2"}], "+", "m", "+", "1"}], ")"}]}]}], 
              "\[RightDoubleBracket]"}], ",", " ", 
             RowBox[{"{", 
              RowBox[{"n", ",", " ", "m", ",", " ", "m"}], "}"}]}], "]"}]}], 
          ";"}]}], "]"}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"x", ",", "dx", ",", "ddx"}], "}"}], "\[LeftDoubleBracket]", 
        RowBox[{"1", ";;", 
         RowBox[{"o", "+", "1"}]}], "\[RightDoubleBracket]"}]}]}], 
     "\[IndentingNewLine]", "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"devecF", "[", 
    RowBox[{"f_", ",", " ", "v_"}], "]"}], " ", ":=", " ", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "n", ",", " ", "F", ",", " ", "r", ",", " ", "d", ",", " ", "p"}], 
      "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"n", " ", "=", " ", 
       RowBox[{"Length", "@", "f"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"d", " ", "=", " ", 
       RowBox[{"Table", "[", 
        RowBox[{
         RowBox[{"p", "[", 
          RowBox[{
           RowBox[{"Slot", "[", "i", "]"}], ",", " ", "j"}], "]"}], ",", " ", 
         RowBox[{"{", 
          RowBox[{"i", ",", " ", 
           RowBox[{"Length", "@", "v"}]}], "}"}], ",", " ", 
         RowBox[{"{", 
          RowBox[{"j", ",", " ", "n"}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"r", " ", "=", " ", 
       RowBox[{
        RowBox[{"With", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"a", " ", "=", " ", 
            RowBox[{"Sequence", "@@", 
             RowBox[{"Flatten", "@", 
              RowBox[{"d", "\[LeftDoubleBracket]", 
               RowBox[{"All", ",", " ", 
                RowBox[{"1", ";;", 
                 RowBox[{
                 "#2", "\[LeftDoubleBracket]", "1", 
                  "\[RightDoubleBracket]"}]}]}], 
               "\[RightDoubleBracket]"}]}]}]}], "}"}], ",", " ", 
          RowBox[{
           RowBox[{"Hold", "[", "#1", "]"}], "[", "a", "]"}]}], "]"}], 
        "&"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"F", " ", "=", " ", 
       RowBox[{"MapIndexed", "[", 
        RowBox[{"r", ",", " ", "f"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{
        RowBox[{"With", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"a", " ", "=", " ", "F"}], "}"}], ",", " ", 
          RowBox[{"a", "&"}]}], "]"}], " ", "/.", " ", 
        RowBox[{
         RowBox[{"Hold", "[", "a_", "]"}], " ", "\[RuleDelayed]", " ", 
         "a"}]}], " ", "/.", " ", 
       RowBox[{"p", " ", "\[Rule]", " ", "Part"}]}]}]}], 
    "\[IndentingNewLine]", "]"}]}], ";"}]}], "Input",
 InitializationCell->
  True,ExpressionUUID->"6d2bc991-0286-490b-aed3-a34a338de089"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"m", "[", 
     RowBox[{"m_", ",", " ", 
      RowBox[{"x_", "?", "VectorQ"}], ",", " ", 
      RowBox[{"c_", "?", "VectorQ"}]}], "]"}], " ", ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"X", ",", " ", "C"}], "}"}], ",", " ", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"X", " ", "=", " ", 
        RowBox[{"devec", "[", 
         RowBox[{"x", ",", " ", "nx"}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"C", " ", "=", " ", 
        RowBox[{"devec", "[", 
         RowBox[{"c", ",", " ", "nc"}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"Sow", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"rbd", "[", 
           RowBox[{"\"\<m\>\"", ",", " ", "m"}], "]"}], "[", 
          RowBox[{"X", ",", " ", "C"}], "]"}], ",", " ", "\"\<m\>\""}], 
        "]"}]}]}], "\[IndentingNewLine]", "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"f", "[", 
     RowBox[{"m_", ",", " ", 
      RowBox[{"x_", "?", "VectorQ"}], ",", " ", 
      RowBox[{"c_", "?", "VectorQ"}]}], "]"}], " ", ":=", " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"X", ",", " ", "C"}], "}"}], ",", " ", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"X", " ", "=", " ", 
        RowBox[{"devec", "[", 
         RowBox[{"x", ",", " ", "nx"}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"C", " ", "=", " ", 
        RowBox[{"devec", "[", 
         RowBox[{"c", ",", " ", "nc"}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"rbd", "[", 
         RowBox[{"\"\<f\>\"", ",", " ", "m"}], "]"}], "[", 
        RowBox[{"X", ",", " ", "C"}], "]"}]}]}], "\[IndentingNewLine]", 
     "]"}]}], ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"h", "[", 
     RowBox[{"m_", ",", " ", 
      RowBox[{"x_", "?", "VectorQ"}], ",", " ", 
      RowBox[{"c_", "?", "VectorQ"}]}], "]"}], " ", ":=", " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"X", ",", " ", "C"}], "}"}], ",", " ", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"X", " ", "=", " ", 
        RowBox[{"devec", "[", 
         RowBox[{"x", ",", " ", "nx"}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"C", " ", "=", " ", 
        RowBox[{"devec", "[", 
         RowBox[{"c", ",", " ", "nc"}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"rbd", "[", 
         RowBox[{"\"\<h\>\"", ",", " ", "m"}], "]"}], "[", 
        RowBox[{"X", ",", " ", "C"}], "]"}]}]}], "\[IndentingNewLine]", 
     "]"}]}], ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"d", "[", 
     RowBox[{"m_", ",", " ", 
      RowBox[{"x_", "?", "VectorQ"}], ",", " ", 
      RowBox[{"c_", "?", "VectorQ"}]}], "]"}], " ", ":=", " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"X", ",", " ", "C"}], "}"}], ",", " ", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"X", " ", "=", " ", 
        RowBox[{"devec", "[", 
         RowBox[{"x", ",", " ", "nx"}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"C", " ", "=", " ", 
        RowBox[{"devec", "[", 
         RowBox[{"c", ",", " ", "nc"}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"Sow", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"rbd", "[", 
           RowBox[{"\"\<d\>\"", ",", " ", "m"}], "]"}], "[", 
          RowBox[{"X", ",", " ", "C"}], "]"}], ",", " ", "\"\<c\>\""}], 
        "]"}]}]}], "\[IndentingNewLine]", "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"T0", "[", 
     RowBox[{"m_", ",", " ", 
      RowBox[{"x_", "?", "VectorQ"}], ",", " ", 
      RowBox[{"c_", "?", "VectorQ"}], ",", " ", "i_Integer"}], "]"}], " ", ":=",
     " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"X", ",", " ", "C"}], "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"X", " ", "=", " ", 
        RowBox[{"devec", "[", 
         RowBox[{"x", ",", " ", "nx"}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"C", " ", "=", " ", 
        RowBox[{"devec", "[", 
         RowBox[{"c", ",", " ", "nc"}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"Sow", "[", 
        RowBox[{
         RowBox[{"DT0", "[", 
          RowBox[{"m", ",", " ", "X", ",", " ", "C", ",", " ", "i"}], "]"}], 
         ",", " ", "\"\<x+\>\""}], "]"}]}]}], "\[IndentingNewLine]", "]"}]}], 
   ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"TF", "[", 
    RowBox[{"m_", ",", " ", 
     RowBox[{"x_", "?", "VectorQ"}], ",", " ", 
     RowBox[{"c_", "?", "VectorQ"}], ",", " ", "i_Integer"}], "]"}], " ", ":=",
    " ", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"X", ",", " ", "C"}], "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"X", " ", "=", " ", 
       RowBox[{"devec", "[", 
        RowBox[{"x", ",", " ", "nx"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"C", " ", "=", " ", 
       RowBox[{"devec", "[", 
        RowBox[{"c", ",", " ", "nc"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"Sow", "[", 
       RowBox[{
        RowBox[{"DTF", "[", 
         RowBox[{"m", ",", " ", "X", ",", " ", "C", ",", " ", "i"}], "]"}], 
        ",", " ", "\"\<x-\>\""}], "]"}]}]}], "\[IndentingNewLine]", "]"}]}], 
  ";"}]}], "Input",
 InitializationCell->
  True,ExpressionUUID->"a9c41381-4ad2-4efb-99b5-5620c7f44bf5"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"Options", "[", "\[CurlyPhi]", "]"}], " ", "=", " ", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"\"\<e\>\"", " ", "\[Rule]", " ", 
       RowBox[{"{", "}"}]}], ",", " ", 
      RowBox[{"\"\<n\>\"", " ", "\[Rule]", " ", "0"}], ",", " ", 
      RowBox[{"\"\<b\>\"", " ", "\[Rule]", " ", 
       RowBox[{"{", "}"}]}], ",", " ", 
      RowBox[{"NDSolve", " ", "\[Rule]", " ", 
       RowBox[{"{", "}"}]}], ",", " ", 
      RowBox[{"\"\<t0\>\"", " ", "\[Rule]", " ", "$MachineEpsilon"}], ",", 
      " ", 
      RowBox[{"\"\<tf\>\"", " ", "\[Rule]", " ", "$MachineEpsilon"}]}], 
     "}"}]}], ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"\[CurlyPhi]", "[", 
     RowBox[{"RBD_Association", ",", " ", "ord_"}], "]"}], " ", ":=", " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"o", " ", "=", " ", "ord"}], ";", "\[IndentingNewLine]", 
       RowBox[{"rbd", " ", "=", " ", "RBD"}], ";"}]}], "\[IndentingNewLine]", 
     "]"}]}], ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"\[CurlyPhi]", "[", 
    RowBox[{"m_", ",", " ", "x_", ",", " ", "c_", ",", " ", "T_", ",", " ", 
     RowBox[{"opts", ":", 
      RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], " ", ":=", " ", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"eqn", ",", " ", "o", ",", " ", "t0", ",", " ", "tf"}], "}"}], 
     ",", "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{"set", " ", "time", " ", "interval"}], " ", "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{
       RowBox[{"{", 
        RowBox[{"t0", ",", " ", "tf"}], "}"}], " ", "=", " ", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"VectorQ", "[", "T", "]"}], ",", " ", 
         RowBox[{"T", "\[LeftDoubleBracket]", 
          RowBox[{"{", 
           RowBox[{"1", ",", " ", 
            RowBox[{"-", "1"}]}], "}"}], "\[RightDoubleBracket]"}], ",", " ", 
         RowBox[{"{", 
          RowBox[{"0", ",", " ", "T"}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
        RowBox[{"MMA", " ", "cannot", " ", "detect", " ", 
         RowBox[{"events", " ", "@", " ", "end"}], " ", "points"}], ",", " ", 
        RowBox[{
        "push", " ", "start", " ", "and", " ", "end", " ", "times", " ", "a", 
         " ", "little"}]}], " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{"t0", " ", "-=", " ", 
       RowBox[{"OptionValue", "[", "\"\<t0\>\"", "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"tf", " ", "+=", " ", 
       RowBox[{"OptionValue", "[", "\"\<tf\>\"", "]"}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"Block", "[", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{
         "\[DoubleStruckX]", ",", " ", "\[DoubleStruckC]", ",", " ", 
          "\[DoubleStruckT]", ",", " ", "\[DoubleStruckM]"}], "}"}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{"(*", " ", 
         RowBox[{
          RowBox[{"eqns", " ", "&"}], " ", "events"}], " ", "*)"}], 
        "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"eqn", " ", "=", " ", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{
             RowBox[{"\[DoubleStruckX]", "'"}], "[", "\[DoubleStruckT]", 
             "]"}], " ", "\[Equal]", " ", 
            RowBox[{"f", "[", 
             RowBox[{
              RowBox[{"\[DoubleStruckM]", "[", "\[DoubleStruckT]", "]"}], ",",
               " ", 
              RowBox[{"\[DoubleStruckX]", "[", "\[DoubleStruckT]", "]"}], ",",
               " ", 
              RowBox[{"\[DoubleStruckC]", "[", "\[DoubleStruckT]", "]"}]}], 
             "]"}]}], "}"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"eqn", " ", "=", " ", 
          RowBox[{"Join", "[", 
           RowBox[{"eqn", ",", " ", 
            RowBox[{"{", 
             RowBox[{
              RowBox[{
               RowBox[{"\[DoubleStruckX]", "[", "t0", "]"}], " ", "\[Equal]", 
               " ", "x"}], ",", " ", 
              RowBox[{
               RowBox[{"\[DoubleStruckC]", "[", "t0", "]"}], " ", "\[Equal]", 
               " ", "c"}], ",", " ", 
              RowBox[{
               RowBox[{"\[DoubleStruckM]", "[", "t0", "]"}], " ", "\[Equal]", 
               " ", "m"}]}], "}"}], ",", " ", "e", ",", " ", 
            RowBox[{"OptionValue", "[", "\"\<e\>\"", "]"}]}], "]"}]}], ";", 
         "\[IndentingNewLine]", "\[IndentingNewLine]", 
         RowBox[{"(*", " ", 
          RowBox[{"get", " ", 
           RowBox[{"options", ":", " ", 
            RowBox[{"fixed", " ", "step", " ", 
             RowBox[{"size", "?", " ", "NDSolve"}], " ", "opts"}]}]}], " ", 
          "*)"}], "\[IndentingNewLine]", 
         RowBox[{"o", " ", "=", " ", 
          RowBox[{"rkopts", "[", 
           RowBox[{
            RowBox[{"OptionValue", "[", "\"\<b\>\"", "]"}], ",", " ", 
            RowBox[{"tf", "-", "t0"}], ",", " ", 
            RowBox[{"OptionValue", "[", "\"\<n\>\"", "]"}]}], "]"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"o", " ", "=", " ", 
          RowBox[{"Flatten", "@", 
           RowBox[{"{", 
            RowBox[{"o", ",", " ", 
             RowBox[{"OptionValue", "[", "NDSolve", "]"}]}], "}"}]}]}], ";", 
         "\[IndentingNewLine]", "\[IndentingNewLine]", 
         RowBox[{"(*", " ", 
          RowBox[{"solve", " ", "ODE"}], " ", "*)"}], "\[IndentingNewLine]", 
         RowBox[{"o", " ", "=", " ", 
          RowBox[{"Reap", "[", 
           RowBox[{
            RowBox[{
             RowBox[{"Sow", "[", 
              RowBox[{"m", ",", " ", "\"\<m\>\""}], "]"}], ";", 
             RowBox[{"Sow", "[", 
              RowBox[{"c", ",", " ", "\"\<c\>\""}], "]"}], ";", 
             RowBox[{"Sow", "[", 
              RowBox[{"x", ",", " ", "\"\<x-\>\""}], "]"}], ";", 
             RowBox[{"Sow", "[", 
              RowBox[{"x", ",", " ", "\"\<x+\>\""}], "]"}], ";", 
             "\[IndentingNewLine]", 
             RowBox[{"NDSolveValue", "[", 
              RowBox[{"eqn", ",", " ", 
               RowBox[{"{", 
                RowBox[{
                "\[DoubleStruckX]", ",", " ", "\[DoubleStruckC]", ",", " ", 
                 "\[DoubleStruckM]"}], "}"}], ",", " ", 
               RowBox[{"{", 
                RowBox[{"\[DoubleStruckT]", ",", " ", "t0", ",", " ", "tf"}], 
                "}"}], ",", " ", 
               RowBox[{"DiscreteVariables", "\[Rule]", " ", 
                RowBox[{"{", 
                 RowBox[{"\[DoubleStruckC]", ",", " ", 
                  RowBox[{"\[DoubleStruckM]", " ", "\[Element]", " ", 
                   RowBox[{"Keys", "@", 
                    RowBox[{"rbd", "[", "\"\<m\>\"", "]"}]}]}]}], "}"}]}], 
               ",", " ", "o"}], "]"}]}], ",", " ", "_", ",", " ", "Rule"}], 
           "]"}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
         RowBox[{"(*", " ", 
          RowBox[{"return", " ", "trajectories", " ", "and", " ", "events"}], 
          " ", "*)"}], "\[IndentingNewLine]", 
         RowBox[{"<|", 
          RowBox[{
           RowBox[{"Thread", "[", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{
              "\"\<x[t]\>\"", ",", " ", "\"\<c[t]\>\"", ",", " ", 
               "\"\<m[t]\>\""}], "}"}], " ", "\[Rule]", " ", 
             RowBox[{
             "o", "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}]}], 
            "]"}], ",", " ", 
           RowBox[{"Rest", "@", "o"}], ",", " ", 
           RowBox[{"\"\<T\>\"", " ", "\[Rule]", " ", "T"}]}], "|>"}]}]}], 
       "\[IndentingNewLine]", "]"}]}]}], "\[IndentingNewLine]", "]"}]}], 
  ";"}]}], "Input",
 InitializationCell->
  True,ExpressionUUID->"96a8e446-5f1d-46af-abde-096e8c874348"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Functions for Computing Derivatives", \
"Section",ExpressionUUID->"2d1a2e80-54a3-4d7e-853c-fe5facd59987"],

Cell["\<\
should switch to T being dT/dc to make general.  Need to then do z[[2]] -= \
Outer[F, T], for example.\
\>", "Text",ExpressionUUID->"12ec3884-4b82-4df5-ac46-6d6636eef341"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"DT0", "[", 
     RowBox[{"m_", ",", " ", "x_", ",", " ", "c_", ",", " ", "T_"}], "]"}], 
    " ", ":=", " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"z", ",", " ", "F"}], "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
        RowBox[{"T", " ", 
         RowBox[{"(", 
          RowBox[{"an", " ", "index"}], ")"}]}], " ", "=", 
        RowBox[{
         RowBox[{">", " ", 
          RowBox[{
          "switching", " ", "time", " ", "derivatives", " ", "at", " ", 
           "s"}]}], " ", "=", " ", "t0"}]}], " ", "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"z", " ", "=", " ", "x"}], ";", "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"o", " ", "\[GreaterEqual]", " ", "1"}], " ", "&&", " ", 
          RowBox[{"T", " ", "\[NotEqual]", "  ", "0"}]}], ",", 
         "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"F", " ", "=", " ", 
           RowBox[{
            RowBox[{"devec", "[", 
             RowBox[{
              RowBox[{
               RowBox[{"rbd", "[", 
                RowBox[{"\"\<f\>\"", ",", " ", "m"}], "]"}], "[", 
               RowBox[{"z", ",", " ", "c"}], "]"}], ",", " ", "nx"}], "]"}], 
            "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}]}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"z", "\[LeftDoubleBracket]", 
            RowBox[{"2", ",", " ", "All", ",", " ", "T"}], 
            "\[RightDoubleBracket]"}], " ", "-=", " ", "F"}], ";", 
          "\[IndentingNewLine]", "\[IndentingNewLine]", 
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{"o", " ", "\[GreaterEqual]", " ", "2"}], ",", " ", 
            "\[IndentingNewLine]", 
            RowBox[{"(*", " ", 
             RowBox[{"must", " ", "have", " ", 
              RowBox[{"dx", "/", "dT"}], " ", "set", " ", "above", " ", 
              "before", " ", "solving", " ", "for", " ", "Hessian"}], " ", 
             "*)"}], "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{"F", " ", "=", " ", 
              RowBox[{
               RowBox[{"devec", "[", 
                RowBox[{
                 RowBox[{
                  RowBox[{"rbd", "[", 
                   RowBox[{"\"\<f\>\"", ",", " ", "m"}], "]"}], "[", 
                  RowBox[{"z", ",", " ", "c"}], "]"}], ",", " ", "nx"}], 
                "]"}], "\[LeftDoubleBracket]", "2", 
               "\[RightDoubleBracket]"}]}], ";", "\[IndentingNewLine]", 
             RowBox[{"Do", "[", 
              RowBox[{
               RowBox[{
                RowBox[{
                 RowBox[{"z", "\[LeftDoubleBracket]", 
                  RowBox[{
                  "3", ",", " ", "i", ",", " ", "T", ",", " ", "All"}], 
                  "\[RightDoubleBracket]"}], " ", "=", " ", 
                 RowBox[{
                  RowBox[{"z", "\[LeftDoubleBracket]", 
                   RowBox[{
                   "3", ",", " ", "i", ",", " ", "All", ",", " ", "T"}], 
                   "\[RightDoubleBracket]"}], " ", "-=", " ", 
                  RowBox[{
                  "F", "\[LeftDoubleBracket]", "i", 
                   "\[RightDoubleBracket]"}]}]}], ";"}], ",", " ", 
               RowBox[{"{", 
                RowBox[{"i", ",", " ", "nx"}], "}"}]}], "]"}], ";"}]}], 
           "\[IndentingNewLine]", "]"}], ";"}]}], "\[IndentingNewLine]", 
        "]"}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"Flatten", "[", "z", "]"}]}]}], "\[IndentingNewLine]", "]"}]}],
    ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"DTF", "[", 
    RowBox[{"m_", ",", " ", "x_", ",", " ", "c_", ",", " ", "T_"}], "]"}], 
   " ", ":=", " ", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"z", ",", " ", "F"}], "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
       RowBox[{"T", " ", 
        RowBox[{"(", 
         RowBox[{"an", " ", "index"}], ")"}]}], " ", "=", 
       RowBox[{
        RowBox[{">", " ", 
         RowBox[{
         "switching", " ", "time", " ", "derivatives", " ", "at", " ", 
          "s"}]}], " ", "=", " ", "tf"}]}], " ", "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
       RowBox[{"or", " ", "initial", " ", 
        RowBox[{"condition", " ", "@", " ", "s"}]}], " ", "=", " ", 
       RowBox[{
        RowBox[{
        "t0", " ", "for", " ", "switching", " ", "time", " ", "derivatives", 
         " ", "at", " ", "s"}], " ", "=", " ", "tf"}]}], " ", "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"z", " ", "=", " ", "x"}], ";", "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"o", " ", "\[GreaterEqual]", " ", "1"}], " ", "&&", " ", 
         RowBox[{"T", " ", "\[NotEqual]", "  ", "0"}]}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"F", " ", "=", " ", 
          RowBox[{
           RowBox[{"devec", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"rbd", "[", 
               RowBox[{"\"\<f\>\"", ",", " ", "m"}], "]"}], "[", 
              RowBox[{"z", ",", " ", "c"}], "]"}], ",", " ", "nx"}], "]"}], 
           "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"z", "\[LeftDoubleBracket]", 
           RowBox[{"2", ",", " ", "All", ",", " ", "T"}], 
           "\[RightDoubleBracket]"}], " ", "+=", " ", "F"}], ";", 
         "\[IndentingNewLine]", "\[IndentingNewLine]", 
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{"o", " ", "\[GreaterEqual]", " ", "2"}], ",", " ", 
           "\[IndentingNewLine]", 
           RowBox[{"(*", " ", 
            RowBox[{"must", " ", "have", " ", 
             RowBox[{"dx", "/", "dT"}], " ", "set", " ", "above", " ", 
             "before", " ", "solving", " ", "for", " ", "Hessian"}], " ", 
            "*)"}], "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"F", " ", "=", " ", 
             RowBox[{
              RowBox[{"devec", "[", 
               RowBox[{
                RowBox[{
                 RowBox[{"rbd", "[", 
                  RowBox[{"\"\<f\>\"", ",", " ", "m"}], "]"}], "[", 
                 RowBox[{"z", ",", " ", "c"}], "]"}], ",", " ", "nx"}], "]"}],
               "\[LeftDoubleBracket]", "2", "\[RightDoubleBracket]"}]}], ";", 
            "\[IndentingNewLine]", 
            RowBox[{"Do", "[", 
             RowBox[{
              RowBox[{
               RowBox[{
                RowBox[{"z", "\[LeftDoubleBracket]", 
                 RowBox[{"3", ",", " ", "i", ",", " ", "T", ",", " ", "All"}],
                  "\[RightDoubleBracket]"}], " ", "=", " ", 
                RowBox[{
                 RowBox[{"z", "\[LeftDoubleBracket]", 
                  RowBox[{
                  "3", ",", " ", "i", ",", " ", "All", ",", " ", "T"}], 
                  "\[RightDoubleBracket]"}], " ", "+=", " ", 
                 RowBox[{
                 "F", "\[LeftDoubleBracket]", "i", 
                  "\[RightDoubleBracket]"}]}]}], ";"}], ",", " ", 
              RowBox[{"{", 
               RowBox[{"i", ",", " ", "nx"}], "}"}]}], "]"}], ";"}]}], 
          "\[IndentingNewLine]", "]"}], ";"}]}], "\[IndentingNewLine]", "]"}],
       ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"Flatten", "[", "z", "]"}]}]}], "\[IndentingNewLine]", "]"}]}], 
  ";"}]}], "Input",
 InitializationCell->
  True,ExpressionUUID->"e1e7b507-2d1c-49b5-936c-e512dfbcbc3e"]
}, Open  ]],

Cell[CellGroupData[{

Cell["End Package", "Section",
 InitializationCell->
  True,ExpressionUUID->"52bcf006-435d-4fb5-ab9c-56c602b78193"],

Cell[BoxData[{
 RowBox[{"End", "[", "]"}], "\n", 
 RowBox[{"EndPackage", "[", "]"}]}], "Input",
 InitializationCell->
  True,ExpressionUUID->"e4dca736-71aa-4a70-bacd-862c25b073ff"]
}, Open  ]]
},
AutoGeneratedPackage->Automatic,
WindowSize->{1373, 1505},
WindowMargins->{{Automatic, 0}, {0, Automatic}},
PrivateNotebookOptions->{"FileOutlineCache"->False},
TrackCellChangeTimes->False,
FrontEndVersion->"11.3 for Linux x86 (64-bit) (March 6, 2018)",
StyleDefinitions->"Default.nb"
]
