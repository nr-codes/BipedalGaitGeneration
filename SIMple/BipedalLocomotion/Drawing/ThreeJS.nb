Notebook[{

Cell[CellGroupData[{
Cell["TO DO", \
"Section",ExpressionUUID->"5942d252-24c7-4407-be58-878fb8e76629"],

Cell["\<\
nothing

https://stackoverflow.com/questions/14614252/how-to-fit-camera-to-object

https://duckduckgo.com/?q=three.js+avoid+two+overlapping+shapes+flickering&t=\
ffab&ia=web
https://stackoverflow.com/questions/25165013/three-js-overlapping-layers-\
flickering

https://stemkoski.github.io/Three.js/#gui

https://github.com/dataarts/dat.gui/blob/master/API.md

https://katex.org/

http://gnuplot.respawned.com/\
\>", "Text",ExpressionUUID->"1d8a9f1a-38c6-4ada-a22e-e56da96c9f9c"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Begin Package", \
"Section",ExpressionUUID->"7ccc636b-f0ba-4d68-af49-6676cbfa4980"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"BeginPackage", "[", 
   RowBox[{"\"\<BipedalLocomotion`\>\"", ",", " ", 
    RowBox[{"{", 
     RowBox[{
     "\"\<GlobalVariables`\>\"", ",", " ", "\"\<RigidBodyDynamics`\>\"", ",", 
      " ", "\"\<HybridDynamics`\>\"", ",", " ", 
      "\"\<BipedalLocomotion`Model`\>\""}], "}"}]}], "]"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"Begin", "[", "\"\<`Private`\>\"", "]"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"base16", " ", "=", " ", "16"}], ";"}], "\[IndentingNewLine]", 
  "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{"THREE", ".", "InterpolateSmooth"}], " ", 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"interpolation", " ", "=", " ", "2302"}], ";"}]}], "Input",
 InitializationCell->True,
 CellLabel->"In[150]:=",ExpressionUUID->"0115de21-8c8b-4e46-bc49-37dc9143e7f8"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Helper Functions", \
"Section",ExpressionUUID->"b159ae4f-fa50-4abd-aacb-d86a024420c8"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"SetAttributes", "[", 
   RowBox[{"ColorToInteger", ",", " ", "Listable"}], "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"ColorToInteger", "[", "c_", "]"}], " ", ":=", " ", 
   RowBox[{"FromDigits", "[", 
    RowBox[{
     RowBox[{"StringJoin", "@", 
      RowBox[{"IntegerString", "[", 
       RowBox[{
        RowBox[{"Round", "[", 
         RowBox[{"255", " ", 
          RowBox[{"List", "@@", 
           RowBox[{"ColorConvert", "[", 
            RowBox[{"c", ",", " ", "\"\<RGB\>\""}], "]"}]}]}], "]"}], ",", 
        " ", "base16"}], "]"}]}], ",", " ", "base16"}], "]"}]}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"addMu", "[", "\[Mu]_", "]"}], " ", ":=", " ", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"m", ",", " ", "n", ",", " ", "c", ",", " ", "mu"}], "}"}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"m", " ", "=", " ", 
      RowBox[{"BLbiped", "[", "\"\<m[0]\>\"", "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"n", " ", "=", " ", 
      RowBox[{"Length", "@", 
       RowBox[{"(", 
        RowBox[{"Join", "@@", 
         RowBox[{"BLbiped", "[", 
          RowBox[{"\"\<p\>\"", ",", " ", "m"}], "]"}]}], ")"}]}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"c", " ", "=", " ", 
      RowBox[{"ConstantArray", "[", 
       RowBox[{"0", ",", " ", "n"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"mu", " ", "=", " ", 
      RowBox[{"BLbiped", "[", 
       RowBox[{"\"\<p\>\"", ",", " ", "m", ",", " ", "\"\<\[Mu]\>\""}], 
       "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"mu", " ", "=!=", " ", 
        RowBox[{"{", "}"}]}], ",", " ", 
       RowBox[{
        RowBox[{
         RowBox[{"c", "\[LeftDoubleBracket]", "mu", "\[RightDoubleBracket]"}],
          " ", "=", " ", "\[Mu]"}], ";"}]}], "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Flatten", "[", 
       RowBox[{"BLc", "[", 
        RowBox[{"m", ",", " ", "c"}], "]"}], "]"}], "\[LeftDoubleBracket]", 
      RowBox[{"1", ";;", "nc"}], "\[RightDoubleBracket]"}]}]}], 
   "\[IndentingNewLine]", "]"}]}]}], "Input",
 InitializationCell->True,
 CellLabel->
  "In[154]:=",ExpressionUUID->"f999365b-3a7b-4e32-9802-21dce7ed3395"],

Cell["\<\
We plan on calling .matrix to update scene; Three.JS stores transforms in \
column-major order; Don\[CloseCurlyQuote]t forget to set .matrixAutoUpdate = \
false for this to work.

see https://threejs.org/docs/#manual/en/introduction/Matrix-transformations \
for more details\
\>", "Text",ExpressionUUID->"305bf461-3b0c-4639-b9ad-ddc829eb164c"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"CreateTba", "[", 
     RowBox[{"M_", "?", "MatrixQ"}], "]"}], " ", ":=", " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"T", ",", " ", "R", ",", " ", "p"}], "}"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"T", " ", "=", " ", 
        RowBox[{"RigidBodyDynamics`Private`Tba", "[", "M", "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"(*", " ", 
        RowBox[{
         RowBox[{"invert", " ", 
          RowBox[{"frame", ":", " ", 
           RowBox[{"T", "^", 
            RowBox[{"-", "1"}]}]}]}], " ", "=", " ", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{
             RowBox[{"R", "^", "T"}], ",", " ", 
             RowBox[{
              RowBox[{"-", 
               RowBox[{"R", "^", "T"}]}], " ", "p"}]}], "}"}], ",", " ", 
           RowBox[{"{", 
            RowBox[{"0", ",", " ", "1"}], "}"}]}], "}"}]}], " ", "*)"}], 
       "\[IndentingNewLine]", 
       RowBox[{"R", " ", "=", " ", 
        RowBox[{"T", "\[LeftDoubleBracket]", 
         RowBox[{
          RowBox[{"1", ";;", "3"}], ",", " ", 
          RowBox[{"1", ";;", "3"}]}], "\[RightDoubleBracket]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"p", " ", "=", " ", 
        RowBox[{"T", "\[LeftDoubleBracket]", 
         RowBox[{
          RowBox[{"1", ";;", "3"}], ",", " ", "4"}], 
         "\[RightDoubleBracket]"}]}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"T", "\[LeftDoubleBracket]", 
         RowBox[{
          RowBox[{"1", ";;", "3"}], ",", " ", 
          RowBox[{"1", ";;", "3"}]}], "\[RightDoubleBracket]"}], " ", "=", 
        " ", 
        RowBox[{"R", "\[Transpose]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"T", "\[LeftDoubleBracket]", 
         RowBox[{
          RowBox[{"1", ";;", "3"}], ",", " ", "4"}], 
         "\[RightDoubleBracket]"}], " ", "=", " ", 
        RowBox[{"-", 
         RowBox[{
          RowBox[{"R", "\[Transpose]"}], ".", "p"}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"Flatten", "@", 
        RowBox[{"Transpose", "@", "T"}]}]}]}], "\[IndentingNewLine]", "]"}]}],
    ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"CreateTba", "[", 
     RowBox[{"v_", "?", "VectorQ"}], "]"}], " ", ":=", " ", 
    RowBox[{"CreateTba", "@", 
     RowBox[{"RigidBodyDynamics`Private`Xba", "[", 
      RowBox[{"PadLeft", "[", 
       RowBox[{"v", ",", " ", "nm"}], "]"}], "]"}]}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"CreateTransforms", "[", 
     RowBox[{"t_", ",", " ", "x_", ",", " ", "c_"}], "]"}], " ", ":=", " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"Xba", ",", " ", "X"}], "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{"Table", "[", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{
         RowBox[{"X", " ", "=", " ", 
          RowBox[{"XLfun", "[", 
           RowBox[{
            RowBox[{"x", "[", "s", "]"}], ",", " ", 
            RowBox[{"c", "[", "s", "]"}]}], "]"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"RBDExpandExpression", "[", 
          RowBox[{"CreateTba", " ", "/@", " ", "X"}], "]"}]}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{"{", 
         RowBox[{"s", ",", " ", "t"}], "}"}]}], "\[IndentingNewLine]", 
       "]"}]}], "\[IndentingNewLine]", "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"CreateTransforms", "[", 
    RowBox[{"\[Mu]_:", "1"}], "]"}], " ", ":=", " ", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", "c", "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"c", " ", "=", " ", 
       RowBox[{"addMu", "[", "\[Mu]", "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"First", "@", 
       RowBox[{"CreateTransforms", "[", 
        RowBox[{
         RowBox[{"{", "0", "}"}], ",", " ", 
         RowBox[{
          RowBox[{"c", "\[LeftDoubleBracket]", 
           RowBox[{"1", ";;", "nx"}], "\[RightDoubleBracket]"}], "&"}], ",", 
         " ", 
         RowBox[{
          RowBox[{"c", "\[LeftDoubleBracket]", 
           RowBox[{"1", ";;", "nc"}], "\[RightDoubleBracket]"}], "&"}]}], 
        "]"}]}]}]}], "\[IndentingNewLine]", "]"}]}], ";"}]}], "Input",
 InitializationCell->
  True,ExpressionUUID->"83bb9741-aacf-4eeb-8124-654ac6a6da32"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"CreateTracks", "[", 
     RowBox[{"n_", ",", " ", "x_", ",", " ", "c_"}], "]"}], " ", ":=", " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"tn", ",", " ", "t", ",", " ", "v"}], "}"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
        RowBox[{"create", " ", "track", " ", "name"}], ";", " ", 
        RowBox[{"key", " ", 
         RowBox[{"on", " ", ".", "matrix"}], " ", "property"}]}], " ", "*)"}],
       "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"n", " ", "===", " ", "Automatic"}], ",", " ", 
         "\[IndentingNewLine]", 
         RowBox[{"tn", " ", "=", " ", 
          RowBox[{"Keys", "[", 
           RowBox[{
            RowBox[{"RigidBodyDynamics`Private`GetExpandedTree", "[", "]"}], 
            "[", "TreeForm", "]"}], "]"}]}], ",", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"tn", " ", "=", " ", "n"}], ";"}]}], "\[IndentingNewLine]", 
        "]"}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"tn", " ", "=", " ", 
        RowBox[{
         RowBox[{
          RowBox[{"#1", " ", "<>", " ", "\"\<.matrix\>\""}], "&"}], " ", "/@",
          " ", "tn"}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"(*", " ", 
        RowBox[{"get", " ", "track", " ", "data"}], " ", "*)"}], 
       "\[IndentingNewLine]", 
       RowBox[{"t", " ", "=", " ", 
        RowBox[{"Flatten", "@", 
         RowBox[{"x", "[", "\"\<Grid\>\"", "]"}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"v", " ", "=", " ", 
        RowBox[{"Flatten", " ", "/@", " ", 
         RowBox[{"Transpose", "@", 
          RowBox[{"CreateTransforms", "[", 
           RowBox[{"t", ",", " ", "x", ",", " ", "c"}], "]"}]}]}]}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"(*", " ", 
        RowBox[{"create", " ", "track"}], " ", "*)"}], "\[IndentingNewLine]", 
       
       RowBox[{"MapThread", "[", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{
          RowBox[{"<|", 
           RowBox[{
            RowBox[{"\"\<name\>\"", " ", "\[Rule]", " ", "#1"}], ",", " ", 
            RowBox[{"\"\<type\>\"", " ", "\[Rule]", " ", "\"\<vector\>\""}], 
            ",", " ", 
            RowBox[{"\"\<times\>\"", " ", "\[Rule]", " ", "t"}], ",", " ", 
            RowBox[{"\"\<values\>\"", " ", "\[Rule]", " ", "#2"}], ",", " ", 
            RowBox[{
            "\"\<interpolation\>\"", " ", "\[Rule]", " ", "interpolation"}]}],
            "|>"}], "&"}], ",", "\[IndentingNewLine]", 
         RowBox[{"{", 
          RowBox[{"tn", ",", " ", "v"}], "}"}]}], "\[IndentingNewLine]", 
        "]"}]}]}], "\[IndentingNewLine]", "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"CreateClips", "[", 
     RowBox[{"M_Association", ",", " ", "tn_", ",", " ", 
      RowBox[{"d_:", "-", "1"}], ",", " ", 
      RowBox[{"fps_:", "1"}]}], "]"}], " ", ":=", " ", 
    RowBox[{"KeyValueMap", "[", 
     RowBox[{
      RowBox[{
       RowBox[{"CreateClip", "[", 
        RowBox[{"#1", ",", " ", "tn", ",", " ", 
         RowBox[{"#2", "[", "\"\<x[t]\>\"", "]"}], ",", " ", 
         RowBox[{"#2", "[", "\"\<c[t]\>\"", "]"}], ",", " ", "d", ",", " ", 
         "fps"}], "]"}], "&"}], ",", " ", "M"}], "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"CreateClip", "[", 
    RowBox[{"n_", ",", " ", "tn_", ",", " ", "x_", ",", " ", "c_", ",", " ", 
     RowBox[{"d_:", "-", "1"}], ",", " ", 
     RowBox[{"fps_:", "1"}]}], "]"}], " ", ":=", " ", 
   RowBox[{"<|", 
    RowBox[{
     RowBox[{"\"\<name\>\"", " ", "\[Rule]", " ", "n"}], ",", " ", 
     RowBox[{"\"\<fps\>\"", " ", "\[Rule]", " ", "1"}], ",", " ", 
     RowBox[{"\"\<duration\>\"", " ", "\[Rule]", " ", "d"}], ",", " ", 
     RowBox[{"\"\<tracks\>\"", " ", "\[Rule]", " ", 
      RowBox[{"CreateTracks", "[", 
       RowBox[{"tn", ",", " ", "x", ",", " ", "c"}], "]"}]}]}], "|>"}]}], 
  ";"}]}], "Input",
 InitializationCell->True,
 CellLabel->
  "In[161]:=",ExpressionUUID->"8dbd2996-082b-420b-a147-b7faf0e56b4c"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"GetSurfaceAngles", "[", "M_Association", "]"}], " ", ":=", 
    "\[IndentingNewLine]", 
    RowBox[{"KeyValueMap", "[", 
     RowBox[{
      RowBox[{
       RowBox[{"GetSurfaceAngle", "[", 
        RowBox[{"#1", ",", " ", 
         RowBox[{
          RowBox[{"#2", "[", "\"\<m\>\"", "]"}], "\[LeftDoubleBracket]", "1", 
          "\[RightDoubleBracket]"}], ",", " ", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{
            RowBox[{"#2", "[", "\"\<x-\>\"", "]"}], "\[LeftDoubleBracket]", 
            "1", "\[RightDoubleBracket]"}], ",", " ", 
           RowBox[{"Table", "[", 
            RowBox[{"0", ",", " ", "nx", ",", " ", "1"}], "]"}]}], "}"}], ",",
          " ", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{
            RowBox[{"#2", "[", "\"\<c\>\"", "]"}], "\[LeftDoubleBracket]", 
            "1", "\[RightDoubleBracket]"}], ",", " ", 
           RowBox[{"Table", "[", 
            RowBox[{"0", ",", " ", "nc", ",", " ", "1"}], "]"}]}], "}"}]}], 
        "]"}], "&"}], ",", " ", "M"}], "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"GetSurfaceAngle", "[", 
   RowBox[{"n_", ",", " ", "m_", ",", " ", "x_", ",", " ", "c_"}], "]"}], " ",
   ":=", " ", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"a", ",", " ", "norm", ",", " ", "g"}], "}"}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"a", " ", "=", " ", 
      RowBox[{"CreateSurface", "[", 
       RowBox[{"m", ",", " ", "x", ",", " ", "c"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"norm", " ", "=", " ", 
      RowBox[{"Cross", "[", 
       RowBox[{
        RowBox[{"a", "\[LeftDoubleBracket]", "3", "\[RightDoubleBracket]"}], 
        ",", " ", 
        RowBox[{"a", "\[LeftDoubleBracket]", "2", "\[RightDoubleBracket]"}]}],
        "]"}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"g", " ", "=", " ", 
      RowBox[{"I3", "\[LeftDoubleBracket]", 
       RowBox[{
        RowBox[{"Lookup", "[", 
         RowBox[{
          RowBox[{"BLbiped", "[", "\"\<draw\>\"", "]"}], ",", " ", 
          "\"\<axes\>\"", ",", " ", "axes"}], "]"}], "\[LeftDoubleBracket]", 
        RowBox[{"-", "1"}], "\[RightDoubleBracket]"}], 
       "\[RightDoubleBracket]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"<|", 
      RowBox[{
       RowBox[{"\"\<c\>\"", " ", "\[Rule]", " ", 
        RowBox[{"-", 
         RowBox[{"norm", ".", 
          RowBox[{
          "a", "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}]}]}]}], 
       ",", " ", 
       RowBox[{"\"\<n\>\"", " ", "\[Rule]", " ", "norm"}], ",", " ", 
       RowBox[{"\"\<d\>\"", " ", "\[Rule]", " ", 
        RowBox[{"-", 
         RowBox[{"g", ".", 
          RowBox[{
          "a", "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}]}]}]}], 
       ",", " ", 
       RowBox[{"\"\<o\>\"", " ", "\[Rule]", " ", 
        RowBox[{
        "a", "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}]}]}], 
      "|>"}]}]}], "\[IndentingNewLine]", "]"}]}]}], "Input",
 InitializationCell->
  True,ExpressionUUID->"4ea9f8ce-7cfe-4349-8671-5afc3cf52aed"],

Cell["\<\
TODO : this function is redundant with OneSurface in DrawBiped.nb and \
AtlasSurface in Atlas.nb; should combine them under one common function.\
\>", "Text",ExpressionUUID->"586390b2-7760-4c7d-8006-cf74e37852e0"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", " ", 
   RowBox[{
    RowBox[{
     RowBox[{"get", " ", "post"}], "-", 
     RowBox[{"impact", " ", "m"}]}], ",", " ", "x", ",", " ", "c"}], " ", 
   "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{
     RowBox[{"CreateSurface", "[", "M_", "]"}], " ", ":=", " ", 
     RowBox[{"CreateSurface", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"M", "[", "\"\<m[t]\>\"", "]"}], "[", "0", "]"}], ",", " ", 
       RowBox[{"devec", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"M", "[", "\"\<x[t]\>\"", "]"}], "[", "0", "]"}], ",", " ", 
         "nx"}], "]"}], ",", " ", 
       RowBox[{"devec", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"M", "[", "\"\<c[t]\>\"", "]"}], "[", "0", "]"}], ",", " ", 
         "nc"}], "]"}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"CreateSurface", "[", 
      RowBox[{"m_", ",", " ", "x_", ",", " ", "c_"}], "]"}], " ", ":=", " ", 
     RowBox[{"Module", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
        "d", ",", " ", "\[Sigma]", ",", " ", "r", ",", " ", "ax", ",", " ", 
         "p", ",", " ", "n"}], "}"}], ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"d", " ", "=", " ", 
         RowBox[{"Lookup", "[", 
          RowBox[{"BLbiped", ",", " ", "\"\<draw\>\"", ",", " ", 
           RowBox[{"<|", "|>"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"ax", " ", "=", " ", 
         RowBox[{"Lookup", "[", 
          RowBox[{
          "d", ",", " ", "\"\<axes\>\"", ",", " ", 
           "BipedalLocomotion`Private`axes"}], "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"n", " ", "=", " ", 
         RowBox[{"Length", "[", "ax", "]"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{"n", " ", "\[Equal]", " ", "2"}], ",", " ", 
          RowBox[{
           RowBox[{"ax", " ", "=", " ", 
            RowBox[{"Insert", "[", 
             RowBox[{"ax", ",", " ", 
              RowBox[{"First", "@", 
               RowBox[{"Complement", "[", 
                RowBox[{
                 RowBox[{"Range", "[", "mm", "]"}], ",", "  ", "ax"}], 
                "]"}]}], ",", " ", "2"}], "]"}]}], ";"}]}], "]"}], ";", 
        "\[IndentingNewLine]", "\[IndentingNewLine]", 
        RowBox[{"(*", " ", 
         RowBox[{"compute", " ", "slope"}], " ", "*)"}], 
        "\[IndentingNewLine]", 
        RowBox[{"\[Sigma]", " ", "=", " ", 
         RowBox[{
          RowBox[{
           RowBox[{"BLbiped", "[", 
            RowBox[{"\"\<\[Sigma]\>\"", ",", " ", "m"}], "]"}], "[", 
           RowBox[{"x", ",", " ", "c"}], "]"}], "\[LeftDoubleBracket]", 
          RowBox[{"1", ";;", "mm"}], "\[RightDoubleBracket]"}]}], ";", 
        "\[IndentingNewLine]", "\[IndentingNewLine]", 
        RowBox[{"(*", " ", 
         RowBox[{"get", " ", 
          RowBox[{"(", 
           RowBox[{"post", "-", "impact"}], ")"}], " ", "stance", " ", "foot",
           " ", "location"}], " ", "*)"}], "\[IndentingNewLine]", 
        RowBox[{"p", " ", "=", " ", 
         RowBox[{"Lookup", "[", 
          RowBox[{"d", ",", " ", "\"\<surface\>\"", ",", " ", "Automatic"}], 
          "]"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"p", " ", "=", " ", 
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{"p", " ", "===", " ", "Automatic"}], ",", " ", 
           RowBox[{"BLSide", "[", 
            RowBox[{"m", ",", " ", 
             RowBox[{"BLbiped", "[", "\"\<feet\>\"", "]"}], ",", " ", "2"}], 
            "]"}], ",", " ", 
           RowBox[{"p", "[", 
            RowBox[{"m", ",", " ", "x", ",", " ", "c"}], "]"}]}], "]"}]}], 
        ";", "\[IndentingNewLine]", 
        RowBox[{"p", " ", "=", " ", 
         RowBox[{
          RowBox[{"RBDSpatialPosition", "[", 
           RowBox[{
            RowBox[{
            "p", "\[LeftDoubleBracket]", "2", "\[RightDoubleBracket]"}], ",", 
            " ", 
            RowBox[{
            "p", "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}], ",", 
            " ", 
            RowBox[{"\"\<x\>\"", " ", "\[Rule]", " ", 
             RowBox[{
             "x", "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}]}], 
            ",", " ", 
            RowBox[{"\"\<\[Lambda]\>\"", " ", "\[Rule]", " ", 
             RowBox[{
             "c", "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}]}]}], 
           "]"}], "\[LeftDoubleBracket]", 
          RowBox[{
           RowBox[{"mm", "+", "1"}], ";;", "nm"}], 
          "\[RightDoubleBracket]"}]}], ";", "\[IndentingNewLine]", 
        "\[IndentingNewLine]", 
        RowBox[{"\[Sigma]", " ", "=", " ", 
         RowBox[{
         "\[Sigma]", "\[LeftDoubleBracket]", "ax", 
          "\[RightDoubleBracket]"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"r", " ", "=", " ", 
         RowBox[{
          RowBox[{"IdentityMatrix", "[", "mm", "]"}], "\[LeftDoubleBracket]", 
          "ax", "\[RightDoubleBracket]"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{"n", " ", "\[Equal]", " ", "2"}], ",", " ", 
          RowBox[{
           RowBox[{
            RowBox[{
            "r", "\[LeftDoubleBracket]", "2", "\[RightDoubleBracket]"}], " ", 
            "=", " ", 
            RowBox[{"-", 
             RowBox[{
             "r", "\[LeftDoubleBracket]", "2", "\[RightDoubleBracket]"}]}]}], 
           ";"}]}], "]"}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
        
        RowBox[{"{", 
         RowBox[{"p", ",", " ", 
          RowBox[{
           RowBox[{"RotationMatrix", "[", 
            RowBox[{
             RowBox[{
             "\[Sigma]", "\[LeftDoubleBracket]", "2", 
              "\[RightDoubleBracket]"}], ",", " ", 
             RowBox[{"-", 
              RowBox[{
              "r", "\[LeftDoubleBracket]", "2", "\[RightDoubleBracket]"}]}]}],
             "]"}], ".", 
           RowBox[{
           "r", "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}]}], ",",
           " ", 
          RowBox[{
           RowBox[{"RotationMatrix", "[", 
            RowBox[{
             RowBox[{
             "\[Sigma]", "\[LeftDoubleBracket]", "3", 
              "\[RightDoubleBracket]"}], ",", " ", 
             RowBox[{
             "r", "\[LeftDoubleBracket]", "3", "\[RightDoubleBracket]"}]}], 
            "]"}], ".", 
           RowBox[{
           "r", "\[LeftDoubleBracket]", "2", "\[RightDoubleBracket]"}]}]}], 
         "}"}]}]}], "\[IndentingNewLine]", "]"}]}], ";"}]}]}]], "Input",
 InitializationCell->
  True,ExpressionUUID->"5edd07c7-1df7-4fb5-a6ab-5f6efcdfbabd"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Base Class", \
"Section",ExpressionUUID->"8b2009df-a48f-4f7d-9e63-6b1725f75de2"],

Cell["\<\
special keys for objopts are joint, link, mesh, dof...technically, \
name/parent, but those shouldn\[CloseCurlyQuote]t be modified under most \
circumstances\
\>", "Text",ExpressionUUID->"ba866565-2c08-4d35-8739-d2996edc9b28"],

Cell[BoxData[
 RowBox[{
  RowBox[{"Object3D", "[", 
   RowBox[{"n_", ",", " ", "p_", ",", " ", 
    RowBox[{"objopts_:", 
     RowBox[{"<|", "|>"}]}]}], "]"}], " ", ":=", " ", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"A", ",", " ", "c"}], "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"A", " ", "=", " ", 
      RowBox[{"<|", 
       RowBox[{
        RowBox[{"\"\<name\>\"", " ", "\[Rule]", " ", "n"}], ",", " ", 
        RowBox[{"\"\<parent\>\"", " ", "\[Rule]", " ", 
         RowBox[{"Quiet", "@", 
          RowBox[{"Check", "[", 
           RowBox[{
            RowBox[{"RBDGetPositionIndex", "@", "p"}], ",", " ", "0"}], 
           "]"}]}]}], ",", " ", "objopts"}], "|>"}]}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"KeyFreeQ", "[", 
        RowBox[{"A", ",", " ", "\"\<dof\>\""}], "]"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"Which", "[", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"StringEndsQ", "[", 
           RowBox[{"n", ",", " ", "\"\<px\>\""}], "]"}], ",", " ", 
          RowBox[{
           RowBox[{"A", "[", "\"\<dof\>\"", "]"}], " ", "=", " ", 
           "\"\<px\>\""}], ",", "\[IndentingNewLine]", 
          RowBox[{"StringEndsQ", "[", 
           RowBox[{"n", ",", " ", "\"\<py\>\""}], "]"}], ",", " ", 
          RowBox[{
           RowBox[{"A", "[", "\"\<dof\>\"", "]"}], " ", "=", " ", 
           "\"\<py\>\""}], ",", "\[IndentingNewLine]", 
          RowBox[{"StringEndsQ", "[", 
           RowBox[{"n", ",", " ", "\"\<pz\>\""}], "]"}], ",", " ", 
          RowBox[{
           RowBox[{"A", "[", "\"\<dof\>\"", "]"}], " ", "=", " ", 
           "\"\<pz\>\""}], ",", "\[IndentingNewLine]", 
          RowBox[{"StringEndsQ", "[", 
           RowBox[{"n", ",", " ", "\"\<rx\>\""}], "]"}], ",", " ", 
          RowBox[{
           RowBox[{"A", "[", "\"\<dof\>\"", "]"}], " ", "=", " ", 
           "\"\<rx\>\""}], ",", "\[IndentingNewLine]", 
          RowBox[{"StringEndsQ", "[", 
           RowBox[{"n", ",", " ", "\"\<ry\>\""}], "]"}], ",", " ", 
          RowBox[{
           RowBox[{"A", "[", "\"\<dof\>\"", "]"}], " ", "=", " ", 
           "\"\<ry\>\""}], ",", "\[IndentingNewLine]", 
          RowBox[{"StringEndsQ", "[", 
           RowBox[{"n", ",", " ", "\"\<rz\>\""}], "]"}], ",", " ", 
          RowBox[{
           RowBox[{"A", "[", "\"\<dof\>\"", "]"}], " ", "=", " ", 
           "\"\<rz\>\""}], ",", "\[IndentingNewLine]", "True", ",", "  ", 
          RowBox[{
           RowBox[{
            RowBox[{"A", "[", "\"\<dof\>\"", "]"}], " ", "=", " ", 
            RowBox[{"If", "[", 
             RowBox[{
              RowBox[{"StringContainsQ", "[", 
               RowBox[{"n", ",", " ", "\"\<foot\>\"", ",", " ", 
                RowBox[{"IgnoreCase", "\[Rule]", "True"}]}], "]"}], ",", " ", 
              "\"\<poi\>\"", ",", " ", "\"\<poi-flat\>\""}], "]"}]}], ";"}]}],
          "\[IndentingNewLine]", "]"}], ";"}]}], "\[IndentingNewLine]", "]"}],
      ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"KeyFreeQ", "[", 
        RowBox[{"A", ",", " ", "\"\<mesh\>\""}], "]"}], ",", " ", 
       RowBox[{
        RowBox[{"A", "[", "\"\<mesh\>\"", "]"}], " ", "=", " ", 
        RowBox[{"<|", "|>"}]}]}], "]"}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
       RowBox[{"draw", "/", "render"}], " ", "link", " ", "for", " ", 
       "relevant", " ", "joint", " ", "types"}], " ", "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{"c", " ", "=", " ", 
      RowBox[{"StringMatchQ", "[", 
       RowBox[{
        RowBox[{"A", "[", "\"\<dof\>\"", "]"}], ",", " ", 
        RowBox[{
        "\"\<rx\>\"", "|", "\"\<ry\>\"", "|", "\"\<rz\>\"", "|", 
         "\"\<poi\>\"", "|", "\"\<poi-flat\>\"", "|", "\"\<poi-circ\>\""}]}], 
       "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{"c", ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"c", " ", "=", " ", 
         RowBox[{"BLbiped", "[", 
          RowBox[{"\"\<draw\>\"", ",", " ", "\"\<lc\>\""}], "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"(*", " ", 
         RowBox[{
          RowBox[{"hack", " ", "to", " ", "remove"}], ",", " ", 
          RowBox[{"e", ".", "g", "."}], ",", " ", 
          RowBox[{"\"\<-rx\>\"", " ", "from", " ", "string"}]}], " ", "*)"}], 
        "\[IndentingNewLine]", 
        RowBox[{"c", " ", "=", " ", 
         RowBox[{"Lookup", "[", 
          RowBox[{"c", ",", " ", "n", ",", " ", 
           RowBox[{"Lookup", "[", 
            RowBox[{"c", ",", " ", 
             RowBox[{"StringTake", "[", 
              RowBox[{"n", ",", " ", 
               RowBox[{"{", 
                RowBox[{"1", ",", " ", 
                 RowBox[{"-", "4"}]}], "}"}]}], "]"}], ",", " ", "lc"}], 
            "]"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
        "\[IndentingNewLine]", 
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{"KeyFreeQ", "[", 
           RowBox[{
            RowBox[{"A", "[", "\"\<mesh\>\"", "]"}], ",", " ", 
            "\"\<link\>\""}], "]"}], ",", " ", 
          RowBox[{
           RowBox[{"A", "[", 
            RowBox[{"\"\<mesh\>\"", ",", " ", "\"\<link\>\""}], "]"}], " ", 
           "=", " ", 
           RowBox[{"<|", "|>"}]}]}], "]"}], ";", "\[IndentingNewLine]", 
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{"KeyFreeQ", "[", 
           RowBox[{
            RowBox[{"A", "[", 
             RowBox[{"\"\<mesh\>\"", ",", " ", "\"\<link\>\""}], "]"}], ",", 
            " ", "\"\<color\>\""}], "]"}], ",", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{
            RowBox[{"A", "[", 
             RowBox[{
             "\"\<mesh\>\"", ",", " ", "\"\<link\>\"", ",", " ", 
              "\"\<color\>\""}], "]"}], " ", "=", " ", 
            RowBox[{"ColorToInteger", "[", "c", "]"}]}], ";"}]}], 
         "\[IndentingNewLine]", "]"}], ";"}]}], "\[IndentingNewLine]", "]"}], 
     ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
       RowBox[{"draw", "/", "render"}], " ", "joint", " ", "for", " ", 
       "relevant", " ", "joint", " ", "types"}], " ", "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{"c", " ", "=", " ", 
      RowBox[{"StringMatchQ", "[", 
       RowBox[{
        RowBox[{"A", "[", "\"\<dof\>\"", "]"}], ",", " ", 
        RowBox[{
        "\"\<rx\>\"", "|", "\"\<ry\>\"", "|", "\"\<rz\>\"", "|", 
         "\"\<poi-circ\>\""}]}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{"c", ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"c", " ", "=", " ", 
         RowBox[{"Lookup", "[", 
          RowBox[{
           RowBox[{"BLbiped", "[", "\"\<draw\>\"", "]"}], ",", " ", 
           "\"\<jc\>\"", ",", " ", 
           RowBox[{"<|", "|>"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"c", " ", "=", " ", 
         RowBox[{"Lookup", "[", 
          RowBox[{"c", ",", " ", "n", ",", " ", 
           RowBox[{"Lookup", "[", 
            RowBox[{"c", ",", " ", 
             RowBox[{"StringTake", "[", 
              RowBox[{"n", ",", " ", 
               RowBox[{"{", 
                RowBox[{"1", ",", " ", 
                 RowBox[{"-", "4"}]}], "}"}]}], "]"}], ",", " ", "jc"}], 
            "]"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
        "\[IndentingNewLine]", 
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{"KeyFreeQ", "[", 
           RowBox[{
            RowBox[{"A", "[", "\"\<mesh\>\"", "]"}], ",", " ", 
            "\"\<joint\>\""}], "]"}], ",", " ", 
          RowBox[{
           RowBox[{"A", "[", 
            RowBox[{"\"\<mesh\>\"", ",", " ", "\"\<joint\>\""}], "]"}], " ", 
           "=", " ", 
           RowBox[{"<|", "|>"}]}]}], "]"}], ";", "\[IndentingNewLine]", 
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{"KeyFreeQ", "[", 
           RowBox[{
            RowBox[{"A", "[", 
             RowBox[{"\"\<mesh\>\"", ",", " ", "\"\<joint\>\""}], "]"}], ",", 
            " ", "\"\<color\>\""}], "]"}], ",", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{
            RowBox[{"A", "[", 
             RowBox[{
             "\"\<mesh\>\"", ",", " ", "\"\<joint\>\"", ",", " ", 
              "\"\<color\>\""}], "]"}], " ", "=", " ", 
            RowBox[{"ColorToInteger", "[", "c", "]"}]}], ";"}]}], 
         "\[IndentingNewLine]", "]"}], ";"}]}], "\[IndentingNewLine]", "]"}], 
     ";", "\[IndentingNewLine]", "\[IndentingNewLine]", "A"}]}], 
   "\[IndentingNewLine]", "]"}]}]], "Input",
 InitializationCell->
  True,ExpressionUUID->"0b4f5337-4efa-4971-8d6c-569edcde47d9"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Specialized Classes", \
"Section",ExpressionUUID->"196775b4-1298-4ddd-8a63-acecd4b90159"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"CreatePOI", "[", 
    RowBox[{
     RowBox[{"\[Mu]_:", "1"}], ",", " ", 
     RowBox[{"objopts_:", " ", 
      RowBox[{"<|", "|>"}]}]}], "]"}], " ", ":=", " ", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"o", ",", " ", "c", ",", " ", "poi", ",", " ", "f"}], "}"}], 
     ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"c", " ", "=", " ", 
       RowBox[{"addMu", "[", "\[Mu]", "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"poi", " ", "=", " ", 
       RowBox[{
        RowBox[{"BLbiped", "[", 
         RowBox[{"\"\<draw\>\"", ",", " ", "\"\<poi\>\""}], "]"}], " ", "/.", 
        " ", 
        RowBox[{
         RowBox[{"\[DoubleStruckC]", "[", "i_", "]"}], " ", "\[RuleDelayed]", 
         " ", 
         RowBox[{
         "c", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}]}]}]}], 
      ";", "\[IndentingNewLine]", 
      RowBox[{"o", " ", "=", " ", 
       RowBox[{
        RowBox[{"Lookup", "[", 
         RowBox[{"objopts", ",", " ", "#", ",", " ", 
          RowBox[{"<|", "|>"}]}], "]"}], "&"}]}], ";", "\[IndentingNewLine]", 
      
      RowBox[{"f", " ", "=", " ", 
       RowBox[{
        RowBox[{"<|", 
         RowBox[{
          RowBox[{"Object3D", "[", 
           RowBox[{"#1", ",", " ", 
            RowBox[{
            "#2", "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}], ",",
             " ", 
            RowBox[{"o", "[", "#1", "]"}]}], "]"}], ",", " ", 
          RowBox[{"\"\<value\>\"", " ", "\[Rule]", " ", 
           RowBox[{"CreateTba", "[", 
            RowBox[{
            "#2", "\[LeftDoubleBracket]", "3", "\[RightDoubleBracket]"}], 
            "]"}]}]}], "|>"}], "&"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"KeyValueMap", "[", 
       RowBox[{"f", ",", " ", "poi"}], "]"}]}]}], "\[IndentingNewLine]", 
    "]"}]}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"CreateJoints", "[", 
   RowBox[{
    RowBox[{"rb_:", "Automatic"}], ",", " ", 
    RowBox[{"\[Mu]_:", "1"}], ",", " ", 
    RowBox[{"objopts_:", " ", 
     RowBox[{"<|", "|>"}]}]}], "]"}], " ", ":=", " ", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
     "r", ",", " ", "p", ",", " ", "n", ",", " ", "v", ",", " ", "o"}], "}"}],
     ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"r", " ", "=", " ", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"rb", " ", "===", " ", "Automatic"}], ",", " ", 
        RowBox[{"RigidBodyDynamics`Private`GetExpandedTree", "[", "]"}], ",", 
        " ", "rb"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"p", " ", "=", " ", 
      RowBox[{"r", "[", "ParentList", "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"n", " ", "=", " ", 
      RowBox[{"Keys", "[", 
       RowBox[{"r", "[", "TreeForm", "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"v", " ", "=", " ", 
      RowBox[{"CreateTransforms", "[", "\[Mu]", "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"o", " ", "=", " ", 
      RowBox[{
       RowBox[{"Lookup", "[", 
        RowBox[{"objopts", ",", " ", "#", ",", " ", 
         RowBox[{"<|", "|>"}]}], "]"}], "&"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"MapThread", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"<|", 
         RowBox[{
          RowBox[{"Object3D", "[", 
           RowBox[{"#1", ",", " ", "#2", ",", " ", 
            RowBox[{"o", "[", "#1", "]"}]}], "]"}], ",", " ", 
          RowBox[{"\"\<value\>\"", " ", "\[Rule]", " ", "#3"}]}], "|>"}], 
        "&"}], ",", " ", 
       RowBox[{"{", 
        RowBox[{"n", ",", " ", "p", ",", " ", "v"}], "}"}]}], "]"}]}]}], 
   "\[IndentingNewLine]", "]"}]}]}], "Input",
 InitializationCell->True,
 CellLabel->"In[169]:=",ExpressionUUID->"f327a82a-afb3-41e3-9ab6-0b223a7788dd"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Common Mesh Options", "Section",
 InitializationCell->
  True,ExpressionUUID->"adfe0e8c-f89c-4688-854f-2a1adf691b09"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"Options", "[", "BLMeshOptions", "]"}], " ", "=", " ", 
  RowBox[{"{", 
   RowBox[{"Length", " ", "\[Rule]", " ", "0.1"}], 
   "}"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"BLMeshOptions", "[", 
    RowBox[{"OptionsPattern", "[", "]"}], "]"}], " ", ":=", " ", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "w", ",", " ", "f", ",", " ", "info", ",", " ", "joints", ",", " ", 
       "links", ",", " ", "A"}], "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"w", " ", "=", " ", 
       RowBox[{"OptionValue", "[", "Length", "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"f", " ", "=", " ", 
       RowBox[{"Function", "[", 
        RowBox[{"x", ",", " ", 
         RowBox[{"StringRiffle", "[", 
          RowBox[{
           RowBox[{"List", "@@", "x"}], ",", " ", "\"\<-\>\""}], "]"}], ",", 
         " ", "Listable"}], "]"}]}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{"get", " ", "all", " ", "joint", " ", "names"}], " ", "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"A", " ", "=", " ", 
       RowBox[{"f", "[", 
        RowBox[{"RBDGetValue", "[", 
         RowBox[{"1", ",", " ", "nq", ",", " ", 
          RowBox[{"\"\<n\>\"", " ", "\[Rule]", " ", "True"}]}], "]"}], 
        "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"A", " ", "=", " ", 
       RowBox[{"Association", "@", 
        RowBox[{"Thread", "[", 
         RowBox[{"A", " ", "\[Rule]", " ", 
          RowBox[{"<|", 
           RowBox[{"\"\<mesh\>\"", " ", "\[Rule]", " ", 
            RowBox[{"<|", 
             RowBox[{
              RowBox[{"\"\<joint\>\"", " ", "\[Rule]", " ", 
               RowBox[{"<|", 
                RowBox[{
                 RowBox[{"\"\<height\>\"", " ", "\[Rule]", " ", 
                  RowBox[{"1.1", " ", "w"}]}], ",", " ", 
                 RowBox[{"\"\<radius\>\"", " ", "\[Rule]", " ", 
                  RowBox[{"w", "/", "2"}]}]}], "|>"}]}], ",", 
              RowBox[{"\"\<link\>\"", " ", "\[Rule]", " ", 
               RowBox[{"<|", 
                RowBox[{"\"\<width\>\"", " ", "\[Rule]", " ", "w"}], 
                "|>"}]}]}], "|>"}]}], "|>"}]}], "]"}]}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", "A"}]}], 
    "\[IndentingNewLine]", "]"}]}], ";"}]}], "Input",
 InitializationCell->
  True,ExpressionUUID->"d25dfcf4-85e7-4637-92bf-42ad008aa37c"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Export to JSON", "Section",
 InitializationCell->
  True,ExpressionUUID->"e860885d-8473-4ad8-ba46-28029292bd00"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"BLCreateBipedToThreeJS", "[", "A_", "]"}], " ", ":=", " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "T", ",", " ", "K", ",", " ", "mu", ",", " ", "j", ",", " ", "f", ",", 
        " ", "ax", ",", " ", "mopts", ",", " ", "mroot"}], "}"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{"get", " ", "kinematic", " ", "tree", " ", "properties"}], " ",
        "*)"}], "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"T", " ", "=", " ", 
        RowBox[{"RigidBodyDynamics`Private`GetExpandedTree", "[", "]"}]}], 
       ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"(*", " ", 
        RowBox[{
         RowBox[{
         "functions", " ", "for", " ", "a", " ", "model", " ", "entry"}], ",",
          " ", 
         RowBox[{
         "model", " ", "defined", " ", "by", " ", "\[Mu]", " ", "vector", " ",
           "in", " ", "\[DoubleStruckC]"}]}], " ", "*)"}], 
       "\[IndentingNewLine]", 
       RowBox[{"K", " ", "=", " ", 
        RowBox[{"KeyDrop", "[", 
         RowBox[{"Key", "@", "Options"}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"(*", " ", 
        RowBox[{
         RowBox[{"mu", " ", "assumes", " ", "no", " ", "derivatives"}], ",", 
         " ", 
         RowBox[{"i", ".", "e", "."}], ",", " ", 
         RowBox[{
          RowBox[{"Length", "[", "mu", "]"}], " ", "===", " ", "nc"}]}], " ", 
        "*)"}], "\[IndentingNewLine]", 
       RowBox[{"mu", " ", "=", " ", 
        RowBox[{
         RowBox[{"#", "\[LeftDoubleBracket]", 
          RowBox[{"1", ",", " ", "\"\<c\>\"", ",", " ", "1", ",", " ", 
           RowBox[{
            RowBox[{"(", 
             RowBox[{
              RowBox[{"If", "[", 
               RowBox[{
                RowBox[{"#", " ", "<", "0"}], ",", " ", 
                RowBox[{"nc", "+", "#", "+", "1"}], ",", " ", "#"}], "]"}], 
              "&"}], ")"}], " ", "/@", " ", 
            RowBox[{"BLbiped", "[", 
             RowBox[{"\"\<c\>\"", ",", " ", 
              RowBox[{"#", "\[LeftDoubleBracket]", 
               RowBox[{"1", ",", " ", "\"\<m\>\"", ",", " ", "1"}], 
               "\[RightDoubleBracket]"}], ",", " ", "\"\<\[Mu]\>\""}], 
             "]"}]}]}], "\[RightDoubleBracket]"}], "&"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"j", " ", "=", " ", 
        RowBox[{
         RowBox[{"Join", "[", 
          RowBox[{
           RowBox[{"CreateJoints", "[", 
            RowBox[{"T", ",", " ", "#1", ",", " ", "#2"}], "]"}], ",", " ", 
           RowBox[{"CreatePOI", "[", 
            RowBox[{"#1", ",", " ", "#2"}], "]"}]}], "]"}], "&"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"mopts", " ", "=", " ", 
        RowBox[{
         RowBox[{"Lookup", "[", 
          RowBox[{"#", ",", " ", "Options", ",", " ", 
           RowBox[{"<|", "|>"}]}], "]"}], "&"}]}], ";", "\[IndentingNewLine]",
        "\[IndentingNewLine]", 
       RowBox[{"ax", " ", "=", " ", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"\"\<x\>\"", ",", " ", "\"\<y\>\"", ",", " ", "\"\<z\>\""}],
           "}"}], "\[LeftDoubleBracket]", 
         RowBox[{"Lookup", "[", 
          RowBox[{
           RowBox[{"BLbiped", "[", "\"\<draw\>\"", "]"}], ",", " ", 
           "\"\<axes\>\"", ",", " ", "axes"}], "]"}], 
         "\[RightDoubleBracket]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"mroot", " ", "=", " ", 
        RowBox[{
         RowBox[{"<|", 
          RowBox[{
           RowBox[{"\"\<axes\>\"", " ", "\[Rule]", " ", "ax"}], ",", " ", 
           RowBox[{
           "\"\<loader\>\"", " ", "\[Rule]", " ", "\"\<DefaultMesh.js\>\""}], 
           ",", " ", 
           RowBox[{"Lookup", "[", 
            RowBox[{
             RowBox[{"mopts", "[", "#", "]"}], ",", " ", "Root", ",", " ", 
             RowBox[{"<|", "|>"}]}], "]"}]}], "|>"}], "&"}]}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"f", " ", "=", " ", 
        RowBox[{
         RowBox[{"<|", 
          RowBox[{
           RowBox[{"\"\<joints\>\"", " ", "\[Rule]", " ", 
            RowBox[{"j", "[", 
             RowBox[{
              RowBox[{"mu", "[", "#", "]"}], ",", " ", 
              RowBox[{"mopts", "[", "#", "]"}]}], "]"}]}], ",", 
           RowBox[{"\"\<clips\>\"", " ", "\[Rule]", " ", 
            RowBox[{"CreateClips", "[", 
             RowBox[{
              RowBox[{"K", "@", "#"}], ",", " ", "Automatic"}], "]"}]}], ",", 
           " ", 
           RowBox[{"mroot", "[", "#", "]"}], ",", " ", 
           RowBox[{"\"\<surfaces\>\"", " ", "\[Rule]", " ", 
            RowBox[{"GetSurfaceAngles", "[", 
             RowBox[{"K", "@", "#"}], "]"}]}]}], "|>"}], "&"}]}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"<|", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"\"\<name\>\"", " ", "\[Rule]", " ", 
          RowBox[{"BLbiped", "[", "\"\<name\>\"", "]"}]}], ",", 
         "\[IndentingNewLine]", 
         RowBox[{"\"\<models\>\"", " ", "\[Rule]", " ", 
          RowBox[{"KeyValueMap", "[", 
           RowBox[{
            RowBox[{
             RowBox[{"<|", 
              RowBox[{
               RowBox[{"\"\<name\>\"", " ", "\[Rule]", " ", "#1"}], ",", " ", 
               
               RowBox[{"f", "[", "#2", "]"}]}], "|>"}], "&"}], ",", " ", 
            "A"}], "]"}]}]}], "\[IndentingNewLine]", "|>"}]}]}], 
     "\[IndentingNewLine]", "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"BLExportBipedToThreeJS", "[", 
    RowBox[{"A_", ",", " ", 
     RowBox[{"folder_:", "Automatic"}]}], "]"}], " ", ":=", " ", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "n", ",", " ", "e", ",", " ", "biped", ",", " ", "file", ",", " ", 
       "m"}], "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"n", " ", "=", " ", 
       RowBox[{"Lookup", "[", 
        RowBox[{"A", ",", " ", "\"\<name\>\"", ",", " ", "Null"}], "]"}]}], 
      ";", "\[IndentingNewLine]", 
      RowBox[{"biped", " ", "=", " ", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"!", 
          RowBox[{"StringQ", "[", "n", "]"}]}], ",", " ", 
         RowBox[{"BLCreateBipedToThreeJS", "[", "A", "]"}], ",", " ", "A"}], 
        "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"file", " ", "=", " ", 
       RowBox[{
        RowBox[{"biped", "[", "\"\<name\>\"", "]"}], " ", "<>", " ", 
        "\"\<.json\>\""}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"folder", " ", "===", " ", "Automatic"}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{"BLExportTo", "[", 
         RowBox[{"\"\<JSON\>\"", ",", " ", "file", ",", " ", "biped"}], "]"}],
         ",", "\[IndentingNewLine]", 
        RowBox[{"(*", " ", "else", " ", "*)"}], "\[IndentingNewLine]", 
        RowBox[{"Export", "[", 
         RowBox[{
          RowBox[{"FileNameJoin", "[", 
           RowBox[{"{", 
            RowBox[{"folder", ",", " ", "file"}], "}"}], "]"}], ",", " ", 
          "biped"}], "]"}]}], "\[IndentingNewLine]", "]"}]}]}], 
    "\[IndentingNewLine]", "]"}]}], ";"}]}], "Input",
 InitializationCell->
  True,ExpressionUUID->"eb95d5c4-dfd0-4fdf-9bf0-edc14468c445"]
}, Open  ]],

Cell[CellGroupData[{

Cell["End Package", "Section",
 InitializationCell->
  True,ExpressionUUID->"7763f1fd-3f31-4fe6-a458-46e8b19904fe"],

Cell[BoxData[{
 RowBox[{"End", "[", "]"}], "\n", 
 RowBox[{"EndPackage", "[", "]"}]}], "Input",
 InitializationCell->True,
 CellLabel->"In[173]:=",ExpressionUUID->"9e692824-408c-4178-91b3-94d404c368e1"]
}, Open  ]]
},
AutoGeneratedPackage->Automatic,
WindowSize->{1373, 1505},
WindowMargins->{{0, Automatic}, {0, Automatic}},
PrivateNotebookOptions->{"FileOutlineCache"->False},
TrackCellChangeTimes->False,
FrontEndVersion->"11.3 for Linux x86 (64-bit) (March 6, 2018)",
StyleDefinitions->"Default.nb"
]

